<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kafka-生产者 | aacopy</title><meta name="keywords" content="Kafka,消息队列"><meta name="author" content="cmyang"><meta name="copyright" content="cmyang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Kafka-消息生产者生产消息过程、链路、消息分区策略，自定义分区策略">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka-生产者">
<meta property="og:url" content="http://www.aacopy.cn/2021/12/22/Kafka/Kafka-%E7%94%9F%E4%BA%A7%E8%80%85/index.html">
<meta property="og:site_name" content="aacopy">
<meta property="og:description" content="Kafka-消息生产者生产消息过程、链路、消息分区策略，自定义分区策略">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.aacopy.cn/images/common/kafka.png">
<meta property="article:published_time" content="2021-12-22T15:19:00.000Z">
<meta property="article:modified_time" content="2022-06-06T13:16:56.169Z">
<meta property="article:author" content="cmyang">
<meta property="article:tag" content="Kafka">
<meta property="article:tag" content="消息队列">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.aacopy.cn/images/common/kafka.png"><link rel="shortcut icon" href="/images/common/favicon.png"><link rel="canonical" href="http://www.aacopy.cn/2021/12/22/Kafka/Kafka-%E7%94%9F%E4%BA%A7%E8%80%85/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kafka-生产者',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2022-06-06 21:16:56'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/common/header.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">96</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">aacopy</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Kafka-生产者</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-12-22T15:19:00.000Z" title="发表于 2021-12-22 23:19:00">2021-12-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-06-06T13:16:56.169Z" title="更新于 2022-06-06 21:16:56">2022-06-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Kafka/">Kafka</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Kafka-生产者"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><p>生产者如何将消息发送给kafka</p>
<p><img src="/images/Kafka-%E7%94%9F%E4%BA%A7%E8%80%85/kafka%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7.png" alt="kafka消息生产"></p>
<ul>
<li><p>batch缓冲区</p>
<ul>
<li>生产者发送消息到服务端不是一条一条发的，而是经过一个内存缓冲区，当缓冲区达到一定条件后，再一次性将消息数据发送到topic</li>
<li>缓冲区大小默认为16KB，通过batch.size配置，单位：字节，当消息数据超过阀值后，就会执行提交</li>
<li>如果消息大小一直没有满设置的缓冲区大小阀值，则会根据超过某个时间后进行发送，通过配置linger.ms实现，默认为0，表示即使缓冲区没满，消息也会立刻发送。</li>
<li>batch.size和linger.ms，两个配置，满足其一，消息就会被发送</li>
</ul>
</li>
<li><p>消息发送到partition分区的策略</p>
<ul>
<li>如果指定了partition的id，就会被发送到指定的partition中</li>
<li>如果指定了key，ProducerRecord会根据key的hash值，发送到对应的partition中，拥有相同key的消息会被写到同一个partition，实现顺序消息</li>
<li>如果id和key都没有指定，则会按照粘性（sticky）分区策略的方式依次发送到每个partition中</li>
<li>如果同时指定id和key，则以id为准</li>
</ul>
</li>
<li><p>partition分区策略的改变</p>
<ul>
<li><p>2.4版本以前，默认round-robin（轮询）方式，2.3.1版本源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The default partitioning strategy:</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;If a partition is specified in the record, use it</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;If no partition is specified but a key is present choose a partition based on a hash of the key</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;If no partition or key is present choose a partition in a round-robin fashion</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultPartitioner</span> <span class="keyword">implements</span> <span class="title">Partitioner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, AtomicInteger&gt; topicCounterMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Compute the partition for the given record.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic The topic name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key The key to partition on (or null if no key)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyBytes serialized key to partition on (or null if no key)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value The value to partition on or null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> valueBytes serialized value to partition on or null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cluster The current cluster metadata</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line">        List&lt;PartitionInfo&gt; partitions = cluster.partitionsForTopic(topic);</span><br><span class="line">        <span class="keyword">int</span> numPartitions = partitions.size();</span><br><span class="line">        <span class="keyword">if</span> (keyBytes == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextValue = nextValue(topic);</span><br><span class="line">            List&lt;PartitionInfo&gt; availablePartitions = cluster.availablePartitionsForTopic(topic);</span><br><span class="line">            <span class="keyword">if</span> (availablePartitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> part = Utils.toPositive(nextValue) % availablePartitions.size();</span><br><span class="line">                <span class="keyword">return</span> availablePartitions.get(part).partition();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// no partitions are available, give a non-available partition</span></span><br><span class="line">                <span class="keyword">return</span> Utils.toPositive(nextValue) % numPartitions;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// hash the keyBytes to choose a partition</span></span><br><span class="line">            <span class="keyword">return</span> Utils.toPositive(Utils.murmur2(keyBytes)) % numPartitions;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">nextValue</span><span class="params">(String topic)</span> </span>&#123;</span><br><span class="line">        AtomicInteger counter = topicCounterMap.get(topic);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == counter) &#123;</span><br><span class="line">            counter = <span class="keyword">new</span> AtomicInteger(ThreadLocalRandom.current().nextInt());</span><br><span class="line">            AtomicInteger currentCounter = topicCounterMap.putIfAbsent(topic, counter);</span><br><span class="line">            <span class="keyword">if</span> (currentCounter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                counter = currentCounter;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> counter.getAndIncrement();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>2.4版本以后，默认为：sticky （粘性）</p>
<p>参考文档：<a target="_blank" rel="noopener" href="https://www.confluent.io/blog/apache-kafka-producer-improvements-sticky-partitioner/">https://www.confluent.io/blog/apache-kafka-producer-improvements-sticky-partitioner/</a></p>
<blockquote>
<p>If we send several records to the same partition at around the same time, they can be sent as a batch</p>
<p>如果我们在同一时间将多条记录发送到同一个分区，它们可以作为批处理发送</p>
<p>Generally, smaller batches lead to more requests and queuing, resulting in higher latency.</p>
<p>一般来说，更小的批量会导致更多的请求和排队，从而导致更高的延迟。</p>
<p>A batch is completed either when it reaches a certain size (batch.size) or after a period of time (linger.ms) is up.</p>
<p>一个批处理要么在达到某个大小(batch.size)时完成，要么在一段时间(linger.ms)结束后完成。</p>
<p>The default for batch. size is 16,384 bytes, and the default of linger. ms is 0 milliseconds. </p>
<p>默认值，batch.size为16KB，linger. ms为0ms</p>
<p>At first glance, it might seem like setting <code>linger.ms</code> to 0 would only lead to the production of single-record batches. However, this is usually not the case. Even when <code>linger.ms</code> is 0, the producer will group records into batches when they are produced to the same partition around the same time. This is because the system needs a bit of time to handle each request, and batches form when the system cannot attend to them all right away.</p>
<p>乍一看，似乎设置<code>linger.ms</code>为 0 只会导致生成单记录批次。然而，通常情况并非如此。即使<code>linger.ms</code>是 0，生产者也会将记录在同一时间生产到同一分区时分批进行。这是因为系统需要一点时间来处理每个请求，并且当系统无法立即处理它们时会批量形成。</p>
<p>Due to the potential for increased latency with small batches, the original strategy for partitioning records with null keys can be inefficient. This changes with <a target="_blank" rel="noopener" href="https://www.confluent.io/blog/apache-kafka-2-4-latest-version-updates">Apache Kafka version 2.4</a>, which introduces sticky partitioning, a new strategy for assigning records to partitions with proven lower latency.</p>
<p>由于小批量可能会增加延迟，因此使用空键对记录进行分区的原始策略可能效率低下。这在<a target="_blank" rel="noopener" href="https://www.confluent.io/blog/apache-kafka-2-4-latest-version-updates">Apache Kafka 2.4 版中</a>发生了变化，它引入了粘性分区，这是一种将记录分配给具有低延迟的分区的新策略。</p>
<p>The sticky partitioner addresses the problem of spreading out records without keys into smaller batches by picking a single partition to send all non-keyed records. Once the batch at that partition is filled or otherwise completed, the sticky partitioner randomly chooses and “sticks” to a new partition. That way, over a larger period of time, records are about evenly distributed among all the partitions while getting the added benefit of larger batch sizes.</p>
<p>粘性分区器通过选择单个分区来发送所有非键记录，解决了将没有键的记录分散成较小批次的问题。一旦该分区的批次被填满或以其他方式完成，粘性分区程序会随机选择并“粘”到一个新分区。这样，在更长的时间内，记录大致均匀地分布在所有分区中，同时获得更大批量的额外好处。</p>
<p>The main goal of the sticky partitioner is to increase the number of records in each batch in order to decrease the total number of batches and eliminate excess queuing. When there are fewer batches with more records in each batch, the cost per record is lower and the same number of records can be sent more quickly using the sticky partitioning strategy. The data shows that this strategy does decrease latency in cases where null keys are used, and the effect becomes more pronounced when the number of partitions increases. In addition, CPU usage is often decreased when using the sticky partitioning strategy. By sticking to a partition and sending fewer but bigger batches, the producer sees great performance improvements.</p>
<p>粘性分区器的主要目标是增加每个批次中的记录数，以减少批次总数并消除多余的排队。当每个批次中有更多记录的批次较少时，每条记录的成本较低，并且使用粘性分区策略可以更快地发送相同数量的记录。数据显示，在使用空键的情况下，这种策略确实减少了延迟，并且当分区数量增加时效果会更加明显。此外，在使用粘性分区策略时，CPU 使用率通常会降低。通过坚持分区并发送更少但更大的批次，生产者看到了巨大的性能改进。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<p>​                <img src="/images/Kafka-%E7%94%9F%E4%BA%A7%E8%80%85/sticky-partitioner-strategy.png" alt="坚持一个分区，直到批次关闭； 每个分区接收一个包含三个记录的完整批次。"></p>
<p>3.0.0版本的源码：                </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The default partitioning strategy:</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;If a partition is specified in the record, use it</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;If no partition is specified but a key is present choose a partition based on a hash of the key</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;If no partition or key is present choose the sticky partition that changes when the batch is full.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * See KIP-480 for details about sticky partitioning.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultPartitioner</span> <span class="keyword">implements</span> <span class="title">Partitioner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StickyPartitionCache stickyPartitionCache = <span class="keyword">new</span> StickyPartitionCache();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Compute the partition for the given record.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic The topic name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key The key to partition on (or null if no key)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyBytes serialized key to partition on (or null if no key)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value The value to partition on or null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> valueBytes serialized value to partition on or null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cluster The current cluster metadata</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> partition(topic, key, keyBytes, value, valueBytes, cluster, cluster.partitionsForTopic(topic).size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Compute the partition for the given record.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic The topic name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> numPartitions The number of partitions of the given &#123;<span class="doctag">@code</span> topic&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key The key to partition on (or null if no key)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyBytes serialized key to partition on (or null if no key)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value The value to partition on or null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> valueBytes serialized value to partition on or null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cluster The current cluster metadata</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="keyword">int</span> numPartitions)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (keyBytes == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> stickyPartitionCache.partition(topic, cluster);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// hash the keyBytes to choose a partition</span></span><br><span class="line">        <span class="keyword">return</span> Utils.toPositive(Utils.murmur2(keyBytes)) % numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If a batch completed for the current sticky partition, change the sticky partition. </span></span><br><span class="line"><span class="comment">     * Alternately, if no sticky partition has been determined, set one.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNewBatch</span><span class="params">(String topic, Cluster cluster, <span class="keyword">int</span> prevPartition)</span> </span>&#123;</span><br><span class="line">        stickyPartitionCache.nextPartition(topic, cluster, prevPartition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An internal class that implements a cache used for sticky partitioning behavior. The cache tracks the current sticky</span></span><br><span class="line"><span class="comment"> * partition for any given topic. This class should not be used externally. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StickyPartitionCache</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Integer&gt; indexCache;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StickyPartitionCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.indexCache = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Cluster cluster)</span> </span>&#123;</span><br><span class="line">        Integer part = indexCache.get(topic);</span><br><span class="line">        <span class="keyword">if</span> (part == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> nextPartition(topic, cluster, -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> part;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">nextPartition</span><span class="params">(String topic, Cluster cluster, <span class="keyword">int</span> prevPartition)</span> </span>&#123;</span><br><span class="line">        List&lt;PartitionInfo&gt; partitions = cluster.partitionsForTopic(topic);</span><br><span class="line">        Integer oldPart = indexCache.get(topic);</span><br><span class="line">        Integer newPart = oldPart;</span><br><span class="line">        <span class="comment">// Check that the current sticky partition for the topic is either not set or that the partition that </span></span><br><span class="line">        <span class="comment">// triggered the new batch matches the sticky partition that needs to be changed.</span></span><br><span class="line">        <span class="comment">// oldPart == null表示新建的topic被第一次调用，oldPart == prevPartition在新的batch被创建时为true</span></span><br><span class="line">        <span class="keyword">if</span> (oldPart == <span class="keyword">null</span> || oldPart == prevPartition) &#123;</span><br><span class="line">            List&lt;PartitionInfo&gt; availablePartitions = cluster.availablePartitionsForTopic(topic);</span><br><span class="line">            <span class="keyword">if</span> (availablePartitions.size() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                Integer random = Utils.toPositive(ThreadLocalRandom.current().nextInt());</span><br><span class="line">                newPart = random % partitions.size();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availablePartitions.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                newPart = availablePartitions.get(<span class="number">0</span>).partition();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (newPart == <span class="keyword">null</span> || newPart.equals(oldPart)) &#123;</span><br><span class="line">                    <span class="keyword">int</span> random = Utils.toPositive(ThreadLocalRandom.current().nextInt());</span><br><span class="line">                    newPart = availablePartitions.get(random % availablePartitions.size()).partition();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Only change the sticky partition if it is null or prevPartition matches the current sticky partition.</span></span><br><span class="line">            <span class="keyword">if</span> (oldPart == <span class="keyword">null</span>) &#123;</span><br><span class="line">                indexCache.putIfAbsent(topic, newPart);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                indexCache.replace(topic, prevPartition, newPart);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> indexCache.get(topic);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> indexCache.get(topic);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>代码验证：</p>
<ol>
<li><p>创建一个topic：aacopy，5个分区，1个副本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createTopic</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">       <span class="comment">//（topic名称，partition分区数量，副本数量）</span></span><br><span class="line">       NewTopic newTopic = <span class="keyword">new</span> NewTopic(<span class="string">&quot;aacopy&quot;</span>, <span class="number">5</span>, (<span class="keyword">short</span>) <span class="number">1</span>);</span><br><span class="line">       CreateTopicsResult topics = adminClient.createTopics(Arrays.asList(newTopic));</span><br><span class="line">       topics.all().get();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>没有指定id和key的情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sandWithNothing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">           ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; sendMsg = kafkaTemplate.send(<span class="string">&quot;aacopy&quot;</span>, <span class="string">&quot;aacopy-msg-&quot;</span> + i);</span><br><span class="line">           <span class="comment">//增加回调函数，打印返回值</span></span><br><span class="line">           sendMsg.addCallback(success -&gt; &#123;</span><br><span class="line">               RecordMetadata rm = success.getRecordMetadata();</span><br><span class="line">               System.out.println(<span class="string">&quot;消息发送成功：topic-&gt;&quot;</span> + rm.topic() + <span class="string">&quot;, partition-&gt;&quot;</span> + rm.partition() + <span class="string">&quot;, offset-&gt;&quot;</span> + rm.offset());</span><br><span class="line">           &#125;, failure -&gt; System.out.println(<span class="string">&quot;消息发送失败：&quot;</span> + failure.getMessage()));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>控制台打印日志截取：</p>
<blockquote>
<p>……</p>
<p>消息发送成功：topic-&gt;aacopy, partition-&gt;2, offset-&gt;403<br>消息发送成功：topic-&gt;aacopy, partition-&gt;2, offset-&gt;404<br>消息发送成功：topic-&gt;aacopy, partition-&gt;2, offset-&gt;405<br>消息发送成功：topic-&gt;aacopy, partition-&gt;2, offset-&gt;406<br>消息发送成功：topic-&gt;aacopy, partition-&gt;2, offset-&gt;407<br>消息发送成功：topic-&gt;aacopy, partition-&gt;1, offset-&gt;319<br>消息发送成功：topic-&gt;aacopy, partition-&gt;1, offset-&gt;320<br>消息发送成功：topic-&gt;aacopy, partition-&gt;1, offset-&gt;321<br>消息发送成功：topic-&gt;aacopy, partition-&gt;1, offset-&gt;322</p>
<p>……</p>
</blockquote>
</li>
<li><p>指定id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendWithId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">           ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; sendMsg = kafkaTemplate.send(<span class="string">&quot;aacopy&quot;</span>, <span class="number">4</span>, <span class="keyword">null</span>, <span class="string">&quot;aacopy-msg-&quot;</span> + i);</span><br><span class="line">           sendMsg.addCallback(success -&gt; &#123;</span><br><span class="line">               RecordMetadata rm = success.getRecordMetadata();</span><br><span class="line">               System.out.println(<span class="string">&quot;消息发送成功：topic-&gt;&quot;</span> + rm.topic() + <span class="string">&quot;, partition-&gt;&quot;</span> + rm.partition() + <span class="string">&quot;, offset-&gt;&quot;</span> + rm.offset());</span><br><span class="line">           &#125;, failure -&gt; System.out.println(<span class="string">&quot;消息发送失败：&quot;</span> + failure.getMessage()));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>控制台打印日志截取：</p>
<blockquote>
<p>……</p>
<p>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;93<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;94<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;95<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;96<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;97<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;98<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;99</p>
</blockquote>
<p>所有消息都推送到id为4的partition中</p>
</li>
<li><p>指定key</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendWithKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">           ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; sendMsg = kafkaTemplate.send(<span class="string">&quot;aacopy&quot;</span>, <span class="string">&quot;HelloWorld&quot;</span>, <span class="string">&quot;aacopy-msg-&quot;</span> + i);</span><br><span class="line">           sendMsg.addCallback(success -&gt; &#123;</span><br><span class="line">               RecordMetadata rm = success.getRecordMetadata();</span><br><span class="line">               System.out.println(<span class="string">&quot;消息发送成功：topic-&gt;&quot;</span> + rm.topic() + <span class="string">&quot;, partition-&gt;&quot;</span> + rm.partition() + <span class="string">&quot;, offset-&gt;&quot;</span> + rm.offset());</span><br><span class="line">           &#125;, failure -&gt; System.out.println(<span class="string">&quot;消息发送失败：&quot;</span> + failure.getMessage()));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>控制台打印日志截取：</p>
<blockquote>
<p>……</p>
<p>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;102<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;103<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;104<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;105<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;106<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;107</p>
<p>……</p>
</blockquote>
</li>
<li><p>同时指定id和key</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendWithIdAndKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">           ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; sendMsg = kafkaTemplate.send(<span class="string">&quot;aacopy&quot;</span>, <span class="number">4</span>, <span class="string">&quot;HelloWorld&quot;</span>, <span class="string">&quot;aacopy-msg-&quot;</span> + i);</span><br><span class="line">           sendMsg.addCallback(success -&gt; &#123;</span><br><span class="line">               RecordMetadata rm = success.getRecordMetadata();</span><br><span class="line">               System.out.println(<span class="string">&quot;消息发送成功：topic-&gt;&quot;</span> + rm.topic() + <span class="string">&quot;, partition-&gt;&quot;</span> + rm.partition() + <span class="string">&quot;, offset-&gt;&quot;</span> + rm.offset());</span><br><span class="line">           &#125;, failure -&gt; System.out.println(<span class="string">&quot;消息发送失败：&quot;</span> + failure.getMessage()));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>控制台打印日志截取：</p>
<blockquote>
<p>……</p>
<p>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;333<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;334<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;335<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;336<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;337</p>
<p>……</p>
</blockquote>
</li>
</ol>
<p>​        打印验证，id和key同时存在，以id为准</p>
<ul>
<li><p>自定义分区规则</p>
<p>自定义分区规则需要实现Partitioner接口，或者继承实现了Partitioner接口的类，这里继承DefaultPartitioner，可以在不需要自定义的消息时走默认的策略</p>
<ol>
<li>编写自定义分区规则类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizedPartitioner</span> <span class="keyword">extends</span> <span class="title">DefaultPartitioner</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(key != <span class="keyword">null</span> &amp;&amp; key <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            String keyStr = (String) key;</span><br><span class="line">            <span class="keyword">if</span>(keyStr.startsWith(<span class="string">&quot;aacopy_&quot;</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;自定义分区策略...... key -&gt;&quot;</span> + keyStr);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.partition(topic, key, keyBytes, value, valueBytes, cluster);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>添加配置文件，</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#定义分区策略</span><br><span class="line">spring.kafka.producer.properties.partitioner.class=cn.aacopy.learn.kafka.CustomizedPartitioner</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>编写测试代码</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendWithCustomizedPartitioner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">           ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; sendMsg = kafkaTemplate.send(<span class="string">&quot;aacopy&quot;</span>, <span class="string">&quot;aacopy_&quot;</span> + i, <span class="string">&quot;aacopy-msg-&quot;</span> + i);</span><br><span class="line">           sendMsg.addCallback(success -&gt; &#123;</span><br><span class="line">               RecordMetadata rm = success.getRecordMetadata();</span><br><span class="line">               System.out.println(<span class="string">&quot;消息发送成功：topic-&gt;&quot;</span> + rm.topic() + <span class="string">&quot;, partition-&gt;&quot;</span> + rm.partition() + <span class="string">&quot;, offset-&gt;&quot;</span> + rm.offset());</span><br><span class="line">           &#125;, failure -&gt; System.out.println(<span class="string">&quot;消息发送失败：&quot;</span> + failure.getMessage()));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>控制台打印日志截取：</li>
</ol>
<blockquote>
<p>……</p>
<p>自定义分区策略…… key -&gt;aacopy_96<br>自定义分区策略…… key -&gt;aacopy_97<br>自定义分区策略…… key -&gt;aacopy_98<br>自定义分区策略…… key -&gt;aacopy_98<br>自定义分区策略…… key -&gt;aacopy_99</p>
<p>……</p>
<p>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;729<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;730<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;731<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;732<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;733</p>
<p>……</p>
</blockquote>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">cmyang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.aacopy.cn/2021/12/22/Kafka/Kafka-%E7%94%9F%E4%BA%A7%E8%80%85/">http://www.aacopy.cn/2021/12/22/Kafka/Kafka-%E7%94%9F%E4%BA%A7%E8%80%85/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.aacopy.cn" target="_blank">aacopy</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kafka/">Kafka</a><a class="post-meta__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a></div><div class="post_share"><div class="social-share" data-image="/images/common/kafka.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/12/22/Kafka/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/"><img class="prev-cover" src="/images/common/kafka.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Kafka-消费者</div></div></a></div><div class="next-post pull-right"><a href="/2021/12/22/Util/Aspose-Excel/"><img class="next-cover" src="/images/common/aspose.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Aspose-Excel</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/12/27/Kafka/Kafka-AdminApi/" title="Kafka-AdminApi"><img class="cover" src="/images/common/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-27</div><div class="title">Kafka-AdminApi</div></div></a></div><div><a href="/2021/12/06/Kafka/Kafka-HelloWorld/" title="Kafka-HelloWorld"><img class="cover" src="/images/common/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-06</div><div class="title">Kafka-HelloWorld</div></div></a></div><div><a href="/2021/12/07/Kafka/Kafka-SpringBoot/" title="Kafka-SpringBoot"><img class="cover" src="/images/common/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-07</div><div class="title">Kafka-SpringBoot</div></div></a></div><div><a href="/2022/01/04/Kafka/Kafka-事务消息/" title="Kafka-事务消息"><img class="cover" src="/images/common/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-04</div><div class="title">Kafka-事务消息</div></div></a></div><div><a href="/2021/12/14/Kafka/Kafka-命令/" title="Kafka-命令"><img class="cover" src="/images/common/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-14</div><div class="title">Kafka-命令</div></div></a></div><div><a href="/2021/12/13/Kafka/Kafka-文件存储机制/" title="Kafka-文件存储机制"><img class="cover" src="/images/common/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-13</div><div class="title">Kafka-文件存储机制</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/common/header.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">cmyang</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">96</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/aacopy"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://gitee.com/aacopy" target="_blank" title="Gitee"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:969312613@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/05/29/Git/Git-%E5%AE%89%E8%A3%85Linux/" title="Git-安装Linux"><img src="/images/common/git.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Git-安装Linux"/></a><div class="content"><a class="title" href="/2022/05/29/Git/Git-%E5%AE%89%E8%A3%85Linux/" title="Git-安装Linux">Git-安装Linux</a><time datetime="2022-05-29T07:03:00.000Z" title="发表于 2022-05-29 15:03:00">2022-05-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/28/Mysql/Druid-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7/" title="Druid-性能监控"><img src="/images/common/mysql.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Druid-性能监控"/></a><div class="content"><a class="title" href="/2022/05/28/Mysql/Druid-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7/" title="Druid-性能监控">Druid-性能监控</a><time datetime="2022-05-28T14:35:00.000Z" title="发表于 2022-05-28 22:35:00">2022-05-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/30/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-UML/" title="设计模式-UML"><img src="/images/common/designMode.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="设计模式-UML"/></a><div class="content"><a class="title" href="/2022/04/30/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-UML/" title="设计模式-UML">设计模式-UML</a><time datetime="2022-04-30T13:28:00.000Z" title="发表于 2022-04-30 21:28:00">2022-04-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/17/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-HelloWorld/" title="设计模式-HelloWorld"><img src="/images/common/designMode.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="设计模式-HelloWorld"/></a><div class="content"><a class="title" href="/2022/04/17/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-HelloWorld/" title="设计模式-HelloWorld">设计模式-HelloWorld</a><time datetime="2022-04-17T15:01:00.000Z" title="发表于 2022-04-17 23:01:00">2022-04-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/06/Util/JWT/" title="JWT"><img src="/images/common/springcloud.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JWT"/></a><div class="content"><a class="title" href="/2022/04/06/Util/JWT/" title="JWT">JWT</a><time datetime="2022-04-06T15:57:00.000Z" title="发表于 2022-04-06 23:57:00">2022-04-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By cmyang</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="http://beian.miit.gov.cn/" target="_blank">皖ICP备2022008292号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='all'|| 'all' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="http://www.aacopy.cn/categories/Kafka/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 Kafka (11)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://www.aacopy.cn/categories/Mysql/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 Mysql (14)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://www.aacopy.cn/categories/SpringCloud/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎮 SpringCloud (10)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://www.aacopy.cn/categories/ElasticSearch/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🐱‍👓 ElasticSearch (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://www.aacopy.cn/categories/Flowable/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 Flowable (8)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://www.aacopy.cn/categories/Redis/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📒 Redis (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="http://www.aacopy.cn/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #b30070}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><!-- hexo injector body_end end --></body></html>