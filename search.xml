<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>MongoDB-事务</title>
      <link href="/mongodb/mongodb-shi-wu/"/>
      <url>/mongodb/mongodb-shi-wu/</url>
      
        <content type="html"><![CDATA[<p>mongoDB 执行事务，需要mongodb的集群模式，需要搭建一个mongo集群</p><h2 id="1-docker搭建伪集群"><a href="#1-docker搭建伪集群" class="headerlink" title="1. docker搭建伪集群"></a>1. docker搭建伪集群</h2><p>如果需要支持mongo的事务，需要集群模式，这里搭建一个简单的伪集群做事务测试</p><ul><li>编写配置文件</li><li><code>vim /dockerData/mongo/config/mongod.conf</code></li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># mongod.conf</span><span class="token comment"># for documentation of all options, see:</span><span class="token comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span><span class="token comment"># Where and how to store data.</span><span class="token key atrule">storage</span><span class="token punctuation">:</span>  <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> /data/db  <span class="token key atrule">journal</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token comment">#  engine:</span><span class="token comment">#  mmapv1:</span><span class="token comment">#  wiredTiger:</span><span class="token comment"># where to write logging data.</span><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>  <span class="token key atrule">destination</span><span class="token punctuation">:</span> file  <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/log/mongodb/mongod.log<span class="token comment"># network interfaces</span><span class="token key atrule">net</span><span class="token punctuation">:</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span><span class="token comment">#  bindIp: 127.0.0.1</span>  <span class="token key atrule">bindIpAll</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token comment"># how the process runs</span><span class="token key atrule">processManagement</span><span class="token punctuation">:</span>  <span class="token key atrule">timeZoneInfo</span><span class="token punctuation">:</span> /usr/share/zoneinfo<span class="token comment">#security:</span><span class="token comment">#  authorization: enabled</span><span class="token comment">#  keyFile: /etc/mongo/keyFilers0.key</span><span class="token comment">#operationProfiling:</span><span class="token key atrule">replication</span><span class="token punctuation">:</span>  <span class="token key atrule">oplogSizeMB</span><span class="token punctuation">:</span> <span class="token number">150</span>  <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> itdeve<span class="token punctuation">-</span>mongodb<span class="token key atrule">sharding</span><span class="token punctuation">:</span>  <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> shardsvr<span class="token comment">## Enterprise-Only Options:</span><span class="token comment">#auditLog:</span><span class="token comment">#snmp:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>执行docker命令</li></ul><pre class="line-numbers language-none"><code class="language-none">docker run -d --name mongo -p 27017:27017 \-v /dockerData/mongo/data/db:/data/db \-v /dockerData/mongo/config/mongod.conf:/etc/mongo/mongod.conf \mongo:4.4.5 --config /etc/mongo/mongod.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>进去容器：<code>docker exec -it mongo /bin/bash</code></p></li><li><p>打开mongo命令行 <code>mongo</code></p></li><li><p>依次执行命令</p></li></ul><pre class="line-numbers language-none"><code class="language-none">use adminrs.initiate()rs.conf()exit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>伪集群搭建完成，可以测试事务</li></ul><h2 id="2-添加事务支持"><a href="#2-添加事务支持" class="headerlink" title="2. 添加事务支持"></a>2. 添加事务支持</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MongoConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">MongoTransactionManager</span> <span class="token function">mongoTransactionManager</span><span class="token punctuation">(</span><span class="token class-name">MongoDatabaseFactory</span> mongoDatabaseFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MongoTransactionManager</span><span class="token punctuation">(</span>mongoDatabaseFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>接下来只需要再service方法上添加<code>@Transactional</code>注解即可</li></ul><h2 id="3-mysql与mongo事务冲突"><a href="#3-mysql与mongo事务冲突" class="headerlink" title="3. mysql与mongo事务冲突"></a>3. mysql与mongo事务冲突</h2><p>如果项目中同时使用了mysql和mongo，并且都使用的事务，会导致mysql的事务失效，无法回滚。因为都实现了PlatformTransactionManager，springboot容器只会加载一个，所需如果需要同时加载两个PlatformTransactionManager的bean。需要对bean从命名，并且保证mysql事务方式不变，指定mysql事务为主</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>mongo<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Primary</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span></span><span class="token class-name">MongoDatabaseFactory</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span></span><span class="token class-name">MongoTransactionManager</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">JdbcTransactionManager</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DataSource</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author cmyang * @date 2022/11/20 0:57 */</span><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MongoConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"mongoTransactionManager"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">MongoTransactionManager</span> <span class="token function">mongoTransactionManager</span><span class="token punctuation">(</span><span class="token class-name">MongoDatabaseFactory</span> mongoDatabaseFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MongoTransactionManager</span><span class="token punctuation">(</span>mongoDatabaseFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"jdbcTransactionManager"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@Primary</span>    <span class="token keyword">public</span> <span class="token class-name">JdbcTransactionManager</span> <span class="token function">jdbcTransactionManager</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTransactionManager</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>mysql的事务还是保持原来的使用方式</li><li>mongodb在添加<code>@Transactional</code>注解时，需要指定PlatformTransactionManager 的具体bean名称</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestAServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TestAService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">TestARepository</span> testARepository<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span><span class="token string">"mongoTransactionManager"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">TestADO</span> <span class="token function">saveTestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">TestADO</span> testADO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestADO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        testADO<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"嘎嘎"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        testARepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>testADO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> testADO<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>这样就解决了同时支持mysql和mongo事务的问题</li></ul><h2 id="4-并发报错WriteConflict"><a href="#4-并发报错WriteConflict" class="headerlink" title="4. 并发报错WriteConflict"></a>4. 并发报错WriteConflict</h2><p>mongo本身不支持事务，直接使用事务注解在并发情况下会报错WriteConflict。</p><p>官方提供的方案是，通过重试的方式spring-retry，但这种方式，很影响效率，</p><ul><li>添加依赖</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.retry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-retry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>启动类上添加<code>@EnableRetry</code></li><li>编写自定义mongo事务注解@MongoTransactional</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Inherited</span><span class="token annotation punctuation">@Retryable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">UncategorizedMongoDbException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> exceptionExpression <span class="token operator">=</span> <span class="token string">"#{message.contains('WriteConflict error')}"</span><span class="token punctuation">,</span> maxAttempts <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">,</span> backoff <span class="token operator">=</span> <span class="token annotation punctuation">@Backoff</span><span class="token punctuation">(</span>delay <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRES_NEW</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">MongoTransactional</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>使用自定义注解</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@MongoTransactional</span><span class="token keyword">public</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> MongoDB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB-入门</title>
      <link href="/mongodb/mongodb-ru-men/"/>
      <url>/mongodb/mongodb-ru-men/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h2><p>mongoDB是非关系型数据库，存储类似json格式数据</p><h2 id="2-docker安装"><a href="#2-docker安装" class="headerlink" title="2. docker安装"></a>2. docker安装</h2><h3 id="2-1-docker搭建单节点"><a href="#2-1-docker搭建单节点" class="headerlink" title="2.1 docker搭建单节点"></a>2.1 docker搭建单节点</h3><pre class="line-numbers language-none"><code class="language-none">docker run -d \  --name mongo \  -p 27017:27017 \  -v /dockerData/mongo/data:/data/db \  -v /dockerData/mongo/backup:/data/backup \  -v /dockerData/mongo/conf:/data/configdb \  -e MONGO_INITDB_ROOT_USERNAME=root \  -e MONGO_INITDB_ROOT_PASSWORD=aacopy.cn \  mongo --auth<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-docker搭建伪集群"><a href="#2-2-docker搭建伪集群" class="headerlink" title="2.2 docker搭建伪集群"></a>2.2 docker搭建伪集群</h3><p>如果需要支持mongo的事务，需要集群模式，这里搭建一个简单的伪集群做事务测试</p><ul><li>编写配置文件</li><li><code>vim /dockerData/mongo/config/mongod.conf</code></li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># mongod.conf</span><span class="token comment"># for documentation of all options, see:</span><span class="token comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span><span class="token comment"># Where and how to store data.</span><span class="token key atrule">storage</span><span class="token punctuation">:</span>  <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> /data/db  <span class="token key atrule">journal</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token comment">#  engine:</span><span class="token comment">#  mmapv1:</span><span class="token comment">#  wiredTiger:</span><span class="token comment"># where to write logging data.</span><span class="token key atrule">systemLog</span><span class="token punctuation">:</span>  <span class="token key atrule">destination</span><span class="token punctuation">:</span> file  <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/log/mongodb/mongod.log<span class="token comment"># network interfaces</span><span class="token key atrule">net</span><span class="token punctuation">:</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span><span class="token comment">#  bindIp: 127.0.0.1</span>  <span class="token key atrule">bindIpAll</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token comment"># how the process runs</span><span class="token key atrule">processManagement</span><span class="token punctuation">:</span>  <span class="token key atrule">timeZoneInfo</span><span class="token punctuation">:</span> /usr/share/zoneinfo<span class="token comment">#security:</span><span class="token comment">#  authorization: enabled</span><span class="token comment">#  keyFile: /etc/mongo/keyFilers0.key</span><span class="token comment">#operationProfiling:</span><span class="token key atrule">replication</span><span class="token punctuation">:</span>  <span class="token key atrule">oplogSizeMB</span><span class="token punctuation">:</span> <span class="token number">150</span>  <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> itdeve<span class="token punctuation">-</span>mongodb<span class="token key atrule">sharding</span><span class="token punctuation">:</span>  <span class="token key atrule">clusterRole</span><span class="token punctuation">:</span> shardsvr<span class="token comment">## Enterprise-Only Options:</span><span class="token comment">#auditLog:</span><span class="token comment">#snmp:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>执行docker命令</li></ul><pre class="line-numbers language-none"><code class="language-none">docker run -d --name mongo -p 27017:27017 \-v /dockerData/mongo/data/db:/data/db \-v /dockerData/mongo/config/mongod.conf:/etc/mongo/mongod.conf \mongo:4.4.5 --config /etc/mongo/mongod.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>进去容器：<code>docker exec -it mongo /bin/bash</code></p></li><li><p>打开mongo命令行 <code>mongo</code></p></li><li><p>依次执行命令</p></li></ul><pre class="line-numbers language-none"><code class="language-none">use adminrs.initiate()rs.conf()exit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>伪集群搭建完成，可以测试事务</li></ul>]]></content>
      
      
      <categories>
          
          <category> MongoDB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis-plus-乐观锁</title>
      <link href="/mybatis/mybatis-plus-le-guan-suo/"/>
      <url>/mybatis/mybatis-plus-le-guan-suo/</url>
      
        <content type="html"><![CDATA[<h2 id="1-设计思路"><a href="#1-设计思路" class="headerlink" title="1. 设计思路"></a>1. 设计思路</h2><ul><li>获取需要更新的记录</li><li>获取当前记录的版本号</li><li>更新时带上历史版本号作为条件，当原始版本没变时，才能更新成功</li><li>更新时，同时对历史版本号+1</li><li>如果版本已经变过了，就不会更新成功</li></ul><h2 id="2-代码示例"><a href="#2-代码示例" class="headerlink" title="2. 代码示例"></a>2. 代码示例</h2><h3 id="2-1-数据库新建一个测试表"><a href="#2-1-数据库新建一个测试表" class="headerlink" title="2.1 数据库新建一个测试表"></a>2.1 数据库新建一个测试表</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>goods<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>num<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>version<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'1'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">9</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_unicode_ci<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-创建一个springboot项目"><a href="#2-2-创建一个springboot项目" class="headerlink" title="2.2 创建一个springboot项目"></a>2.2 创建一个springboot项目</h3><h3 id="2-3-导入maven依赖"><a href="#2-3-导入maven依赖" class="headerlink" title="2.3 导入maven依赖"></a>2.3 导入maven依赖</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.7.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.aacopy.learn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatisplus-learn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>mybatisplus-learn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>mybatisplus-learn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.4.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-4-设置数据库连接配置"><a href="#2-4-设置数据库连接配置" class="headerlink" title="2.4 设置数据库连接配置"></a>2.4 设置数据库连接配置</h3><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">spring.datasource.driver-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span><span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://192.168.25.216:3306/aacopy</span><span class="token key attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span><span class="token key attr-name">spring.datasource.password</span><span class="token punctuation">=</span><span class="token value attr-value">aacopy.cn</span><span class="token key attr-name">mybatis-plus.configuration.log-impl</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.ibatis.logging.stdout.StdOutImpl</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-5-添加mybatisPlus-乐观锁插件"><a href="#2-5-添加mybatisPlus-乐观锁插件" class="headerlink" title="2.5 添加mybatisPlus 乐观锁插件"></a>2.5 添加mybatisPlus 乐观锁插件</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span></span><span class="token class-name">MybatisPlusInterceptor</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>inner<span class="token punctuation">.</span></span><span class="token class-name">OptimisticLockerInnerInterceptor</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author iseven.yang * @date 2022/11/2 20:56 */</span><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisPlusConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">MybatisPlusInterceptor</span> <span class="token function">mybatisPlusInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">MybatisPlusInterceptor</span> interceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MybatisPlusInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 添加乐观锁插件</span>        interceptor<span class="token punctuation">.</span><span class="token function">addInnerInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OptimisticLockerInnerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> interceptor<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>同时需要添加mapper扫描路径</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"cn.aacopy.learn.mybatisplus.mapper"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisplusLearnApplication</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MybatisplusLearnApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-6-通过代码生成工具生成service和mapper"><a href="#2-6-通过代码生成工具生成service和mapper" class="headerlink" title="2.6 通过代码生成工具生成service和mapper"></a>2.6 通过代码生成工具生成service和mapper</h3><p><img src="/images/Mybatis-plus-%E4%B9%90%E8%A7%82%E9%94%81/image-20221102233850924.png"></p><h3 id="2-7-编写测试代码"><a href="#2-7-编写测试代码" class="headerlink" title="2.7 编写测试代码"></a>2.7 编写测试代码</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>mybatisplus</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>domain<span class="token punctuation">.</span></span><span class="token class-name">GoodsDO</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">GoodsService</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span><span class="token annotation punctuation">@SpringBootTest</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">class</span> <span class="token class-name">MybatisplusLearnApplicationTests</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">GoodsService</span> goodsService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">testMybatisPlusOptimisticLocker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"测试乐观锁======start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">GoodsDO</span> goodsDO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GoodsDO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        goodsDO<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"物品1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        goodsDO<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span><span class="token number">100L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        goodsService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>goodsDO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Long</span> id <span class="token operator">=</span> goodsDO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//线程1：获取当前记录，睡眠1秒，再执行更新num为50</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">GoodsDO</span> goodsDO1 <span class="token operator">=</span> goodsService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}, 保存物品成功，goodsDO={}"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> goodsDO1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            goodsDO1<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span><span class="token number">50L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            goodsService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>goodsDO1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//线程2：获取当前记录，睡眠2秒，再执行更新num为200</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">GoodsDO</span> goodsDO1 <span class="token operator">=</span> goodsService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}, 保存物品成功，goodsDO={}"</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> goodsDO1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            goodsDO1<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span><span class="token number">200L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            goodsService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>goodsDO1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"更新物品数量成功，goodsDO={}"</span><span class="token punctuation">,</span> goodsService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"测试乐观锁======end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-8-执行测试"><a href="#2-8-执行测试" class="headerlink" title="2.8 执行测试"></a>2.8 执行测试</h3><pre class="line-numbers language-none"><code class="language-none">2022-11-02 23:22:44.378  INFO 20540 --- [           main] c.a.l.m.MybatisplusLearnApplicationTests : 测试乐观锁======startCreating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@79518e00] was not registered for synchronization because synchronization is not active2022-11-02 23:22:44.434  INFO 20540 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...2022-11-02 23:22:45.119  INFO 20540 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.JDBC Connection [HikariProxyConnection@970900790 wrapping com.mysql.cj.jdbc.ConnectionImpl@4a1a256d] will not be managed by Spring==&gt;  Preparing: INSERT INTO goods ( name, num ) VALUES ( ?, ? )==&gt; Parameters: 物品1(String), 100(Long)&lt;==    Updates: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@79518e00]Creating a new SqlSessionCreating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@17b1f1c0] was not registered for synchronization because synchronization is not activeSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@584e9813] was not registered for synchronization because synchronization is not activeJDBC Connection [HikariProxyConnection@596671943 wrapping com.mysql.cj.jdbc.ConnectionImpl@4a1a256d] will not be managed by Spring==&gt;  Preparing: SELECT id,name,num,version FROM goods WHERE id=?==&gt; Parameters: 8(Long)&lt;==    Columns: id, name, num, version&lt;==        Row: 8, 物品1, 100, 1&lt;==      Total: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@17b1f1c0]JDBC Connection [HikariProxyConnection@999750580 wrapping com.mysql.cj.jdbc.ConnectionImpl@4a1a256d] will not be managed by Spring==&gt;  Preparing: SELECT id,name,num,version FROM goods WHERE id=?2022-11-02 23:22:45.218  INFO 20540 --- [       Thread-2] c.a.l.m.MybatisplusLearnApplicationTests : Thread-2, 保存物品成功，goodsDO=GoodsDO(id=8, name=物品1, num=100, version=1)==&gt; Parameters: 8(Long)&lt;==    Columns: id, name, num, version&lt;==        Row: 8, 物品1, 100, 1&lt;==      Total: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@584e9813]2022-11-02 23:22:45.221  INFO 20540 --- [       Thread-3] c.a.l.m.MybatisplusLearnApplicationTests : Thread-3, 保存物品成功，goodsDO=GoodsDO(id=8, name=物品1, num=100, version=1)Creating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@50aa8c9b] was not registered for synchronization because synchronization is not activeJDBC Connection [HikariProxyConnection@908498390 wrapping com.mysql.cj.jdbc.ConnectionImpl@4a1a256d] will not be managed by Spring==&gt;  Preparing: UPDATE goods SET name=?, num=?, version=? WHERE id=?==&gt; Parameters: 物品1(String), 50(Long), 1(Integer), 8(Long)&lt;==    Updates: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@50aa8c9b]Creating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@432171d4] was not registered for synchronization because synchronization is not activeJDBC Connection [HikariProxyConnection@2006681630 wrapping com.mysql.cj.jdbc.ConnectionImpl@4a1a256d] will not be managed by Spring==&gt;  Preparing: UPDATE goods SET name=?, num=?, version=? WHERE id=?==&gt; Parameters: 物品1(String), 200(Long), 1(Integer), 8(Long)&lt;==    Updates: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@432171d4]Creating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@49433c98] was not registered for synchronization because synchronization is not activeJDBC Connection [HikariProxyConnection@190605872 wrapping com.mysql.cj.jdbc.ConnectionImpl@4a1a256d] will not be managed by Spring==&gt;  Preparing: SELECT id,name,num,version FROM goods WHERE id=?==&gt; Parameters: 8(Long)&lt;==    Columns: id, name, num, version&lt;==        Row: 8, 物品1, 200, 1&lt;==      Total: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@49433c98]2022-11-02 23:22:48.214  INFO 20540 --- [           main] c.a.l.m.MybatisplusLearnApplicationTests : 更新物品数量成功，goodsDO=GoodsDO(id=8, name=物品1, num=200, version=1)2022-11-02 23:22:48.214  INFO 20540 --- [           main] c.a.l.m.MybatisplusLearnApplicationTests : 测试乐观锁======end2022-11-02 23:22:48.231  INFO 20540 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown initiated...2022-11-02 23:22:48.237  INFO 20540 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown completed.进程已结束，退出代码为 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>执行结果发现，在模拟2个并发同时操作更新同一条数据时，两条SQL都执行成功了</li><li>更新sql为 <code>SELECT id,name,num,version FROM goods WHERE id=?</code></li><li>执行最终结果为200</li><li>更新后记录的version版本号为1</li></ul><h3 id="2-9-添加乐观锁配置"><a href="#2-9-添加乐观锁配置" class="headerlink" title="2.9 添加乐观锁配置"></a>2.9 添加乐观锁配置</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>domain</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span><span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token string">"goods"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GoodsDO</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    <span class="token comment">/**     *      */</span>    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">AUTO</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Long</span> num<span class="token punctuation">;</span>    <span class="token comment">// 开启乐观锁</span>    <span class="token annotation punctuation">@Version</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> version<span class="token punctuation">;</span>    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在version字段上添加了@Version注解，用于开启乐观锁</p><h3 id="2-10-有乐观锁的执行结果"><a href="#2-10-有乐观锁的执行结果" class="headerlink" title="2.10 有乐观锁的执行结果"></a>2.10 有乐观锁的执行结果</h3><pre class="line-numbers language-none"><code class="language-none">2022-11-02 23:45:44.194  INFO 7112 --- [           main] c.a.l.m.MybatisplusLearnApplicationTests : 测试乐观锁======startCreating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@7d70638] was not registered for synchronization because synchronization is not active2022-11-02 23:45:44.251  INFO 7112 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...2022-11-02 23:45:44.869  INFO 7112 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.JDBC Connection [HikariProxyConnection@1287215032 wrapping com.mysql.cj.jdbc.ConnectionImpl@3cdc7b09] will not be managed by Spring==&gt;  Preparing: INSERT INTO goods ( name, num ) VALUES ( ?, ? )==&gt; Parameters: 物品1(String), 100(Long)&lt;==    Updates: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@7d70638]Creating a new SqlSessionCreating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3d4881fa] was not registered for synchronization because synchronization is not activeSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@7af5595d] was not registered for synchronization because synchronization is not activeJDBC Connection [HikariProxyConnection@1796948188 wrapping com.mysql.cj.jdbc.ConnectionImpl@3cdc7b09] will not be managed by Spring==&gt;  Preparing: SELECT id,name,num,version FROM goods WHERE id=?==&gt; Parameters: 9(Long)&lt;==    Columns: id, name, num, version&lt;==        Row: 9, 物品1, 100, 1&lt;==      Total: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3d4881fa]JDBC Connection [HikariProxyConnection@82868218 wrapping com.mysql.cj.jdbc.ConnectionImpl@3cdc7b09] will not be managed by Spring==&gt;  Preparing: SELECT id,name,num,version FROM goods WHERE id=?2022-11-02 23:45:44.950  INFO 7112 --- [       Thread-2] c.a.l.m.MybatisplusLearnApplicationTests : Thread-2, 保存物品成功，goodsDO=GoodsDO(id=9, name=物品1, num=100, version=1)==&gt; Parameters: 9(Long)&lt;==    Columns: id, name, num, version&lt;==        Row: 9, 物品1, 100, 1&lt;==      Total: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@7af5595d]2022-11-02 23:45:44.952  INFO 7112 --- [       Thread-3] c.a.l.m.MybatisplusLearnApplicationTests : Thread-3, 保存物品成功，goodsDO=GoodsDO(id=9, name=物品1, num=100, version=1)Creating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@5a7240f4] was not registered for synchronization because synchronization is not activeJDBC Connection [HikariProxyConnection@1513447050 wrapping com.mysql.cj.jdbc.ConnectionImpl@3cdc7b09] will not be managed by Spring==&gt;  Preparing: UPDATE goods SET name=?, num=?, version=? WHERE id=? AND version=?==&gt; Parameters: 物品1(String), 50(Long), 2(Integer), 9(Long), 1(Integer)&lt;==    Updates: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@5a7240f4]Creating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@55205d07] was not registered for synchronization because synchronization is not activeJDBC Connection [HikariProxyConnection@829715892 wrapping com.mysql.cj.jdbc.ConnectionImpl@3cdc7b09] will not be managed by Spring==&gt;  Preparing: UPDATE goods SET name=?, num=?, version=? WHERE id=? AND version=?==&gt; Parameters: 物品1(String), 200(Long), 2(Integer), 9(Long), 1(Integer)&lt;==    Updates: 0Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@55205d07]Creating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3bfae028] was not registered for synchronization because synchronization is not activeJDBC Connection [HikariProxyConnection@393594087 wrapping com.mysql.cj.jdbc.ConnectionImpl@3cdc7b09] will not be managed by Spring==&gt;  Preparing: SELECT id,name,num,version FROM goods WHERE id=?==&gt; Parameters: 9(Long)&lt;==    Columns: id, name, num, version&lt;==        Row: 9, 物品1, 50, 2&lt;==      Total: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3bfae028]2022-11-02 23:45:47.946  INFO 7112 --- [           main] c.a.l.m.MybatisplusLearnApplicationTests : 更新物品数量成功，goodsDO=GoodsDO(id=9, name=物品1, num=50, version=2)2022-11-02 23:45:47.946  INFO 7112 --- [           main] c.a.l.m.MybatisplusLearnApplicationTests : 测试乐观锁======end2022-11-02 23:45:47.960  INFO 7112 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown initiated...2022-11-02 23:45:47.964  INFO 7112 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown completed.进程已结束，退出代码为 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>执行结果发现，在模拟2个并发同时操作更新同一条数据时，只有第一天更新50的成功了，更新200的SQL因为version不匹配更新失败</li><li>更新sql为 <code>UPDATE goods SET name=?, num=?, version=? WHERE id=? AND version=?</code></li><li>执行最终结果为50</li><li>更新后记录的version版本号为2</li></ul><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul><li>在更新的对象里version字段不能为NULL，必须要有值，不然不生效</li></ul>]]></content>
      
      
      <categories>
          
          <category> Mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ClickHouse-入门</title>
      <link href="/clickhouse/clickhouse-ru-men/"/>
      <url>/clickhouse/clickhouse-ru-men/</url>
      
        <content type="html"><![CDATA[<h2 id="行存储与列式存储"><a href="#行存储与列式存储" class="headerlink" title="行存储与列式存储"></a>行存储与列式存储</h2><ul><li>行存储<ul><li>传统的关系性数据库都是行存储</li><li>一行数据在存储介质中的连续的</li><li>适合随机增删改查操作</li><li>查询全部记录的某些字段时，需要查全量数据，查询效率低</li></ul></li><li>列式存储<ul><li>在存储数据时，存储介质中的数据以列的方式来组织的</li><li>存储完需要操作的所有记录的第一个字段后，再存储第二个字段，等等</li><li>查询只查询涉及到的字段，不需要全表扫描，可以减少磁盘io</li><li>列式存储在聚合统计方面性能更优</li><li>存储的列是同一种数据结构，数据压缩率更高，更省空间</li><li>更新数据成本高，一般只适合读多写少的场景</li></ul></li></ul><h2 id="ClickHouse简介"><a href="#ClickHouse简介" class="headerlink" title="ClickHouse简介"></a>ClickHouse简介</h2><p>俄罗斯Yandex在2016年开源，使用C++编写的列式存储数据库，近几年在OLAP领域大范围应用</p><p>官网：<a href="https://clickhouse.com/">https://clickhouse.com/</a></p><p>特点：</p><ul><li>不依赖Hadoop 生态、安装和维护简单</li><li>擅长对列的聚合、计数等统计操作性能强劲</li><li>对列存储和压缩的采用更好的算法，更好节省成本</li><li>拓展性强，在生产中经过实战测试，从单服务器部署到具有数千个节点的集群的线性水平可扩展性</li><li>具有企业级安全功能和故障安全机制，可防止数据因应用程序错误和人为错误而损坏</li><li>支持主流的大部分SQL语法和函数</li><li>吞吐能力强，官方测试支持，支持多种存储引擎，满足多数业务场景</li><li>广泛应用：互联网电商、在线教育、金融等领域，用户行为数据记录和分析，搭建数据可视化平台</li><li>需要Linux或者Mac OS系统</li></ul><h2 id="docker安装ClickHouse"><a href="#docker安装ClickHouse" class="headerlink" title="docker安装ClickHouse"></a>docker安装ClickHouse</h2><ul><li>启动脚本</li></ul><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker">docker run -d --name clickhouse --ulimit nofile=262144:262144 \-p 8123:8123 -p 9000:9000 -p 9009:9009 --privileged=true \-v /home/dockerdata/clickhouse/log:/var/log/clickhouse-server \-v /home/dockerdata/clickhouse/data:/var/lib/clickhouse clickhouse/clickhouse-server:22.2.3.5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>端口：<ul><li>8123：Http端口</li><li>9000：tcp端口</li><li>9009：同步端口</li></ul></li><li>可视化界面</li></ul><h2 id="数据库客户端"><a href="#数据库客户端" class="headerlink" title="数据库客户端"></a>数据库客户端</h2><p>可以使用DBeaver连接clickHouse，下载地址：<a href="https://dbeaver.io/download/">https://dbeaver.io/download/</a></p>]]></content>
      
      
      <categories>
          
          <category> ClickHouse </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ClickHouse </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SkyWalking-自定义插件</title>
      <link href="/skywalking/skywalking-zi-ding-yi-cha-jian/"/>
      <url>/skywalking/skywalking-zi-ding-yi-cha-jian/</url>
      
        <content type="html"><![CDATA[<p>当现有skywalking无法满足现有统计需求时，需要自定义统计维度，或者对自研中间件进行监控，可以通过添加skywalking的插件来实现无侵入的添加功能</p><p>执行步骤：</p><ul><li>创建一个自定义插件项目</li><li>pom文件继承apm-sdk-plugin</li><li>继承ClassInstanceMethodsEnhancePluginDefine，用于设置需要拦截的类</li><li>实现InstanceMethodsAroundInterceptor，用于对拦截的类进行额外功能扩展</li><li>添加skywalking-plugin.def，指定插件拦截类路径，skywalking启动时会加载该类</li><li>maven打包，并把打好的包放在agent\plugins目录下面</li><li>重启服务</li></ul><p><img src="/images/SkyWalking-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%92%E4%BB%B6/image-20221027172409170.png"></p><p>（1）maven依赖</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.skywalking<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>apm-sdk-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.5.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.aacopy.skywalking.plugin.plus<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>skywalking-plugin-plus<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>checkstyle.skip</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>checkstyle.skip</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（2）拦截类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>plus</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>description<span class="token punctuation">.</span>method<span class="token punctuation">.</span></span><span class="token class-name">MethodDescription</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span></span><span class="token class-name">ElementMatcher</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">ConstructorInterceptPoint</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">InstanceMethodsInterceptPoint</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span>enhance<span class="token punctuation">.</span></span><span class="token class-name">ClassInstanceMethodsEnhancePluginDefine</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>match<span class="token punctuation">.</span></span><span class="token class-name">ClassMatch</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>match<span class="token punctuation">.</span></span><span class="token class-name">PrefixMatch</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span></span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token static">nameStartsWith</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author iseven.yang * @date 2022/10/27 14:45 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountTestHandlerInstrumentation</span> <span class="token keyword">extends</span> <span class="token class-name">ClassInstanceMethodsEnhancePluginDefine</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">METHOD_INTERCEPTOR_CLASS</span> <span class="token operator">=</span> <span class="token string">"cn.aacopy.skywalking.plugin.plus.CountTestHandlerMethodInterceptor"</span><span class="token punctuation">;</span>        <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token class-name">ClassMatch</span> <span class="token function">enhanceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//需要对哪些类做增强</span>        <span class="token keyword">return</span> <span class="token class-name">PrefixMatch</span><span class="token punctuation">.</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"cn.aacopy.test.simpleboot"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">ConstructorInterceptPoint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getConstructorsInterceptPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConstructorInterceptPoint</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">InstanceMethodsInterceptPoint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getInstanceMethodsInterceptPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InstanceMethodsInterceptPoint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>                <span class="token keyword">new</span> <span class="token class-name">InstanceMethodsInterceptPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token class-name">ElementMatcher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodDescription</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMethodsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">return</span> <span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"fun"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMethodsInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">return</span> <span class="token constant">METHOD_INTERCEPTOR_CLASS</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isOverrideArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（3）拦截处理类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>plus</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ContextManager</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span>tag<span class="token punctuation">.</span></span><span class="token class-name">StringTag</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span>tag<span class="token punctuation">.</span></span><span class="token class-name">Tags</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span>trace<span class="token punctuation">.</span></span><span class="token class-name">AbstractSpan</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span>trace<span class="token punctuation">.</span></span><span class="token class-name">SpanLayer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span>enhance<span class="token punctuation">.</span></span><span class="token class-name">EnhancedInstance</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span>enhance<span class="token punctuation">.</span></span><span class="token class-name">InstanceMethodsAroundInterceptor</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>core<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span>enhance<span class="token punctuation">.</span></span><span class="token class-name">MethodInterceptResult</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>skywalking<span class="token punctuation">.</span>apm<span class="token punctuation">.</span>network<span class="token punctuation">.</span>trace<span class="token punctuation">.</span>component<span class="token punctuation">.</span></span><span class="token class-name">ComponentsDefine</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author iseven.yang * @date 2022/10/27 14:53 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountTestHandlerMethodInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">InstanceMethodsAroundInterceptor</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforeMethod</span><span class="token punctuation">(</span><span class="token class-name">EnhancedInstance</span> enhancedInstance<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> classes<span class="token punctuation">,</span> <span class="token class-name">MethodInterceptResult</span> methodInterceptResult<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            count<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            count<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">AbstractSpan</span> span <span class="token operator">=</span> <span class="token class-name">ContextManager</span><span class="token punctuation">.</span><span class="token function">createLocalSpan</span><span class="token punctuation">(</span><span class="token string">"CountTest:"</span><span class="token operator">+</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        span<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token class-name">ComponentsDefine</span><span class="token punctuation">.</span><span class="token constant">TOMCAT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        span<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringTag</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"params"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        span<span class="token punctuation">.</span><span class="token function">setLayer</span><span class="token punctuation">(</span><span class="token class-name">SpanLayer</span><span class="token punctuation">.</span><span class="token constant">CACHE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">afterMethod</span><span class="token punctuation">(</span><span class="token class-name">EnhancedInstance</span> enhancedInstance<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> classes<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"方法调用次数==========="</span> <span class="token operator">+</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">AbstractSpan</span> span <span class="token operator">=</span> <span class="token class-name">ContextManager</span><span class="token punctuation">.</span><span class="token function">activeSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Tags</span><span class="token punctuation">.</span><span class="token constant">STATUS_CODE</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ContextManager</span><span class="token punctuation">.</span><span class="token function">stopSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> o<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMethodException</span><span class="token punctuation">(</span><span class="token class-name">EnhancedInstance</span> enhancedInstance<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> classes<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">ContextManager</span><span class="token punctuation">.</span><span class="token function">activeSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（4）skywalking-plugin.def</p><pre class="line-numbers language-none"><code class="language-none">count-test-plugin=cn.aacopy.skywalking.plugin.plus.CountTestHandlerInstrumentation<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>随便写一个springboot工程,启动加入skywalkingagent包，访问接口</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>simpleboot<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author iseven.yang * @date 2022/10/27 11:16 */</span><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test1"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test1Haha</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hahaha"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token string">"hahah"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test2"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test2Haha</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hahaha2sssssssss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token string">"hihei"</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test3"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test3Haha1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hihei123123213"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token string">"hihei1232312322"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>访问效果：后台</p><p><img src="/images/SkyWalking-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%92%E4%BB%B6/image-20221027172706435.png"></p><p>skywalking控制台</p><p><img src="/images/SkyWalking-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%92%E4%BB%B6/image-20221027172805707.png"></p>]]></content>
      
      
      <categories>
          
          <category> SkyWalking </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SkyWalking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SkyWalking-JavaAgent</title>
      <link href="/skywalking/skywalking-javaagent/"/>
      <url>/skywalking/skywalking-javaagent/</url>
      
        <content type="html"><![CDATA[<h3 id="Skywalking实现"><a href="#Skywalking实现" class="headerlink" title="Skywalking实现"></a>Skywalking实现</h3><p>如果需要我们对每个方法的执行添加打印执行时间，一般可以通过AOP的方式来实现，对每个方法做环绕通知的切面，这种方式有一个问题就是，如果后续还有一些其他需求需要在方法执行前做统计，比如打印HTTPRequest中的请求地址，请求参数等信息，就需要重新编写aop，编译部署上线。</p><p>skywalking使用0侵入的方式来扩展Java程序的功能，具体实现就是使用了Java插桩技术。</p><h2 id="字节码插桩"><a href="#字节码插桩" class="headerlink" title="字节码插桩"></a>字节码插桩</h2><p>字节码插桩实际就是在代码运行期间对字节码进行修改，比如动态代理，或者java Agent</p><p>skywalking就是通过javaAgent实现的字节码增强，启动方式：</p><p>启动jar包时，需要添加额外的运行参数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">-</span>javaagent<span class="token operator">:</span><span class="token class-name">D</span><span class="token operator">:</span>\tool\apache<span class="token operator">-</span>skywalking<span class="token operator">-</span>apm<span class="token operator">-</span>bin<span class="token operator">-</span>es7\agent\skywalking<span class="token operator">-</span>agent<span class="token punctuation">.</span>jar <span class="token operator">-</span><span class="token class-name">Dskywalking</span><span class="token punctuation">.</span>agent<span class="token punctuation">.</span>service_name<span class="token operator">=</span>skywalking<span class="token operator">-</span>learn <span class="token operator">-</span><span class="token class-name">Dskywalking</span><span class="token punctuation">.</span>collector<span class="token punctuation">.</span>backend_service<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.80</span><span class="token number">.128</span><span class="token operator">:</span><span class="token number">11800</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>skywalking-agent.jar就是修改字节码的具体实现的包</p><h3 id="JavaAgent"><a href="#JavaAgent" class="headerlink" title="JavaAgent"></a>JavaAgent</h3><p>jdk1.5引入的新特性，在加载class前进行拦截，我们可以对拦截的class做一些修改操作，然后再加载这个class。</p><p>agent的启动方式</p><ul><li>静态启动<ul><li>使用-javaagent的方式，在应用启动时挂载agent</li><li>主方法入口：premain()</li><li>对字节码操作自由度高，只要符合字节码规范，JVM可以验证通过，可以对字节码做任何修改</li><li>SkyWalking</li></ul></li><li>动态附加<ul><li>在应用运行过程中通过attach API挂载Agent</li><li>主方法入口：agentmain()</li><li>对字节码操作自由度低，不能创建父类，接口，字段…</li><li>Arthas</li></ul></li></ul><p>javaAgent探针包要求在META-INF/MANIFEST.MF文件中，要有一个包含premain方法的入口类</p><p>public static void premain(String agentArgs, Instrumentation inst) </p><p>agentArgs：挂载agent是设置的参数</p><p>Instrumentation ：可以获取一些类信息</p><ul><li>addTransformer()/removeTransformer() ：注册/注销一个 ClassFileTransformer 类的实例，该 Transformer 会在类加载的时候被调用，可用于修改类定义（修改类的字节码）。</li><li>redefineClasses() ：重新定义传入已经加载的类。</li><li>getAllLoadedClasses()：返回 JVM 已加载的所有类。</li><li>getInitiatedClasses() ：返回 JVM 已经初始化的类。</li><li>getObjectSize()：获取参数指定的对象的大小。</li></ul><h3 id="字节码操作工具"><a href="#字节码操作工具" class="headerlink" title="字节码操作工具"></a>字节码操作工具</h3><p>JavaAgent就是一个插桩入口，主要是做代理拦截的，真正做字节码修改的，是有一套操作字节码的工具，目前主要有：</p><p>asm，javassist，bytebuddy</p><ul><li>asm<ul><li>支持任意字节码插入，功能强大，比较偏底层，学习难度大</li></ul></li><li>javassist<ul><li>java原始语法，支持jdk1.5的语法，后面的一些其他语法比如泛型等不支持</li></ul></li><li>bytebuddy<ul><li>基于asm实现，通过一些API操作class，支持java任意版本，性能比javassist高</li><li>skywalking就是使用bytebuddy来实现的修改字节码</li></ul></li></ul><h2 id="bytebuddy"><a href="#bytebuddy" class="headerlink" title="bytebuddy"></a>bytebuddy</h2><p>定义一个最简单的探针包主要分为如下几个步骤</p><ul><li>创建一个探针maven项目</li><li>编写探针入口类：public static void premain(String agentArgs, Instrumentation inst)</li><li>编写拦截配置，需要拦截哪些类，可以根据全类名前缀，后缀，标记的注解等等</li><li>编写拦截后的处理类</li><li>处理类的方法参数中可以获取当前执行类的method，参数，调用类，父类对象等等</li><li>在方法中编写需要增强的代码</li><li>使用maven插件，生成MANIFEST.MF文件，打包</li></ul><p>DEMO实例：</p><p><img src="/images/SkyWalking-JavaAgent/image-20221027134214704.png"></p><p>（1）引入maven依赖</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.aacopy.learn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>agent-learn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.bytebuddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>byte-buddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.12.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-assembly-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>archive</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!--自动添加META-INF/MANIFEST.MF --&gt;</span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span><span class="token punctuation">&gt;</span></span>                            <span class="token comment">&lt;!-- 添加 mplementation-*和Specification-*配置项--&gt;</span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>addDefaultImplementationEntries</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>addDefaultImplementationEntries</span><span class="token punctuation">&gt;</span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>addDefaultSpecificationEntries</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>addDefaultSpecificationEntries</span><span class="token punctuation">&gt;</span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifestEntries</span><span class="token punctuation">&gt;</span></span>                            <span class="token comment">&lt;!--指定premain方法所在的类--&gt;</span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Premain-Class</span><span class="token punctuation">&gt;</span></span>cn.aacopy.learn.agent.AgentMainTest<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Premain-Class</span><span class="token punctuation">&gt;</span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Can-Redefine-Classes</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Can-Redefine-Classes</span><span class="token punctuation">&gt;</span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Can-Retransform-Classes</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Can-Retransform-Classes</span><span class="token punctuation">&gt;</span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifestEntries</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>archive</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>make-assembly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>single<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（2）创建探针入口premain方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>agent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>builder<span class="token punctuation">.</span></span><span class="token class-name">AgentBuilder</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span></span><span class="token class-name">MethodDelegation</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span></span><span class="token class-name">ElementMatchers</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>instrument<span class="token punctuation">.</span></span><span class="token class-name">Instrumentation</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author iseven.yang * @date 2022/10/27 9:07 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentMainTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行agent拦截，参数："</span> <span class="token operator">+</span> agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//使用bytebuddy的AgentBuilder构建Agent</span>        <span class="token class-name">AgentBuilder<span class="token punctuation">.</span>Identified<span class="token punctuation">.</span>Extendable</span> agentBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AgentBuilder</span>                <span class="token comment">//使用默认agent实例</span>                <span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">//拦截配置方式设置</span>                <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span>agentArgs<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment">//拦截到的class的处理方式</span>                <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> typeDescription<span class="token punctuation">,</span> classLoader<span class="token punctuation">,</span> javaModule<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>                        <span class="token comment">// 设置拦截规则，哪些方法会被拦截</span>                        builder<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">nameEndsWith</span><span class="token punctuation">(</span><span class="token string">"Haha"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                <span class="token comment">// 拦截后交给 SpringControllerInterceptor 处理</span>                                <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">MethodDelegation</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">TimeInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 装载到 instrumentation 上</span>        agentBuilder<span class="token punctuation">.</span><span class="token function">installOn</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（3）编写一个拦截后的方法处理类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>agent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">AllArguments</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Origin</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RuntimeType</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">SuperCall</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Callable</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author iseven.yang * @date 2022/10/27 10:56 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeInterceptor</span> <span class="token punctuation">{</span>    <span class="token comment">//@RuntimeType：不进行严格的参数类型检测，在参数匹配失败时，尝试使用类型转换方式（runtime type casting）进行类型转换，匹配相应方法。</span>    <span class="token comment">//@Origin：注入正在执行的方法Method 对象</span>    <span class="token comment">//@AllArguments：获取入参列表</span>    <span class="token comment">//@SuperCall:方法的调用者对象,可以用于对原始方法的调用</span>    <span class="token annotation punctuation">@RuntimeType</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Origin</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span>                                   <span class="token annotation punctuation">@AllArguments</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span>                                   <span class="token annotation punctuation">@SuperCall</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> l1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 执行原函数</span>        <span class="token class-name">Object</span> result <span class="token operator">=</span> callable<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":执行耗时"</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> l1<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"参数列表："</span><span class="token operator">+</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"返回类型："</span><span class="token operator">+</span>method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"返回值："</span><span class="token operator">+</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（4）随便写一个应用程序</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>simpleboot<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author iseven.yang * @date 2022/10/27 11:16 */</span><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test1"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test1Haha</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hahaha"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token string">"hahah"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test2"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test2Haha</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hahaha2sssssssss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token string">"hihei"</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test3"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test3Haha1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hihei123123213"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token string">"hihei1232312322"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（5）修改启动jvm配置：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">-</span>javaagent<span class="token operator">:</span><span class="token class-name">D</span><span class="token operator">:</span>\code\mine\agent<span class="token operator">-</span>learn\target\agent<span class="token operator">-</span>learn<span class="token operator">-</span><span class="token number">1.0</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">-</span>jar<span class="token operator">-</span><span class="token keyword">with</span><span class="token operator">-</span>dependencies<span class="token punctuation">.</span>jar<span class="token operator">=</span>cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>simpleboot<span class="token punctuation">.</span>controller<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（6）启动服务，调用接口</p><p>启动服务前会打印日志</p><pre class="line-numbers language-none"><code class="language-none">执行agent拦截，参数：cn.aacopy.test.simpleboot.controller<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>调用接口</p><pre class="line-numbers language-none"><code class="language-none">hihei123123213hahahatest1Haha:执行耗时100ms参数列表：[]返回类型：class java.lang.String返回值：hahahhahaha2ssssssssstest2Haha:执行耗时306ms参数列表：[wwwww]返回类型：class java.lang.String返回值：hiheiwwwww<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Skywalking的插桩实现，静态方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClassEnhancePluginDefine</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractClassEnhancePluginDefine</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * Enhance a class to intercept class static methods.     *     * @param typeDescription target class description     * @param newClassBuilder byte-buddy's builder to manipulate class bytecode.     * @return new byte-buddy's builder for further manipulation.     */</span>    <span class="token keyword">protected</span> <span class="token class-name">DynamicType<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">enhanceClass</span><span class="token punctuation">(</span><span class="token class-name">TypeDescription</span> typeDescription<span class="token punctuation">,</span> <span class="token class-name">DynamicType<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> newClassBuilder<span class="token punctuation">,</span>        <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">PluginException</span> <span class="token punctuation">{</span>        <span class="token class-name">StaticMethodsInterceptPoint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> staticMethodsInterceptPoints <span class="token operator">=</span> <span class="token function">getStaticMethodsInterceptPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> enhanceOriginClassName <span class="token operator">=</span> typeDescription<span class="token punctuation">.</span><span class="token function">getTypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>staticMethodsInterceptPoints <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> staticMethodsInterceptPoints<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> newClassBuilder<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StaticMethodsInterceptPoint</span> staticMethodsInterceptPoint <span class="token operator">:</span> staticMethodsInterceptPoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> interceptor <span class="token operator">=</span> staticMethodsInterceptPoint<span class="token punctuation">.</span><span class="token function">getMethodsInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EnhanceException</span><span class="token punctuation">(</span><span class="token string">"no StaticMethodsAroundInterceptor define to enhance class "</span> <span class="token operator">+</span> enhanceOriginClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>staticMethodsInterceptPoint<span class="token punctuation">.</span><span class="token function">isOverrideArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBootstrapInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    newClassBuilder <span class="token operator">=</span> newClassBuilder<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>staticMethodsInterceptPoint<span class="token punctuation">.</span><span class="token function">getMethodsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                                     <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">MethodDelegation</span><span class="token punctuation">.</span><span class="token function">withDefaultConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                                                                <span class="token punctuation">.</span><span class="token function">withBinders</span><span class="token punctuation">(</span><span class="token class-name">Morph<span class="token punctuation">.</span>Binder</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token class-name">OverrideCallable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                                                                <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">BootstrapInstrumentBoost</span><span class="token punctuation">.</span><span class="token function">forInternalDelegateClass</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    newClassBuilder <span class="token operator">=</span> newClassBuilder<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>staticMethodsInterceptPoint<span class="token punctuation">.</span><span class="token function">getMethodsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                                     <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">MethodDelegation</span><span class="token punctuation">.</span><span class="token function">withDefaultConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                                                                <span class="token punctuation">.</span><span class="token function">withBinders</span><span class="token punctuation">(</span><span class="token class-name">Morph<span class="token punctuation">.</span>Binder</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token class-name">OverrideCallable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                                                                <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StaticMethodsInterWithOverrideArgs</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBootstrapInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    newClassBuilder <span class="token operator">=</span> newClassBuilder<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>staticMethodsInterceptPoint<span class="token punctuation">.</span><span class="token function">getMethodsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                                     <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">MethodDelegation</span><span class="token punctuation">.</span><span class="token function">withDefaultConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                                                                <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">BootstrapInstrumentBoost</span><span class="token punctuation">.</span><span class="token function">forInternalDelegateClass</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    newClassBuilder <span class="token operator">=</span> newClassBuilder<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>staticMethodsInterceptPoint<span class="token punctuation">.</span><span class="token function">getMethodsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                                     <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">MethodDelegation</span><span class="token punctuation">.</span><span class="token function">withDefaultConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                                                                <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StaticMethodsInter</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> newClassBuilder<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（增强类）</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StaticMethodsInter</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ILog</span> <span class="token constant">LOGGER</span> <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">StaticMethodsInter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * A class full name, and instanceof {@link StaticMethodsAroundInterceptor} This name should only stay in {@link     * String}, the real {@link Class} type will trigger classloader failure. If you want to know more, please check on     * books about Classloader or Classloader appointment mechanism.     */</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> staticMethodsAroundInterceptorClassName<span class="token punctuation">;</span>    <span class="token comment">/**     * Set the name of {@link StaticMethodsInter#staticMethodsAroundInterceptorClassName}     *     * @param staticMethodsAroundInterceptorClassName class full name.     */</span>    <span class="token keyword">public</span> <span class="token class-name">StaticMethodsInter</span><span class="token punctuation">(</span><span class="token class-name">String</span> staticMethodsAroundInterceptorClassName<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>staticMethodsAroundInterceptorClassName <span class="token operator">=</span> staticMethodsAroundInterceptorClassName<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * Intercept the target static method.     *     * @param clazz        target class 要修改字节码的目标类     * @param allArguments all method arguments 原方法所有的入参     * @param method       method description. 原方法     * @param zuper        the origin call ref. 原方法的调用 zuper.call()代表调用原方法     * @return the return value of target static method.     * @throws Exception only throw exception because of zuper.call() or unexpected exception in sky-walking ( This is a     *                   bug, if anything triggers this condition ).     */</span>    <span class="token annotation punctuation">@RuntimeType</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Origin</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token annotation punctuation">@AllArguments</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> allArguments<span class="token punctuation">,</span> <span class="token annotation punctuation">@Origin</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span>        <span class="token annotation punctuation">@SuperCall</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> zuper<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>        <span class="token class-name">StaticMethodsAroundInterceptor</span> interceptor <span class="token operator">=</span> <span class="token class-name">InterceptorInstanceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>staticMethodsAroundInterceptorClassName<span class="token punctuation">,</span> clazz            <span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">MethodInterceptResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodInterceptResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            interceptor<span class="token punctuation">.</span><span class="token function">beforeMethod</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> method<span class="token punctuation">,</span> allArguments<span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"class[{}] before static method[{}] intercept failure"</span><span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Object</span> ret <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">isContinue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                ret <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">_ret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment">//调用原方法</span>                ret <span class="token operator">=</span> zuper<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                interceptor<span class="token punctuation">.</span><span class="token function">handleMethodException</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> method<span class="token punctuation">,</span> allArguments<span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t2<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>t2<span class="token punctuation">,</span> <span class="token string">"class[{}] handle static method[{}] exception failure"</span><span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t2<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">throw</span> t<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                ret <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">afterMethod</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> method<span class="token punctuation">,</span> allArguments<span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"class[{}] after static method[{}] intercept failure:{}"</span><span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> SkyWalking </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SkyWalking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring-Event</title>
      <link href="/spring/spring-event/"/>
      <url>/spring/spring-event/</url>
      
        <content type="html"><![CDATA[<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><h3 id="定义事件"><a href="#定义事件" class="headerlink" title="定义事件"></a>定义事件</h3><p>定义事件可以是一个简单的POJO对象</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token annotation punctuation">@Builder</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AacopyTestEvent</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="编写监听事件处理类"><a href="#编写监听事件处理类" class="headerlink" title="编写监听事件处理类"></a>编写监听事件处理类</h3><p>监听事件需要</p><ul><li>在处理方法上添加<code>@EventListener</code>注解，</li><li>在方法入参里加上对应的事件对象</li><li>将方法所在类加入到spring容器</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AacopyTestEventListener</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@EventListener</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleAacopyTestEvent</span><span class="token punctuation">(</span><span class="token class-name">AacopyTestEvent</span> aacopyTestEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到事件..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>aacopyTestEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="编写发布事件测试类"><a href="#编写发布事件测试类" class="headerlink" title="编写发布事件测试类"></a>编写发布事件测试类</h3><p>发布事件需要用<code>ApplicationEventPublisher</code>对象，或者<code>ApplicationContext</code>,ApplicationContext继承了ApplicationEventPublisher</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventPublisherTest</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">ApplicationEventPublisher</span> applicationEventPublisher<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">testPublish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送事件..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        applicationEventPublisher<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token class-name">AacopyTestEvent</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"aacopy"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"aacopy.cn"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>执行结果</li></ul><pre class="line-numbers language-none"><code class="language-none">发送事件...接收到事件...AacopyTestEvent(name=aacopy, description=aacopy.cn)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="异步执行事件"><a href="#异步执行事件" class="headerlink" title="异步执行事件"></a>异步执行事件</h2><p>发布事件和监听事件默认情况下是同步执行的，如果需要异步执行，只需要在监听方法上添加@Async</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring-EL</title>
      <link href="/spring/spring-el/"/>
      <url>/spring/spring-el/</url>
      
        <content type="html"><![CDATA[<h2 id="SpringEL实现规则表达式判断"><a href="#SpringEL实现规则表达式判断" class="headerlink" title="SpringEL实现规则表达式判断"></a>SpringEL实现规则表达式判断</h2><p>Spring 表达式语言（简称“SpEL”）是一种强大的表达式语言</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span><span class="token string">"'1 + 1 = ' + (1 + 1)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> message <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1 + 1 = 2</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="项目中动态计算表达式值的过程"><a href="#项目中动态计算表达式值的过程" class="headerlink" title="项目中动态计算表达式值的过程"></a>项目中动态计算表达式值的过程</h2><ul><li><p>从页面上配置表单式，左值选择表单中的属性或者接口返回对象属性，中间选择比较符号，右值选择枚举或者输入字符串</p><p><img src="/images/Spring-EL/image-20220705110312380.png"></p></li><li><p>使用时，生成完整表达式，并获取计算表达式需要的所有的数据</p><pre class="line-numbers language-none"><code class="language-none">(#fun1([formModules][MD_OC], "[status]=='1'") &amp;&amp; [formModules][MD_PROJECT][projectStatusId]=='13123b02-74a6-4ec4-8978-77ec446d4e29') || (#fun1([formModules][MD_OC], "[status]=='1'") &amp;&amp; [formModules][MD_PROJECT][projectStatusId]=='3619a136-7988-440a-84d1-ccf8a7e2cb06')<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/images/Spring-EL/image-20220705110836953.png"></p></li><li><p>通过SpringEL模板引擎计算结果</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 根据表达式和资源数据，计算表达式的值 * @param express * @param sourceData * @return */</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doCompute</span><span class="token punctuation">(</span><span class="token class-name">String</span> express<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> sourceData<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">EvaluationContext</span> evaluationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span>sourceData<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token class-name">Method</span> fun1Method <span class="token operator">=</span> <span class="token class-name">RuleComponent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"fun1"</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        evaluationContext<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token string">"fun1"</span><span class="token punctuation">,</span> fun1Method<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token class-name">Object</span> value <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>express<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>evaluationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> value<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"计算表达式值出错：{}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>引用的方法主要处理一些内置表达式无法完成的规则计算，这里是为了计算接口返回的集合中的每一条数据是否都满足条件</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> arr<span class="token punctuation">,</span> <span class="token class-name">String</span> exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Expression</span> expression <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> jsonNode <span class="token operator">:</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> param <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">convertValue</span><span class="token punctuation">(</span>jsonNode<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">EvaluationContext</span> evaluationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Boolean</span> value <span class="token operator">=</span> expression<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>evaluationContext<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="SpEL支持的功能"><a href="#SpEL支持的功能" class="headerlink" title="SpEL支持的功能"></a>SpEL支持的功能</h2><h3 id="从对象，集合，Map中获取数据"><a href="#从对象，集合，Map中获取数据" class="headerlink" title="从对象，集合，Map中获取数据"></a>从对象，集合，Map中获取数据</h3><ul><li><p>从对象获取数据</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">EvaluationContext</span> evaluationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span><span class="token string">"#root.name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> message <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>evaluationContext<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//张三</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>从集合获取数据</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"王五"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">EvaluationContext</span> evaluationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span><span class="token string">"#root[2].name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> message <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>evaluationContext<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//王五</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>从Map获取对象</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> detail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    detail<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"address"</span><span class="token punctuation">,</span> <span class="token string">"合肥"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"detail"</span><span class="token punctuation">,</span> detail<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token class-name">EvaluationContext</span> evaluationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> express <span class="token operator">=</span> <span class="token string">"'姓名：' + [name] + '，年龄：' + [age] + '，地址：' + [detail][address]"</span><span class="token punctuation">;</span>    <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>express<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> message <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>evaluationContext<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//姓名：张三，年龄：18，地址：合肥</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="判空处理"><a href="#判空处理" class="headerlink" title="判空处理"></a>判空处理</h3><ul><li><p>Map的判空操作</p><ul><li><p>如果在StandardEvaluationContext中设置的对象是一个map，在判空获取值时，不能使用[xxx]这种方式，需要使用get方式</p></li><li><p>例如：从approve中获取summary参数值，approve有可能为null，summary也有可能为空</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token char">'摘要：'</span><span class="token operator">+</span><span class="token punctuation">(</span>#root<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>'approve'<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>'summary<span class="token char">')?:'</span>'<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul></li></ul><h3 id="计算符号"><a href="#计算符号" class="headerlink" title="计算符号"></a>计算符号</h3><ul><li><p>支持基本的运算符，括号内和符号是等价的</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">lt</span><span class="token punctuation">(</span> <span class="token operator">&lt;</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">gt</span><span class="token punctuation">(</span> <span class="token operator">&gt;</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">le</span><span class="token punctuation">(</span> <span class="token operator">&lt;=</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ge</span><span class="token punctuation">(</span> <span class="token operator">&gt;=</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">eq</span><span class="token punctuation">(</span> <span class="token operator">==</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ne</span><span class="token punctuation">(</span> <span class="token operator">!=</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">div</span><span class="token punctuation">(</span> <span class="token operator">/</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mod</span><span class="token punctuation">(</span> <span class="token operator">%</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">not</span><span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">)</span><span class="token function">and</span><span class="token punctuation">(</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">or</span><span class="token punctuation">(</span> <span class="token operator">||</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">not</span><span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">%</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token keyword">instanceof</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span><span class="token string">"'xyz' instanceof T(Integer)"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>matchesparser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span><span class="token string">"'5.00' matches '^-?\\d+(\\.\\d{2})?$'"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h3><p>可以调用java的方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span><span class="token string">"'abc'.substring(1, 3)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> message <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//bc</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h3><p>当基本的运算符和方法无法满足表达式计算时，可以自定义函数，在表达式中调用自定义函数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ELExpress</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">EvaluationContext</span> evaluationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">Method</span> funMethod <span class="token operator">=</span> <span class="token class-name">ELExpress</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"check"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            evaluationContext<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token string">"check"</span><span class="token punctuation">,</span> funMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Expression</span> exp <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span><span class="token string">"#check(#root.name)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Boolean</span> message <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>evaluationContext<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"处理复杂逻辑..."</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//处理复杂逻辑...张三</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>语法可以参考官方文档：<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#expressions-language-ref">https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#expressions-language-ref</a></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring-AOP</title>
      <link href="/spring/spring-aop/"/>
      <url>/spring/spring-aop/</url>
      
        <content type="html"><![CDATA[<p>AOP面向切面编程</p><p>切面的逻辑和业务逻辑进行隔离，降低耦合度，提高代码可重用性</p><h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>AOP通过动态代理来实现，分为两种代理方式，（1）JDK动态代理，（2）CGLIB动态代理</p><h3 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h3><p>有接口通过JDK动态代理，通过实现接口来创建代理对象</p><h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><ul><li><p>定义一个接口</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span>    <span class="token class-name">Integer</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Boolean</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>创建实现类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行add方法："</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行删除方法："</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>创建代理类并执行</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">TestService</span> testService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">TestService</span> testServiceProxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TestService</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">JdkProxyTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">TestService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args1<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"方法执行前执行："</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Object</span> result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>testService<span class="token punctuation">,</span> args1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"方法执行后执行："</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    testServiceProxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"---------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    testServiceProxy<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>通过Proxy.newProxyInstance来创建代理类，第一个参数为类加载器，第二个参数为需要代理的接口，第三个参数为代理方法，需要自己实现InvocationHandler接口。</li></ul></li><li><p>执行结果</p><pre class="line-numbers language-none"><code class="language-none">方法执行前执行：add执行add方法：hello方法执行后执行：1---------------------------方法执行前执行：delete执行删除方法：world方法执行后执行：true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="CGLIB动态代理"><a href="#CGLIB动态代理" class="headerlink" title="CGLIB动态代理"></a>CGLIB动态代理</h3><p>没有接口时，需要使用CGLIB动态代理，通过创建被代理类的子类作为代理对象</p><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><ul><li><p>连接点</p><ul><li>可以被增强的方法</li></ul></li><li><p>切入点</p><ul><li>实际被增强的方法</li></ul></li><li><p>通知</p><ul><li>增强的逻辑就是通知</li><li>通知的类型<ul><li>前置通知</li><li>后置通知，正常执行完通知</li><li>异常通知</li><li>环绕通知</li><li>方法执行完的最终通知，不管有没有异常</li></ul></li></ul></li><li><p>切面</p><ul><li>把通知应用到切入点的动作叫切面</li></ul></li></ul><h2 id="切面表达式"><a href="#切面表达式" class="headerlink" title="切面表达式"></a>切面表达式</h2><p>表达式模板：<code>execution([权限修饰符][返回值][全类名].[方法名]([参数]))</code></p><p>例如：<code>execution(public void cn.aacopy.learn.spring.aop.UserService.add())</code></p><ul><li>通配符可以用*表示</li><li>修饰符可以省略</li><li>方法参数可以用<code>..</code>表示</li></ul><h2 id="demo-1"><a href="#demo-1" class="headerlink" title="demo"></a>demo</h2><ul><li>引入依赖</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.3.22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-aspects<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.3.22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>启用aop注解</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"cn.aacopy"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConfig</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>编写业务类</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行add方法"</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token string">" @aacopy"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>编写切面类</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Aspect</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AopTest</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"execution(public String cn.aacopy.learn.spring.aop.UserService.add(..))"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"前置通知执行..."</span> <span class="token operator">+</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"execution(* cn.aacopy.learn.spring.aop.UserService.*(..))"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> proceedingJoinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"环绕通知前..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Object</span> result <span class="token operator">=</span> proceedingJoinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"环绕通知后..."</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span><span class="token string">"execution(* cn.aacopy.learn.spring.aop.UserService.*(..))"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterReturning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"后置通知执行..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@After</span><span class="token punctuation">(</span><span class="token string">"execution(* cn.aacopy.learn.spring.aop.UserService.*(..))"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"最终通知执行..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span><span class="token string">"execution(* cn.aacopy.learn.spring.aop.UserService.*(..))"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterThrowing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"异常通知执行..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>执行代码</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">MyConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">UserService</span> userService <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    userService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="提取公共模板"><a href="#提取公共模板" class="headerlink" title="提取公共模板"></a>提取公共模板</h3><ul><li>编写一个方法，上面使用@Pointcut注解，其他方法直接使用方法名即可，方便统一管理</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Aspect</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AopTest</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(* cn.aacopy.learn.spring.aop.UserService.*(..))"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pointCutTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"execution(public String cn.aacopy.learn.spring.aop.UserService.add(..))"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"前置通知执行..."</span> <span class="token operator">+</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"pointCutTemplate()"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> proceedingJoinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"环绕通知前..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Object</span> result <span class="token operator">=</span> proceedingJoinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"环绕通知后..."</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span><span class="token string">"pointCutTemplate()"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterReturning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"后置通知执行..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@After</span><span class="token punctuation">(</span><span class="token string">"execution(* cn.aacopy.learn.spring.aop.UserService.*(..))"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"最终通知执行..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span><span class="token string">"execution(* cn.aacopy.learn.spring.aop.UserService.*(..))"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@Async</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterThrowing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"异常通知执行..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>如果需要异步执行，只需要在启动类上开启异步@EnableAsync，并在方法上添加@Async注解</li></ul><h2 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h2><p>多个AOP切面，设置优先级，可以在切面类上添加@Order注解，值小的，优先执行</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Aspect</span><span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AopTest</span> <span class="token punctuation">{</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="通过注解方式实现切面"><a href="#通过注解方式实现切面" class="headerlink" title="通过注解方式实现切面"></a>通过注解方式实现切面</h2><ul><li>定义注解</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">RefreshCache</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>添加注解到需要执行切面的方法上</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RefreshCache</span><span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RoleVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">RoleAddDto</span> roleAddDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>roleService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>roleAddDto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>切面逻辑</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Aspect</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RefreshCacheAspect</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@Resource</span><span class="token keyword">private</span> <span class="token class-name">ResourceCacheService</span> resourceCacheService<span class="token punctuation">;</span><span class="token comment">/** * 方法成功返回后执行刷新缓存 */</span><span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span><span class="token string">"@annotation(com.xxx.cache.RefreshCache)"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Async</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refreshCache</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}执行完成，开始异步刷新缓存..."</span><span class="token punctuation">,</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> l1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resourceCacheService<span class="token punctuation">.</span><span class="token function">doCacheAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> l2 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"异步刷新Resource缓存成功，耗时:{}ms"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>l2<span class="token operator">-</span>l1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring-IOC</title>
      <link href="/spring/spring-ioc/"/>
      <url>/spring/spring-ioc/</url>
      
        <content type="html"><![CDATA[<p>IOC：控制反转，将创建对象的操作交给Spring处理，要使用某个对象，只需要从Spring容器中获取，主要目的是为了降低耦合</p><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><ul><li><p>创建一个maven项目</p></li><li><p>在pom文件中引入spring的依赖spring-context，context依赖了spring的4大核心包，spring-core，spring-beans，spring-core，spring-expression</p></li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.3.22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/Spring-IOC/image-20220909001243096.png"></p><ul><li>编写一个类Hello</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>spring</span><span class="token punctuation">;</span><span class="token comment">/** * @author cmyang * @date 2022/9/9 0:14 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>编写一个配置bean的XML文件bean.xml放在classpath路径下</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hello<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cn.aacopy.learn.spring.Hello<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在main方法中获取hello对象，并调用hello方法</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"bean.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Hello</span> hello <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Hello</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    hello<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/Spring-IOC/image-20220909002548209.png"></p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>通过xml解析，工厂模式，反射来实现</p><p>A类中引用B类的对象，最原始的方式是在A类中new一个B类的对象进行使用，这样B发生改变可能会影响到A类，为了降低耦合度，可以创建一个获取B对象的工厂类，A类需要B类对象时，只需要从工厂类中获取，这样就不需要关系B类是怎么创建的，降低了耦合度。在工厂类中，需要创建类的对象，可以统一通过从配置文件中获取全类名称和初始化参数，通过反射的方式来创建类，避免硬编码，所有需要通过工厂来创建的类，统一写在配置文件中</p><ul><li><p>获取IOC容器的两种方式</p><ul><li><p>BeanFactory和ApplicationContext</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">BeanFactory</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"bean.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        ApplicationContext applicationContext = new ClassPathXmlApplicationContext("bean.xml");</span>        <span class="token class-name">Hello</span> hello <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Hello</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hello<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>BeanFactory是IOC容器的基础实现，一般在spring内部使用，在加载配置文件的时候不会立即创建对象，在获取的bean对象的时候创建</p></li><li><p>ApplicationContext是BeanFactory的子接口，提供了更多的功能，在加载配置文件的时候，会立即创建对象</p></li><li><p>继承关系</p></li></ul><p><img src="/images/Spring-IOC/image-20220909003510084.png"></p></li></ul><p>Bean管理：（1）创建对象，（2）注入属性</p><p>Bean管理的两种方式：（1）基于XML，（2）基于注解</p><h2 id="管理Bean"><a href="#管理Bean" class="headerlink" title="管理Bean"></a>管理Bean</h2><h3 id="基于XML方式"><a href="#基于XML方式" class="headerlink" title="基于XML方式"></a>基于XML方式</h3><p><code>&lt;bean id="hello" class="cn.aacopy.learn.spring.Hello"&gt;&lt;/bean&gt;</code></p><ul><li>id：bean的唯一标识</li><li>class：类全路径</li></ul><h4 id="创建对象"><a href="#创建对象" class="headerlink" title="创建对象"></a>创建对象</h4><p>spring创建对象时，默认调用类的无参构造器进行创建</p><h4 id="注入属性"><a href="#注入属性" class="headerlink" title="注入属性"></a>注入属性</h4><p>注入属性有两种方式，（1）通过调用set方法，（2）通过有参构造器</p><ul><li><p>set方式注入</p><ul><li>创建一个User对象，包含name，age两个属性</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>spring</span><span class="token punctuation">;</span><span class="token comment">/** * @author cmyang * @date 2022/9/9 22:17 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"User{"</span> <span class="token operator">+</span>                <span class="token string">"name='"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>                <span class="token string">", age="</span> <span class="token operator">+</span> age <span class="token operator">+</span>                <span class="token char">'}'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在bean的xml配置文件中配置User，通过property配置，spring可以通过name找到对应的属性，并将value的值赋给属性</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cn.aacopy.learn.spring.User<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>小七<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>18<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>编写测试类</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"bean.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">User</span> user <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//User{name='小七', age=18}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>有参构造器</p><ul><li>在上面的User类中添加全参和无参构造器</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Integer</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在bean的xml配置文件中通过constructor-arg指定构造器的参数</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cn.aacopy.learn.spring.User<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>小七<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>constructor-arg</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>18<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>constructor-arg</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="特殊值的注入"><a href="#特殊值的注入" class="headerlink" title="特殊值的注入"></a>特殊值的注入</h4><ul><li><p>在XML的配置中，如果要设置对应的值为null，可以使用<code>&lt;null/&gt;</code>，例如：<code>&lt;constructor-arg name="name"&gt;&lt;null/&gt;&lt;/constructor-arg&gt;</code></p></li><li><p>如果配置的值有特殊符号，可以通过<code>&lt;![CDATA[]]&gt;</code>包裹</p></li><li><p>如果需要引用其他bean，需要使用ref属性，例如：<code>&lt;property name="hello" ref="hello"&gt;&lt;/property&gt;</code></p></li><li><p>注入数组</p></li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>arr<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>array</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>aa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>bb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>array</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>注入list</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>aa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>bb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>注入map</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>map<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>map</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aa<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AA<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bb<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BB<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>map</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="基于注解的方式"><a href="#基于注解的方式" class="headerlink" title="基于注解的方式"></a>基于注解的方式</h3><h4 id="创建对象-1"><a href="#创建对象-1" class="headerlink" title="创建对象"></a>创建对象</h4><p>添加context命名空间</p><p>在bean.xml中开启注解扫描，base-package配置扫描的路径</p><p><code>&lt;context:component-scan base-package="cn.aacopy"&gt;&lt;/context:component-scan&gt;</code></p><p>使用：@Component，@Controller，@Service，@Repository等注解标识为spring容器的bean</p><ul><li>只扫描固定的注解下的类</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cn.aacopy<span class="token punctuation">"</span></span> <span class="token attr-name">use-default-filters</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>include-filter</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>annotation<span class="token punctuation">"</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.stereotype.Controller<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>component-scan</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>排除注解下的类</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cn.aacopy<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>exclude-filter</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>annotation<span class="token punctuation">"</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.stereotype.Controller<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>component-scan</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="属性注入"><a href="#属性注入" class="headerlink" title="属性注入"></a>属性注入</h4><ul><li>@Autowired<ul><li>根据类型进行装配</li><li>如果同一个类型有多个实现类的bean，需要使用@Qualifier指定需要注入的bean名称</li></ul></li><li>@Resource<ul><li>根据名称进行装配 （参数name指定bean的名称）</li><li>也可以根据类型装配</li></ul></li><li>@Value<ul><li>注入普通类型的值</li></ul></li></ul><h4 id="通过注解方式"><a href="#通过注解方式" class="headerlink" title="通过注解方式"></a>通过注解方式</h4><ul><li>编写一个配置类来代替bean.xml配置</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"cn.aacopy"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConfig</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>获取容器的方式改为注解方式</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">MyConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Hello</span> hello <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Hello</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    hello<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Bean类型"><a href="#Bean类型" class="headerlink" title="Bean类型"></a>Bean类型</h2><p>bean有两种类型，一种时普通bean，一种是工厂bean</p><ul><li><p>普通bean</p><ul><li>返回的就是创建的bean的类型</li></ul></li><li><p>工厂bean</p><ul><li>需要实现FactoryBean接口，其中getObject就是返回的bean对象，对象类型可以用泛型定义</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFactoryBean</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myFactoryBean<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cn.aacopy.learn.spring.MyFactoryBean<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"bean.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">User</span> user <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"myFactoryBean"</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="Bean作用域"><a href="#Bean作用域" class="headerlink" title="Bean作用域"></a>Bean作用域</h2><p>singleton：单例, 默认值，prototype：多例，request，session，global session</p><p>通过scope配置</p><h2 id="Bean生命周期"><a href="#Bean生命周期" class="headerlink" title="Bean生命周期"></a>Bean生命周期</h2><p>生命周期是bean从创建到销毁的过程</p><ul><li>基本过程<ul><li>通过无参构造器创建bean对象</li><li>调用set方法设置属性和其他对象</li><li>调用初始化方法（需要设置初始化方法名）</li><li>使用bean</li><li>容器关闭时，调用销毁方法（需要设置销毁方法名）</li></ul></li></ul><p>在第三步初始化方法的前后，可以执行后置处理器，需要实现BeanPostProcessor接口</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用构造器创建对象"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"设置属性"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">": Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"初始化方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"销毁方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建后置处理</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">BeanPostProcessor</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"初始化前置方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"初始化后置方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注入bean</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>user<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cn.aacopy.tools.mytest.spring.User<span class="token punctuation">"</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>init<span class="token punctuation">"</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>destroy<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aacopy<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cn.aacopy.tools.mytest.spring.MyBeanPostProcessor<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"bean.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">User</span> user <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    user<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//关闭容器</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">)</span> applicationContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行后的结果：</p><pre class="line-numbers language-none"><code class="language-none">调用构造器创建对象设置属性初始化前置方法初始化方法初始化后置方法aacopy: Hello World15:46:51.601 [main] DEBUG org.springframework.context.support.ClassPathXmlApplicationContext - Closing org.springframework.context.support.ClassPathXmlApplicationContext@b684286, started on Mon Sep 12 15:46:51 CST 2022销毁方法<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="自动装配"><a href="#自动装配" class="headerlink" title="自动装配"></a>自动装配</h2><h3 id="通过XML方式"><a href="#通过XML方式" class="headerlink" title="通过XML方式"></a>通过XML方式</h3><ul><li>在User对象中添加属性private School school;</li><li>添加School的bean</li><li>修改User的配置文件进行自动装配，有两种类型，一种是byType，一种是byName</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>user<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cn.aacopy.tools.mytest.spring.User<span class="token punctuation">"</span></span> <span class="token attr-name">autowire</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>byName<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aacopy<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>school<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cn.aacopy.tools.mytest.spring.School<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="引入配置文件数据"><a href="#引入配置文件数据" class="headerlink" title="引入配置文件数据"></a>引入配置文件数据</h2><h3 id="通过XML方式-1"><a href="#通过XML方式-1" class="headerlink" title="通过XML方式"></a>通过XML方式</h3><ul><li>添加配置文件：aacopy.properties，放在classpath下面</li></ul><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">aacopy.aa</span><span class="token punctuation">=</span><span class="token value attr-value">AA</span><span class="token key attr-name">aacopy.bb</span><span class="token punctuation">=</span><span class="token value attr-value">123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>在User对象里设置name，age两个属性，添加set方法</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>配置bean.xml，首先需要用到context命名空间，要在头部引入，导入配置文件，使用${}获取配置文件中的属性</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd            http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>property-placeholder</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aacopy.properties<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>property-placeholder</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>user<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cn.aacopy.tools.mytest.spring.User<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${aacopy.aa}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${aacopy.bb}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringSecurity-原理</title>
      <link href="/springsecurity/springsecurity-yuan-li/"/>
      <url>/springsecurity/springsecurity-yuan-li/</url>
      
        <content type="html"><![CDATA[<p>SpringSecurity本质上是一个过滤器链，通过各个过滤器做认证和授权操作</p>]]></content>
      
      
      <categories>
          
          <category> SpringSecurity </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringSecurity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringSecurity-应用</title>
      <link href="/springsecurity/springsecurity-ying-yong/"/>
      <url>/springsecurity/springsecurity-ying-yong/</url>
      
        <content type="html"><![CDATA[<h2 id="自定义账号密码登录"><a href="#自定义账号密码登录" class="headerlink" title="自定义账号密码登录"></a>自定义账号密码登录</h2><p>默认密码由SpringSecurity启动时创建，实际项目使用中，需要从数据库查询用户账号密码</p><ul><li>实现方案<ul><li>通过实现<code>org.springframework.security.core.userdetails.UserDetailsService</code>接口，在<code>loadUserByUsername</code>方法中可以编写从数据库查询用户信息的过程，返回实现<code>org.springframework.security.core.userdetails.UserDetails</code>接口的用户对象</li><li>创建密码编码器PasswordEncoder，用于对密码加密，加入到spring容器</li><li><del>编写配置类，继承WebSecurityConfigurerAdapter，重写configure(AuthenticationManagerBuilder auth)方法，用于认证</del>（当前这种方式新版本已过时）</li></ul></li></ul><h3 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h3><ul><li>实现UserDetailsService接口</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomUserDetailService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>        <span class="token comment">//todo 通过数据库查询username对应的用户对象</span>        <span class="token comment">//todo 通过数据库查询username对应的角色信息</span>        <span class="token comment">//此处直接返回</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> grantedAuthorities <span class="token operator">=</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> grantedAuthorities<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> user<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建密码编码器PasswordEncoder</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomSecurityConfig</span> <span class="token punctuation">{</span>    <span class="token comment">//密码编码器</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><del>编写配置类，并注入PasswordEncoder密码编码器</del>（新版本已过时）</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomWebSecurityConfigurerAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>测试<ul><li>访问受到权限保护的路径<a href="http://127.0.0.1:8080/test/hello">http://127.0.0.1:8080/test/hello</a></li><li>跳到登录页，用户名随便写，密码输入123456，即可登录</li></ul></li></ul><h2 id="自定义登录页面"><a href="#自定义登录页面" class="headerlink" title="自定义登录页面"></a>自定义登录页面</h2><ul><li>继承WebSecurityConfigurerAdapter，重写configure(HttpSecurity http)方法</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomWebSecurityConfigurerAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/login.html"</span><span class="token punctuation">)</span> <span class="token comment">//登录页</span>                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span> <span class="token comment">//登录访问路径</span>                <span class="token punctuation">.</span><span class="token function">defaultSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/test/hello"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//登录成功跳转路径</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//设置不需要认证的路径</span>                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关闭csrf</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>编写一个登录页login.html</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>登录<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> SpringSecurity </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringSecurity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringSecurity-入门</title>
      <link href="/springsecurity/springsecurity-ru-men/"/>
      <url>/springsecurity/springsecurity-ru-men/</url>
      
        <content type="html"><![CDATA[<p>Spring Security 是一个功能强大且高度可定制的身份验证和访问控制框架。</p><p>主要包括认证和授权两大核心功能</p><ul><li><p>认证</p><p>认证用户是否为系统允许的合法用户，认证通过的用户才能访问被保护的资源，例如用户通过账号密码方式登录系统，就是一个认证的过程</p></li><li><p>授权</p><p>在系统中不同的用户拥有不同的权限，只有有权限的用户才能去操作对应资源，系统可以分配给用户权限</p></li></ul><h2 id="SpringSecurity和Shiro"><a href="#SpringSecurity和Shiro" class="headerlink" title="SpringSecurity和Shiro"></a>SpringSecurity和Shiro</h2><ul><li><p>SpringSecurity</p><ul><li>Spring家族的一部分，可以和Spring轻松整合</li><li>功能全面</li><li>专门为Web开发设计</li><li>重量级</li></ul></li><li><p>Shiro</p><ul><li>是apache中的一个权限控制框架</li><li>通用框架</li><li>轻量级</li></ul></li></ul><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><ul><li>创建一个springboot web项目</li><li>添加依赖</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>编写测试controller</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>springsecuritylearn<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author cmyang * @date 2022/9/4 23:56 */</span><span class="token annotation punctuation">@RestController</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"Hello Spring Security"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>启动服务</p></li><li><p>访问地址<a href="http://127.0.0.1:8080/test/hello">http://127.0.0.1:8080/test/hello</a></p><ul><li><p>页面会跳转至<a href="http://127.0.0.1:8080/login">http://127.0.0.1:8080/login</a></p></li><li><p><img src="/images/SpringSecurity-%E5%85%A5%E9%97%A8/image-20220905002110363.png"></p></li><li><p>登录默认用户名为user，密码为服务启动时，控制台打印的随机生成的密码</p></li><li><p><img src="/images/SpringSecurity-%E5%85%A5%E9%97%A8/image-20220905002341958.png"></p></li><li><p>登录成功后，页面跳转至访问地址，页面显示Hello Spring Security。</p></li><li><p><img src="/images/SpringSecurity-%E5%85%A5%E9%97%A8/image-20220905002456223.png"></p></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> SpringSecurity </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringSecurity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ElasticSearch-SQL</title>
      <link href="/elasticsearch/elasticsearch-sql/"/>
      <url>/elasticsearch/elasticsearch-sql/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Logstash-同步sql数据到ES</title>
      <link href="/elasticsearch/logstash-tong-bu-sql-shu-ju-dao-es/"/>
      <url>/elasticsearch/logstash-tong-bu-sql-shu-ju-dao-es/</url>
      
        <content type="html"><![CDATA[<p>Logstash 是免费且开放的服务器端数据处理管道，能够从多个来源采集数据，转换数据，然后将数据发送到您最喜欢的“存储库”中。</p><p>官方地址：<a href="https://www.elastic.co/cn/logstash/">https://www.elastic.co/cn/logstash/</a></p><p>Logstash 中自带有从数据库读取数据同步到ES的功能</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>安装版本：7.16.2</p><ul><li><p>创建挂载的目录和配置文件</p><pre class="line-numbers language-none"><code class="language-none">/dockerData/logstash/config/logstash.yml/dockerData/logstash/config/pipelines.yml/dockerData/logstash/conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>conf用来存放pipeline配置运行的文件</li></ul></li><li><p>在conf文件夹下添加同步mysql的配置文件<code>test1.conf</code></p><pre class="line-numbers language-none"><code class="language-none">input {    stdin {    }    jdbc {      jdbc_connection_string =&gt; "jdbc:mysql://192.168.80.128:3306/my_test?characterEncoding=UTF-8&amp;nullCatalogMeansCurrent=true"      jdbc_driver_class =&gt; "com.mysql.cj.jdbc.Driver"      jdbc_user =&gt; "root"      jdbc_password =&gt; "aacopy.cn"      jdbc_paging_enabled =&gt; "true"      jdbc_page_size =&gt; "50000"      jdbc_default_timezone =&gt; "Asia/Shanghai"      jdbc_driver_library =&gt; "/usr/share/logstash/conf/mysql-connector-java-8.0.26.jar" #数据库连接包       statement =&gt; "SELECT * FROM table_name"      schedule =&gt; "*/5 * * * *" #cron表达式,多久搬运一次数据      lowercase_column_names =&gt; false # 保留sql字段的大写    }}filter {  date { match =&gt; ["time_stamp","yyyy-MM-dd HH:mm:ss.SSS"] #将表数据中time_stamp字段的数据映射到@time_stamp中target =&gt; "@time_stamp"   }}output {    elasticsearch {        hosts =&gt; ["http://192.168.80.128:9200"] #对应的elasticsearch的地址        index =&gt; "test_user" #数据搬运到access_log这个索引中        document_id =&gt; "%{id}" #映射上面数据库查出来的表id    }    stdout {        codec =&gt; json_lines #美化output输出    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>把mysql的数据库驱动包<code>mysql-connector-java-8.0.26.jar</code>放在conf目录下</p></li><li><p>在pipelines.yml文件中添加配置</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">pipeline.id</span><span class="token punctuation">:</span> test1  <span class="token key atrule">pipeline.workers</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">path.config</span><span class="token punctuation">:</span> /usr/share/logstash/conf/test1.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>docker启动logstash</p><pre class="line-numbers language-none"><code class="language-none">docker run -d --name logstash \  -v /dockerData/logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml \  -v /dockerData/logstash/config/pipelines.yml:/usr/share/logstash/config/pipelines.yml \  -v /dockerData/logstash/conf:/usr/share/logstash/conf \  logstash:7.16.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Logstash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kibana-安装</title>
      <link href="/elasticsearch/kibana-an-zhuang/"/>
      <url>/elasticsearch/kibana-an-zhuang/</url>
      
        <content type="html"><![CDATA[<p>Kibana 是一个免费且开放的用户界面，能够对 Elasticsearch 数据进行可视化</p><p>github:<a href="https://github.com/elastic/kibana">https://github.com/elastic/kibana</a></p><h3 id="docker安装"><a href="#docker安装" class="headerlink" title="docker安装"></a>docker安装</h3><ul><li><p>创建文件<code>/dockerData/kibana/config/kibana.yml</code></p></li><li><p>在文件中加上配置</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server.host</span><span class="token punctuation">:</span> <span class="token string">"0.0.0.0"</span> <span class="token key atrule">elasticsearch.hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http://192.168.80.128:9200"</span><span class="token punctuation">]</span><span class="token key atrule">i18n.locale</span><span class="token punctuation">:</span> zh<span class="token punctuation">-</span>CN<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>docker启动</p><pre class="line-numbers language-none"><code class="language-none">docker run -d --name kibana -p 5601:5601 \  -v /dockerData/kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml \  kibana:7.16.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kibana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>分库分表思想</title>
      <link href="/shardingsphere/fen-ku-fen-biao-si-xiang/"/>
      <url>/shardingsphere/fen-ku-fen-biao-si-xiang/</url>
      
        <content type="html"><![CDATA[<h2 id="数据库架构演变史"><a href="#数据库架构演变史" class="headerlink" title="数据库架构演变史"></a>数据库架构演变史</h2><ul><li><p>单机</p><ul><li><p>高并发下查询慢</p></li><li><p>单机故障</p></li></ul></li><li><p>主从</p><ul><li>主从同步数据</li><li>主节点写，从节点读</li><li>从库可水平扩展，满足更大并发的读需求</li><li>主库单节点压力</li></ul></li><li><p>多主多从</p><ul><li>多节点数据保持一致性，多主之间同步比较复杂</li></ul></li><li><p>分库分表</p><ul><li>对业务库进行水平或垂直拆分多库多表</li></ul></li></ul><h2 id="数据库性能优化思路"><a href="#数据库性能优化思路" class="headerlink" title="数据库性能优化思路"></a>数据库性能优化思路</h2><ul><li>软优化<ul><li>数据库参数调优</li><li>慢sql分析，执行计划分析，优化sql语句</li><li>优化索引结构</li><li>优化表结构</li><li>引入缓存，ES等中间件</li></ul></li><li>硬件优化<ul><li>提高系统硬件性能，加带宽，加CPU，加内存</li></ul></li><li>分库分表<ul><li>根据业务情况，选择合适的分库分表策略</li><li>优先选择分表看是否满足业务需求和未来的增长，分表可以解决单表数据量大，查询慢的问题，但是无法解决高并发下的IO瓶颈</li></ul></li></ul><h2 id="分库分表的优点"><a href="#分库分表的优点" class="headerlink" title="分库分表的优点"></a>分库分表的优点</h2><ul><li>解决数据库本身瓶颈<ul><li>连接数过多问题，访问量过大，或者连接数设置比较小（默认100，最大可设置16384）都会出现“too many connections”错误</li><li>分表可以解决单表数据量过大，查询慢的问题</li><li>分库可以解决单库访问压力过大的问题</li></ul></li><li>解决系统IO和CPU瓶颈<ul><li>磁盘读写IO瓶颈</li><li>网络IO瓶颈</li><li>CPU瓶颈，复杂的SQL计算，SQL执行占用CPU过高，扫描行过多，锁冲突，锁等待等原因<ul><li>可以通过show processlist，show full processlist，发现CPU占用高的SQL，State列值是Sending data，Copy to tmp table，Copy to tmp table on disk，Sort result，Using filesort，等都可能是有性能问题的SQL</li><li>通过执行计划分析</li></ul></li></ul></li></ul><h2 id="分库分表带来的问题"><a href="#分库分表带来的问题" class="headerlink" title="分库分表带来的问题"></a>分库分表带来的问题</h2><ul><li>跨节点Join关联查询</li><li>跨库带来的分布式事务问题</li><li>执行的SQL排序、分页、函数计算问题</li><li>全局主键重复问题</li><li>二次扩容问题</li><li>技术选型问题</li></ul><h2 id="垂直分表"><a href="#垂直分表" class="headerlink" title="垂直分表"></a>垂直分表</h2><ul><li>基于列字段大表拆小表</li><li>不常用的字段单独放在一张表</li><li>text大字段拆分出来放在附表中</li><li>经常组合查询的放在一张表</li></ul><h2 id="垂直分库"><a href="#垂直分库" class="headerlink" title="垂直分库"></a>垂直分库</h2><p>数据库的CPU长期处于90%+的利用率，数据库连接不够时，需要分库优化</p><ul><li>对系统中的不同业务进行拆分，连接到不同的数据库</li><li>垂直分库避免了不同业务竞争同一个数据库资源，在高并发场景下可以突破IO，连接数，硬件资源的瓶颈</li><li>降低了业务层面的耦合，方便维护</li><li>微服务项目就是垂直分库的体现</li></ul><p>垂直分库分表可以提高并发能力，但是无法解决单表数据量大查询效率问题</p><h2 id="水平分表"><a href="#水平分表" class="headerlink" title="水平分表"></a>水平分表</h2><p>当单表数据达到几千万时，查询慢，可以用水平分表解决</p><p>基于数据大表拆小标</p><ul><li>垂直分表：基于表结构拆分</li><li>水平分表：基于表数据拆分</li><li>把一个数据量大的表，拆分成多个小表，每个表的表结构相同，数据不同，全部表数据之和就是全部数据</li><li>才成多表后，每个表的数据量减少，查询效率变高</li><li>减少了锁表时间，当添加一列的时候mysql会锁表，期间所有读写操作只能等待</li><li>但是所有表都在同一个库，无法解决单库资源的瓶颈</li></ul><h2 id="水平分库"><a href="#水平分库" class="headerlink" title="水平分库"></a>水平分库</h2><p>单数据库的资源是有限的，水平分库可以解决</p><ul><li>把表中的数据按照一定规则分散到不同的数据库中</li><li>表结构相同，数据库不同</li><li>水平分库比水平分表粒度更大</li></ul><h2 id="水平分库分表策略"><a href="#水平分库分表策略" class="headerlink" title="水平分库分表策略"></a>水平分库分表策略</h2><h3 id="range范围"><a href="#range范围" class="headerlink" title="range范围"></a>range范围</h3><ul><li><p>自增id</p><ul><li>通过自增id，根据id范围进行分表，例如id 0~1百万为一个表，1百万到2百万为一个表</li><li>优点：id是自增的，可以无限增长，扩容不用迁移数据，易于维护</li><li>缺点：数据读写集中在新的数据中，数据倾斜严重，利用率不均衡</li></ul></li><li><p>时间范围</p><ul><li>按照年月日进行分表</li></ul></li><li><p>空间范围</p><ul><li>地理位置，省份，区域等</li></ul></li></ul><h3 id="Hash取模"><a href="#Hash取模" class="headerlink" title="Hash取模"></a>Hash取模</h3><p>通过Hash转成整数，再取模</p><p>例如，2个库，每个库4个表</p><ul><li>库id = userId % 库数量</li><li>表id = userId % 库数量 % 表数量</li></ul><p>优点：保证数据均匀分布到各个库表中，避免热点数据问题</p><p>缺点：扩容不方便，需要数据迁移</p>]]></content>
      
      
      <categories>
          
          <category> Shardingsphere </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Shardingsphere </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Netty-NIO</title>
      <link href="/netty/netty-nio/"/>
      <url>/netty/netty-nio/</url>
      
        <content type="html"><![CDATA[<p>Java支持三种网络IO模型：BIO，NIO，AIO</p><h2 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h2><ul><li><p>同步阻塞</p></li><li><p>一个连接一个线程</p><p><img src="/images/Netty-NIO/BIO.png"></p></li><li><p>场景：适用于连接数量比较小且固定的架构，JDK1.4以前只有BIO</p></li><li><p>编程：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>       <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token class-name">Socket</span> socket <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户端已连接..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>               <span class="token keyword">try</span> <span class="token punctuation">{</span>                   <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                   <span class="token keyword">int</span> length<span class="token punctuation">;</span>                   <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>length <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前线程："</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                <span class="token operator">+</span> <span class="token string">", 收到消息："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token punctuation">}</span>               <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                   <span class="token keyword">try</span> <span class="token punctuation">{</span>                       socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                       e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token punctuation">}</span>               <span class="token punctuation">}</span>           <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>测试：<ul><li>启动main方法，</li><li>打开cmd窗口，输入<code>telnet 127.0.0.1 9999</code></li><li>按ctrl + ]</li><li>发送消息 <code>send hello</code></li><li>启动多个cmd发送消息，查看服务端的日志可以发现，每连接一个客户端，都需要启动一个线程，并且线程是阻塞状态</li></ul></li></ul></li></ul><h2 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h2><ul><li><p>同步非阻塞</p></li><li><p>一个线程处理多个连接，客户端发送的连接请求会注册到多路复用器上，多路复用器轮询到连接有IO请求就进行处理</p><p><img src="/images/Netty-NIO/NIO.png"></p></li><li><p>场景：适用于连接数量多，且连接比较短的架构，比如聊天室，弹幕，服务器间通讯，从JDK1.4支持</p></li></ul><h3 id="三大核心"><a href="#三大核心" class="headerlink" title="三大核心"></a>三大核心</h3><p>NIO三大核心部分：Channel（通道），Buffer（缓冲区），Selector（选择器）</p><h2 id="AIO"><a href="#AIO" class="headerlink" title="AIO"></a>AIO</h2><ul><li>异步非阻塞</li><li>采用Proactor模式，先由操作系统完成后才通知服务端程序启动线程处理</li><li>场景：适用于连接数量多，且连接比较长的架构，比如相册服务器，从JDK1.7支持</li></ul><h2 id="NIO和BIO的区别"><a href="#NIO和BIO的区别" class="headerlink" title="NIO和BIO的区别"></a>NIO和BIO的区别</h2><ul><li>BIO以流的方式处理数据，NIO以块的方式处理</li><li>BIO时阻塞的，NIO是非阻塞的</li><li>BIO基于字节和字符流进行操作，而NIO基于Channel和Buffer进行操作，数据总是从Channel读取到Buffer，或者从Buffer写入Channel中，Selector用于监听多个Channel事件（连接请求，可读，可写），因此使用单线程可以监听多个通道</li></ul><h2 id="三大核心Selector，Channel，Buffer"><a href="#三大核心Selector，Channel，Buffer" class="headerlink" title="三大核心Selector，Channel，Buffer"></a>三大核心Selector，Channel，Buffer</h2><p>​<img src="/images/Netty-NIO/202206270748.png"></p><ul><li>每个Channel都会对应一个buffer</li><li>一个Selector对应一个线程，一个线程对应多个Channel（连接）</li><li>如上图，有三个连接注册到Selector上</li><li>程序切换到哪个Channel是由事件决定的</li><li>Selector会根据不同的事件，在各个通道上切换</li><li>Buffer就是一个内存块，底层是一个数组</li><li>数据的读写都是通过Buffer，BIO要么是输入流要么是输出流是单向的，NIO的Buffer是可读可写的，通过flip切换，是双向的。</li></ul><h2 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h2><p>NIO是面向缓冲区编程的，数据会读取到一个缓存区中，需要时可以在缓冲区向前或向后移动，提供了非阻塞式的网络</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//创建可存放5个int数据的IntBuffer</span><span class="token class-name">IntBuffer</span> intBuffer <span class="token operator">=</span> <span class="token class-name">IntBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在buffer中存数据</span>intBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">115</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取数据</span><span class="token comment">//读写模式转换</span>intBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//是否还有数据</span><span class="token keyword">while</span> <span class="token punctuation">(</span>intBuffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//读取数据</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>intBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>Buffer是一个顶层父类，有7个直接子类，IntBuffer，FloatBuffer，CharBuffer，DoubleBuffer，ShortBuffer，LongBuffer，ByteBuffer，都是通过对应的一个数组来存储数据，ByteBuffer最常用。</p></li><li><p>通过四个参数来控制数组的数据和位置</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Invariants: mark &lt;= position &lt;= limit &lt;= capacity</span><span class="token comment">//标记</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> mark <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//位置，下一个要被读或写的元素的索引，每次读写缓冲区的数据都会改变该值，为下次读写做准备</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//缓存区的终点，不能对超过limit的位置进行读写，该限制可以修改</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> limit<span class="token punctuation">;</span><span class="token comment">//容量，即可以容量的最大数据量，在缓冲区被创建时设置，不能改变</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h2><ul><li>BIO中的stream是单向的，例如FileInputStream对象只能进行读取数据，NIO中的Channel是双向的，可读可写</li><li>常用的Channel类：ServerSocketChannel（TCP），SocketChannel（TCP），DatagramChannel（UDP），FileChannel（文件）</li></ul><h3 id="FileChannel"><a href="#FileChannel" class="headerlink" title="FileChannel"></a>FileChannel</h3><ul><li>FileChannel用于文件数据读写<ul><li>read方法，从通道读取数据到缓冲区</li><li>write方法，从缓冲区写数据到通道</li><li>transferFrom，目标通道复制数据到当前通道</li><li>transferTo，当前通道数据复制到目标通道</li></ul></li><li>将字符串写入到文件示例</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeToFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>       <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"D:/hello.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//从输出流获取FileChannel</span>       <span class="token class-name">FileChannel</span> fileChannel <span class="token operator">=</span> fileOutputStream<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//创建缓冲区</span>       <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//将字符串放入缓冲区</span>       byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//切换读写模式</span>       byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//把缓冲区数据写入Channel</span>       fileChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//关闭流</span>       fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>从文件读取数据打印</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>    <span class="token comment">//创建输入流</span>    <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"D:/hello.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//从输入流获取Channel</span>    <span class="token class-name">FileChannel</span> fileChannel <span class="token operator">=</span> fileInputStream<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//创建缓冲区</span>    <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//将Channel中的数据读到缓冲区</span>    <span class="token keyword">int</span> length <span class="token operator">=</span> fileChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//打印缓冲区数据</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    fileInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Selector"><a href="#Selector" class="headerlink" title="Selector"></a>Selector</h2><p>Selector可以检测多个注册的通道上是否有事件发生，只有在通道真正有事件发生时，才会进行读写，只需要一个线程来维护多个通道，减少了系统开销</p><p>相关方法</p><ul><li>select()  //阻塞</li><li>select(1000)  //阻塞1000ms</li><li>wakeup()  //唤醒selector</li><li>selectNow()  //不阻塞，立马返回</li></ul><p>注册方式</p><ul><li>创建ServerSocketChannel，并绑定端口，然后注册到Selector上，监听accept事件</li><li>当有新连接时，从Selector上获取accept事件的key，通过key获取SocketChannel</li><li>将SocketChannel注册到Selector上，监听read事件</li><li>当通道可读时，从Selector获取可读通道，并读取通道中的数据</li></ul><p>编写一个简单，ServerSocketChannel服务端，和SocketChannel客户端，进行客户端与客户端的实时通讯</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>mytest<span class="token punctuation">.</span>nio</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">InetSocketAddress</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">ByteBuffer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>channels<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author iseven.yang * @date 2022/7/8 10:13 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioTest</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nioServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">ServerSocketChannel</span> serverSocketChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        serverSocketChannel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        serverSocketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        serverSocketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"+++++++++++++++++++++++"</span> <span class="token operator">+</span> selector<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"===============&gt;"</span> <span class="token operator">+</span> selectionKeys<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> selectionKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>selectionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>selectionKey<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token class-name">SocketChannel</span> accept <span class="token operator">=</span> serverSocketChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        accept<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        accept<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>selectionKey<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token class-name">SocketChannel</span> channel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> selectionKey<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> length <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>length <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">//消息转发</span>                            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> channelKeys <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">while</span> <span class="token punctuation">(</span>channelKeys<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token class-name">SelectionKey</span> eachKey <span class="token operator">=</span> channelKeys<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token keyword">if</span><span class="token punctuation">(</span>eachKey <span class="token operator">!=</span> selectionKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                    <span class="token class-name">SelectableChannel</span> selectableChannel <span class="token operator">=</span> eachKey<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token keyword">if</span><span class="token punctuation">(</span>selectableChannel <span class="token keyword">instanceof</span> <span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                        <span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> eachKey<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                        byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                        socketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token punctuation">}</span>                                <span class="token punctuation">}</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                    iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">nioClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">nioClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">nioClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nioClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> <span class="token class-name">SocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            socketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> length <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"接收到消息："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">"你好："</span> <span class="token operator">+</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"发送消息："</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>                byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                socketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>                byteBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>SelectionKey   channel关心的事件</li><li>ServerSocketChannel    服务端监听新的客户端连接</li><li>SocketChannel    网络IO通道，负责具体的读写操作</li></ul><h2 id="零拷贝"><a href="#零拷贝" class="headerlink" title="零拷贝"></a>零拷贝</h2><p>是针对CPU而言的，不是没有copy，而是没有CPU拷贝</p><h3 id="传统IO"><a href="#传统IO" class="headerlink" title="传统IO"></a>传统IO</h3><p>4次拷贝，3次状态切换</p><p>磁盘拷贝到内核态（kernel buffer）,再由内核态拷贝到用户态，再由用户态拷贝到内核态（socket buffer），再拷贝到协议栈</p><p><img src="/images/Netty-NIO/202207101116.png"></p><h3 id="mmap优化"><a href="#mmap优化" class="headerlink" title="mmap优化"></a>mmap优化</h3><ul><li><p>mmap通过内存映射，将文件映射到内核缓冲区，同时，用户空间可以共享内核空间的数据，这样在进行网络传输时，可以减少内核空间到用户空间到拷贝次数</p></li><li><p>需要4次数上下文切换，3次数据拷贝</p></li><li><p>适合小数据量传输</p></li><li><p><img src="/images/Netty-NIO/202207101507.png"></p></li></ul><h3 id="sendFile"><a href="#sendFile" class="headerlink" title="sendFile"></a>sendFile</h3><ul><li>在linux2.4版本以后，数据不经过用户态，直接从kernel buffer拷贝到协议栈</li><li>3次上下文切换，2次数据拷贝</li><li>没有CPU拷贝</li><li>适合大文件传输</li></ul><p><img src="/images/Netty-NIO/202207101501.png"></p>]]></content>
      
      
      <categories>
          
          <category> Netty </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XXL-Job-入门</title>
      <link href="/xxl-job/xxl-job-ru-men/"/>
      <url>/xxl-job/xxl-job-ru-men/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>XXL-Job是一个分布式任务调度平台</p><p>官方网站：<a href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p><h2 id="设计思想"><a href="#设计思想" class="headerlink" title="设计思想"></a>设计思想</h2><ul><li>将调度行为抽象形成“调度中心”公共平台，而平台自身并不承担业务逻辑，“调度中心”负责发起调度请求。</li><li>将任务抽象成分散的JobHandler，交由“执行器”统一管理</li><li>“执行器”负责接收调度请求并执行对应的JobHandler中业务逻辑。</li><li>“调度”和“任务”两部分可以相互解耦，提高系统整体稳定性和扩展性</li></ul><h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><p>版本2.3.0：<a href="https://github.com/xuxueli/xxl-job/tree/2.3.0">https://github.com/xuxueli/xxl-job/tree/2.3.0</a></p><ul><li>目录介绍<ul><li>doc：xxl-job的文档资料，包括了数据库的脚本</li><li>xxl-job-core：公共jar包依赖</li><li>xxl-job-admin：调度中心</li><li>xxl-job-executor-samples：执行器</li></ul></li><li>数据库表<ul><li>xxl_job_group：执行器信息表，用于维护任务执行器的信息</li><li>xxl_job_info：调度扩展信息表，主要是用于保存xxl-job的调度任务的扩展信息，比如说像任务分组、任务名、机器的地址等等</li><li>xxl_job_lock：任务调度锁表</li><li>xxl_job_log：日志表，主要是用在保存xxl-job任务调度历史信息，像调度结果、执行结果、调度入参等等</li><li>xxl_job_log_report：日志报表，会存储xxl-job任务调度的日志报表，会在调度中心里的报表功能里使用到</li><li>xxl_job_logglue：任务的GLUE日志，用于保存GLUE日志的更新历史变化，支持GLUE版本的回溯功能</li><li>xxl_job_registry：执行器的注册表，用在维护在线的执行器与调度中心的地址信息</li><li>xxl_job_user：系统的用户表</li></ul></li></ul><h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><ul><li><p>在源码中找到doc/db/table_xxl_job.sql文件,在数据库执行脚本</p></li><li><p>修改xxl-job-admin的配置文件application.properties</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://192.168.80.128:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span><span class="token key attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span><span class="token key attr-name">spring.datasource.password</span><span class="token punctuation">=</span><span class="token value attr-value">aacopy.cn</span><span class="token key attr-name">xxl.job.accessToken</span><span class="token punctuation">=</span><span class="token value attr-value">aacopy.cn</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>启动XxlJobAdminApplication</p></li><li><p>访问<a href="http://127.0.0.1:8080/xxl-job-admin">http://127.0.0.1:8080/xxl-job-admin</a></p></li><li><p>默认账号密码：admin/123456</p></li></ul><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><ul><li><p>创建一个springboot项目</p></li><li><p>引入maven依赖</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xuxueli<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xxl-job-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>添加配置文件</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment"># web port</span><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8081</span><span class="token comment">#----------xxl-job配置--------------</span><span class="token key attr-name">logging.config</span><span class="token punctuation">=</span><span class="token value attr-value">classpath:logback.xml</span><span class="token comment">#调度中心部署地址,多个配置逗号分隔 "http://address01,http://address02"</span><span class="token key attr-name">xxl.job.admin.addresses</span><span class="token punctuation">=</span><span class="token value attr-value">http://127.0.0.1:8080/xxl-job-admin</span><span class="token comment">#执行器token，非空时启用 xxl-job, access token,和服务端要保持一致</span><span class="token key attr-name">xxl.job.accessToken</span><span class="token punctuation">=</span><span class="token value attr-value">aacopy.cn</span><span class="token comment"># 执行器app名称,和控制台那边配置一样的名称，不然注册不上去</span><span class="token key attr-name">xxl.job.executor.appname</span><span class="token punctuation">=</span><span class="token value attr-value">xxxl-job-learn</span><span class="token comment"># [选填]执行器注册：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。</span><span class="token comment">#从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。</span><span class="token key attr-name">xxl.job.executor.address</span><span class="token punctuation">=</span><span class="token comment">#[选填]执行器IP ：默认为空表示自动获取IP（即springboot容器的ip和端口，可以自动获取，也可以指定），多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 "执行器注册" 和 "调度中心请求并触发任务"，</span><span class="token key attr-name">xxl.job.executor.ip</span><span class="token punctuation">=</span><span class="token comment"># [选填]执行器端口号：小于等于0则自动获取；默认端口为9999，单机部署多个执行器时，注意要配置不同执行器端口；</span><span class="token key attr-name">xxl.job.executor.port</span><span class="token punctuation">=</span><span class="token value attr-value">9999</span><span class="token comment">#执行器日志文件存储路径，需要对该路径拥有读写权限；为空则使用默认路径</span><span class="token key attr-name">xxl.job.executor.logpath</span><span class="token punctuation">=</span><span class="token value attr-value">/data/applogs/xxl-job/jobhandler</span><span class="token comment">#执行器日志保存天数</span><span class="token key attr-name">xxl.job.executor.logretentiondays</span><span class="token punctuation">=</span><span class="token value attr-value">30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>创建logback.xml配置文件</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span> <span class="token attr-name">debug</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">scan</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">scanPeriod</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1 seconds<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>contextName</span><span class="token punctuation">&gt;</span></span>logback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>contextName</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>log.path<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/data/applogs/xxl-job/xxl-job-learn.log<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>console<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>%d{HH:mm:ss.SSS} %contextName [%thread] %-5level %logger{36} - %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.RollingFileAppender<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">&gt;</span></span>${log.path}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rollingPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.TimeBasedRollingPolicy<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fileNamePattern</span><span class="token punctuation">&gt;</span></span>${log.path}.%d{yyyy-MM-dd}.zip<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fileNamePattern</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rollingPolicy</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>%date %level [%thread] %logger{36} [%file : %line] %msg%n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>info<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>console<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>创建config配置文件</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XxlJobConfig</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">XxlJobConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.admin.addresses}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> adminAddresses<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.accessToken}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> accessToken<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.appname}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> appname<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.address}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.ip}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> ip<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.port}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.logpath}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> logPath<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.logretentiondays}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> logRetentionDays<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">XxlJobSpringExecutor</span> <span class="token function">xxlJobExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">XxlJobSpringExecutor</span> xxlJobSpringExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XxlJobSpringExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAdminAddresses</span><span class="token punctuation">(</span>adminAddresses<span class="token punctuation">)</span><span class="token punctuation">;</span>        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAppname</span><span class="token punctuation">(</span>appname<span class="token punctuation">)</span><span class="token punctuation">;</span>        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAccessToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setLogPath</span><span class="token punctuation">(</span>logPath<span class="token punctuation">)</span><span class="token punctuation">;</span>        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setLogRetentionDays</span><span class="token punctuation">(</span>logRetentionDays<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> xxlJobSpringExecutor<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 针对多网卡、容器内部署等情况，可借助 "spring-cloud-commons" 提供的 "InetUtils" 组件灵活定制注册IP；     *     *      1、引入依赖：     *          &lt;dependency&gt;     *             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;     *             &lt;artifactId&gt;spring-cloud-commons&lt;/artifactId&gt;     *             &lt;version&gt;${version}&lt;/version&gt;     *         &lt;/dependency&gt;     *     *      2、配置文件，或者容器启动变量     *          spring.cloud.inetutils.preferred-networks: 'xxx.xxx.xxx.'     *     *      3、获取IP     *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();     */</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>编写jobhandler任务</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleXxlJob</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">"demoJobHandler1"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">demo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=============="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>新建执行器</p><p><img src="/images/XXL-Job-%E5%AE%89%E8%A3%85/image-20220614224616957.png"></p></li><li><p>新建任务</p><p><img src="/images/XXL-Job-%E5%AE%89%E8%A3%85/image-20220614224644561.png"></p></li><li><p>启动任务</p></li></ul><p><img src="/images/XXL-Job-%E5%AE%89%E8%A3%85/image-20220614224655573.png"></p><ul><li>查看日志</li></ul><h2 id="执行器管理"><a href="#执行器管理" class="headerlink" title="执行器管理"></a>执行器管理</h2><ul><li>Appname：是每一个执行器的唯一表示AppName，执行器会以周期性为appname进行注册，为任务调度的时候使用</li><li>名称：执行器的名称，因为appname有限制字母与数字等等组成，可读性不强，这个名称就是为了提高执行器的可读性</li><li>注册方式：调度中心获取执行器地址的方式<ul><li>自动注册：执行器自动进行执行器的注册，通过底层的注册表可以动态的发现执行器机器的地址</li><li>手动录入：人工手动录入执行器的地址信息，多地址使用逗号进行分割，供调度中心使用</li></ul></li><li>机器地址：“注册方式”为手动录入的时候才能使用，支持人工维护执行器的地址</li><li>点击保存后可能要等30S左右才回显示机器的地址</li></ul><h2 id="任务管理"><a href="#任务管理" class="headerlink" title="任务管理"></a>任务管理</h2><ul><li>示例执行器：所用到的执行器</li><li>任务描述：概述该任务是做什么的</li><li>路由策略：<ul><li>第一个：选择第一个机器</li><li>最后一个：选择最后一个机器</li><li>轮询：依次选择执行</li><li>随机：随机选择在线的机器</li><li>一致性HASH：每个任务按照Hash算法固定选择某一台机器，并且所有的任务均匀散列在不同的机器上</li><li>最不经常使用：使用频率最低的机器优先被使用</li><li>最近最久未使用：最久未使用的机器优先被选举</li><li>故障转移：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标的执行器并且会发起任务调度</li><li>忙碌转移：按照顺序来依次进行空闲检测，第一个空闲检测成功的机器会被选定为目标群机器，并且会发起任务调度</li><li>分片广播：广播触发对于集群中的所有机器执行任务，同时会系统会自动传递分片的参数</li></ul></li><li>Cron：执行规则</li><li>调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等</li><li>JobHandler：定义执行器的名字</li><li>阻塞处理策略：<ul><li>单机串行：新的调度任务在进入到执行器之后，该调度任务进入FIFO队列，并以串行的方式去进行</li><li>丢弃后续调度：新的调度任务在进入到执行器之后，如果存在相同的且正在运行的调度任务，本次的调度任务请求就会被丢弃掉，并且标记为失败</li><li>覆盖之前的调度：新的调度任务在进入到执行器之后，如果存在相同的且正在运行的调度任务，就会终止掉当前正在运行的调度任务，并且清空队列，运行新的调度任务。</li></ul></li><li>子任务ID：输入子任务的任务id，可填写多个</li><li>任务超时时间：添加任务超时的时候，单位s，设置时间大于0的时候就会生效</li><li>失败重试次数：设置失败重试的次数，设置时间大于0的时候就会生效</li><li>负责人：填写该任务调度的负责人</li><li>报警邮件：出现报警，则发送邮件</li></ul><h2 id="参数传递和日志及执行结果"><a href="#参数传递和日志及执行结果" class="headerlink" title="参数传递和日志及执行结果"></a>参数传递和日志及执行结果</h2><p><img src="/images/XXL-Job-%E5%AE%89%E8%A3%85/image-20220614225711654.png"></p><ul><li><p>通过api方法获取参数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleXxlJob</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">"demoJobHandler1"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">demo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//获取参数</span>        <span class="token class-name">String</span> jobParam <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getJobParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"获取到参数：{}"</span><span class="token punctuation">,</span> jobParam<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//打印日志</span>        <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hello xxl-job"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//执行结果成功</span><span class="token comment">//        XxlJobHelper.handleSuccess("执行成功！！！");</span>        <span class="token comment">//执行失败</span>        <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">handleFail</span><span class="token punctuation">(</span><span class="token string">"任务执行失败！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>执行结果</p><ul><li>可以查看执行日志和结果日志</li></ul><p><img src="/images/XXL-Job-%E5%AE%89%E8%A3%85/image-20220614230507949.png"></p></li></ul><h2 id="分片任务"><a href="#分片任务" class="headerlink" title="分片任务"></a>分片任务</h2><ul><li><p>执行器集群部署，如果任务的路由策略选择【分片广播】，一次任务调度将会【广播触发】对应集群中所有执行器执行一次任务，同时系统自动传递分片参数，执行器可根据分片参数开发分片任务</p></li><li><p>需要处理的海量数据，以执行器为划分，每个执行器分配一定的任务数，并行执行</p></li><li><p>XXL-Job支持动态扩容执行器集群，从而动态增加分片数量，到达更快处理任务</p></li><li><p>分片的值是调度中心分配的</p></li><li><p>编写代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">"shardingJobHandler"</span><span class="token punctuation">)</span>   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shardingJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment">// 分片参数</span>       <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"分片参数：当前分片序号 = {}, 总分片数 = {}"</span><span class="token punctuation">,</span> shardIndex<span class="token punctuation">,</span> shardTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 业务逻辑</span>       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> shardTotal<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> shardIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>               <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"第 {} 片, 命中分片开始处理"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>               <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"第 {} 片, 忽略"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span>       <span class="token punctuation">}</span>     <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>任务配置</p><p><img src="/images/XXL-Job-%E5%AE%89%E8%A3%85/image-20220614231245349.png"></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> XXL-Job </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XXL-Job </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SkyWalking-告警</title>
      <link href="/skywalking/skywalking-gao-jing/"/>
      <url>/skywalking/skywalking-gao-jing/</url>
      
        <content type="html"><![CDATA[<h2 id="启动通知"><a href="#启动通知" class="headerlink" title="启动通知"></a>启动通知</h2><ul><li><p>在alarm-settings.yml配置文件中，添加通知接口</p><pre class="line-numbers language-none"><code class="language-none">webhooks:  - http://192.168.80.1:8080/notify/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>编写代码</p><pre class="line-numbers language-none"><code class="language-none">@Datapublic class AlarmMessage  {    private int scopeId;    private String scope;    private String name;    private String id0;    private String id1;    private String ruleName;    private String alarmMessage;    private long startTime;    private transient int period;    private transient boolean onlyAsCondition;}@RestControllerpublic class AlarmController {    @PostMapping("/notify")    public void  webhook(@RequestBody List&lt;AlarmMessage&gt; alarmMessageList){        System.out.println("收到告警消息:" +alarmMessageList);    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> SkyWalking </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SkyWalking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SkyWalking-日志</title>
      <link href="/skywalking/skywalking-ri-zhi/"/>
      <url>/skywalking/skywalking-ri-zhi/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ul><li>日志中找到traceId来跟踪系统调用链路</li><li>需要在系统日志打印出traceId</li></ul><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><ul><li><p>添加依赖</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.skywalking<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>apm-toolkit-logback-1.x<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.5.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>添加logback.xml配置文件</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>　　    <span class="token comment">&lt;!-- 控制台输出 --&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>console<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.encoder.LayoutWrappingEncoder<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.skywalking.apm.toolkit.log.logback.v1.x.TraceIdPatternLogbackLayout<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Pattern</span><span class="token punctuation">&gt;</span></span>%d{yyyy-MM-dd HH:mm:ss.SSS} [%tid] [%thread] %-5level %logger{36} -%msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Pattern</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>grpc-log<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.skywalking.apm.toolkit.log.logback.v1.x.log.GRPCLogClientAppender<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ch.qos.logback.core.encoder.LayoutWrappingEncoder<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.skywalking.apm.toolkit.log.logback.v1.x.mdc.TraceIdMDCPatternLogbackLayout<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Pattern</span><span class="token punctuation">&gt;</span></span>%d{yyyy-MM-dd HH:mm:ss.SSS} [%tid] [%thread] %-5level %logger{36} -%msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Pattern</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>    <span class="token comment">&lt;!--系统操作日志--&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>INFO<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>　　        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>console<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>grpc-log<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>skywaling agent 默认是上传到本地的oap，如果oap server地址不是本地，则需要单独配置oap server地址，agent文件夹里面config配置</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">#日志数据的grpc服务器的主机</span><span class="token key attr-name">plugin.toolkit.log.grpc.reporter.server_host</span><span class="token punctuation">=</span><span class="token value attr-value">${SW_GRPC_LOG_SERVER_HOST:192.168.80.128} </span><span class="token comment">#日志数据的grpc服务器的端口</span><span class="token key attr-name">plugin.toolkit.log.grpc.reporter.server_port</span><span class="token punctuation">=</span><span class="token value attr-value">${SW_GRPC_LOG_SERVER_PORT:11800}</span><span class="token comment">#日志数据的最大大小</span><span class="token key attr-name">plugin.toolkit.log.grpc.reporter.max_message_size</span><span class="token punctuation">=</span><span class="token value attr-value">${SW_GRPC_LOG_MAX_MESSAGE_SIZE:10485760}</span><span class="token comment">#发送数据时将超时多长时间。单位是秒</span><span class="token key attr-name">plugin.toolkit.log.grpc.reporter.upstream_timeout</span><span class="token punctuation">=</span><span class="token value attr-value">${SW_GRPC_LOG_GRPC_UPSTREAM_TIMEOUT:30}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>打印日志，查看日志模块</p><p><img src="/images/SkyWalking-%E6%97%A5%E5%BF%97/image-20220612222558229.png"></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> SkyWalking </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SkyWalking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SkyWalking-自定义链路追踪</title>
      <link href="/skywalking/skywalking-zi-ding-yi-lian-lu-zhui-zong/"/>
      <url>/skywalking/skywalking-zi-ding-yi-lian-lu-zhui-zong/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ul><li>对业务代码进行链路追踪，方便排查问题</li><li>比如，某个接口请求耗时慢，想对业务接口方法进行追踪</li><li>controller-&gt;service 方法，记录业务方法加入到链路中，记录入参、返回值等</li></ul><h2 id="TraceId"><a href="#TraceId" class="headerlink" title="TraceId"></a>TraceId</h2><p>TraceId用来标识一条请求链路，一条请求链路中包含一个Trace ID，多个Span ID</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><ul><li><p>添加依赖</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.skywalking<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>apm-toolkit-trace<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.5.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在Service业务方法添加注解 <code>@Trace</code></p></li><li><p>记录入参和返回值</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Tags</span><span class="token punctuation">(</span>  <span class="token punctuation">{</span><span class="token annotation punctuation">@Tag</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">"reqParam"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"arg[0]"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token annotation punctuation">@Tag</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">"respData"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"returnedObj"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="性能分析"><a href="#性能分析" class="headerlink" title="性能分析"></a>性能分析</h2><p><img src="/images/SkyWalking-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/image-20220612210230597.png"></p><ul><li>在性能分析页面，选择新建的任务，点击分析</li><li>点击service上的查看，可以查看到对应的出入参</li><li>查看堆栈信息可以，看到具体哪行代码慢</li></ul><p><img src="/images/SkyWalking-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/image-20220612210337144.png"></p>]]></content>
      
      
      <categories>
          
          <category> SkyWalking </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SkyWalking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SkyWalking-UI和指标</title>
      <link href="/skywalking/skywalking-ui-he-zhi-biao/"/>
      <url>/skywalking/skywalking-ui-he-zhi-biao/</url>
      
        <content type="html"><![CDATA[<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><ul><li><p>Service 服务，具体的服务，比如用户服务</p></li><li><p>Instance 实例，服务的实例，比如xxx节点上的服务，id@ip</p></li><li><p>Endpoint 端点，服务对外提供的接口，一个接口就是一个端点</p></li><li><p>Service Apdex 用户满意程度</p><ul><li>最大值就是 1， 是一个不断优化的方向</li><li>分3个指标，T 值代表着用户对服务性能满意的响应时间界限，假如T是0.5秒<ul><li>满意：响应时间少于 T 秒钟； 0.5秒内</li><li>容忍：响应时间 T～4T 秒； 0.5~2秒内</li><li>失望：响应时间超过 4T 秒； 多于2秒</li></ul></li></ul></li><li><p>SLA</p><ul><li><p>服务等级协议，全称：service level agreement，为保障服务的性能和可用性</p></li><li><p>9越多代表全年服务可用时间越长服务更可靠，停机时间越短</p><pre class="line-numbers language-none"><code class="language-none">1年 = 365天 = 8760小时99.9 = 8760 * 0.1% = 8760 * 0.001 = 8.76小时99.99 = 8760 * 0.0001 = 0.876小时 = 0.876 * 60 = 52.6分钟99.999 = 8760 * 0.00001 = 0.0876小时 = 0.0876 * 60 = 5.26分钟全年停机5.26分钟才能99.999%，即5个9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p>CPM 全称 call per minutes，是吞吐量(Throughput)指标，每分钟请求调用的次数</p></li><li><p>RT Response Time 表示请求响应时间</p></li><li><p>Percent Response 百分位数统计</p><ul><li>表示采集样本中某些值的占比，SkyWalking 有 “p50、p75、p90、p95、p99” 一些列值， “p99:360” 表示 99% 请求的响应时间在360ms以内</li></ul></li></ul><h2 id="SkyWalking-UI"><a href="#SkyWalking-UI" class="headerlink" title="SkyWalking UI"></a>SkyWalking UI</h2><ul><li><p>顶部控制栏</p><p><img src="/images/SkyWalking-UI%E5%92%8C%E6%8C%87%E6%A0%87/image-20220612112037031.png"></p><ul><li>仪表盘：查看被监控服务的运行状态</li><li>拓扑图：以拓扑图的方式展现服务的关系</li><li>追踪：以接口的列表方式展现</li><li>性能剖析：对端点进行采样分析</li><li>日志：可查看服务日志</li><li>告警：触发告警的告警列表，包括了服务的失败率，超时等待</li></ul></li><li><p>Global：全局维度</p><p><img src="/images/SkyWalking-UI%E5%92%8C%E6%8C%87%E6%A0%87/image-20220612183507443.png"></p><ul><li>Services load：服务每分钟请求数</li><li>Slow Services：慢响应服务，单位ms</li><li>Un-Health services(Apdex): Apdex性能指标，1为满分</li><li>Slow Endpoint：慢响应端点，单位ms</li><li>Global Response Latency：百分比响应延时，不同百分比的延时时间，单位ms</li><li>Global Heatmap：服务响应时间热力分布图，根据时间段内不同响应时间的数量显示颜色深度；</li></ul></li><li><p>Service：服务维度</p><p><img src="/images/SkyWalking-UI%E5%92%8C%E6%8C%87%E6%A0%87/image-20220612192802910.png"></p><ul><li><p>Service Apdex（数字）:当前服务的评分</p></li><li><p>Service Apdex（折线图）：不同时间的Apdex评分</p></li><li><p>Service Avg Response Times：平均响应延时，单位ms</p></li><li><p>Service Response Time Percentile：百分比响应延时</p></li><li><p>Successful Rate（数字）：请求成功率</p></li><li><p>Successful Rate（折线图）：不同时间的请求成功率</p></li><li><p>Servce Load（数字）：每分钟请求数</p></li><li><p>Servce Load（折线图）：不同时间的每分钟请求数</p></li><li><p>Servce Instances Load：每个服务实例的每分钟请求数</p></li></ul></li><li><p>Instance：实例维度</p><p><img src="/images/SkyWalking-UI%E5%92%8C%E6%8C%87%E6%A0%87/image-20220612193601535.png"></p><ul><li>对于CPU、内存的监控，Promethus更好一点</li><li>Service instance load：当前实例的每分钟请求数</li><li>Service Instance Successful Rate：当前实例的请求成功率</li><li>Service Instance Latency：当前实例的响应延时</li><li>JVM CPU：jvm占用CPU的百分比</li><li>JVM Memory：JVM内存占用大小，单位m</li><li>JVM GC Time：JVM垃圾回收时间，包含YGC和OGC</li><li>JVM GC Count：JVM垃圾回收次数，包含YGC和OGC</li><li>JVM Thread Count：JVM线程数</li><li>其他几个是.NET的，java无需关心</li></ul></li><li><p>Endpoint：端点维度</p><p><img src="/images/SkyWalking-UI%E5%92%8C%E6%8C%87%E6%A0%87/image-20220612193809206.png"></p><ul><li>Endpoint Load in Current Service：每个端点的每分钟请求数</li><li>Slow Endpoints in Current Service：每个端点的最慢请求时间，单位ms</li><li>Successful Rate in Current Service：每个端点的请求成功率</li><li>Endpoint Load：当前端点每个时间段的请求数据</li><li>Endpoint Avg Response Time：当前端点每个时间段的请求行响应时间</li><li>Endpoint Response Time Percentile：当前端点每个时间段的响应时间占比</li><li>Endpoint Successful Rate：当前端点每个时间段的请求成功率</li></ul></li><li><p>拓扑图</p><p><img src="/images/SkyWalking-UI%E5%92%8C%E6%8C%87%E6%A0%87/image-20220612194119321.png"></p><ul><li>服务间的关系和连接情况，可以从这里进去具体某个服务查看详情</li></ul></li><li><p>追踪</p><p><img src="/images/SkyWalking-UI%E5%92%8C%E6%8C%87%E6%A0%87/image-20220612194317281.png"></p><ul><li>左侧：接口列表，请求为红色表示异常，蓝色表示正常</li><li>右侧：追踪列表，api的各个连接点按照端点的先后顺序和时间排序</li></ul></li><li><p>性能剖析</p><p><img src="/images/SkyWalking-UI%E5%92%8C%E6%8C%87%E6%A0%87/image-20220612195816866.png"></p><ul><li>右上角，新建任务：新建需要分析的端点</li><li>左侧列表：对任务进行采样</li><li>右侧：每个端点的链路信息</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> SkyWalking </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SkyWalking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SkyWalking-SpringBoot</title>
      <link href="/skywalking/skywalking-springboot/"/>
      <url>/skywalking/skywalking-springboot/</url>
      
        <content type="html"><![CDATA[<h2 id="下载探针"><a href="#下载探针" class="headerlink" title="下载探针"></a>下载探针</h2><p>以8.5.0版本为例</p><ul><li>探针是集成到客户端系统中的代理或 SDK 库,收集并格式化数据后发送到后端。包括链路追踪和性能指标</li><li>下载地址：<a href="https://skywalking.apache.org/downloads/">https://skywalking.apache.org/downloads/</a></li><li><a href="https://archive.apache.org/dist/skywalking/8.5.0/">https://archive.apache.org/dist/skywalking/8.5.0/</a></li></ul><p><img src="/images/SkyWalking-SpringBoot/image-20220611173837627.png"></p><ul><li><p>解压</p><p><img src="/images/SkyWalking-SpringBoot/image-20220611174525345.png" alt="image-20220611174525345"></p></li><li><p>agent目录文件的介绍</p><ul><li>activations：插件包</li><li>bootstrap-plugins：插件包</li><li>config: 配置文件</li><li>logs：skywalking agent的相关运行日志</li><li>optional-plugins：插件包（可供选择的插件包，如果需要生效则需要拷贝到plugins包下）</li><li>optional-reporter-plugins：插件包</li><li>plugins：插件包（生效的插件包，支持多个框架链路追踪）</li><li>skywalking-agent.jar：agent代理的jar包）</li></ul></li><li><p>优先级：JVM配置 &gt; 环境变量配置 &gt; agent.config</p></li></ul><h2 id="编写一个SpringBoot测试项目"><a href="#编写一个SpringBoot测试项目" class="headerlink" title="编写一个SpringBoot测试项目"></a>编写一个SpringBoot测试项目</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/list"</span><span class="token punctuation">)</span>   <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token annotation punctuation">@Override</span>   <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">return</span> <span class="token function">getRandomUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRandomUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDO</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token keyword">int</span> i <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getUserDelayed</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>       <span class="token keyword">return</span> result<span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token keyword">private</span> <span class="token class-name">UserDO</span> <span class="token function">getUserDelayed</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">int</span> i <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">try</span> <span class="token punctuation">{</span>           <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>           e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>       <span class="token keyword">return</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="添加VM启动参数"><a href="#添加VM启动参数" class="headerlink" title="添加VM启动参数"></a>添加VM启动参数</h2><pre class="line-numbers language-none"><code class="language-none">-javaagent:D:\tool\apache-skywalking-apm-bin-es7\agent\skywalking-agent.jar -Dskywalking.agent.service_name=skywalking-learn -Dskywalking.collector.backend_service=192.168.80.128:11800<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/images/SkyWalking-SpringBoot/image-20220611214736976.png"></p><ul><li>agent.service_name：客户端服务名，在apm系统中显示的服务名称</li><li>collector.backend_service：SW上传的服务地址</li></ul><h2 id="查看效果"><a href="#查看效果" class="headerlink" title="查看效果"></a>查看效果</h2><ul><li><p>访问springboot服务的一个接口地址</p></li><li><p>查看sw-ui的页面：<a href="http://192.168.80.128:8080/">http://192.168.80.128:8080/</a></p><img src="/images/SkyWalking-SpringBoot/image-20220611215030563.png" alt="image-20220611215030563" style="zoom:80%;"></li></ul>]]></content>
      
      
      <categories>
          
          <category> SkyWalking </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SkyWalking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SkyWalking-安装</title>
      <link href="/skywalking/skywalking-an-zhuang/"/>
      <url>/skywalking/skywalking-an-zhuang/</url>
      
        <content type="html"><![CDATA[<h2 id="前置安装ES"><a href="#前置安装ES" class="headerlink" title="前置安装ES"></a>前置安装ES</h2><pre class="line-numbers language-none"><code class="language-none">mkdir -p /dockerData/elasticsearch/configmkdir -p /dockerData/elasticsearch/datachmod 777 -R /dockerData/elasticsearchecho "http.host: 0.0.0.0" &gt;&gt; /dockerData/elasticsearch/config/elasticsearch.ymldocker run -d --name elasticsearch --privileged=true -p 9200:9200 -p 9300:9300 \  -e "discovery.type=single-node" \  -e ES_JAVA_OPTS="-Xms1024m -Xmx1024m" \  -v /dockerData/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \  -v /dockerData/elasticsearch/data:/usr/share/elasticsearch/data \  -v /dockerData/elasticsearch/plugins:/usr/share/elasticsearch/plugins elasticsearch:7.16.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="安装Skywalking-OAP-Server"><a href="#安装Skywalking-OAP-Server" class="headerlink" title="安装Skywalking-OAP-Server"></a>安装Skywalking-OAP-Server</h2><pre class="line-numbers language-none"><code class="language-none">docker run -d --name skywalking-oap-server -p 12800:12800 -p 11800:11800 \  --link elasticsearch \  -e TZ=Asia/Shanghai \  -e SW_STORAGE=elasticsearch7 \  -e SW_STORAGE_ES_CLUSTER_NODES=elasticsearch:9200 \  apache/skywalking-oap-server:8.5.0-es7<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="安装Skywalking-UI"><a href="#安装Skywalking-UI" class="headerlink" title="安装Skywalking-UI"></a>安装Skywalking-UI</h2><pre class="line-numbers language-none"><code class="language-none">docker run -d --name skywalking-ui -p 8080:8080 \  --link skywalking-oap-server \  -e TZ=Asia/Shanghai \  -e SW_OAP_ADDRESS=skywalking-oap-server:12800 \  apache/skywalking-ui:8.5.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>查看UI界面：<a href="http://192.168.80.128:8080/">http://192.168.80.128:8080/</a></li><li>查看ES索引：<a href="http://192.168.80.128:9200/_cat/indices?v=true&amp;pretty">http://192.168.80.128:9200/_cat/indices?v=true&amp;pretty</a></li></ul><h2 id="Nginx代理11800RPC接口"><a href="#Nginx代理11800RPC接口" class="headerlink" title="Nginx代理11800RPC接口"></a>Nginx代理11800RPC接口</h2><ul><li>如果在客户端数据上报时访问不到oap服务，需要做代理转发，通过nginx rpc代理的方式实现</li></ul><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">upstream</span> grpcservers</span> <span class="token punctuation">{</span><span class="token directive"><span class="token keyword">server</span> 192.168.80.128:11800</span><span class="token punctuation">;</span> <span class="token comment"># Skywalking OAP 后端 11800 地址</span><span class="token punctuation">}</span><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>       <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">11800</span> http2</span><span class="token punctuation">;</span>       <span class="token directive"><span class="token keyword">server_name</span>  skywalking</span><span class="token punctuation">;</span>       <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span><span class="token directive"><span class="token keyword">grpc_pass</span> grpc://grpcservers</span><span class="token punctuation">;</span><span class="token punctuation">}</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> SkyWalking </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SkyWalking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx-部署SSL</title>
      <link href="/nginx/nginx-bu-shu-ssl/"/>
      <url>/nginx/nginx-bu-shu-ssl/</url>
      
        <content type="html"><![CDATA[<h2 id="获取证书"><a href="#获取证书" class="headerlink" title="获取证书"></a>获取证书</h2><ul><li><p>登录阿里云</p></li><li><p>搜索SSL</p></li><li><p>进去云盾证书服务页面，选择DV单域名证书</p><p><img src="/images/Nginx-%E9%83%A8%E7%BD%B2SSL/image-20220607003418788.png"></p></li><li><p>选择20，免费，点击购买</p></li><li><p>购买完成后，进入数字证书管理服务</p><p><img src="/images/Nginx-%E9%83%A8%E7%BD%B2SSL/image-20220607003744548.png"></p></li><li><p>绑定自己的域名，并提交审核</p></li><li><p>等状态变为已签发，点击下载</p><p><img src="/images/Nginx-%E9%83%A8%E7%BD%B2SSL/image-20220607003909327.png"></p></li><li><p>下载nginx版本的证书</p></li><li><p>在nginx的目录下创建cert的目录，上传证书，并解压</p></li><li><p>修改nginx配置</p></li></ul><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment">#user  nobody;</span><span class="token directive"><span class="token keyword">worker_processes</span>  <span class="token number">1</span></span><span class="token punctuation">;</span><span class="token comment">#error_log  logs/error.log;</span><span class="token comment">#error_log  logs/error.log  notice;</span><span class="token comment">#error_log  logs/error.log  info;</span><span class="token comment">#pid        logs/nginx.pid;</span><span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">worker_connections</span>  <span class="token number">1024</span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">include</span>       mime.types</span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">default_type</span>  application/octet-stream</span><span class="token punctuation">;</span>    <span class="token comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span>    <span class="token comment">#                  '$status $body_bytes_sent "$http_referer" '</span>    <span class="token comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span>    <span class="token comment">#access_log  logs/access.log  main;</span>    <span class="token directive"><span class="token keyword">sendfile</span>        <span class="token boolean">on</span></span><span class="token punctuation">;</span>    <span class="token comment">#tcp_nopush     on;</span>    <span class="token comment">#keepalive_timeout  0;</span>    <span class="token directive"><span class="token keyword">keepalive_timeout</span>  <span class="token number">65</span></span><span class="token punctuation">;</span>    <span class="token comment">#gzip  on;</span>    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">server_name</span>  aacopy.cn</span><span class="token punctuation">;</span><span class="token directive"><span class="token keyword">rewrite</span> ^(.*)$ https://$</span><span class="token punctuation">{</span>server_name<span class="token punctuation">}</span>$1 <span class="token directive"><span class="token keyword">permanent</span></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment"># HTTPS server</span>    <span class="token comment">#</span>    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">server_name</span>  aacopy.cn</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">ssl_certificate</span>      /usr/local/nginx/cert/7897869_aacopy.cn.pem</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">ssl_certificate_key</span>  /usr/local/nginx/cert/7897869_aacopy.cn.key</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">ssl_session_cache</span>    shared:SSL:1m</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">ssl_session_timeout</span>  <span class="token number">5m</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">ssl_ciphers</span>  HIGH:!aNULL:!MD5</span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">ssl_prefer_server_ciphers</span>  <span class="token boolean">on</span></span><span class="token punctuation">;</span>        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>            <span class="token directive"><span class="token keyword">root</span>   /aacopy/blog/aacopy</span><span class="token punctuation">;</span>            <span class="token directive"><span class="token keyword">index</span>  index.html index.htm</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>重启nginx</li></ul>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx-安装</title>
      <link href="/nginx/nginx-an-zhuang/"/>
      <url>/nginx/nginx-an-zhuang/</url>
      
        <content type="html"><![CDATA[<ul><li>下载稳定版本安装包，<a href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a></li><li>例如：<a href="https://nginx.org/download/nginx-1.22.0.tar.gz">https://nginx.org/download/nginx-1.22.0.tar.gz</a></li><li>上传nginx-1.22.0.tar.gz至/usr/local/src包下</li><li><code>tar -zxvf nginx-1.22.0.tar.gz</code> 解压</li><li><code>cd nginx-1.22.0</code></li><li><code>./configure --with-http_stub_status_module --with-http_ssl_module</code></li><li><code>make &amp; make install</code></li><li><code>/usr/local/nginx/sbin/nginx -v</code></li><li>启动<code>/usr/local/nginx/sbin/nginx</code></li></ul>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git-安装Linux</title>
      <link href="/git/git-an-zhuang-linux/"/>
      <url>/git/git-an-zhuang-linux/</url>
      
        <content type="html"><![CDATA[<h2 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h2><p>下载文件</p><p><a href="https://git-scm.com/download/linux">https://git-scm.com/download/linux</a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ul><li><code>yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel</code></li><li><code>yum install gcc perl-ExtUtils-MakeMaker</code></li><li><code>rz</code> 上传至<code>/usr/local</code>目录下</li><li><code>tar -zxvf git-2.36.1.tar.gz</code>  解压缩</li><li><code>cd git-2.36.1</code>  进入目录</li><li><code>./configure --prefix=/usr/local/git-2.36.1</code>  预编译</li><li><code>make &amp;&amp; make install</code>  编译并安装</li><li><code>ln -s /usr/local/git-2.36.1/bin/* /usr/bin/</code>  将git命令软连接到/usr/bin目录下</li></ul><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><code>git --help</code></p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul><li><code>git config --global user.email "969312613@qq.com"</code></li><li><code>git config --global user.name "cmyang"</code></li></ul><p>查看配置：<code>git config --list</code></p>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Druid-性能监控</title>
      <link href="/mysql/druid-xing-neng-jian-kong/"/>
      <url>/mysql/druid-xing-neng-jian-kong/</url>
      
        <content type="html"><![CDATA[<h2 id="引入maven依赖"><a href="#引入maven依赖" class="headerlink" title="引入maven依赖"></a>引入maven依赖</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.4.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="添加配置文件"><a href="#添加配置文件" class="headerlink" title="添加配置文件"></a>添加配置文件</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource    <span class="token key atrule">druid</span><span class="token punctuation">:</span>      <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat      <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver      <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.80.128<span class="token punctuation">:</span>3306/learn_mysql<span class="token punctuation">?</span>charset=utf8mb4<span class="token important">&amp;useSSL=false</span>      <span class="token key atrule">username</span><span class="token punctuation">:</span> root      <span class="token key atrule">password</span><span class="token punctuation">:</span> aacopy.cn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="编写druid配置类"><a href="#编写druid配置类" class="headerlink" title="编写druid配置类"></a>编写druid配置类</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DruidConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">ServletRegistrationBean</span> <span class="token function">druidServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">ServletRegistrationBean</span> servletRegistrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletRegistrationBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        servletRegistrationBean<span class="token punctuation">.</span><span class="token function">setServlet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StatViewServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        servletRegistrationBean<span class="token punctuation">.</span><span class="token function">addUrlMappings</span><span class="token punctuation">(</span><span class="token string">"/druid/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> initParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        initParameters<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"loginUsername"</span><span class="token punctuation">,</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 用户名</span>        initParameters<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"loginPassword"</span><span class="token punctuation">,</span> <span class="token string">"aacopy.cn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 密码</span>        initParameters<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"resetEnable"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 禁用HTML页面上的“Reset All”功能</span>        servletRegistrationBean<span class="token punctuation">.</span><span class="token function">setInitParameters</span><span class="token punctuation">(</span>initParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> servletRegistrationBean<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">FilterRegistrationBean</span> <span class="token function">filterRegistrationBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">FilterRegistrationBean</span> filterRegistrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterRegistrationBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        filterRegistrationBean<span class="token punctuation">.</span><span class="token function">setFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebStatFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        filterRegistrationBean<span class="token punctuation">.</span><span class="token function">addUrlPatterns</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        filterRegistrationBean<span class="token punctuation">.</span><span class="token function">addInitParameter</span><span class="token punctuation">(</span><span class="token string">"exclusions"</span><span class="token punctuation">,</span> <span class="token string">"*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> filterRegistrationBean<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="编写测试代码"><a href="#编写测试代码" class="headerlink" title="编写测试代码"></a>编写测试代码</h2><p>编写测试代码，在数据库创建测试表，录入测试数据</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/find_users"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">findUsers</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>访问：<a href="http://127.0.0.1:8080/user/find_users?name=Yang">http://127.0.0.1:8080/user/find_users?name=Yang</a></p><p>打开监控页面：<a href="http://127.0.0.1:8080/druid/login.html">http://127.0.0.1:8080/druid/login.html</a></p><p>账号：admin 密码：aacopy.cn</p><p><img src="/../../images/Druid-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7/image-20220528224742783.png" alt="image-20220528224742783"></p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
            <tag> Druid </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式-UML</title>
      <link href="/she-ji-mo-shi/she-ji-mo-shi-uml/"/>
      <url>/she-ji-mo-shi/she-ji-mo-shi-uml/</url>
      
        <content type="html"><![CDATA[<p>UML (Unified modeling language) 是一个统一建模语言</p><p>UML本身是一套符号的规定，这些符号用于描述软件模块之前的关系，比如：类，接口，实现，泛型，依赖，组合，聚合等</p><p>类之间的关系</p><p>依赖、继承、实现、关联、聚合、组合</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式-HelloWorld</title>
      <link href="/she-ji-mo-shi/she-ji-mo-shi-helloworld/"/>
      <url>/she-ji-mo-shi/she-ji-mo-shi-helloworld/</url>
      
        <content type="html"><![CDATA[<p>​设计模式是对软件设计过程中普遍存在（反复出现）的各种问题，所提出的解决方案</p><h2 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h2><p>设计模式可以让程序在以下方面做的更好</p><ul><li>代码重用性</li><li>代码可读性</li><li>可扩展性</li><li>可靠性</li><li>使程序具有高内聚，低耦合和特性</li></ul><h2 id="七大原则"><a href="#七大原则" class="headerlink" title="七大原则"></a>七大原则</h2><p>要是设计具备以上有点，需要具备七大原则</p><ul><li>单一职责原则</li><li>接口隔离原则</li><li>依赖倒转原则</li><li>里氏替换原则</li><li>开闭原则</li><li>迪米特法则</li><li>合成复用原则</li></ul><h3 id="单一职责原则"><a href="#单一职责原则" class="headerlink" title="单一职责原则"></a>单一职责原则</h3><p>一个类应该只负责一个职责</p><ul><li>降低类的复杂度，一个类只负责一项职责</li><li>提高类的可读性，可维护性</li><li>降低变更引起的风险</li></ul><h3 id="接口隔离原则"><a href="#接口隔离原则" class="headerlink" title="接口隔离原则"></a>接口隔离原则</h3><p>一个类与另外一个类的依赖应该建立在最小的接口</p><h3 id="依赖倒转原则"><a href="#依赖倒转原则" class="headerlink" title="依赖倒转原则"></a>依赖倒转原则</h3><ul><li>高层模块不应该依赖底层模块</li><li>抽象不应该依赖细节，细节应该依赖抽象</li><li>中心思想是面向接口编程</li><li>抽象是指接口和抽象类，细节指实现类</li><li>接口和抽象的目的是定制好规范</li><li>实现方式<ul><li>通过接口作为参数实现依赖</li><li>通过构造器参数</li><li>通过setter方法</li></ul></li></ul><h3 id="里氏替换原则"><a href="#里氏替换原则" class="headerlink" title="里氏替换原则"></a>里氏替换原则</h3><ul><li>在使用继承时，子类尽量不要重写父类的方法</li><li>继承实际上增加了类的耦合性，在适当的情况下可以通过聚合，组合，依赖来解决问题</li></ul><h3 id="开闭原则"><a href="#开闭原则" class="headerlink" title="开闭原则"></a>开闭原则</h3><ul><li>类，方法，或者实体，应该对提供方扩展开放，对使用方修改关闭，用抽象构建框架，用实现扩展细节</li><li>在软件需要变化时，尽量通过扩展来实现，而不是修改原有代码</li></ul><h3 id="迪米特法则"><a href="#迪米特法则" class="headerlink" title="迪米特法则"></a>迪米特法则</h3><ul><li>最少知道原则，一个类自己依赖的类知道的越少越好</li><li>最好只与成员变量，方法参数，返回值对应的类交互</li></ul><h3 id="合成复用原则"><a href="#合成复用原则" class="headerlink" title="合成复用原则"></a>合成复用原则</h3><ul><li>尽量使用合成/聚合的方式，而不是使用继承</li></ul><h2 id="设计原则核心思想"><a href="#设计原则核心思想" class="headerlink" title="设计原则核心思想"></a>设计原则核心思想</h2><ul><li>找出代码中可能变化的地方，独立出去，不要与不变的代码混在一起</li><li>面向接口编程，而不是针对实现编程</li><li>努力实现交互对象之前的松耦合</li></ul>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JWT</title>
      <link href="/util/jwt/"/>
      <url>/util/jwt/</url>
      
        <content type="html"><![CDATA[<ul><li><p>JWT 是一个开放标准，它定义了一种用于简洁，自包含的用于通信双方之间以 JSON 对象的形式安全传递信息的方法。 可以使用 HMAC 算法或者是 RSA 的公钥密钥对进行签名。</p></li><li><p>优点</p><ul><li>生产的token可以包含基本信息，比如id、用户昵称、头像等信息，避免再次查库</li><li>存储在客户端，不占用服务端的内存资源</li></ul></li><li><p>缺点</p><ul><li><p>token是经过base64编码，所以可以解码，因此token加密前的对象不应该包含敏感信息，如用户权限，密码等</p></li><li><p>如果没有服务端存储，则不能做登录失效处理，除非服务端改秘钥</p></li></ul></li><li><p>JWT格式组成 头部、负载、签名 header+payload+signature</p><ul><li>头部：主要是描述签名算法</li><li>负载：主要描述是加密对象的信息，如用户的id等，也可以加些规范里面的东西，如iss签发者，exp 过期时间，sub 面向的用户</li><li>签名：主要是把前面两部分进行加密，防止别人拿到token进行base解密后篡改token</li></ul></li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JWTUtil</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 主题     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SUBJECT</span> <span class="token operator">=</span> <span class="token string">"aacopy"</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 加密密钥     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECRET</span> <span class="token operator">=</span> <span class="token string">"aacopy.cn"</span><span class="token punctuation">;</span>    <span class="token comment">/**     * token过期时间，7天     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">EXPIRED</span> <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 生产token     * @param loginUser     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token class-name">LoginUser</span> loginUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token constant">SUBJECT</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">"head_img"</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getHeadImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">"account_no"</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getAccountNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">"mail"</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">"phone"</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">"auth"</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">EXPIRED</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">,</span> <span class="token constant">SECRET</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> token<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 校验token     * @param token     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">LoginUser</span> <span class="token function">checkToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span><span class="token constant">SECRET</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>claims <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Long</span> accountNo <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"account_no"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> headImg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"head_img"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> mail <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"mail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> phone <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"phone"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> auth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"auth"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token class-name">LoginUser</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">accountNo</span><span class="token punctuation">(</span>accountNo<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">phone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">headImg</span><span class="token punctuation">(</span>headImg<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">mail</span><span class="token punctuation">(</span>mail<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> loginUser<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>登录拦截器</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginUser</span><span class="token punctuation">&gt;</span></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">OPTIONS</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">NO_CONTENT</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> accessToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            accessToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token class-name">JWTUtil</span><span class="token punctuation">.</span><span class="token function">checkToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>loginUser <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">postHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> modelAndView<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        threadLocal<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>拦截器配置</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterceptorConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment">//添加拦截的路径</span>                <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/api/account/*/**"</span><span class="token punctuation">,</span> <span class="token string">"/api/traffic/*/**"</span><span class="token punctuation">)</span>                <span class="token comment">//排除不拦截</span>                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span>                        <span class="token string">"/api/account/*/register"</span><span class="token punctuation">,</span><span class="token string">"/api/account/*/upload"</span><span class="token punctuation">,</span><span class="token string">"/api/account/*/login"</span><span class="token punctuation">,</span>                        <span class="token string">"/api/notify/*/captcha"</span><span class="token punctuation">,</span><span class="token string">"/api/notify/*/send_code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> Util </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Util </tag>
            
            <tag> JWT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MinIO-Client</title>
      <link href="/minio/minio-client/"/>
      <url>/minio/minio-client/</url>
      
        <content type="html"><![CDATA[<p>在Java中使用minio</p><ul><li><p>导入依赖</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.minio<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>minio<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.2.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>MinioConfig</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MinioConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${minio.endpoint}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> endpoint<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${minio.accessKey}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> accessKey<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${minio.secretKey}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> secretKey<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">MinioClient</span> <span class="token function">minioClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name">MinioClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">credentials</span><span class="token punctuation">(</span>accessKey<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>FileComponent</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileComponent</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">MinioClient</span> minioClient<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${minio.defaultBucket}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> defaultBucket<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${minio.endpoint}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> endpoint<span class="token punctuation">;</span>    <span class="token comment">/**     * 上传文件     * @param multipartFile     */</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> multipartFile<span class="token punctuation">,</span> <span class="token class-name">String</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">PutObjectArgs</span> putObjectArgs <span class="token operator">=</span> <span class="token class-name">PutObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>defaultBucket<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>multipartFile<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> multipartFile<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span>multipartFile<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">ObjectWriteResponse</span> objectWriteResponse <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>putObjectArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>objectWriteResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> endpoint<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>defaultBucket<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>filename<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BizException</span><span class="token punctuation">(</span><span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span><span class="token constant">FILE_UPLOAD_FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">download</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>                <span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>defaultBucket<span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>配置文件</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">minio</span><span class="token punctuation">:</span>  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.80.128<span class="token punctuation">:</span><span class="token number">9000</span>  <span class="token key atrule">accessKey</span><span class="token punctuation">:</span> root  <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> aacopy.cn  <span class="token key atrule">defaultBucket</span><span class="token punctuation">:</span> test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>测试接口</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/user_img/upload"</span><span class="token punctuation">)</span>   <span class="token keyword">public</span> <span class="token class-name">JsonData</span> <span class="token function">uploadUserImg</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">return</span> <span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">buildSuccess</span><span class="token punctuation">(</span>accountService<span class="token punctuation">.</span><span class="token function">uploadUserImg</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>accountService</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">uploadUserImg</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token class-name">DateTimeFormatter</span> dateTimeFormatter <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy/MM/dd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token class-name">String</span> folder <span class="token operator">=</span> <span class="token string">"user/"</span> <span class="token operator">+</span> dateTimeFormatter<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token class-name">String</span> filename <span class="token operator">=</span> <span class="token class-name">CommonUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token class-name">String</span> originalFilename <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token class-name">String</span> extension <span class="token operator">=</span> originalFilename<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>originalFilename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token class-name">String</span> wholeFilename <span class="token operator">=</span> folder <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> filename <span class="token operator">+</span> extension<span class="token punctuation">;</span>       <span class="token keyword">return</span> fileComponent<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> wholeFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> MinIO </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MinIO </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sentinel-Nacos规则配置持久化</title>
      <link href="/springcloud/sentinel-nacos-gui-ze-pei-zhi-chi-jiu-hua/"/>
      <url>/springcloud/sentinel-nacos-gui-ze-pei-zhi-chi-jiu-hua/</url>
      
        <content type="html"><![CDATA[<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ul><li><p>Sentinel默认在控制台（Dashboard）中添加流控降级规则后，将配置规则信息推送给Sentinel客户端，配置的规则记录在内存中，如果客户端重启，规则也就丢失。</p><p><img src="/images/Sentinel-Nacos%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE%E6%8C%81%E4%B9%85%E5%8C%96/202203171.png"></p></li><li><p>Sentinel的流控规则持久化到nacos中，并且在Sentinel控制台中修改流控规则，需要同步修改nacos的值，并且服务立即生效</p></li></ul><h2 id="官方相关文档："><a href="#官方相关文档：" class="headerlink" title="官方相关文档："></a>官方相关文档：</h2><ul><li><p>动态规则扩展：<a href="https://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95">https://github.com/alibaba/Sentinel/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95</a></p></li><li><p>在生产环境中使用 Sentinel：<a href="https://github.com/alibaba/Sentinel/wiki/%E5%9C%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E4%BD%BF%E7%94%A8-Sentinel">https://github.com/alibaba/Sentinel/wiki/%E5%9C%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E4%BD%BF%E7%94%A8-Sentinel</a></p></li><li><p>Sentinel 控制台（集群流控管理）：<a href="https://github.com/alibaba/Sentinel/wiki/Sentinel-%E6%8E%A7%E5%88%B6%E5%8F%B0%EF%BC%88%E9%9B%86%E7%BE%A4%E6%B5%81%E6%8E%A7%E7%AE%A1%E7%90%86%EF%BC%89#%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE">https://github.com/alibaba/Sentinel/wiki/Sentinel-%E6%8E%A7%E5%88%B6%E5%8F%B0%EF%BC%88%E9%9B%86%E7%BE%A4%E6%B5%81%E6%8E%A7%E7%AE%A1%E7%90%86%EF%BC%89#%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE</a></p></li><li><p>示例代码：<a href="https://github.com/alibaba/Sentinel/blob/master/sentinel-demo/sentinel-demo-nacos-datasource/src/main/java/com/alibaba/csp/sentinel/demo/datasource/nacos/NacosDataSourceDemo.java">https://github.com/alibaba/Sentinel/blob/master/sentinel-demo/sentinel-demo-nacos-datasource/src/main/java/com/alibaba/csp/sentinel/demo/datasource/nacos/NacosDataSourceDemo.java</a></p></li></ul><h2 id="方案：DataSource-扩展"><a href="#方案：DataSource-扩展" class="headerlink" title="方案：DataSource 扩展"></a>方案：DataSource 扩展</h2><p>官方推荐：通过控制台设置规则后将规则推送到统一的规则中心（Nacos、Zookeepe），客户端实现 <code>ReadableDataSource</code> 接口端监听规则中心实时获取变更</p><p><img src="/images/Sentinel-Nacos%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE%E6%8C%81%E4%B9%85%E5%8C%96/45406233-645e8380-b698-11e8-8199-0c917403238f.png"></p><p><strong>客户端部分：（实现上图 2，3步骤）</strong></p><ul><li><p>最简单的方式是继承 <a href="https://github.com/alibaba/Sentinel/blob/master/sentinel-extension/sentinel-datasource-extension/src/main/java/com/alibaba/csp/sentinel/datasource/AbstractDataSource.java">AbstractDataSource</a> 抽象类，该抽象类已经实现了ReadableDataSource接口，在其构造方法中添加监听器，并实现 <code>readSource()</code> 从指定数据源读取字符串格式的配置数据。</p></li><li><p>目前官方已经实现了基于Nacos的数据源，<a href="https://github.com/alibaba/Sentinel/blob/master/sentinel-extension/sentinel-datasource-nacos/src/main/java/com/alibaba/csp/sentinel/datasource/nacos/NacosDataSource.java">NacosDataSource</a>，这个类继承了抽象类<code>AbstractDataSource</code>。</p></li><li><p>客户端只需要引入<code>sentinel-datasource-nacos</code>依赖</p></li><li><p>通过Nacos配置参数创建<code>NacosDataSource</code>数据源对象，并且将该数据源注册到指定的规则管理器中，如下将Nacos数据源注册到流控规则管理器中</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ReadableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> flowRuleDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NacosDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">,</span> groupId<span class="token punctuation">,</span> dataId<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">register2Property</span><span class="token punctuation">(</span>flowRuleDataSource<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>该操作可以放在spring容器启动完成后，执行注册操作。</p></li></ul><p><strong>控制台部分：（实现上图1步骤）</strong></p><ul><li><p>Sentinel 控制台提供 <code>DynamicRulePublisher</code>（推送规则） 和 <code>DynamicRuleProvider</code> （拉取规则）接口用于实现应用维度的规则推送和拉取</p></li><li><p>官方提供了流程规则的示例代码，参照示例代码，对降级，热点，系统，权限做相应的改造</p></li><li><p>官方提供了 Nacos、ZooKeeper 和 Apollo 的推送和拉取规则实现示例（位于 <code>test</code> 目录下）</p></li><li><p>以 Nacos 为例，只需在 FlowControllerV2 中指定对应Nacos的 bean 即可开启 Nacos 适配。前端页面需要手动切换，或者修改前端路由配置（sidebar.html 流控规则路由从 dashboard.flowV1 改成 dashboard.flow 即可，簇点链路页面对话框需要自行改造</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"flowRuleNacosProvider"</span><span class="token punctuation">)</span><span class="token keyword">private</span> <span class="token class-name">DynamicRuleProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ruleProvider<span class="token punctuation">;</span><span class="token annotation punctuation">@Autowired</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"flowRuleNacosPublisher"</span><span class="token punctuation">)</span><span class="token keyword">private</span> <span class="token class-name">DynamicRulePublisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> rulePublisher<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>默认 Nacos 适配的 dataId 和 groupId 约定如下：</p><ul><li>groupId: <code>SENTINEL_GROUP</code></li><li>流控规则 dataId: <code>{appName}-flow-rules</code>，比如应用名为 appA，则 dataId 为 appA-flow-rules</li><li>这些约定配置<code>NacosConfigUtil</code>类中定义</li><li>扩展的降级，热点，系统，权限等这些配置就需要在这里定义</li></ul></li><li><p>官方还提供了String和流控规则对象转换类，在<code>NacosConfig</code>类中，在做扩展时也需要将其他规则转换器注册到spring容器中，在controller操作时需要用到</p></li></ul><h2 id="控制台Dashboard改造"><a href="#控制台Dashboard改造" class="headerlink" title="控制台Dashboard改造"></a>控制台Dashboard改造</h2><h3 id="下载控制台源码"><a href="#下载控制台源码" class="headerlink" title="下载控制台源码"></a>下载控制台源码</h3><p>根据项目具体版本获取对应的源码，本笔记使用1.7.1版本</p><p>github地址：<a href="https://github.com/alibaba/Sentinel">https://github.com/alibaba/Sentinel</a></p><p>克隆：<a href="https://github.com/alibaba/Sentinel.git">https://github.com/alibaba/Sentinel.git</a></p><p>切换到tag1.7.1的代码</p><h3 id="修改控制台代码sentinel-dashboard"><a href="#修改控制台代码sentinel-dashboard" class="headerlink" title="修改控制台代码sentinel-dashboard"></a>修改控制台代码sentinel-dashboard</h3><ol><li><p>修改pom.xml</p><ul><li><p>找到<code>&lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;</code></p></li><li><p>将<code>&lt;scope&gt;test&lt;/scope&gt;</code>删掉</p><p><img src="/images/Sentinel-Nacos%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE%E6%8C%81%E4%B9%85%E5%8C%96/image-20220316021805277.png"></p></li></ul></li><li><p>在test目录下</p><ul><li><p>将com.alibaba.csp.sentinel.dashboard.rule.nacos文件夹复制到main对应的目录下</p><img src="/images/Sentinel-Nacos%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE%E6%8C%81%E4%B9%85%E5%8C%96/image-20220316022119911.png" alt="image-20220316022119911" style="zoom: 67%;"></li></ul></li><li><p>修改<code>com.alibaba.csp.sentinel.dashboard.rule.nacos.NacosConfig</code>文件</p><p>nacos的地址从配置文件获取，同时将降级，热点，系统，权限转换器注入到spring容器中</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${nacos.server-addr:localhost}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> serverAddr<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">flowRuleEntityEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token operator">::</span><span class="token function">toJSONString</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">flowRuleEntityDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> s <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">FlowRuleEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">AuthorityRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">authorityRuleEntityEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token operator">::</span><span class="token function">toJSONString</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">AuthorityRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">authorityRuleEntityDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> s <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">AuthorityRuleEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">degradeRuleEntityEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token operator">::</span><span class="token function">toJSONString</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">degradeRuleEntityDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> s <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ParamFlowRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">paramFlowRuleEntityEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token operator">::</span><span class="token function">toJSONString</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ParamFlowRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">paramFlowRuleEntityDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> s <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">ParamFlowRuleEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SystemRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">systemRuleEntityEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token operator">::</span><span class="token function">toJSONString</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SystemRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">systemRuleEntityDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> s <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">SystemRuleEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">ConfigService</span> <span class="token function">nacosConfigService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name">ConfigFactory</span><span class="token punctuation">.</span><span class="token function">createConfigService</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>约定nacos配置项定义，修改<code>NacosConfigUtil</code></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NacosConfigUtil</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GROUP_ID</span> <span class="token operator">=</span> <span class="token string">"SENTINEL_GROUP"</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">FLOW_DATA_ID_POSTFIX</span> <span class="token operator">=</span> <span class="token string">"-flow-rules"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEGRADE_DATA_ID_POSTFIX</span> <span class="token operator">=</span> <span class="token string">"-degrade-rules"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PARAM_FLOW_DATA_ID_POSTFIX</span> <span class="token operator">=</span> <span class="token string">"-param-rules"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SYSTEM_DATA_ID_POSTFIX</span> <span class="token operator">=</span> <span class="token string">"-system-rules"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">AUTHORITY_DATA_ID_POSTFIX</span> <span class="token operator">=</span> <span class="token string">"-authority-rules"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CLUSTER_MAP_DATA_ID_POSTFIX</span> <span class="token operator">=</span> <span class="token string">"-cluster-map"</span><span class="token punctuation">;</span>    <span class="token comment">/**     * cc for `cluster-client`     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CLIENT_CONFIG_DATA_ID_POSTFIX</span> <span class="token operator">=</span> <span class="token string">"-cc-config"</span><span class="token punctuation">;</span>    <span class="token comment">/**     * cs for `cluster-server`     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SERVER_TRANSPORT_CONFIG_DATA_ID_POSTFIX</span> <span class="token operator">=</span> <span class="token string">"-cs-transport-config"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SERVER_FLOW_CONFIG_DATA_ID_POSTFIX</span> <span class="token operator">=</span> <span class="token string">"-cs-flow-config"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SERVER_NAMESPACE_SET_DATA_ID_POSTFIX</span> <span class="token operator">=</span> <span class="token string">"-cs-namespace-set"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">NacosConfigUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>application.properties</code>配置文件中添加配置</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">nacos.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.80.128:8848</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><h3 id="流控规则"><a href="#流控规则" class="headerlink" title="流控规则"></a>流控规则</h3><p>流控规则官方文档中已经讲了一部分，参照文档进行改造。</p><ol><li><p>修改<code>com.alibaba.csp.sentinel.dashboard.controller.v2.FlowControllerV2</code>文件</p><p>bean使用nacos</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>   <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"flowRuleNacosProvider"</span><span class="token punctuation">)</span>   <span class="token keyword">private</span> <span class="token class-name">DynamicRuleProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ruleProvider<span class="token punctuation">;</span>   <span class="token annotation punctuation">@Autowired</span>   <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"flowRuleNacosPublisher"</span><span class="token punctuation">)</span>   <span class="token keyword">private</span> <span class="token class-name">DynamicRulePublisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> rulePublisher<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>搜索<code>sidebar.html</code>文件，找关键字<code>flowV1</code>，改为<code>flow</code></p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">ui-sref-active</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>active<span class="token punctuation">"</span></span> <span class="token attr-name">ng-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>!entry.isGateway<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">ui-sref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dashboard.flow({app: entry.app})<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>glyphicon glyphicon-filter<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>流控规则<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>搜索<code>identity.js</code>文件，找关键字<code>FlowServiceV1</code>，改为<code>FlowServiceV2</code></p></li></ol><h3 id="降级规则"><a href="#降级规则" class="headerlink" title="降级规则"></a>降级规则</h3><p>因为官方只有流控规则的改造说明，降级规则需要自己完成，可以参考流控规则<code>FlowControllerV1</code>到<code>FlowControllerV2</code>版本的变动，做一下改造。</p><p><strong>核心思路</strong>：</p><ul><li>实现<code>DynamicRulePublisher</code>（推送规则） 接口，实现<code>publish</code>方法，用于规则推送配置中心，通过Nacos的<code>configService</code>的<code>publishConfig</code>方法实现</li><li>实现<code>DynamicRuleProvider</code> （拉取规则）接口，实现getRules方法，用于规则拉取，通过Nacos的<code>configService</code>的<code>getConfig</code>方法实现</li><li>在Controller中，获取规则的方法中将原来拉去规则的地方改为<code>dynamicRuleProvider.getRules(app);</code>方式</li><li>在保存修改删除规则方法中，同步推送到配置中心<code>dynamicRulePublisher.publish(app, rules);</code></li></ul><p><strong>代码实现</strong>：</p><ol><li><p>推送实现类<code>DegradeRuleNacosPublisher</code></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DegradeRuleNacosPublisher</span> <span class="token keyword">implements</span> <span class="token class-name">DynamicRulePublisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">ConfigService</span> configService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> converter<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">String</span> app<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span></span> rules<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">AssertUtil</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token string">"app name cannot be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>rules <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        configService<span class="token punctuation">.</span><span class="token function">publishConfig</span><span class="token punctuation">(</span>app <span class="token operator">+</span> <span class="token class-name">NacosConfigUtil</span><span class="token punctuation">.</span><span class="token constant">DEGRADE_DATA_ID_POSTFIX</span><span class="token punctuation">,</span>            <span class="token class-name">NacosConfigUtil</span><span class="token punctuation">.</span><span class="token constant">GROUP_ID</span><span class="token punctuation">,</span> converter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>拉取实现类<code>DegradeRuleNacosProvider</code></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DegradeRuleNacosProvider</span> <span class="token keyword">implements</span> <span class="token class-name">DynamicRuleProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">ConfigService</span> configService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> converter<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRules</span><span class="token punctuation">(</span><span class="token class-name">String</span> appName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> rules <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>appName <span class="token operator">+</span> <span class="token class-name">NacosConfigUtil</span><span class="token punctuation">.</span><span class="token constant">DEGRADE_DATA_ID_POSTFIX</span><span class="token punctuation">,</span>            <span class="token class-name">NacosConfigUtil</span><span class="token punctuation">.</span><span class="token constant">GROUP_ID</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> converter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>DegradeController</code></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Controller</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/degrade"</span><span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DegradeController</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DegradeController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">InMemoryRuleRepositoryAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span></span> repository<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">DynamicRuleProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ruleProvider<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">DynamicRulePublisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> rulePublisher<span class="token punctuation">;</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/rules.json"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@AuthAction</span><span class="token punctuation">(</span><span class="token class-name">PrivilegeType</span><span class="token punctuation">.</span><span class="token constant">READ_RULE</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryMachineRules</span><span class="token punctuation">(</span><span class="token class-name">String</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"app can't be null or empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> ruleProvider<span class="token punctuation">.</span><span class="token function">getRules</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>            rules <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofSuccess</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"queryApps error:"</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofThrowable</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/new.json"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@AuthAction</span><span class="token punctuation">(</span><span class="token class-name">PrivilegeType</span><span class="token punctuation">.</span><span class="token constant">WRITE_RULE</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span> app<span class="token punctuation">,</span> <span class="token class-name">String</span> ip<span class="token punctuation">,</span> <span class="token class-name">Integer</span> port<span class="token punctuation">,</span> <span class="token class-name">String</span> limitApp<span class="token punctuation">,</span> <span class="token class-name">String</span> resource<span class="token punctuation">,</span>                                         <span class="token class-name">Double</span> count<span class="token punctuation">,</span> <span class="token class-name">Integer</span> timeWindow<span class="token punctuation">,</span> <span class="token class-name">Integer</span> grade<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"app can't be null or empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"ip can't be null or empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>port <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"port can't be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"limitApp can't be null or empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"resource can't be null or empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"count can't be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeWindow <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"timeWindow can't be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>grade <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"grade can't be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>grade <span class="token operator">&lt;</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">DEGRADE_GRADE_RT</span> <span class="token operator">||</span> grade <span class="token operator">&gt;</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">DEGRADE_GRADE_EXCEPTION_COUNT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Invalid grade: "</span> <span class="token operator">+</span> grade<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">DegradeRuleEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        entity<span class="token punctuation">.</span><span class="token function">setApp</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        entity<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>ip<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        entity<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>        entity<span class="token punctuation">.</span><span class="token function">setLimitApp</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        entity<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        entity<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>        entity<span class="token punctuation">.</span><span class="token function">setTimeWindow</span><span class="token punctuation">(</span>timeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>        entity<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        entity<span class="token punctuation">.</span><span class="token function">setGmtCreate</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>        entity<span class="token punctuation">.</span><span class="token function">setGmtModified</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            entity <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">publishRules</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to add degrade rule"</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofThrowable</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofSuccess</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/save.json"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@AuthAction</span><span class="token punctuation">(</span><span class="token class-name">PrivilegeType</span><span class="token punctuation">.</span><span class="token constant">WRITE_RULE</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">updateIfNotNull</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> app<span class="token punctuation">,</span> <span class="token class-name">String</span> limitApp<span class="token punctuation">,</span> <span class="token class-name">String</span> resource<span class="token punctuation">,</span>                                                     <span class="token class-name">Double</span> count<span class="token punctuation">,</span> <span class="token class-name">Integer</span> timeWindow<span class="token punctuation">,</span> <span class="token class-name">Integer</span> grade<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"id can't be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>grade <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>grade <span class="token operator">&lt;</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">DEGRADE_GRADE_RT</span> <span class="token operator">||</span> grade <span class="token operator">&gt;</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">DEGRADE_GRADE_EXCEPTION_COUNT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Invalid grade: "</span> <span class="token operator">+</span> grade<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token class-name">DegradeRuleEntity</span> entity <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"id "</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">" dose not exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            entity<span class="token punctuation">.</span><span class="token function">setApp</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            entity<span class="token punctuation">.</span><span class="token function">setLimitApp</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            entity<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            entity<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeWindow <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            entity<span class="token punctuation">.</span><span class="token function">setTimeWindow</span><span class="token punctuation">(</span>timeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>grade <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            entity<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        entity<span class="token punctuation">.</span><span class="token function">setGmtModified</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            entity <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"save entity fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">publishRules</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to update degrade rule"</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofThrowable</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofSuccess</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/delete.json"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@AuthAction</span><span class="token punctuation">(</span><span class="token class-name">PrivilegeType</span><span class="token punctuation">.</span><span class="token constant">DELETE_RULE</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"id can't be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">DegradeRuleEntity</span> oldEntity <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEntity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofSuccess</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            repository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">publishRules</span><span class="token punctuation">(</span>oldEntity<span class="token punctuation">.</span><span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofFail</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofSuccess</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">publishRules</span><span class="token punctuation">(</span><span class="token comment">/*@NonNull*/</span> <span class="token class-name">String</span> app<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRuleEntity</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">findAllByApp</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>        rulePublisher<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="热点，系统，权限规则"><a href="#热点，系统，权限规则" class="headerlink" title="热点，系统，权限规则"></a>热点，系统，权限规则</h3><p>改造方式和流控规则一样</p><h2 id="改造客户端"><a href="#改造客户端" class="headerlink" title="改造客户端"></a>改造客户端</h2><ol><li><p>添加依赖</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-datasource-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>添加配置信息</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">application</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> api<span class="token punctuation">-</span>gateway  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.80.128<span class="token punctuation">:</span><span class="token number">8848</span>    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>      <span class="token key atrule">transport</span><span class="token punctuation">:</span>        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">9001</span>      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>        <span class="token key atrule">flow</span><span class="token punctuation">:</span>          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.nacos.server<span class="token punctuation">-</span>addr<span class="token punctuation">}</span>            <span class="token key atrule">namespace</span><span class="token punctuation">:</span> public            <span class="token key atrule">group-id</span><span class="token punctuation">:</span> SENTINEL_GROUP            <span class="token key atrule">data-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>flow<span class="token punctuation">-</span>rules            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> flow        <span class="token key atrule">degrade</span><span class="token punctuation">:</span>          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.nacos.server<span class="token punctuation">-</span>addr<span class="token punctuation">}</span>            <span class="token key atrule">namespace</span><span class="token punctuation">:</span> public            <span class="token key atrule">group-id</span><span class="token punctuation">:</span> SENTINEL_GROUP            <span class="token key atrule">data-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>degrade<span class="token punctuation">-</span>rules            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> degrade        <span class="token key atrule">param</span><span class="token punctuation">:</span>          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.nacos.server<span class="token punctuation">-</span>addr<span class="token punctuation">}</span>            <span class="token key atrule">namespace</span><span class="token punctuation">:</span> public            <span class="token key atrule">group-id</span><span class="token punctuation">:</span> SENTINEL_GROUP            <span class="token key atrule">data-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>param<span class="token punctuation">-</span>rules            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> param<span class="token punctuation">-</span>flow        <span class="token key atrule">system</span><span class="token punctuation">:</span>          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.nacos.server<span class="token punctuation">-</span>addr<span class="token punctuation">}</span>            <span class="token key atrule">namespace</span><span class="token punctuation">:</span> public            <span class="token key atrule">group-id</span><span class="token punctuation">:</span> SENTINEL_GROUP            <span class="token key atrule">data-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>system<span class="token punctuation">-</span>rules            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> system        <span class="token key atrule">authority</span><span class="token punctuation">:</span>          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.nacos.server<span class="token punctuation">-</span>addr<span class="token punctuation">}</span>            <span class="token key atrule">namespace</span><span class="token punctuation">:</span> public            <span class="token key atrule">group-id</span><span class="token punctuation">:</span> SENTINEL_GROUP            <span class="token key atrule">data-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>authority<span class="token punctuation">-</span>rules            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> authority<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>添加初始化类，用于Sentinel规则持久化DataSource初始化，SentinelNacosDataSourceInit</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SentinelNacosDataSourceInit</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationRunner</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">SentinelProperties</span> sentinelProperties<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ApplicationArguments</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//获取配置文件中的规则信息</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DataSourcePropertiesConfiguration</span><span class="token punctuation">&gt;</span></span> datasource <span class="token operator">=</span> sentinelProperties<span class="token punctuation">.</span><span class="token function">getDatasource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>datasource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        datasource<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>ds <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">NacosDataSourceProperties</span> nacosDsp <span class="token operator">=</span> ds<span class="token punctuation">.</span><span class="token function">getNacos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>nacosDsp<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">//获取规则类型</span>                <span class="token class-name">RuleType</span> ruleType <span class="token operator">=</span> nacosDsp<span class="token punctuation">.</span><span class="token function">getRuleType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">switch</span> <span class="token punctuation">(</span>ruleType<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">case</span> <span class="token constant">FLOW</span><span class="token operator">:</span>                        <span class="token class-name">ReadableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> flowRuleDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NacosDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>nacosDsp<span class="token punctuation">.</span><span class="token function">getServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nacosDsp<span class="token punctuation">.</span><span class="token function">getGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nacosDsp<span class="token punctuation">.</span><span class="token function">getDataId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                source <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">register2Property</span><span class="token punctuation">(</span>flowRuleDataSource<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Sentinel 流控规则注册完成......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token keyword">case</span> <span class="token constant">DEGRADE</span><span class="token operator">:</span>                        <span class="token class-name">ReadableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> degradeRuleDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NacosDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>nacosDsp<span class="token punctuation">.</span><span class="token function">getServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nacosDsp<span class="token punctuation">.</span><span class="token function">getGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nacosDsp<span class="token punctuation">.</span><span class="token function">getDataId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                source <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">register2Property</span><span class="token punctuation">(</span>degradeRuleDataSource<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Sentinel 降级规则注册完成......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token keyword">case</span> <span class="token constant">PARAM_FLOW</span><span class="token operator">:</span>                        <span class="token class-name">ReadableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ParamFlowRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> paramFlowRuleDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NacosDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>nacosDsp<span class="token punctuation">.</span><span class="token function">getServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nacosDsp<span class="token punctuation">.</span><span class="token function">getGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nacosDsp<span class="token punctuation">.</span><span class="token function">getDataId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                source <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ParamFlowRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">ParamFlowRuleManager</span><span class="token punctuation">.</span><span class="token function">register2Property</span><span class="token punctuation">(</span>paramFlowRuleDataSource<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Sentinel 热点规则注册完成......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token keyword">case</span> <span class="token constant">SYSTEM</span><span class="token operator">:</span>                        <span class="token class-name">ReadableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SystemRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> systemRuleDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NacosDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>nacosDsp<span class="token punctuation">.</span><span class="token function">getServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nacosDsp<span class="token punctuation">.</span><span class="token function">getGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nacosDsp<span class="token punctuation">.</span><span class="token function">getDataId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                source <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SystemRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">SystemRuleManager</span><span class="token punctuation">.</span><span class="token function">register2Property</span><span class="token punctuation">(</span>systemRuleDataSource<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Sentinel 系统规则注册完成......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token keyword">case</span> <span class="token constant">AUTHORITY</span><span class="token operator">:</span>                        <span class="token class-name">ReadableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">AuthorityRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> authorityRuleDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NacosDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>nacosDsp<span class="token punctuation">.</span><span class="token function">getServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nacosDsp<span class="token punctuation">.</span><span class="token function">getGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nacosDsp<span class="token punctuation">.</span><span class="token function">getDataId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                source <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">AuthorityRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">AuthorityRuleManager</span><span class="token punctuation">.</span><span class="token function">register2Property</span><span class="token punctuation">(</span>authorityRuleDataSource<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Sentinel 授权规则注册完成......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token keyword">default</span><span class="token operator">:</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><ol><li>启动nacos</li><li>启动客户端</li><li>启动Sentinel控制台</li><li>请求客户端的接口，在控制台修改流控配置，查看nacos是否同步更新，测试流控是否生效</li></ol><h2 id="代码地址"><a href="#代码地址" class="headerlink" title="代码地址"></a>代码地址</h2><p><a href="https://gitee.com/aacopy/sentinel-dashboard.git">https://gitee.com/aacopy/sentinel-dashboard.git</a></p>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
            <tag> Sentinel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gateway-自定义负载均衡</title>
      <link href="/springcloud/gateway-zi-ding-yi-fu-zai-jun-heng/"/>
      <url>/springcloud/gateway-zi-ding-yi-fu-zai-jun-heng/</url>
      
        <content type="html"><![CDATA[<h2 id="需求："><a href="#需求：" class="headerlink" title="需求："></a>需求：</h2><p>多人开发同一个微服务时，同时注册了多个相同的服务在注册中心上，通过网关调用服务时，不希望由自带的负载均衡路由，需要调到指定的服务，通过在请求头里加上version标识，在网关路由转发时，只要请求头里的标识和注册到nacos上的服务元数据内的标识匹配就路由到该服务</p><h2 id="代码实现："><a href="#代码实现：" class="headerlink" title="代码实现："></a>代码实现：</h2><ol><li><p>首先为了避免新增或减少一个微服务，需要修改gateway的配置文件和重启服务，使用spring约定大于配置的思想，加上通用的服务发现配置，gateway自己根据请求的名称，去注册中心匹配对应的服务</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>        <span class="token key atrule">locator</span><span class="token punctuation">:</span>          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>重写负载均衡拦截器</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"env-dev"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomLoadBalancerFilter</span> <span class="token keyword">extends</span> <span class="token class-name">LoadBalancerClientFilter</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> nacosDiscoveryClient<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">CustomLoadBalancerFilter</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerClient</span> loadBalancer<span class="token punctuation">,</span> <span class="token class-name">LoadBalancerProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>loadBalancer<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token class-name">ServiceInstance</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> version <span class="token operator">=</span> headers<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"version"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> serviceId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">URI</span><span class="token punctuation">)</span> exchange<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">GATEWAY_REQUEST_URL_ATTR</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> nacosDiscoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>instances <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> instances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span> serviceInstance<span class="token operator">:</span> instances<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> metadata <span class="token operator">=</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>version<span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">return</span> serviceInstance<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>解决问题的过程</p><ol><li><p>首先确定是需要修改负载均衡器</p></li><li><p>查看gateway的自动配置类<code>GatewayAutoConfiguration</code>,找到有一个<code>GatewayLoadBalancerClientAutoConfiguration</code>的负载均衡配置类</p><p><img src="/images/Gateway-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/image-20220309234108585.png"></p></li><li><p>在负载均衡的配置类里，可以看到创建了一个<code>LoadBalancerClientFilter</code>的过滤器</p><p><img src="/images/Gateway-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/image-20220309234122746.png"></p></li><li><p>查看过滤器类，其实就是一个全局过滤器的实现</p><p><img src="/images/Gateway-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/image-20220309234135504.png"></p></li><li><p>通过debug，可以发现网关通过final ServiceInstance instance = choose(exchange);这段代码实现从服务列表里选出一个服务实例</p><p><img src="/images/Gateway-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/image-20220309234149014.png"></p></li><li><p>查看choose方法，发现刚好是protected，说明gateway本来就是留好了方便重写的入口，我们只需要继承这个过滤器<code>LoadBalancerClientFilter</code>，并且重写choose方法，就可以实现自定义的负载均衡。</p></li><li><p>添加<code>@ConditionalOnProperty(name = "env-dev", havingValue = "true")</code>这段代码主要是为了根据环境区分是否需要加载这个bean，在配置文件中配置了env-dev=true，就走自定义的负载均衡，不配做还是走原来的，不过这个类基本上也没有复杂逻辑，只要请求头里不加version，也不影响性能</p></li></ol></li></ol><h2 id="代码地址"><a href="#代码地址" class="headerlink" title="代码地址"></a>代码地址</h2><p><a href="https://gitee.com/aacopy/gateway-test.git">https://gitee.com/aacopy/gateway-test.git</a></p>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
            <tag> Gateway </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gateway-聚合swagger</title>
      <link href="/springcloud/gateway-ju-he-swagger/"/>
      <url>/springcloud/gateway-ju-he-swagger/</url>
      
        <content type="html"><![CDATA[<h2 id="gateway聚合微服务swagger"><a href="#gateway聚合微服务swagger" class="headerlink" title="gateway聚合微服务swagger"></a>gateway聚合微服务swagger</h2><p>参考：《重新定义Spring Cloud实战》</p><p>UI：knife4j</p><ol><li><p>引入依赖</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.springfox<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springfox-swagger2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.springfox<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springfox-swagger-ui<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.xiaoymin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>swagger-bootstrap-ui<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>因为swagger不支持webflux，不能在gateway里配置config，需要实现<code>SwaggerResourcesProvider</code>接口，用于获取<code>SwaggerResource</code>,此处参考书上的配置，一直获取不到swagger的API资源，主要是从配置文件读取路由节点时，一直为空，<code>gatewayProperties.getRoutes()</code>,测试发现当网关配置文件配置为从注册中心以服务发现方式获取路由资源时，获取不到，只有挨个配置route才可以获取到，不知道具体原因。</p><ul><li><p><del>参考书上的获取资源方式版本</del></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Primary</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewaySwaggerProvider</span> <span class="token keyword">implements</span> <span class="token class-name">SwaggerResourcesProvider</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">API_URI</span> <span class="token operator">=</span> <span class="token string">"/v2/api-docs"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RouteLocator</span> routeLocator<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">GatewayProperties</span> gatewayProperties<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">GatewaySwaggerProvider</span><span class="token punctuation">(</span><span class="token class-name">RouteLocator</span> routeLocator<span class="token punctuation">,</span> <span class="token class-name">GatewayProperties</span> gatewayProperties<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>routeLocator <span class="token operator">=</span> routeLocator<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>gatewayProperties <span class="token operator">=</span> gatewayProperties<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SwaggerResource</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SwaggerResource</span><span class="token punctuation">&gt;</span></span> resources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> routes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//获取gateway中的route</span>        routeLocator<span class="token punctuation">.</span><span class="token function">getRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>route <span class="token operator">-&gt;</span> routes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//结合配置文件只获取有效route节点</span>        gatewayProperties<span class="token punctuation">.</span><span class="token function">getRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>routeDefinition <span class="token operator">-&gt;</span> routes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>routeDefinition<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>route <span class="token operator">-&gt;</span>                route<span class="token punctuation">.</span><span class="token function">getPredicates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>predicateDefinition <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token string">"Path"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>predicateDefinition<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>predicateDefinition <span class="token operator">-&gt;</span> resources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">swaggerResource</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                predicateDefinition<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">NameUtils</span><span class="token punctuation">.</span><span class="token constant">GENERATED_NAME_PREFIX</span> <span class="token operator">+</span> <span class="token string">"0"</span><span class="token punctuation">)</span>                                        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">,</span> <span class="token constant">API_URI</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> resources<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">SwaggerResource</span> <span class="token function">swaggerResource</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> location<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">SwaggerResource</span> swaggerResource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SwaggerResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        swaggerResource<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        swaggerResource<span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>        swaggerResource<span class="token punctuation">.</span><span class="token function">setSwaggerVersion</span><span class="token punctuation">(</span><span class="token string">"2.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> swaggerResource<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>这里需要改为通过服务发现的方式获取路由列表</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Primary</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewaySwaggerProvider</span> <span class="token keyword">implements</span> <span class="token class-name">SwaggerResourcesProvider</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">API_URI</span> <span class="token operator">=</span> <span class="token string">"/v2/api-docs"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NACOS_ROUTE_ID_PREFIX</span> <span class="token operator">=</span> <span class="token string">"ReactiveCompositeDiscoveryClient_"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROUTE_ID_PREFIX</span> <span class="token operator">=</span> <span class="token string">"CompositeDiscoveryClient_"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DiscoveryClientRouteDefinitionLocator</span> discoveryClientRouteDefinitionLocator<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">GatewaySwaggerProvider</span><span class="token punctuation">(</span><span class="token class-name">DiscoveryClientRouteDefinitionLocator</span> discoveryClientRouteDefinitionLocator<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>discoveryClientRouteDefinitionLocator <span class="token operator">=</span> discoveryClientRouteDefinitionLocator<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SwaggerResource</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SwaggerResource</span><span class="token punctuation">&gt;</span></span> resources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//获取gateway中的route</span>        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteDefinition</span><span class="token punctuation">&gt;</span></span> routeDefinitions <span class="token operator">=</span> discoveryClientRouteDefinitionLocator<span class="token punctuation">.</span><span class="token function">getRouteDefinitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SwaggerResource</span><span class="token punctuation">&gt;</span></span> pattern <span class="token operator">=</span> routeDefinitions<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>routeDefinition <span class="token operator">-&gt;</span> <span class="token function">swaggerResource</span><span class="token punctuation">(</span>routeDefinition<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">NACOS_ROUTE_ID_PREFIX</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">ROUTE_ID_PREFIX</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                routeDefinition<span class="token punctuation">.</span><span class="token function">getPredicates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"pattern"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">,</span> <span class="token constant">API_URI</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Disposable</span> subscribe <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>resources<span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">//最多锁10秒，10秒还没结果就返回空</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">&lt;</span><span class="token number">10000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">//查看任务是否已完成</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">.</span><span class="token function">isDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> resources<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            i <span class="token operator">+=</span> <span class="token number">100</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">//主动释放任务</span>        subscribe<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">SwaggerResource</span> <span class="token function">swaggerResource</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> location<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">SwaggerResource</span> swaggerResource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SwaggerResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        swaggerResource<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        swaggerResource<span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>        swaggerResource<span class="token punctuation">.</span><span class="token function">setSwaggerVersion</span><span class="token punctuation">(</span><span class="token string">"2.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> swaggerResource<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p>创建SwaggerHeaderFilter，主要是为了解决路由规则为admin/test/{a}/{b}时，缺少根节点admin的情况</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwaggerHeaderFilter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractGatewayFilterFactory</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">HEADER_NAME</span> <span class="token operator">=</span> <span class="token string">"X-Forwarded-Prefix"</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">GatewayFilter</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Object</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> path <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">endsWithIgnoreCase</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token class-name">GatewaySwaggerProvider</span><span class="token punctuation">.</span><span class="token constant">API_URI</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token class-name">String</span> basePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token class-name">GatewaySwaggerProvider</span><span class="token punctuation">.</span><span class="token constant">API_URI</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">ServerHttpRequest</span> newRequest <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token constant">HEADER_NAME</span><span class="token punctuation">,</span> basePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">ServerWebExchange</span> newExchange <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>newRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>newExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>创建swagger的访问入口</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/swagger-resources"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwaggerController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">SecurityConfiguration</span> securityConfiguration<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">UiConfiguration</span> uiConfiguration<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SwaggerResourcesProvider</span> swaggerResources<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">public</span> <span class="token class-name">SwaggerController</span><span class="token punctuation">(</span><span class="token class-name">SwaggerResourcesProvider</span> swaggerResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>swaggerResources <span class="token operator">=</span> swaggerResources<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/configuration/security"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfiguration</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">securityConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>                <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>securityConfiguration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SecurityConfiguration</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">ApiKeyVehicle</span><span class="token punctuation">.</span><span class="token constant">HEADER</span><span class="token punctuation">,</span> <span class="token string">"api_key"</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/configuration/ui"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">&lt;</span><span class="token class-name">UiConfiguration</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">uiConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>                <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>uiConfiguration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UiConfiguration</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">swaggerResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>swaggerResources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>访问地址：网关ip:port/doc.html</p></li></ol><h2 id="代码地址"><a href="#代码地址" class="headerlink" title="代码地址"></a>代码地址</h2><p><a href="https://gitee.com/aacopy/gateway-test.git">https://gitee.com/aacopy/gateway-test.git</a></p>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
            <tag> Gateway </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenFeign-传递请求头</title>
      <link href="/springcloud/openfeign-chuan-di-qing-qiu-tou/"/>
      <url>/springcloud/openfeign-chuan-di-qing-qiu-tou/</url>
      
        <content type="html"><![CDATA[<h2 id="openFeign向下传递请求头"><a href="#openFeign向下传递请求头" class="headerlink" title="openFeign向下传递请求头"></a>openFeign向下传递请求头</h2><p>OpenFeign在微服务间的调用向下传递请求头</p><p>思路：把请求头放在ThreadLocal里，feign调用时，把请求头取出来再传递给下个服务</p><p>方案：实现<code>RequestInterceptor</code>接口，该接口的作用是在feign调用时，给请求添加头信息</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignRequestInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">ServletRequestAttributes</span> attributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headerNames <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaderNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>headerNames <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>headerNames<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> name <span class="token operator">=</span> headerNames<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> values <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>从RequestContextHolder获取请求参数，内部就是通过ThreadLocal实现的</p><p><img src="/images/OpenFeign-%E4%BC%A0%E9%80%92%E8%AF%B7%E6%B1%82%E5%A4%B4/image-20220309234955480.png"></p></li></ul><h3 id="代码地址"><a href="#代码地址" class="headerlink" title="代码地址"></a>代码地址</h3><p><a href="https://gitee.com/aacopy/gateway-test.git">https://gitee.com/aacopy/gateway-test.git</a></p>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
            <tag> OpenFeign </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RedisTemplate</title>
      <link href="/redis/redistemplate/"/>
      <url>/redis/redistemplate/</url>
      
        <content type="html"><![CDATA[<h2 id="redis连接池配置"><a href="#redis连接池配置" class="headerlink" title="redis连接池配置"></a>redis连接池配置</h2><ul><li>添加maven依赖</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>添加配置文件，设置redis连接池</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">redis</span><span class="token punctuation">:</span>    <span class="token key atrule">client-type</span><span class="token punctuation">:</span> jedis    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.80.128    <span class="token key atrule">password</span><span class="token punctuation">:</span> aacopy.cn    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>    <span class="token key atrule">jedis</span><span class="token punctuation">:</span>      <span class="token key atrule">pool</span><span class="token punctuation">:</span>        <span class="token comment"># 连接池最大连接数，默认为8</span>        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">100</span>        <span class="token comment"># 最大空闲连接数, 默认为8</span>        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">100</span>        <span class="token comment"># 最小空闲连接数，默认为0，设置最大最小相同，空间换时间，避免创建tcp握手耗时</span>        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">100</span>        <span class="token comment"># 连接池最大阻塞等待时间，默认-1，表示没有限制</span>        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">60000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="设置序列化规则"><a href="#设置序列化规则" class="headerlink" title="设置序列化规则"></a>设置序列化规则</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisTemplateConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//配置序列化规则</span>        <span class="token class-name">Jackson2JsonRedisSerializer</span> jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        objectMapper<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jackson2JsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置key-value序列化规则</span>        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        redisTemplate<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置hash-value序列化规则</span>        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Seata-seata与事务消息</title>
      <link href="/seata/seata-seata-yu-shi-wu-xiao-xi/"/>
      <url>/seata/seata-seata-yu-shi-wu-xiao-xi/</url>
      
        <content type="html"><![CDATA[<ul><li>分布式事务：<ul><li>刚性事务：强一致性（seata）</li><li>柔性事务：最终一致性（MQ事务消息）</li></ul></li></ul><h2 id="seata"><a href="#seata" class="headerlink" title="seata"></a>seata</h2><p>Seata 是一款开源的分布式事务解决方案，强一致性，要么同时成功，要么同时失败</p><p><img src="/images/Seata-seata%E4%B8%8E%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF/TB1rDpkJAvoK1RjSZPfXXXPKFXa-794-478.png"></p><p>结合公司内部框架版本，集成seata</p><h3 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h3><ul><li>SpringCloud：Hoxton.SR3</li><li>SpringBoot：2.2.5.RELEASE</li><li>seata：1.1.0</li><li>nacos：1.2.1</li><li>mysql：5.7</li></ul><h3 id="服务端集成步骤"><a href="#服务端集成步骤" class="headerlink" title="服务端集成步骤"></a>服务端集成步骤</h3><h4 id="seata-server下载"><a href="#seata-server下载" class="headerlink" title="seata-server下载"></a>seata-server下载</h4><p>下载地址：<a href="https://github.com/seata/seata/releases/download/v1.1.0/seata-server-1.1.0.zip">https://github.com/seata/seata/releases/download/v1.1.0/seata-server-1.1.0.zip</a></p><h4 id="创建seata数据库及表"><a href="#创建seata数据库及表" class="headerlink" title="创建seata数据库及表"></a>创建seata数据库及表</h4><ul><li>数据库名为seata</li><li>创建表结构</li></ul><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">-- -------------------------------- The script used when storeMode is 'db' ---------------------------------- the table to store GlobalSession dataCREATE TABLE IF NOT EXISTS `global_table`(    `xid`                       VARCHAR(128) NOT NULL,    `transaction_id`            BIGINT,    `status`                    TINYINT      NOT NULL,    `application_id`            VARCHAR(32),    `transaction_service_group` VARCHAR(32),    `transaction_name`          VARCHAR(128),    `timeout`                   INT,    `begin_time`                BIGINT,    `application_data`          VARCHAR(2000),    `gmt_create`                DATETIME,    `gmt_modified`              DATETIME,    PRIMARY KEY (`xid`),    KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),    KEY `idx_transaction_id` (`transaction_id`)) ENGINE = InnoDB  DEFAULT CHARSET = utf8;-- the table to store BranchSession dataCREATE TABLE IF NOT EXISTS `branch_table`(    `branch_id`         BIGINT       NOT NULL,    `xid`               VARCHAR(128) NOT NULL,    `transaction_id`    BIGINT,    `resource_group_id` VARCHAR(32),    `resource_id`       VARCHAR(256),    `branch_type`       VARCHAR(8),    `status`            TINYINT,    `client_id`         VARCHAR(64),    `application_data`  VARCHAR(2000),    `gmt_create`        DATETIME(6),    `gmt_modified`      DATETIME(6),    PRIMARY KEY (`branch_id`),    KEY `idx_xid` (`xid`)) ENGINE = InnoDB  DEFAULT CHARSET = utf8;-- the table to store lock dataCREATE TABLE IF NOT EXISTS `lock_table`(    `row_key`        VARCHAR(128) NOT NULL,    `xid`            VARCHAR(96),    `transaction_id` BIGINT,    `branch_id`      BIGINT       NOT NULL,    `resource_id`    VARCHAR(256),    `table_name`     VARCHAR(32),    `pk`             VARCHAR(36),    `gmt_create`     DATETIME,    `gmt_modified`   DATETIME,    PRIMARY KEY (`row_key`),    KEY `idx_branch_id` (`branch_id`)) ENGINE = InnoDB  DEFAULT CHARSET = utf8;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="服务端nacos配置文件"><a href="#服务端nacos配置文件" class="headerlink" title="服务端nacos配置文件"></a>服务端nacos配置文件</h4><ul><li>创建config.txt</li></ul><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">store.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span><span class="token key attr-name">store.db.datasource</span><span class="token punctuation">=</span><span class="token value attr-value">dbcp</span><span class="token key attr-name">store.db.dbType</span><span class="token punctuation">=</span><span class="token value attr-value">mysql</span><span class="token key attr-name">store.db.driverClassName</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.jdbc.Driver</span><span class="token key attr-name">store.db.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://192.168.80.128:3306/seata?useUnicode=true</span><span class="token key attr-name">store.db.user</span><span class="token punctuation">=</span><span class="token value attr-value">root</span><span class="token key attr-name">store.db.password</span><span class="token punctuation">=</span><span class="token value attr-value">aacopy.cn</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建nacos-config.sh</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span><span class="token comment"># Copyright 1999-2019 Seata.io Group.</span><span class="token comment">#</span><span class="token comment"># Licensed under the Apache License, Version 2.0 (the "License");</span><span class="token comment"># you may not use this file except in compliance with the License.</span><span class="token comment"># You may obtain a copy of the License at、</span><span class="token comment">#</span><span class="token comment">#      http://www.apache.org/licenses/LICENSE-2.0</span><span class="token comment">#</span><span class="token comment"># Unless required by applicable law or agreed to in writing, software</span><span class="token comment"># distributed under the License is distributed on an "AS IS" BASIS,</span><span class="token comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span class="token comment"># See the License for the specific language governing permissions and</span><span class="token comment"># limitations under the License.</span><span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> <span class="token string">":h:p:g:t:"</span> opt<span class="token keyword">do</span>  <span class="token keyword">case</span> <span class="token variable">$opt</span> <span class="token keyword">in</span>  h<span class="token punctuation">)</span>    <span class="token assign-left variable">host</span><span class="token operator">=</span><span class="token variable">$OPTARG</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>  p<span class="token punctuation">)</span>    <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token variable">$OPTARG</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>  g<span class="token punctuation">)</span>    <span class="token assign-left variable">group</span><span class="token operator">=</span><span class="token variable">$OPTARG</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>  t<span class="token punctuation">)</span>    <span class="token assign-left variable">tenant</span><span class="token operator">=</span><span class="token variable">$OPTARG</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>  ?<span class="token punctuation">)</span>    <span class="token builtin class-name">echo</span> <span class="token string">" USAGE OPTION: <span class="token variable">$0</span> [-h host] [-p port] [-g group] [-t tenant] "</span>    <span class="token builtin class-name">exit</span> <span class="token number">1</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>  <span class="token keyword">esac</span><span class="token keyword">done</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">${host}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token assign-left variable">host</span><span class="token operator">=</span>localhost<span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">${port}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">8848</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">${group}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token assign-left variable">group</span><span class="token operator">=</span><span class="token string">"SEATA_GROUP"</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">${tenant}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token assign-left variable">tenant</span><span class="token operator">=</span><span class="token string">""</span><span class="token keyword">fi</span><span class="token assign-left variable">nacosAddr</span><span class="token operator">=</span><span class="token variable">$host</span><span class="token builtin class-name">:</span><span class="token variable">$port</span><span class="token assign-left variable">contentType</span><span class="token operator">=</span><span class="token string">"content-type:application/json;charset=UTF-8"</span><span class="token builtin class-name">echo</span> <span class="token string">"set nacosAddr=<span class="token variable">$nacosAddr</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"set group=<span class="token variable">$group</span>"</span><span class="token assign-left variable">failCount</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">tempLog</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>mktemp <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token keyword">function</span> <span class="token function-name function">addConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">-H</span> <span class="token string">"<span class="token variable">${1}</span>"</span> <span class="token string">"http://<span class="token variable">$2</span>/nacos/v1/cs/configs?dataId=<span class="token variable">$3</span>&amp;group=<span class="token variable">$group</span>&amp;content=<span class="token variable">$4</span>&amp;tenant=<span class="token variable">$tenant</span>"</span> <span class="token operator">&gt;</span><span class="token string">"<span class="token variable">${tempLog}</span>"</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> <span class="token string">"<span class="token variable">${tempLog}</span>"</span><span class="token variable">)</span></span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">" Please check the cluster status. "</span>    <span class="token builtin class-name">exit</span> <span class="token number">1</span>  <span class="token keyword">fi</span>  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> <span class="token string">"<span class="token variable">${tempLog}</span>"</span><span class="token variable">)</span></span> <span class="token operator">=~</span> <span class="token string">"true"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">"Set <span class="token variable">$3</span>=<span class="token variable">$4</span> successfully "</span>  <span class="token keyword">else</span>    <span class="token builtin class-name">echo</span> <span class="token string">"Set <span class="token variable">$3</span>=<span class="token variable">$4</span> failure "</span>    <span class="token variable"><span class="token punctuation">((</span> failCount<span class="token operator">++</span> <span class="token punctuation">))</span></span>  <span class="token keyword">fi</span><span class="token punctuation">}</span><span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">0</span><span class="token keyword">for</span> <span class="token for-or-select variable">line</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> <span class="token punctuation">$(</span>dirname <span class="token string">"<span class="token environment constant">$PWD</span>"</span><span class="token punctuation">)</span>/config.txt <span class="token operator">|</span> <span class="token function">sed</span> s/<span class="token punctuation">[</span><span class="token punctuation">[</span>:space:<span class="token punctuation">]</span><span class="token punctuation">]</span>//g<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>  <span class="token variable"><span class="token punctuation">((</span> count<span class="token operator">++</span> <span class="token punctuation">))</span></span><span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token variable">${line<span class="token operator">%%</span>=*}</span>  <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token variable">${line<span class="token operator">#</span>*=}</span>addConfig <span class="token string">"<span class="token variable">${contentType}</span>"</span> <span class="token string">"<span class="token variable">${nacosAddr}</span>"</span> <span class="token string">"<span class="token variable">${key}</span>"</span> <span class="token string">"<span class="token variable">${value}</span>"</span><span class="token keyword">done</span><span class="token builtin class-name">echo</span> <span class="token string">"========================================================================="</span><span class="token builtin class-name">echo</span> <span class="token string">" Complete initialization parameters,  total-count:<span class="token variable">$count</span> ,  failure-count:<span class="token variable">$failCount</span> "</span><span class="token builtin class-name">echo</span> <span class="token string">"========================================================================="</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${failCount}</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token builtin class-name">echo</span> <span class="token string">" Init nacos config finished, please start seata-server. "</span><span class="token keyword">else</span><span class="token builtin class-name">echo</span> <span class="token string">" init nacos config fail. "</span><span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>config.txt要放在nacos-config.sh的上一级目录里，可以和github上目录保持一致，将nacos-config.sh放在nacos目录下，config.txt放在和nacos同一级目录</li><li>在nacos-config.sh的目录中，右键打开git bash here</li><li>执行命令</li></ul><h4 id="修改seata-server配置文件registry-conf"><a href="#修改seata-server配置文件registry-conf" class="headerlink" title="修改seata-server配置文件registry.conf"></a>修改seata-server配置文件registry.conf</h4><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">registry</span> <span class="token value attr-value">{</span><span class="token comment">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><span class="token key attr-name">  type</span> <span class="token punctuation">=</span> <span class="token value attr-value">"nacos"</span><span class="token key attr-name">  nacos</span> <span class="token value attr-value">{</span><span class="token key attr-name">    serverAddr</span> <span class="token punctuation">=</span> <span class="token value attr-value">"192.168.80.128:8848"</span><span class="token key attr-name">    namespace</span> <span class="token punctuation">=</span> <span class="token value attr-value">""</span><span class="token key attr-name">    cluster</span> <span class="token punctuation">=</span> <span class="token value attr-value">"default"</span>  }}<span class="token key attr-name">config</span> <span class="token value attr-value">{</span><span class="token comment">  # file、nacos 、apollo、zk、consul、etcd3</span><span class="token key attr-name">  type</span> <span class="token punctuation">=</span> <span class="token value attr-value">"nacos"</span><span class="token key attr-name">  nacos</span> <span class="token value attr-value">{</span><span class="token key attr-name">    serverAddr</span> <span class="token punctuation">=</span> <span class="token value attr-value">"192.168.80.128:8848"</span><span class="token key attr-name">    namespace</span> <span class="token punctuation">=</span> <span class="token value attr-value">""</span><span class="token key attr-name">    group</span> <span class="token punctuation">=</span> <span class="token value attr-value">"SEATA_GROUP"</span>  }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="启动server"><a href="#启动server" class="headerlink" title="启动server"></a>启动server</h4><pre class="line-numbers language-none"><code class="language-none">nohup ./seata-server.sh -h 192.168.80.128 -p 8091 &amp;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="客户端集成步骤"><a href="#客户端集成步骤" class="headerlink" title="客户端集成步骤"></a>客户端集成步骤</h3><h4 id="新增数据库表"><a href="#新增数据库表" class="headerlink" title="新增数据库表"></a>新增数据库表</h4><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE TABLE IF NOT EXISTS `undo_log`(    `id`            BIGINT(20)   NOT NULL AUTO_INCREMENT COMMENT 'increment id',    `branch_id`     BIGINT(20)   NOT NULL COMMENT 'branch transaction id',    `xid`           VARCHAR(100) NOT NULL COMMENT 'global transaction id',    `context`       VARCHAR(128) NOT NULL COMMENT 'undo_log context,such as serialization',    `rollback_info` LONGBLOB     NOT NULL COMMENT 'rollback info',    `log_status`    INT(11)      NOT NULL COMMENT '0:normal status,1:defense status',    `log_created`   DATETIME     NOT NULL COMMENT 'create datetime',    `log_modified`  DATETIME     NOT NULL COMMENT 'modify datetime',    PRIMARY KEY (`id`),    UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`)) ENGINE = InnoDB  AUTO_INCREMENT = 1  DEFAULT CHARSET = utf8 COMMENT ='AT transaction mode undo table';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h4><ul><li>添加依赖</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>排除依赖</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.quectel.web.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>cloud-common-log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-sleuth<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="客户端配置文件"><a href="#客户端配置文件" class="headerlink" title="客户端配置文件"></a>客户端配置文件</h4><p>添加配置</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">seata</span><span class="token punctuation">:</span>  <span class="token key atrule">config</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.80.128<span class="token punctuation">:</span><span class="token number">8848</span>      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> public      <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos      <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">registry</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.80.128<span class="token punctuation">:</span><span class="token number">8848</span>      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> public      <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos      <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">tx-service-group</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>_tx_group  <span class="token key atrule">application-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="nacos添加配置文件"><a href="#nacos添加配置文件" class="headerlink" title="nacos添加配置文件"></a>nacos添加配置文件</h4><ul><li>Group： SEATA_GROUP</li><li>Data ID<ul><li>service.vgroupMapping.datacenter_tx_group</li><li>service.vgroupMapping.rule_tx_group</li></ul></li><li>配置内容：default</li></ul><p><img src="/images/Seata-seata%E4%B8%8E%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF/image-20220615152814025.png"></p><h4 id="添加注解-GlobalTransactional"><a href="#添加注解-GlobalTransactional" class="headerlink" title="添加注解@GlobalTransactional"></a>添加注解@GlobalTransactional</h4><p>在需要分布式事务的地方增加@GlobalTransactional注解，只需要在入口的服务上加，被rpc调用的服务可以不加</p><h3 id="集成完毕测试"><a href="#集成完毕测试" class="headerlink" title="集成完毕测试"></a>集成完毕测试</h3><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><h4 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h4><ul><li>优点：强一致性，要么同时成功，要么同时失败，不需要考虑失败后的数据补偿，集成简单，老代码改造容易</li><li>缺点：性能较低，通过锁表实现。</li></ul><h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ul><li>需要强制性，业务简单，</li><li>涉及到的表不多的情况</li><li>并发量不高的操作</li></ul><h4 id="版本问题"><a href="#版本问题" class="headerlink" title="版本问题"></a>版本问题</h4><p>当前最新版本1.4.2，在集成过程中会出现导致spring security oauth2的bean无法加载的报错，是官方bug，目前还没有正式版修复，只有补丁文件，可以参考：</p><p><a href="http://www.aacopy.cn/2022/02/08/Seata/Seata-Demo1.4.2/">http://www.aacopy.cn/2022/02/08/Seata/Seata-Demo1.4.2/</a></p><h4 id="Seata-OpenFeign问题"><a href="#Seata-OpenFeign问题" class="headerlink" title="Seata-OpenFeign问题"></a>Seata-OpenFeign问题</h4><ul><li>报错信息</li></ul><pre class="line-numbers language-none"><code class="language-none">Caused by: com.netflix.client.ClientException: Load balancer does not have available server for client: ip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p>原因分析</p><ul><li>项目中同时引用了<code>spring-cloud-alibaba-seata</code> 和 <code>spring-cloud-starter-sleuth</code>两个依赖。</li><li>Sleuth 的配置类<code>TraceFeignClientAutoConfiguration</code> 和 Seata 的配置类 <code>SeataFeignClientAutoConfiguration</code> 都创建了 <code>FeignHystrixBuilder</code>的bean，导致spring加载时冲突</li></ul></li><li><p>解决方案</p><p>目前项目没有用到zipkin，sleuth，可以直接去掉该jar</p></li></ul><h4 id="更换默认版本"><a href="#更换默认版本" class="headerlink" title="更换默认版本"></a>更换默认版本</h4><ul><li><p>如果服务端和客户端的版本不一致，客户端会报错</p><pre class="line-numbers language-none"><code class="language-none">[main] io.seata.core.rpc.netty.NettyClientChannelManager 170 no available service 'default' found, please make sure registry config correct<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>需要指定版本</p><ul><li><p>在根pom中增加</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>seata-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在子模块pom中增加</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>seata-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>seata-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><h2 id="事务消息"><a href="#事务消息" class="headerlink" title="事务消息"></a>事务消息</h2><p>通过消息中间件，进行解耦，只需要保证“本地事务”和“消息提交到MQ”两者同时成功或者失败，客户端在接收到消息后再做相应的业务处理，如果成功就标记消息消费成功，如果失败，进行重试或者数据补偿操作。只需要对业务数据保证最终的一致性即可。以RocketMQ为例</p><h3 id="版本信息-1"><a href="#版本信息-1" class="headerlink" title="版本信息"></a>版本信息</h3><p>RocketMQ：4.9.2</p><h3 id="服务端集成步骤-1"><a href="#服务端集成步骤-1" class="headerlink" title="服务端集成步骤"></a>服务端集成步骤</h3><h4 id="服务端下载"><a href="#服务端下载" class="headerlink" title="服务端下载"></a>服务端下载</h4><p>二进制文件下载：<a href="https://dlcdn.apache.org/rocketmq/4.9.2/rocketmq-all-4.9.2-bin-release.zip">https://dlcdn.apache.org/rocketmq/4.9.2/rocketmq-all-4.9.2-bin-release.zip</a></p><h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><pre class="line-numbers language-none"><code class="language-none">nohup sh bin/mqnamesrv &amp;nohup sh bin/mqbroker -n localhost:9876 &amp;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="可视化控制台安装"><a href="#可视化控制台安装" class="headerlink" title="可视化控制台安装"></a>可视化控制台安装</h4><p>github:<a href="https://github.com/apache/rocketmq-externals">https://github.com/apache/rocketmq-externals</a></p><p>安装文档：<a href="https://rocketmq-1.gitbook.io/rocketmq-connector/rocketmq-connect/rocketmq-console/an-zhuang-shi-yong">https://rocketmq-1.gitbook.io/rocketmq-connector/rocketmq-connect/rocketmq-console/an-zhuang-shi-yong</a></p><p>docker安装</p><pre class="line-numbers language-none"><code class="language-none">docker run -p 8080:8080 --name rocketmq-console-ng \-e "JAVA_OPTS=-Drocketmq.namesrv.addr=192.168.80.128:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false" \-d styletang/rocketmq-console-ng<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="客户端集成"><a href="#客户端集成" class="headerlink" title="客户端集成"></a>客户端集成</h3><h4 id="maven依赖-1"><a href="#maven依赖-1" class="headerlink" title="maven依赖"></a>maven依赖</h4><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${rocketmq.spring.boot.starter.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">rocketmq.name-server</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.80.128:9876</span><span class="token key attr-name">rocketmq.producer.group</span><span class="token punctuation">=</span><span class="token value attr-value">my-group</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="通过普通消息ACK机制实现"><a href="#通过普通消息ACK机制实现" class="headerlink" title="通过普通消息ACK机制实现"></a>通过普通消息ACK机制实现</h3><h4 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h4><p>在生产者端，通过返回值SendResult获取消息发送状态，如果是OK，说明发送成功，提交本地事务，如果失败，抛出异常，回滚本地事务</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token string">"test-topic-1"</span><span class="token punctuation">,</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span>  <span class="token class-name">SendStatus</span><span class="token punctuation">.</span><span class="token constant">SEND_OK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//消息发送成功</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"消息发送异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h4><p>在消费者端，通过ACK机制，在成功消费消息后，手动确认消息已被消费，如果消费失败，这不确认，进行重试操作，或者通过数据补偿来保证数据一致性，通过将异常消息保存到数据库，然后成功消费消息，人工干预处理。在消费者端为了避免重复消费，需要做幂等处理</p><ul><li>redis，通过setNX或者incr原子操作，确定消息已经被消费</li><li>数据库将消息id作为唯一索引</li></ul><h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>普通的消息已经基本满足业务分布式事务需求，只要做好消息幂等处理即可，考虑到异常情况：</p><ul><li>在发送消费到MQ后，服务器宕机了，然后本地事务被回滚，但是消息已经被发送到MQ，这种情况就没有保证本地事务和消息的一致性</li></ul><h3 id="事务消息-1"><a href="#事务消息-1" class="headerlink" title="事务消息"></a>事务消息</h3><p><a href="https://rocketmq.apache.org/rocketmq/the-design-of-transactional-message/">https://rocketmq.apache.org/rocketmq/the-design-of-transactional-message/</a></p><p><img src="/images/Seata-seata%E4%B8%8E%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF/transaction-execute-flow.png"></p><ul><li>事务消息在一阶段对用户不可见</li><li>在本地事务执行完成后会向MQServer发送Commit或Rollback操作，此时如果在发送消息的时候生产者出故障了，那么要保证这条消息最终被消费，MQServer会像服务端发送回查请求，确认本地事务的执行状态</li></ul><h4 id="生产者集成步骤"><a href="#生产者集成步骤" class="headerlink" title="生产者集成步骤"></a>生产者集成步骤</h4><p>事务入口，改为消息事务</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">TransactionSendResult</span> transactionSendResult <span class="token operator">=</span> rocketMQTemplate<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span><span class="token string">"rocketmq-learn:order-create"</span><span class="token punctuation">,</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>orderRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">SendStatus</span><span class="token punctuation">.</span><span class="token constant">SEND_OK</span> <span class="token operator">==</span> transactionSendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT_MESSAGE</span> <span class="token operator">==</span> transactionSendResult<span class="token punctuation">.</span><span class="token function">getLocalTransactionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"订单服务下单成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">ROLLBACK_MESSAGE</span> <span class="token operator">==</span> transactionSendResult<span class="token punctuation">.</span><span class="token function">getLocalTransactionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"订单服务下单失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token string">"error"</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span> <span class="token operator">==</span> transactionSendResult<span class="token punctuation">.</span><span class="token function">getLocalTransactionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token string">"warn"</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建listener监听事务消息</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>order<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>order<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OrderRequest</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OrderService</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RocketMQTransactionListener</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQLocalTransactionListener</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RocketMQLocalTransactionState</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">RocketMQHeaders</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">RocketMQUtil</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span></span><span class="token class-name">MessageHeaders</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author cmyang * @date 2022/2/14 0:14 */</span><span class="token annotation punctuation">@RocketMQTransactionListener</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQLocalTransactionListener</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RocketMQLocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"开始执行本地事务..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">MessageHeaders</span> headers <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//获取事务id</span>        <span class="token class-name">String</span> transactionId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RocketMQUtil</span><span class="token punctuation">.</span><span class="token function">toRocketHeaderKey</span><span class="token punctuation">(</span><span class="token class-name">RocketMQHeaders</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_ID</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//获取tags</span>        <span class="token class-name">String</span> tags <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RocketMQUtil</span><span class="token punctuation">.</span><span class="token function">toRocketHeaderKey</span><span class="token punctuation">(</span><span class="token class-name">RocketMQHeaders</span><span class="token punctuation">.</span><span class="token constant">TAGS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tags<span class="token punctuation">,</span> <span class="token string">"order-create"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                orderService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">OrderRequest</span><span class="token punctuation">)</span> arg<span class="token punctuation">,</span> transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"本地事务执行成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token class-name">RocketMQLocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"本地事务异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token class-name">RocketMQLocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">ROLLBACK</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token class-name">RocketMQLocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RocketMQLocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"检查本地事务状态"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//查询数据库确定本地事务是否正常提交了</span>        <span class="token keyword">return</span> <span class="token class-name">RocketMQLocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>事务日志记录要和业务操作放在同一个事务里提交</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>    <span class="token annotation punctuation">@Transactional</span>    <span class="token keyword">public</span> <span class="token class-name">OrderDO</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">OrderRequest</span> orderRequest<span class="token punctuation">,</span> <span class="token class-name">String</span> transactionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//减少账户余额</span>        <span class="token keyword">int</span> orderMoney <span class="token operator">=</span> <span class="token function">calculate</span><span class="token punctuation">(</span>orderRequest<span class="token punctuation">.</span><span class="token function">getCommodityCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderRequest<span class="token punctuation">.</span><span class="token function">getOrderCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//创建订单</span>        <span class="token class-name">OrderDO</span> orderDO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderDO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        orderDO<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>orderRequest<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        orderDO<span class="token punctuation">.</span><span class="token function">setCommodityCode</span><span class="token punctuation">(</span>orderRequest<span class="token punctuation">.</span><span class="token function">getCommodityCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        orderDO<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>orderRequest<span class="token punctuation">.</span><span class="token function">getOrderCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        orderDO<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span>orderMoney<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">save</span><span class="token punctuation">(</span>orderDO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TransactionLogDO</span> transactionLogDO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionLogDO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        transactionLogDO<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>        transactionLogMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>transactionLogDO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        int i=1/0;</span>        <span class="token keyword">return</span> orderDO<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="完成"><a href="#完成" class="headerlink" title="完成"></a>完成</h3><p>消费者端和消费普通消息一样</p><h3 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h3><h4 id="优缺点："><a href="#优缺点：" class="headerlink" title="优缺点："></a>优缺点：</h4><ul><li>优点：事务消息将feign改为异步调用，大大提高了性能，保证数据最终一致</li><li>缺点：本地事务一旦提交，是无法回滚的，如果需要回滚数据，需要根据具体业务做数据补偿，幂等处理，对老项目加入分布式事务要求较高，需要根据具体业务分析，异常情况的处理，公司项目基本都带了用户信息请求，如果改为消息，需要将用户信息带到消息内，并改造框架底层获取用户信息方法</li></ul>]]></content>
      
      
      <categories>
          
          <category> Seata </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seata </tag>
            
            <tag> 分布式事务 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git-命令</title>
      <link href="/git/git-ming-ling/"/>
      <url>/git/git-ming-ling/</url>
      
        <content type="html"><![CDATA[<h2 id="Git命令"><a href="#Git命令" class="headerlink" title="Git命令"></a>Git命令</h2><ul><li><p>git –help</p><p>git帮助文档</p></li><li><p>git –version</p><p>查看git版本</p></li><li><p>git init</p><p>创建空的本地仓库</p></li><li><p>git add</p><p>将文件添加到暂存区</p></li><li><p>git config –global user.email “<a href="mailto:you@example.com">you@example.com</a>“</p></li><li><p>git config –global user.name “Your Name”</p><p>配置邮箱及用户名</p></li><li><p>git commit -m “xxx”</p><p>将暂存区提交到本地仓库</p></li><li><p>git remote add origin <a href="mailto:git@gitee.com">git@gitee.com</a>:aacopy/xxx.git</p><p>关联本地仓库和名称为origin远程仓库</p></li><li><p>git push -u origin master</p><p>将变更推送到名称为origin的远程仓库的master分支上</p></li><li><p>git fetch</p><p>拉去远程仓库的变更到本地仓库</p></li><li><p>git merge origin/master</p><p>将远程的变更，合并到本地的master分支</p></li><li><p>git pull</p><p>等于上面两个命令的合并</p></li><li><p>git status</p><p>查看git上变更的文件状态</p></li><li><p>git rm xxx</p><p>删除工作区的文件，并提交到暂存区</p></li><li><p>git rm –catch xxx</p><p>仅删除暂存区的文件</p></li><li><p>git checkout xxx</p><p>从暂存区将文件恢复的工作区，有文件则覆盖</p></li><li><p>git checkout master xxx</p><p>从master分支恢复文件到本地</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RocketMQ-SpringBoot</title>
      <link href="/rocketmq/rocketmq-springboot/"/>
      <url>/rocketmq/rocketmq-springboot/</url>
      
        <content type="html"><![CDATA[<h2 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h2><p>RocketMQ 4.9.2</p><p>JDK 1.8</p>]]></content>
      
      
      <categories>
          
          <category> RocketMQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 消息队列 </tag>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RocketMQ-安装</title>
      <link href="/rocketmq/rocketmq-an-zhuang/"/>
      <url>/rocketmq/rocketmq-an-zhuang/</url>
      
        <content type="html"><![CDATA[<h2 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h2><ul><li><p>RocketMQ 4.9.2</p></li><li><p>JDK 1.8</p></li><li><p>CentOS 7</p></li></ul><p>以下为官方推荐</p><blockquote><ol><li>64bit OS, Linux/Unix/Mac is recommended;(Windows user see guide below)</li><li>64bit JDK 1.8+;</li><li>Maven 3.2.x;</li><li>Git;</li><li>4g+ free disk for Broker server</li></ol></blockquote><h2 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h2><ul><li><p>下载页面：<a href="https://rocketmq.apache.org/dowloading/releases/">https://rocketmq.apache.org/dowloading/releases/</a></p></li><li><p>二进制文件下载：<a href="https://dlcdn.apache.org/rocketmq/4.9.2/rocketmq-all-4.9.2-bin-release.zip">https://dlcdn.apache.org/rocketmq/4.9.2/rocketmq-all-4.9.2-bin-release.zip</a></p></li></ul><p>将下载的文件上传到服务器，解压</p><h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>注意事项：</p><p>如果是非生产环境，本地测试，如果本地服务器的内容不够，会启动报错<code>error='Cannot allocate memory'</code>,需要先调整启动参数</p><ul><li><p><code>nameServer</code></p><ul><li>默认配置需要4G内存</li><li>本地学习测试修改为256M</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&gt;</span> <span class="token function">vim</span> bin/runserver.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>找到<code>JAVA_OPT="${JAVA_OPT} -server -Xms4g -Xmx4g -Xmn2g -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m"</code></li><li>修改为<code>JAVA_OPT="${JAVA_OPT} -server -Xms256m -Xmx256m -Xmn256m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m"</code></li></ul></li><li><p><code>broker</code></p><ul><li>默认配置需要8G内存</li><li>本地学习测试修改为512M</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&gt;</span> <span class="token function">vim</span> bin/runbroker.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>找到<code>JAVA_OPT="${JAVA_OPT} -server -Xms8g -Xmx8g</code></li><li>修改为<code>JAVA_OPT="${JAVA_OPT} -server -Xms512m -Xmx512m"</code></li></ul></li></ul><h3 id="启动nameServer"><a href="#启动nameServer" class="headerlink" title="启动nameServer"></a>启动<code>nameServer</code></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&gt;</span> <span class="token function">nohup</span> <span class="token function">sh</span> bin/mqnamesrv <span class="token operator">&amp;</span><span class="token operator">&gt;</span> <span class="token function">tail</span> <span class="token parameter variable">-f</span> ~/logs/rocketmqlogs/namesrv.logThe Name Server boot success. <span class="token assign-left variable">serializeType</span><span class="token operator">=</span>JSON<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>提示<code>The Name Server boot success. serializeType=JSON</code>启动成功</p><h3 id="启动broker"><a href="#启动broker" class="headerlink" title="启动broker"></a>启动<code>broker</code></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&gt;</span> <span class="token function">nohup</span> <span class="token function">sh</span> bin/mqbroker <span class="token parameter variable">-n</span> localhost:9876 <span class="token operator">&amp;</span><span class="token operator">&gt;</span> <span class="token function">tail</span> <span class="token parameter variable">-f</span> ~/logs/rocketmqlogs/broker.logmain - The broker<span class="token punctuation">[</span>localhost.localdomain, <span class="token number">172.17</span>.0.1:10911<span class="token punctuation">]</span> boot success. <span class="token assign-left variable">serializeType</span><span class="token operator">=</span>JSON and name server is localhost:9876<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="发送消费消息测试"><a href="#发送消费消息测试" class="headerlink" title="发送消费消息测试"></a>发送消费消息测试</h2><ul><li>发送消息</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">NAMESRV_ADDR</span><span class="token operator">=</span>localhost:9876<span class="token operator">&gt;</span> <span class="token function">sh</span> bin/tools.sh org.apache.rocketmq.example.quickstart.ProducerSendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK, <span class="token assign-left variable">msgId</span><span class="token operator">=</span> <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>消费消息</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&gt;</span> <span class="token function">sh</span> bin/tools.sh org.apache.rocketmq.example.quickstart.ConsumerConsumeMessageThread_6 Receive New Messages: <span class="token punctuation">[</span>MessageExt <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="关闭服务"><a href="#关闭服务" class="headerlink" title="关闭服务"></a>关闭服务</h2><pre class="line-numbers language-none"><code class="language-none">&gt; sh bin/mqshutdown broker&gt; sh bin/mqshutdown namesrv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="可视化控制台安装"><a href="#可视化控制台安装" class="headerlink" title="可视化控制台安装"></a>可视化控制台安装</h2><p>github:<a href="https://github.com/apache/rocketmq-externals">https://github.com/apache/rocketmq-externals</a></p><p>安装文档：<a href="https://rocketmq-1.gitbook.io/rocketmq-connector/rocketmq-connect/rocketmq-console/an-zhuang-shi-yong">https://rocketmq-1.gitbook.io/rocketmq-connector/rocketmq-connect/rocketmq-console/an-zhuang-shi-yong</a></p><h3 id="docker安装rocketmq-console-ng"><a href="#docker安装rocketmq-console-ng" class="headerlink" title="docker安装rocketmq-console-ng"></a>docker安装<code>rocketmq-console-ng</code></h3><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker">docker run -p 8080:8080 --name rocketmq-console-ng \-e "JAVA_OPTS=-Drocketmq.namesrv.addr=192.168.80.128:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false" \-d styletang/rocketmq-console-ng<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>访问地址：<a href="http://192.168.80.128:8080/">http://192.168.80.128:8080/</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> RocketMQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 消息队列 </tag>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RocketMQ-HelloWorld</title>
      <link href="/rocketmq/rocketmq-helloworld/"/>
      <url>/rocketmq/rocketmq-helloworld/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Apache RocketMQ作为阿里开源的一款高性能、高吞吐量的分布式消息中间件</p><p>官网地址：<a href="https://rocketmq.apache.org/">https://rocketmq.apache.org/</a></p><p>github：<a href="https://github.com/apache/rocketmq">https://github.com/apache/rocketmq</a></p><h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><ul><li>支持Broker和Consumer端消息过滤</li><li>支持发布订阅模型，和点对点，</li><li>支持拉pull和推push两种消息模式</li><li>单一队列百万消息、亿级消息堆积</li><li>支持单master节点，多master节点，多master多slave节点</li><li>任意一点都是高可用，水平拓展，Producer、Consumer、队列都可以分布式</li><li>消息失败重试机制、支持特定level的定时消息</li><li>4.3.x支持分布式事务</li><li>适合金融类业务，高可用性跟踪和审计功能。</li></ul><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><ul><li><p>Producer:消息生产者</p></li><li><p>Producer Group:消息生产者组，发送同类消息的一个消息生产组</p></li><li><p>Consumer:消费者</p></li><li><p>Consumer Group:消费同类消息的多个实例</p></li><li><p>Tag:标签，子主题（二级分类）对topic的进一步细化,用于区分同一个主题下的不同业务的消息</p></li><li><p>Topic:主题, 如订单类消息，queue是消息的物理管理单位，而topic是逻辑管理单位。一个topic下可以有多个queue。</p><p>默认自动创建是4个，手动创建是8个</p></li><li><p>Message：消息,每个message必须指定一个topic</p></li><li><p>Broker：MQ程序，接收生产的消息，提供给消费者消费的程序</p></li><li><p>Name Server：给生产和消费者提供路由信息，提供轻量级的服务发现、路由、元数据信息，可以多个部署，互相独立（比zookeeper更轻量）</p></li><li><p>Offset: 偏移量，消费位置</p></li><li><p>commit log: 消息存储会写在Commit log文件里面</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> RocketMQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 消息队列 </tag>
            
            <tag> RocketMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Seata-OpenFeign问题</title>
      <link href="/seata/seata-openfeign-wen-ti/"/>
      <url>/seata/seata-openfeign-wen-ti/</url>
      
        <content type="html"><![CDATA[<h2 id="报错信息"><a href="#报错信息" class="headerlink" title="报错信息"></a>报错信息</h2><pre class="line-numbers language-none"><code class="language-none">Caused by: com.netflix.client.ClientException: Load balancer does not have available server for client: ip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><ul><li><p>项目中同时引用了<code>spring-cloud-alibaba-seata</code> 和 <code>spring-cloud-starter-sleuth</code>两个依赖。</p></li><li><p>Sleuth 的配置类<code>TraceFeignClientAutoConfiguration</code> 和 Seata 的配置类 <code>SeataFeignClientAutoConfiguration</code> 都创建了 <code>FeignHystrixBuilder</code>的bean，导致spring加载时冲突</p></li></ul><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h3><ul><li>在springboot启动类上排除SeataFeign配置类</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">SeataFeignClientAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>使用自定义拦截器传递XID</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">RequestInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">GlobalTransactional</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeataFeignInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> currentXid <span class="token operator">=</span> <span class="token class-name">RootContext</span><span class="token punctuation">.</span><span class="token function">getXID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>currentXid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">RootContext</span><span class="token punctuation">.</span><span class="token constant">KEY_XID</span><span class="token punctuation">,</span> currentXid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h3><ul><li>如果没有用到<code>zipkin</code>，<code>sleuth</code>，可以排除掉maven中的相关依赖</li></ul>]]></content>
      
      
      <categories>
          
          <category> Seata </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seata </tag>
            
            <tag> 分布式事务 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Seata-Demo1.1.0</title>
      <link href="/seata/seata-demo1.1.0/"/>
      <url>/seata/seata-demo1.1.0/</url>
      
        <content type="html"><![CDATA[<p>seata1.1.0版本Demo，主要为了适配公司框架版本</p><h2 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h2><ul><li>seata 版本 1.1.0</li><li>mysql 版本 5.7</li><li>nacos 版本 1.2.1</li><li>SpringCloud 版本  ，AlibabaCloud 版本</li></ul><h3 id="seata-server下载"><a href="#seata-server下载" class="headerlink" title="seata-server下载"></a>seata-server下载</h3><p>下载地址：<a href="https://github.com/seata/seata/releases/download/v1.1.0/seata-server-1.1.0.zip">https://github.com/seata/seata/releases/download/v1.1.0/seata-server-1.1.0.zip</a></p><h2 id="创建seata数据库及表"><a href="#创建seata数据库及表" class="headerlink" title="创建seata数据库及表"></a>创建seata数据库及表</h2><h3 id="创建seata数据库"><a href="#创建seata数据库" class="headerlink" title="创建seata数据库"></a>创建seata数据库</h3><p>数据库名为seata</p><h3 id="创建表结构"><a href="#创建表结构" class="headerlink" title="创建表结构"></a>创建表结构</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">-- -------------------------------- The script used when storeMode is 'db' ---------------------------------- the table to store GlobalSession dataCREATE TABLE IF NOT EXISTS `global_table`(    `xid`                       VARCHAR(128) NOT NULL,    `transaction_id`            BIGINT,    `status`                    TINYINT      NOT NULL,    `application_id`            VARCHAR(32),    `transaction_service_group` VARCHAR(32),    `transaction_name`          VARCHAR(128),    `timeout`                   INT,    `begin_time`                BIGINT,    `application_data`          VARCHAR(2000),    `gmt_create`                DATETIME,    `gmt_modified`              DATETIME,    PRIMARY KEY (`xid`),    KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),    KEY `idx_transaction_id` (`transaction_id`)) ENGINE = InnoDB  DEFAULT CHARSET = utf8;-- the table to store BranchSession dataCREATE TABLE IF NOT EXISTS `branch_table`(    `branch_id`         BIGINT       NOT NULL,    `xid`               VARCHAR(128) NOT NULL,    `transaction_id`    BIGINT,    `resource_group_id` VARCHAR(32),    `resource_id`       VARCHAR(256),    `branch_type`       VARCHAR(8),    `status`            TINYINT,    `client_id`         VARCHAR(64),    `application_data`  VARCHAR(2000),    `gmt_create`        DATETIME(6),    `gmt_modified`      DATETIME(6),    PRIMARY KEY (`branch_id`),    KEY `idx_xid` (`xid`)) ENGINE = InnoDB  DEFAULT CHARSET = utf8;-- the table to store lock dataCREATE TABLE IF NOT EXISTS `lock_table`(    `row_key`        VARCHAR(128) NOT NULL,    `xid`            VARCHAR(96),    `transaction_id` BIGINT,    `branch_id`      BIGINT       NOT NULL,    `resource_id`    VARCHAR(256),    `table_name`     VARCHAR(32),    `pk`             VARCHAR(36),    `gmt_create`     DATETIME,    `gmt_modified`   DATETIME,    PRIMARY KEY (`row_key`),    KEY `idx_branch_id` (`branch_id`)) ENGINE = InnoDB  DEFAULT CHARSET = utf8;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="服务端nacos配置文件"><a href="#服务端nacos配置文件" class="headerlink" title="服务端nacos配置文件"></a>服务端nacos配置文件</h2><p>nacos启动命令里不能加<code>NACOS_AUTH_ENABLE=true</code>，不然会报错</p><ul><li><p>复制config.txt文件到本地</p><ul><li><a href="https://github.com/seata/seata/blob/1.1.0/script/config-center/config.txt">https://github.com/seata/seata/blob/1.1.0/script/config-center/config.txt</a></li></ul></li><li><p>复制nacos-config.sh文件到本地，此处注意：如果使用1.1.0版本的nacos-config，报错，导入失败，使用1.2.0的可以</p><ul><li><a href="https://github.com/seata/seata/blob/1.2.0/script/config-center/nacos/nacos-config.sh">https://github.com/seata/seata/blob/1.2.0/script/config-center/nacos/nacos-config.sh</a></li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span><span class="token comment"># Copyright 1999-2019 Seata.io Group.</span><span class="token comment">#</span><span class="token comment"># Licensed under the Apache License, Version 2.0 (the "License");</span><span class="token comment"># you may not use this file except in compliance with the License.</span><span class="token comment"># You may obtain a copy of the License at、</span><span class="token comment">#</span><span class="token comment">#      http://www.apache.org/licenses/LICENSE-2.0</span><span class="token comment">#</span><span class="token comment"># Unless required by applicable law or agreed to in writing, software</span><span class="token comment"># distributed under the License is distributed on an "AS IS" BASIS,</span><span class="token comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span class="token comment"># See the License for the specific language governing permissions and</span><span class="token comment"># limitations under the License.</span><span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> <span class="token string">":h:p:g:t:"</span> opt<span class="token keyword">do</span>  <span class="token keyword">case</span> <span class="token variable">$opt</span> <span class="token keyword">in</span>  h<span class="token punctuation">)</span>    <span class="token assign-left variable">host</span><span class="token operator">=</span><span class="token variable">$OPTARG</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>  p<span class="token punctuation">)</span>    <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token variable">$OPTARG</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>  g<span class="token punctuation">)</span>    <span class="token assign-left variable">group</span><span class="token operator">=</span><span class="token variable">$OPTARG</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>  t<span class="token punctuation">)</span>    <span class="token assign-left variable">tenant</span><span class="token operator">=</span><span class="token variable">$OPTARG</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>  ?<span class="token punctuation">)</span>    <span class="token builtin class-name">echo</span> <span class="token string">" USAGE OPTION: <span class="token variable">$0</span> [-h host] [-p port] [-g group] [-t tenant] "</span>    <span class="token builtin class-name">exit</span> <span class="token number">1</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span>  <span class="token keyword">esac</span><span class="token keyword">done</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">${host}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token assign-left variable">host</span><span class="token operator">=</span>localhost<span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">${port}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">8848</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">${group}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token assign-left variable">group</span><span class="token operator">=</span><span class="token string">"SEATA_GROUP"</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable">${tenant}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token assign-left variable">tenant</span><span class="token operator">=</span><span class="token string">""</span><span class="token keyword">fi</span><span class="token assign-left variable">nacosAddr</span><span class="token operator">=</span><span class="token variable">$host</span><span class="token builtin class-name">:</span><span class="token variable">$port</span><span class="token assign-left variable">contentType</span><span class="token operator">=</span><span class="token string">"content-type:application/json;charset=UTF-8"</span><span class="token builtin class-name">echo</span> <span class="token string">"set nacosAddr=<span class="token variable">$nacosAddr</span>"</span><span class="token builtin class-name">echo</span> <span class="token string">"set group=<span class="token variable">$group</span>"</span><span class="token assign-left variable">failCount</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">tempLog</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>mktemp <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token keyword">function</span> <span class="token function-name function">addConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">-H</span> <span class="token string">"<span class="token variable">${1}</span>"</span> <span class="token string">"http://<span class="token variable">$2</span>/nacos/v1/cs/configs?dataId=<span class="token variable">$3</span>&amp;group=<span class="token variable">$group</span>&amp;content=<span class="token variable">$4</span>&amp;tenant=<span class="token variable">$tenant</span>"</span> <span class="token operator">&gt;</span><span class="token string">"<span class="token variable">${tempLog}</span>"</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> <span class="token string">"<span class="token variable">${tempLog}</span>"</span><span class="token variable">)</span></span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">" Please check the cluster status. "</span>    <span class="token builtin class-name">exit</span> <span class="token number">1</span>  <span class="token keyword">fi</span>  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> <span class="token string">"<span class="token variable">${tempLog}</span>"</span><span class="token variable">)</span></span> <span class="token operator">=~</span> <span class="token string">"true"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">"Set <span class="token variable">$3</span>=<span class="token variable">$4</span> successfully "</span>  <span class="token keyword">else</span>    <span class="token builtin class-name">echo</span> <span class="token string">"Set <span class="token variable">$3</span>=<span class="token variable">$4</span> failure "</span>    <span class="token variable"><span class="token punctuation">((</span> failCount<span class="token operator">++</span> <span class="token punctuation">))</span></span>  <span class="token keyword">fi</span><span class="token punctuation">}</span><span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">0</span><span class="token keyword">for</span> <span class="token for-or-select variable">line</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> <span class="token punctuation">$(</span>dirname <span class="token string">"<span class="token environment constant">$PWD</span>"</span><span class="token punctuation">)</span>/config.txt <span class="token operator">|</span> <span class="token function">sed</span> s/<span class="token punctuation">[</span><span class="token punctuation">[</span>:space:<span class="token punctuation">]</span><span class="token punctuation">]</span>//g<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>  <span class="token variable"><span class="token punctuation">((</span> count<span class="token operator">++</span> <span class="token punctuation">))</span></span><span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token variable">${line<span class="token operator">%%</span>=*}</span>  <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token variable">${line<span class="token operator">#</span>*=}</span>addConfig <span class="token string">"<span class="token variable">${contentType}</span>"</span> <span class="token string">"<span class="token variable">${nacosAddr}</span>"</span> <span class="token string">"<span class="token variable">${key}</span>"</span> <span class="token string">"<span class="token variable">${value}</span>"</span><span class="token keyword">done</span><span class="token builtin class-name">echo</span> <span class="token string">"========================================================================="</span><span class="token builtin class-name">echo</span> <span class="token string">" Complete initialization parameters,  total-count:<span class="token variable">$count</span> ,  failure-count:<span class="token variable">$failCount</span> "</span><span class="token builtin class-name">echo</span> <span class="token string">"========================================================================="</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${failCount}</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token builtin class-name">echo</span> <span class="token string">" Init nacos config finished, please start seata-server. "</span><span class="token keyword">else</span><span class="token builtin class-name">echo</span> <span class="token string">" init nacos config fail. "</span><span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>config.txt中的内容很多是不需要的，加入以下仅需要的内容</p></li></ul><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">store.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span><span class="token key attr-name">store.db.datasource</span><span class="token punctuation">=</span><span class="token value attr-value">dbcp</span><span class="token key attr-name">store.db.dbType</span><span class="token punctuation">=</span><span class="token value attr-value">mysql</span><span class="token key attr-name">store.db.driverClassName</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.jdbc.Driver</span><span class="token key attr-name">store.db.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://192.168.80.128:3306/seata?useUnicode=true</span><span class="token key attr-name">store.db.user</span><span class="token punctuation">=</span><span class="token value attr-value">root</span><span class="token key attr-name">store.db.password</span><span class="token punctuation">=</span><span class="token value attr-value">aacopy.cn</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>config.txt要放在nacos-config.sh的上一级目录里，可以和github上目录保持一致，将nacos-config.sh放在nacos目录下，config.txt放在和nacos同一级目录</li><li>在nacos-config.sh的目录中，右键打开git bash here</li><li>执行命令</li></ul><pre class="line-numbers language-none"><code class="language-none">sh ./nacos-config.sh -h 192.168.80.128<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="修改seata-server配置文件"><a href="#修改seata-server配置文件" class="headerlink" title="修改seata-server配置文件"></a>修改seata-server配置文件</h2><pre class="line-numbers language-none"><code class="language-none">registry {  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa  type = "nacos"  nacos {    serverAddr = "192.168.80.128:8848"    namespace = ""    cluster = "default"  }}config {  # file、nacos 、apollo、zk、consul、etcd3  type = "nacos"  nacos {    serverAddr = "192.168.80.128:8848"    namespace = ""    group = "SEATA_GROUP"  }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="启动server"><a href="#启动server" class="headerlink" title="启动server"></a>启动server</h2><pre class="line-numbers language-none"><code class="language-none">nohup ./seata-server.sh -h 192.168.80.128 -p 8091 &amp;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Seata </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seata </tag>
            
            <tag> 分布式事务 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Seata-Demo1.3.0</title>
      <link href="/seata/seata-demo1.3.0/"/>
      <url>/seata/seata-demo1.3.0/</url>
      
        <content type="html"><![CDATA[<p>seata1.3.0版本Demo</p><h2 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h2><ul><li>seata 版本 1.3.0</li><li>mysql 版本 8.0</li><li>nacos 版本 2.0.2</li><li>SpringCloud 版本 2020.0.4 ，AlibabaCloud 版本 2021.1</li></ul><h3 id="seata-server下载"><a href="#seata-server下载" class="headerlink" title="seata-server下载"></a>seata-server下载</h3><p>下载地址：<a href="https://github.com/seata/seata/releases/download/v1.3.0/seata-server-1.3.0.zip">https://github.com/seata/seata/releases/download/v1.3.0/seata-server-1.3.0.zip</a></p><h2 id="服务端nacos配置文件"><a href="#服务端nacos配置文件" class="headerlink" title="服务端nacos配置文件"></a>服务端nacos配置文件</h2><ul><li>复制config.txt文件到本地<ul><li><a href="https://github.com/seata/seata/blob/v1.3.0/script/config-center/config.txt">https://github.com/seata/seata/blob/v1.3.0/script/config-center/config.txt</a></li></ul></li><li>复制nacos-config.sh文件到本地<ul><li><a href="https://github.com/seata/seata/blob/v1.3.0/script/config-center/nacos/nacos-config.sh">https://github.com/seata/seata/blob/v1.3.0/script/config-center/nacos/nacos-config.sh</a></li></ul></li><li>config.txt中的内容很多是不需要的，加入以下仅需要的内容</li></ul><pre class="line-numbers language-none"><code class="language-none">store.mode=dbstore.db.datasource=druidstore.db.dbType=mysqlstore.db.driverClassName=com.mysql.cj.jdbc.Driverstore.db.url=jdbc:mysql://192.168.80.128:3306/seata?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghaistore.db.user=rootstore.db.password=aacopy.cn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>config.txt要放在nacos-config.sh的上一级目录里，可以和github上目录保持一致，将nacos-config.sh放在nacos目录下，config.txt放在和nacos同一级目录</li><li>在nacos-config.sh的目录中，右键打开git bash here</li><li>执行命令</li></ul><pre class="line-numbers language-none"><code class="language-none">sh ./nacos-config.sh -h 192.168.80.128 -p 8848 -g SEATA_GROUP -u nacos -w nacos<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Seata </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seata </tag>
            
            <tag> 分布式事务 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux-常用命令</title>
      <link href="/linux/linux-chang-yong-ming-ling/"/>
      <url>/linux/linux-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<h2 id="CentOS相关"><a href="#CentOS相关" class="headerlink" title="CentOS相关"></a>CentOS相关</h2><h3 id="防火墙设置"><a href="#防火墙设置" class="headerlink" title="防火墙设置"></a>防火墙设置</h3><ul><li>查看防火墙状态</li></ul><pre class="line-numbers language-none"><code class="language-none">systemctl status firewalld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>开启防火墙</li></ul><pre class="line-numbers language-none"><code class="language-none">systemctl start firewalld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>临时关闭防火墙</li></ul><pre class="line-numbers language-none"><code class="language-none">systemctl stop firewalld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>永久关闭防火墙</li></ul><pre class="line-numbers language-none"><code class="language-none">systemctl disable firewalld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="同步系统时间"><a href="#同步系统时间" class="headerlink" title="同步系统时间"></a>同步系统时间</h3><pre class="line-numbers language-none"><code class="language-none">yum install ntpdatentpdate cn.pool.ntp.org<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Seata-Demo1.4.2</title>
      <link href="/seata/seata-demo1.4.2/"/>
      <url>/seata/seata-demo1.4.2/</url>
      
        <content type="html"><![CDATA[<p>seata 1.4.2版本 代码示例</p><p><a href="https://gitee.com/aacopy/seata-learn/tree/1.4.2/">https://gitee.com/aacopy/seata-learn/tree/1.4.2/</a></p><h2 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h2><ul><li>seata 版本 1.4.2</li><li>mysql 版本 8.0</li><li>nacos 版本 2.0.2</li><li>SpringCloud 版本 2020.0.4 ，AlibabaCloud 版本 2021.1</li></ul><h2 id="代码说明"><a href="#代码说明" class="headerlink" title="代码说明"></a>代码说明</h2><p>四个服务：</p><ul><li>Account 账户服务</li><li>Order 订单服务</li><li>Storage 库存服务</li><li>Business 业务服务</li></ul><p>业务服务下单，调用库存服务，扣减库存，调用订单服务，下单，订单服务中再调用账户服务，扣款</p><p><img src="/images/Seata-Demo/architecture.png"></p><h2 id="启动seata服务端"><a href="#启动seata服务端" class="headerlink" title="启动seata服务端"></a>启动seata服务端</h2><h3 id="下载服务端"><a href="#下载服务端" class="headerlink" title="下载服务端"></a>下载服务端</h3><p>下载地址：<a href="http://seata.io/zh-cn/blog/download.html">http://seata.io/zh-cn/blog/download.html</a> 点击1.4.2版本的binary</p><h3 id="创建数据库脚本"><a href="#创建数据库脚本" class="headerlink" title="创建数据库脚本"></a>创建数据库脚本</h3><ol><li>创建数据库seata</li><li>执行建表SQL脚本，脚本地址：<a href="https://github.com/seata/seata/blob/v1.4.2/script/server/db/mysql.sql">https://github.com/seata/seata/blob/v1.4.2/script/server/db/mysql.sql</a></li></ol><p>注意：</p><ul><li>seata在创建事务组的时候，如果在客户端中不指定配置<code>seata.tx-service-group</code>，则默认以：<code>spring.application.name</code>值+”<code>-seata-service-group</code>“拼接后的字符串作为分组名，例如：<code>seata-business-seata-service-group</code>。而在sql脚本中<code>global_table</code>表的<code>transaction_service_group</code>字段的长度默认为32，是不够的，会报以下错误：<ul><li>解决方案1：把<code>global_table</code>表的<code>transaction_service_group</code>字段长度加大，改为<code>64</code></li><li>解决方案2：在客户端配置文件中，配置<code>seata.tx-service-group</code>的值，使长度小于等于32</li></ul></li></ul><pre class="line-numbers language-none"><code class="language-none">io.seata.core.exception.TmTransactionException: TransactionException[begin global request failed. xid=null, msg=Data truncation: Data too long for column 'transaction_service_group' at row 1]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="nacos中添加seata配置文件"><a href="#nacos中添加seata配置文件" class="headerlink" title="nacos中添加seata配置文件"></a>nacos中添加seata配置文件</h3><ul><li><p>nacos中新增配置</p><ul><li><code>Data ID</code> 填写 <code>seata.properties</code></li><li><code>Group</code> 填写 <code>SEATA_GROUP</code></li><li><code>配置格式</code> 选择 <code>Properties</code></li><li><code>配置内容</code> 配置内容如下，以下为最小配置项，其他都有默认配置</li></ul><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">store.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span><span class="token key attr-name">store.db.datasource</span><span class="token punctuation">=</span><span class="token value attr-value">druid</span><span class="token key attr-name">store.db.dbType</span><span class="token punctuation">=</span><span class="token value attr-value">mysql</span><span class="token key attr-name">store.db.driverClassName</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span><span class="token key attr-name">store.db.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://192.168.80.128:3306/seata?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span><span class="token key attr-name">store.db.user</span><span class="token punctuation">=</span><span class="token value attr-value">root</span><span class="token key attr-name">store.db.password</span><span class="token punctuation">=</span><span class="token value attr-value">aacopy.cn</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>其他配置项内容可以参考官方提供的配置文件内容，获取地址：<a href="https://github.com/seata/seata/blob/v1.4.2/script/config-center/config.txt">https://github.com/seata/seata/blob/v1.4.2/script/config-center/config.txt</a></p></li><li><p><strong>注意事项</strong>：</p><ul><li><code>store.db.driverClassName</code>配置项文档中给的值是<code>com.mysql.jdbc.Driver</code>，需要改为<code>com.mysql.cj.jdbc.Driver</code>，不然启动会报以下错误</li></ul><pre class="line-numbers language-none"><code class="language-none">21:48:30.295 ERROR --- [ionPool-Create-1741786839] com.alibaba.druid.pool.DruidDataSource   : create connection SQLException, url: jdbc:mysql://192.168.80.128:3306/seata?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai, errorCode 0, state 08001==&gt;com.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Could not create connection to database server.  ...Caused by: java.lang.NullPointerException: null  ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>store.mode</code>配置项数据库模式，配置项<code>db</code>一定要小写，一开始参考最新分支的注释，写成了大写，结果启动会报以下错误</li></ul><pre class="line-numbers language-none"><code class="language-none">Exception in thread "main" io.seata.common.loader.EnhancedServiceNotFoundException: java.lang.IllegalStateException: Extension instance(definition: io.seata.common.loader.ExtensionDefinition@2edbda99, class: class io.seata.server.coordinator.AbstractCore)  could not be instantiated: nullCaused by: java.lang.IllegalStateException: Extension instance(definition: io.seata.common.loader.ExtensionDefinition@2edbda99, class: class io.seata.server.coordinator.AbstractCore)  could not be instantiated: null...Caused by: java.lang.reflect.InvocationTargetException...Caused by: java.lang.ExceptionInInitializerError...Caused by: io.seata.common.loader.EnhancedServiceNotFoundException: not found service provider for : io.seata.server.lock.LockManager<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>store.db.datasource=druid</code>必须要配置，不配置会报如下错误</li></ul><pre class="line-numbers language-none"><code class="language-none">Exception in thread "main" io.seata.common.loader.EnhancedServiceNotFoundException: not found service provider for : io.seata.server.session.SessionManager caused by java.lang.IllegalStateException: Extension instance(definition: io.seata.common.loader.ExtensionDefinition@c1d87e38, class: interface io.seata.server.session.SessionManager)  could not be instantiated: the name of service provider for [io.seata.core.store.db.DataSourceProvider] name is null...Caused by: java.lang.IllegalArgumentException: the name of service provider for [io.seata.core.store.db.DataSourceProvider] name is null...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>store.db.dbType=mysql</code>必须要配置，不配置会报如下错误</li></ul><pre class="line-numbers language-none"><code class="language-none">Exception in thread "main" io.seata.common.loader.EnhancedServiceNotFoundException: not found service provider for : io.seata.server.session.SessionManager caused by java.lang.IllegalStateException: Extension instance(definition: io.seata.common.loader.ExtensionDefinition@aef73b8c, class: interface io.seata.server.session.SessionManager)  could not be instantiated: not found service provider for : io.seata.core.store.db.DataSourceProvider caused by java.lang.IllegalStateException: Extension instance(definition: io.seata.common.loader.ExtensionDefinition@bc3d4a39, class: interface io.seata.core.store.db.DataSourceProvider)  could not be instantiated: unknown dbtype:null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h3 id="修改seata配置文件"><a href="#修改seata配置文件" class="headerlink" title="修改seata配置文件"></a>修改seata配置文件</h3><ul><li>打开根目录<code>conf</code>文件夹</li><li>编辑修改<code>registry.conf</code>配置文件</li><li>修改<code>registry</code>和<code>config</code>的<code>type</code>为<code>nacos</code>，并修改nacos的相关配置</li></ul><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">registry</span> <span class="token value attr-value">{</span><span class="token key attr-name">  type</span> <span class="token punctuation">=</span> <span class="token value attr-value">"nacos"</span><span class="token key attr-name">  nacos</span> <span class="token value attr-value">{</span><span class="token key attr-name">    application</span> <span class="token punctuation">=</span> <span class="token value attr-value">"seata-server"</span><span class="token key attr-name">    serverAddr</span> <span class="token punctuation">=</span> <span class="token value attr-value">"192.168.80.128:8848"</span><span class="token key attr-name">    group</span> <span class="token punctuation">=</span> <span class="token value attr-value">"SEATA_GROUP"</span><span class="token key attr-name">    namespace</span> <span class="token punctuation">=</span> <span class="token value attr-value">""</span><span class="token key attr-name">    cluster</span> <span class="token punctuation">=</span> <span class="token value attr-value">"default"</span><span class="token key attr-name">    username</span> <span class="token punctuation">=</span> <span class="token value attr-value">"nacos"</span><span class="token key attr-name">    password</span> <span class="token punctuation">=</span> <span class="token value attr-value">"nacos"</span>  }}<span class="token key attr-name">config</span> <span class="token value attr-value">{</span><span class="token key attr-name">  type</span> <span class="token punctuation">=</span> <span class="token value attr-value">"nacos"</span><span class="token key attr-name">  nacos</span> <span class="token value attr-value">{</span><span class="token key attr-name">    serverAddr</span> <span class="token punctuation">=</span> <span class="token value attr-value">"192.168.80.128:8848"</span><span class="token key attr-name">    namespace</span> <span class="token punctuation">=</span> <span class="token value attr-value">""</span><span class="token key attr-name">    group</span> <span class="token punctuation">=</span> <span class="token value attr-value">"SEATA_GROUP"</span><span class="token key attr-name">    username</span> <span class="token punctuation">=</span> <span class="token value attr-value">"nacos"</span><span class="token key attr-name">    password</span> <span class="token punctuation">=</span> <span class="token value attr-value">"nacos"</span><span class="token key attr-name">    dataId</span> <span class="token punctuation">=</span> <span class="token value attr-value">"seata.properties"</span>  }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动seata服务端-1"><a href="#启动seata服务端-1" class="headerlink" title="启动seata服务端"></a>启动seata服务端</h3><ul><li>进入seata根目录中的bin目录下，执行命令（linux）</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nohup</span> ./seata-server.sh <span class="token parameter variable">-h</span> <span class="token number">192.168</span>.80.128 <span class="token parameter variable">-p</span> <span class="token number">8091</span> <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p>注意：</p><ul><li>因为seata服务端在启动时，可能无法找到本机正确的ip，导致客户端连接时，会报错，并且查看nacos注册中心，服务的ip也不对，所以最好在启动的时候，加上<code>-h 192.168.80.128</code></li></ul><pre class="line-numbers language-none"><code class="language-none">ERROR 82884 --- [eoutChecker_1_1] i.s.c.r.netty.NettyClientChannelManager  : 0101 can not connect to 172.17.0.1:8091 cause:can not register RM,err:can not connect to services-server.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>非docker安装的服务，注意需要关闭服务器防火墙，不然客户端无法访问到seata服务端</li></ul></li><li><p>查看nohup日志没有报错，并且nacos服务管理，服务列表中有<code>seata-server</code>服务，即表示启动成功</p></li></ul><h2 id="客户端代码编写"><a href="#客户端代码编写" class="headerlink" title="客户端代码编写"></a>客户端代码编写</h2><p>完整代码gitee地址：<a href="https://gitee.com/aacopy/seata-learn/tree/1.4.2/">https://gitee.com/aacopy/seata-learn/tree/1.4.2/</a></p><p>客户端集成主要步骤</p><h3 id="添加maven依赖"><a href="#添加maven依赖" class="headerlink" title="添加maven依赖"></a>添加maven依赖</h3><ul><li>parent pom.xml</li></ul><pre class="line-numbers language-none"><code class="language-none">&lt;dependencyManagement&gt;  ...  &lt;dependency&gt;    &lt;groupId&gt;io.seata&lt;/groupId&gt;    &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;    &lt;version&gt;1.4.2&lt;/version&gt;  &lt;/dependency&gt;  ...&lt;/dependencyManagement&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>各微服务pom.xml添加seata依赖，和其他springcloud依赖</li></ul><pre class="line-numbers language-none"><code class="language-none">&lt;dependency&gt;&lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;&lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;&lt;/dependency&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="nacos新增配置"><a href="#nacos新增配置" class="headerlink" title="nacos新增配置"></a>nacos新增配置</h3><ul><li>各微服务配置</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">seata</span><span class="token punctuation">:</span>  <span class="token key atrule">config</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.80.128<span class="token punctuation">:</span><span class="token number">8848</span>      <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos      <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">registry</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.80.128<span class="token punctuation">:</span><span class="token number">8848</span>      <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos      <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>seata.properties</li></ul><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">service.vgroupMapping.seata-business-seata-service-group</span><span class="token punctuation">=</span><span class="token value attr-value">default</span><span class="token key attr-name">service.vgroupMapping.seata-storage-seata-service-group</span><span class="token punctuation">=</span><span class="token value attr-value">default</span><span class="token key attr-name">service.vgroupMapping.seata-order-seata-service-group</span><span class="token punctuation">=</span><span class="token value attr-value">default</span><span class="token key attr-name">service.vgroupMapping.seata-account-seata-service-group</span><span class="token punctuation">=</span><span class="token value attr-value">default</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="在调用入口处，添加注解"><a href="#在调用入口处，添加注解" class="headerlink" title="在调用入口处，添加注解"></a>在调用入口处，添加注解</h3><p>服务调用入口service方法上添加注解<code>@GlobalTransactional</code></p><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ul><li>一般微服务有全局异常处理，直接调用会导致分布式事务失效</li><li>需要直接判断业务接口返回值，或者AOP统一处理，或者取消全局异常处理</li></ul><h3 id="启动服务测试"><a href="#启动服务测试" class="headerlink" title="启动服务测试"></a>启动服务测试</h3><p>至此，已全部集成完成，可以启动服务做相关测试</p><h2 id="1-4-2版本问题"><a href="#1-4-2版本问题" class="headerlink" title="1.4.2版本问题"></a>1.4.2版本问题</h2><h3 id="seata1-4-2中io-seata-spring-util-SpringProxyUtils-findTargetClass相关的代码影响了spring-security-oauth2的bean初始化"><a href="#seata1-4-2中io-seata-spring-util-SpringProxyUtils-findTargetClass相关的代码影响了spring-security-oauth2的bean初始化" class="headerlink" title="seata1.4.2中io.seata.spring.util.SpringProxyUtils#findTargetClass相关的代码影响了spring security oauth2的bean初始化"></a>seata1.4.2中io.seata.spring.util.SpringProxyUtils#findTargetClass相关的代码影响了spring security oauth2的bean初始化</h3><p><a href="https://github.com/seata/seata/issues/3709">https://github.com/seata/seata/issues/3709</a></p><p>启动报错：</p><pre class="line-numbers language-none"><code class="language-none">[datacenter:10.66.38.102:9011] 2022-02-09 15:21:06.228 ERROR 23440 [main] org.springframework.boot.SpringApplication 826 Application run failedorg.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.security.oauth2.config.annotation.web.configuration.OAuth2ClientConfiguration$OAuth2ClientContextConfiguration': Injection of resource dependencies failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'accessTokenRequest': Post-processing of FactoryBean's singleton object failed; nested exception is java.lang.RuntimeException: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'scopedTarget.accessTokenRequest': Scope 'request' is not active for the current thread; consider defining a scoped proxy for this bean if you intend to refer to it from a singleton; nested exception is java.lang.IllegalStateException: No thread-bound request found: Are you referring to request attributes outside of an actual web request, or processing a request outside of the originally receiving thread? If you are actually operating within a web request and still receive this message, your code is probably running outside of DispatcherServlet: In this case, use RequestContextListener or RequestContextFilter to expose the current request.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>查看当前develop版本已经修复了<a href="https://github.com/seata/seata/blob/develop/spring/src/main/java/io/seata/spring/util/SpringProxyUtils.java">https://github.com/seata/seata/blob/develop/spring/src/main/java/io/seata/spring/util/SpringProxyUtils.java</a></p><p>参照issues上的建议，当前版本将修复后的文件覆盖原有文件</p><p><a href="https://github.com/ls9527/seata/blob/ddaeaf7678368a8fad0f8c579446ca8ecde2b683/spring/src/main/java/io/seata/spring/util/SpringProxyUtils.java">https://github.com/ls9527/seata/blob/ddaeaf7678368a8fad0f8c579446ca8ecde2b683/spring/src/main/java/io/seata/spring/util/SpringProxyUtils.java</a></p>]]></content>
      
      
      <categories>
          
          <category> Seata </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seata </tag>
            
            <tag> 分布式事务 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring-RestTemplate</title>
      <link href="/spring/spring-resttemplate/"/>
      <url>/spring/spring-resttemplate/</url>
      
        <content type="html"><![CDATA[<h2 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h2><ul><li><p>RestTemplate是Spring提供的用于访问Rest服务的客户端</p></li><li><p>底层通过使用java.net包下的实现创建HTTP 请求</p></li><li><p>通过使用ClientHttpRequestFactory指定不同的HTTP请求方式，主要提供了两种实现方式</p><ul><li>SimpleClientHttpRequestFactory（默认）<ul><li>底层使用J2SE提供的方式，既java.net包提供的方式，创建底层的Http请求连接</li><li>主要createRequest 方法（ 断点调试），每次都会创建一个新的连接，每次都创建连接会造成极大的资源浪费，而且若连接不能及时释放，会因为无法建立新的连接导致后面的请求阻塞</li></ul></li><li>HttpComponentsClientHttpRequestFactory<ul><li>底层使用HttpClient访问远程的Http服务</li></ul></li></ul></li></ul><h2 id="RestTemplate报错"><a href="#RestTemplate报错" class="headerlink" title="RestTemplate报错"></a>RestTemplate报错</h2><h3 id="Broken-pipe"><a href="#Broken-pipe" class="headerlink" title="Broken pipe"></a>Broken pipe</h3><ul><li>服务端向前端socket连接管道写返回数据时链接（pipe）已经断开了</li><li>从应用角度分析，这是因为客户端等待返回超时了，主动断开了与服务端链接</li><li>连接数设置太小，并发量增加后，造成大量请求排队等待</li><li>网络延迟，是否有丢包</li><li>内存是否足够多支持对应的并发量</li></ul><h2 id="问题解决思路"><a href="#问题解决思路" class="headerlink" title="问题解决思路"></a>问题解决思路</h2><ul><li>客户端每次请求都要和服务端建立新的连接，即三次握手将会非常耗时</li><li>通过http连接池可以减少连接建立与释放的时间，提升http请求的性能</li><li>Spring的restTemplate是对httpclient进行了封装, 而httpclient是支持池化机制</li><li>对httpclient进行封装的有：Apache的Fluent、es的restHighLevelClient、spring的restTemplate等</li></ul><h2 id="编码实践"><a href="#编码实践" class="headerlink" title="编码实践"></a>编码实践</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestTemplateConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token class-name">ClientHttpRequestFactory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">ClientHttpRequestFactory</span> <span class="token function">httpComponentsClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpComponentsClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token function">httpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">HttpClient</span> <span class="token function">httpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Registry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConnectionSocketFactory</span><span class="token punctuation">&gt;</span></span> registry <span class="token operator">=</span> <span class="token class-name">RegistryBuilder</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConnectionSocketFactory</span><span class="token punctuation">&gt;</span></span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">,</span> <span class="token class-name">PlainConnectionSocketFactory</span><span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"https"</span><span class="token punctuation">,</span> <span class="token class-name">SSLConnectionSocketFactory</span><span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">PoolingHttpClientConnectionManager</span> connectionManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolingHttpClientConnectionManager</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置整个连接池最大连接数</span>        connectionManager<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//MaxPerRoute路由是对maxTotal的细分,每个主机的并发最大是300，这里route指的是域名</span>        <span class="token comment">//MaxPerRoute所有路由的并发数加起来不会超过最大连接数</span>        connectionManager<span class="token punctuation">.</span><span class="token function">setDefaultMaxPerRoute</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">RequestConfig</span> requestConfig <span class="token operator">=</span> <span class="token class-name">RequestConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">//返回数据的超时时间</span>                <span class="token punctuation">.</span><span class="token function">setSocketTimeout</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span>                <span class="token comment">//连接上服务器的超时时间</span>                <span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>                <span class="token comment">//从连接池中获取连接的超时时间</span>                <span class="token punctuation">.</span><span class="token function">setConnectionRequestTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">HttpClientBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">setDefaultRequestConfig</span><span class="token punctuation">(</span>requestConfig<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">setConnectionManager</span><span class="token punctuation">(</span>connectionManager<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring-@Async</title>
      <link href="/spring/spring-async/"/>
      <url>/spring/spring-async/</url>
      
        <content type="html"><![CDATA[<p>@Async用于在Spring中执行异步任务</p><h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><ul><li>启动类里面使用@EnableAsync注解开启功能，自动扫描</li><li>定义异步任务类并使用@Component标记组件被容器扫描,异步方法加上@Async</li></ul><h2 id="Async失效情况"><a href="#Async失效情况" class="headerlink" title="@Async失效情况"></a>@Async失效情况</h2><ul><li>注解@Async的方法不是public方法</li><li>注解@Async的返回值只能为void或者Future</li><li>注解@Async方法使用static修饰也会失效</li><li>spring无法扫描到异步类，没加注解@Async 或 @EnableAsync注解</li><li>调用方与被调方不能在同一个类<ul><li>Spring 在扫描bean的时候会扫描方法上是否包含@Async注解，动态地生成一个子类（即proxy代理类），当这个有注解的方法被调用的时候，实际上是由代理类来调用的，代理类在调用时增加异步作用</li><li>如果这个有注解的方法是被同一个类中的其他方法调用的，那么该方法的调用并没有通过代理类，而是直接通过原来的那个 bean，所以就失效了</li><li>所以调用方与被调方不能在同一个类，主要是使用了动态代理，同一个类的时候直接调用，不是通过生成的动态代理类调用</li><li>一般将要异步执行的方法单独抽取成一个类</li></ul></li><li>类中需要使用@Autowired或@Resource等注解自动注入，不能自己手动new对象</li><li>在Async 方法上标注@Transactional是没用的，但在Async 方法调用的方法上标注@Transactional 是有效的</li></ul><h2 id="编码实践"><a href="#编码实践" class="headerlink" title="编码实践"></a>编码实践</h2><h3 id="编写接口"><a href="#编写接口" class="headerlink" title="编写接口"></a>编写接口</h3><p>RestTemplate远程调用第三方地址</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NoticeServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">NoticeService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> beginTime <span class="token operator">=</span> <span class="token class-name">CommonUtil</span><span class="token punctuation">.</span><span class="token function">getCurrentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> forEntity <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span><span class="token string">"http://xxx"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> body <span class="token operator">=</span> forEntity<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token class-name">CommonUtil</span><span class="token punctuation">.</span><span class="token function">getCurrentTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"耗时={},body={}"</span><span class="token punctuation">,</span>endTime<span class="token operator">-</span>beginTime<span class="token punctuation">,</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Jmeter压力测试："><a href="#Jmeter压力测试：" class="headerlink" title="Jmeter压力测试："></a>Jmeter压力测试：</h3><p>线程数：200，Ramp-Up时间：2，循环次数：500</p><table><thead><tr><th>Label</th><th># 样本</th><th>平均值</th><th>中位数</th><th>90% 百分位</th><th>95% 百分位</th><th>99% 百分位</th><th>最小值</th><th>最大值</th><th>异常 %</th><th>吞吐量</th><th>接收 KB/sec</th><th>发送 KB/sec</th></tr></thead><tbody><tr><td>HTTP请求</td><td>100000</td><td>73</td><td>31</td><td>282</td><td>346</td><td>440</td><td>27</td><td>3005</td><td>0.00%</td><td>2432.79406</td><td>488.72</td><td>337.36</td></tr><tr><td>总体</td><td>100000</td><td>73</td><td>31</td><td>282</td><td>346</td><td>440</td><td>27</td><td>3005</td><td>0.00%</td><td>2432.79406</td><td>488.72</td><td>337.36</td></tr></tbody></table><h3 id="异步调用"><a href="#异步调用" class="headerlink" title="异步调用"></a>异步调用</h3><ul><li><p>在启动类上添加注解<code>@EnableAsync</code></p></li><li><p>在service实现方法NoticeServiceImpl上添加注解<code>@Async</code></p></li></ul><p>再次压测</p><table><thead><tr><th>Label</th><th># 样本</th><th>平均值</th><th>中位数</th><th>90% 百分位</th><th>95% 百分位</th><th>99% 百分位</th><th>最小值</th><th>最大值</th><th>异常 %</th><th>吞吐量</th><th>接收 KB/sec</th><th>发送 KB/sec</th></tr></thead><tbody><tr><td>HTTP请求</td><td>100000</td><td>12</td><td>10</td><td>22</td><td>28</td><td>44</td><td>0</td><td>170</td><td>0.00%</td><td>13065.06402</td><td>2624.62</td><td>1811.76</td></tr><tr><td>总体</td><td>100000</td><td>12</td><td>10</td><td>22</td><td>28</td><td>44</td><td>0</td><td>170</td><td>0.00%</td><td>13065.06402</td><td>2624.62</td><td>1811.76</td></tr></tbody></table><h2 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h2><p>现象：压测后很快跑完全部内容，是因为都在线程池内部的阻塞队列里面</p><ul><li><p>极容易出现OOM，或者消息丢失</p></li><li><p>默认8个核心线程数占用满了之后, 新的调用就会进入队列, 最大值是Integer.MAX_VALUE</p></li><li><p>设置下idea启动进程的jvm参数： -Xms50M -Xmx50M，再次压测，会出现异常</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Exception</span> in thread <span class="token string">"http-nio-8001-Poller"</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token class-name">Java</span> heap space<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>代码位置：</p><ul><li>TaskExecutionProperties</li><li>TaskExecutionAutoConfiguration</li></ul><p>说明：</p><ul><li>直接使用 @Async 注解没指定线程池的话，即未设置TaskExecutor时</li><li>默认使用Spring创建ThreadPoolTaskExecutor</li><li>核心线程数：8</li><li>最大线程数：Integer.MAX_VALUE ( 21亿多)</li><li>队列使用LinkedBlockingQueue</li><li>容量是：Integer.MAX_VALUE</li><li>空闲线程保留时间：60s</li><li>线程池拒绝策略：AbortPolicy</li></ul><h2 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h2><h3 id="ThreadPoolTaskExecutor和ThreadPoolExecutor"><a href="#ThreadPoolTaskExecutor和ThreadPoolExecutor" class="headerlink" title="ThreadPoolTaskExecutor和ThreadPoolExecutor"></a>ThreadPoolTaskExecutor和ThreadPoolExecutor</h3><ul><li><code>ThreadPoolExecutor</code>，这个类是JDK中的线程池类，继承自<code>Executor</code>，里面有一个<code>execute()</code>方法，用来执行线程，线程池主要提供一个线程队列，队列中保存着所有等待状态的线程，避免了创建与销毁的额外开销</li><li><code>ThreadPoolTaskExecutor</code>，是spring包下的，是Spring为我们提供的线程池类，Spring异步线程池的接口类是<code>TaskExecutor</code>，本质还是<code>java.util.concurrent.Executor</code></li></ul><h3 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h3><p>spring会先搜索<code>TaskExecutor</code>类型的bean或者名字为<code>taskExecutor</code>的<code>Executor</code>类型的<code>bean</code>，所以我们最好来自定义一个线程池，加入<code>Spring IOC</code>容器里面，即可覆盖</p><p>去掉启动类上的<code>@EnableAsync</code>注解，添加线程配置类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@EnableAsync</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolTaskConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"threadPoolTaskExecutor"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolTaskExecutor</span> <span class="token function">threadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">ThreadPoolTaskExecutor</span> threadPoolTaskExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//线程池创建的核心线程数，线程池维护线程的最少数量，即使没有任务需要执行，也会一直存活</span>        <span class="token comment">//如果设置allowCoreThreadTimeout=true（默认false）时，核心线程会超时关闭</span>        threadPoolTaskExecutor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//最大线程池数量，当线程数&gt;=corePoolSize，且任务队列已满时。线程池会创建新线程来处理任务</span>        <span class="token comment">//当线程数=maxPoolSize，且任务队列已满时，线程池会拒绝处理任务而抛出异常</span>        threadPoolTaskExecutor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//缓存队列（阻塞队列）当核心线程数达到最大时，新任务会放在队列中排队等待执行</span>        threadPoolTaskExecutor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//当线程空闲时间达到keepAliveTime时，线程会退出，直到线程数量=corePoolSize</span>        <span class="token comment">//允许线程空闲时间60秒，当maxPoolSize的线程在空闲时间到达的时候销毁</span>        <span class="token comment">//如果allowCoreThreadTimeout=true，则会直到线程数量=0</span>        threadPoolTaskExecutor<span class="token punctuation">.</span><span class="token function">setKeepAliveSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//spring 提供的 ThreadPoolTaskExecutor 线程池，是有setThreadNamePrefix() 方法的。</span>        <span class="token comment">//jdk 提供的ThreadPoolExecutor 线程池是没有 setThreadNamePrefix() 方法的</span>        threadPoolTaskExecutor<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span><span class="token string">"自定义线程："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        threadPoolTaskExecutor<span class="token punctuation">.</span><span class="token function">setWaitForTasksToCompleteOnShutdown</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// rejection-policy：当pool已经达到max size的时候，如何处理新任务</span>        <span class="token comment">// CallerRunsPolicy()：交由调用方线程运行，比如 main 线程；如果添加到线程池失败，那么主线程会自己去执行该任务，不会等待线程池中的线程去执行</span>        <span class="token comment">//AbortPolicy()：该策略是线程池的默认策略，如果线程池队列满了丢掉这个任务并且抛出RejectedExecutionException异常。</span>        <span class="token comment">//DiscardPolicy()：如果线程池队列满了，会直接丢掉这个任务并且不会有任何异常</span>        <span class="token comment">//DiscardOldestPolicy()：丢弃队列中最老的任务，队列满了，会将最早进入队列的任务删掉腾出空间，再尝试加入队列</span>        threadPoolTaskExecutor<span class="token punctuation">.</span><span class="token function">setRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        threadPoolTaskExecutor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> threadPoolTaskExecutor<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Async</span><span class="token punctuation">(</span><span class="token string">"threadPoolTaskExecutor"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p>线程判断规则：</p><p>先是CorePoolSize是否满足，然后是Queue阻塞队列是否满，最后才是MaxPoolSize是否满足</p></li><li><p>高并发下核心线程怎么设置？</p><ul><li>分IO密集还是CPU密集<ul><li>CPU密集设置为跟核心数一样大小</li><li>IO密集型设置为2倍CPU核心数</li></ul></li><li>非固定，根据实际情况压测进行调整</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>验证码-Kaptcha</title>
      <link href="/yan-zheng-ma/kaptcha/"/>
      <url>/yan-zheng-ma/kaptcha/</url>
      
        <content type="html"><![CDATA[<p>Kaptcha是谷歌开源的一个可高度配置的验证码生成工具</p><ul><li>验证码的字体/大小/颜色</li><li>验证码内容的范围(数字，字母，中文汉字！)</li><li>验证码图片的大小，边框，边框粗细，边框颜色</li><li>验证码的干扰线</li><li>验证码的样式(鱼眼样式、3D、普通模糊)</li></ul><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kaptcha-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="验证码配置"><a href="#验证码配置" class="headerlink" title="验证码配置"></a>验证码配置</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CaptchaConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">DefaultKaptcha</span> <span class="token function">kaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">DefaultKaptcha</span> kaptcha <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultKaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//    properties.setProperty(Constants.KAPTCHA_BORDER, "yes");</span><span class="token comment">//    properties.setProperty(Constants.KAPTCHA_BORDER_COLOR, "220,220,220");</span><span class="token comment">//    //properties.setProperty(Constants.KAPTCHA_TEXTPRODUCER_FONT_COLOR, "38,29,12");</span><span class="token comment">//    properties.setProperty(Constants.KAPTCHA_IMAGE_WIDTH, "147");</span><span class="token comment">//    properties.setProperty(Constants.KAPTCHA_IMAGE_HEIGHT, "34");</span><span class="token comment">//    properties.setProperty(Constants.KAPTCHA_TEXTPRODUCER_FONT_SIZE, "25");</span><span class="token comment">//    //properties.setProperty(Constants.KAPTCHA_SESSION_KEY, "code");</span>        <span class="token comment">//验证码个数</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">KAPTCHA_TEXTPRODUCER_CHAR_LENGTH</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//    properties.setProperty(Constants.KAPTCHA_TEXTPRODUCER_FONT_NAMES, "Courier");</span>        <span class="token comment">//字体间隔</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">KAPTCHA_TEXTPRODUCER_CHAR_SPACE</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//干扰线颜色</span><span class="token comment">//    properties.setProperty(Constants.KAPTCHA_NOISE_COLOR, "white");</span>        <span class="token comment">//干扰实现类</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">KAPTCHA_NOISE_IMPL</span><span class="token punctuation">,</span> <span class="token string">"com.google.code.kaptcha.impl.NoNoise"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//图片样式</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">KAPTCHA_OBSCURIFICATOR_IMPL</span><span class="token punctuation">,</span> <span class="token string">"com.google.code.kaptcha.impl.WaterRipple"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//文字来源</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">KAPTCHA_TEXTPRODUCER_CHAR_STRING</span><span class="token punctuation">,</span> <span class="token string">"0123456789"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>        kaptcha<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> kaptcha<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>account<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>account<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">SendCodeEnum</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>account<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">SendCodeRequest</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>account<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">NoticeService</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">BizCodeEnum</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">CommonUtil</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>dcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">JsonData</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>code<span class="token punctuation">.</span>kaptcha<span class="token punctuation">.</span></span><span class="token class-name">Producer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpHeaders</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Validated</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>imageio<span class="token punctuation">.</span></span><span class="token class-name">ImageIO</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletOutputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span>image<span class="token punctuation">.</span></span><span class="token class-name">BufferedImage</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author cmyang * @date 2022/2/1 21:25 */</span><span class="token annotation punctuation">@RestController</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/v1/notice"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NoticeController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">NoticeService</span> noticeService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">Producer</span> producer<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">REDIS_CAPTCHA_KEY_PREFIX</span> <span class="token operator">=</span> <span class="token string">"account-service:captcha:"</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 获取验证码     */</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/captcha"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getCaptcha</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> text <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">createText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"验证码内容：{}"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//保存在redis，设置10分钟过期</span>        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">getRedisCaptchaKey</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BufferedImage</span> image <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">createImage</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ServletOutputStream</span> outputStream <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token class-name">ImageIO</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token string">"jpg"</span><span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>            outputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"获取流出错：{}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 获取验证码，通过ip+浏览器User-Agent区分     * @return     */</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getRedisCaptchaKey</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> ip <span class="token operator">=</span> <span class="token class-name">CommonUtil</span><span class="token punctuation">.</span><span class="token function">getIpAddr</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> userAgent <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">USER_AGENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token constant">REDIS_CAPTCHA_KEY_PREFIX</span><span class="token operator">+</span><span class="token class-name">CommonUtil</span><span class="token punctuation">.</span><span class="token function">MD5</span><span class="token punctuation">(</span>ip<span class="token operator">+</span>userAgent<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 发送短信验证码     * @param sendCodeRequest     * @return     */</span>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/send_code"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">JsonData</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token annotation punctuation">@Validated</span> <span class="token class-name">SendCodeRequest</span> sendCodeRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//验证图片验证码是否正确</span>        <span class="token class-name">String</span> cacheKey <span class="token operator">=</span> <span class="token function">getRedisCaptchaKey</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> cacheValue <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//先删除缓存key，验证一次后，需要重新获取验证码</span>        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>sendCodeRequest<span class="token punctuation">.</span><span class="token function">getCaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cacheValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">buildResult</span><span class="token punctuation">(</span><span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span><span class="token constant">CODE_CAPTCHA_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> noticeService<span class="token punctuation">.</span><span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">SendCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_REGISTER</span><span class="token punctuation">,</span> sendCodeRequest<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>获取ip的方法</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getIpAddr</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token class-name">String</span> ipAddress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>       <span class="token keyword">try</span> <span class="token punctuation">{</span>           ipAddress <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"x-forwarded-for"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>ipAddress <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> ipAddress<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token string">"unknown"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>ipAddress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>               ipAddress <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Proxy-Client-IP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>ipAddress <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> ipAddress<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token string">"unknown"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>ipAddress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>               ipAddress <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"WL-Proxy-Client-IP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>ipAddress <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> ipAddress<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token string">"unknown"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>ipAddress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>               ipAddress <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token keyword">if</span> <span class="token punctuation">(</span>ipAddress<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   <span class="token comment">// 根据网卡取本机配置的IP</span>                   <span class="token class-name">InetAddress</span> inet <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                   <span class="token keyword">try</span> <span class="token punctuation">{</span>                       inet <span class="token operator">=</span> <span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnknownHostException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                       e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token punctuation">}</span>                   ipAddress <span class="token operator">=</span> inet<span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>           <span class="token punctuation">}</span>           <span class="token comment">// 对于通过多个代理的情况，第一个IP为客户端真实IP,多个IP按照','分割</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>ipAddress <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> ipAddress<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>               <span class="token comment">// "***.***.***.***".length()</span>               <span class="token comment">// = 15</span>               <span class="token keyword">if</span> <span class="token punctuation">(</span>ipAddress<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   ipAddress <span class="token operator">=</span> ipAddress<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ipAddress<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">}</span>           <span class="token punctuation">}</span>       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>           ipAddress <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>       <span class="token keyword">return</span> ipAddress<span class="token punctuation">;</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 验证码 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 验证码 </tag>
            
            <tag> Kaptcha </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>短信平台接入测试</title>
      <link href="/duan-xin/duan-xin-ping-tai-jie-ru-ce-shi/"/>
      <url>/duan-xin/duan-xin-ping-tai-jie-ru-ce-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="短信平台"><a href="#短信平台" class="headerlink" title="短信平台"></a>短信平台</h2><ul><li>阿里云：<a href="https://www.aliyun.com/product/sms">https://www.aliyun.com/product/sms</a></li><li>腾讯云：<a href="https://cloud.tencent.com/product/sms">https://cloud.tencent.com/product/sms</a></li><li>第三方厂商：<a href="https://market.aliyun.com/products/57000002/cmapi00046920.html">https://market.aliyun.com/products/57000002/cmapi00046920.html</a></li></ul><h2 id="购买短信"><a href="#购买短信" class="headerlink" title="购买短信"></a>购买短信</h2><p>个人开发或者测试可以接入第三方厂商，费用很低，不需要审核</p><p><a href="https://market.aliyun.com/products/57000002/cmapi00046920.html">https://market.aliyun.com/products/57000002/cmapi00046920.html</a></p><p>购买3元75条和0元5条测试</p><p><img src="/images/%E7%9F%AD%E4%BF%A1%E5%B9%B3%E5%8F%B0%E6%8E%A5%E5%85%A5%E6%B5%8B%E8%AF%95/image-20220131113433013.png"></p><p>购买成功后，打开地址，查看订单和开发需要用到的AppKey，AppSecret，AppCode</p><h2 id="代码接入"><a href="#代码接入" class="headerlink" title="代码接入"></a>代码接入</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#短信配置</span><span class="token key atrule">sms</span><span class="token punctuation">:</span>  <span class="token key atrule">app-code</span><span class="token punctuation">:</span> 订单中的AppCode  <span class="token key atrule">template-id</span><span class="token punctuation">:</span> M72CB42894<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="短信配置类"><a href="#短信配置类" class="headerlink" title="短信配置类"></a>短信配置类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"sms"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SmsConfig</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> appCode<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> templateId<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="HTTP发送配置"><a href="#HTTP发送配置" class="headerlink" title="HTTP发送配置"></a>HTTP发送配置</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestTemplateConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token class-name">ClientHttpRequestFactory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">ClientHttpRequestFactory</span> <span class="token function">simpleClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">SimpleClientHttpRequestFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factory<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factory<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="发送短信"><a href="#发送短信" class="headerlink" title="发送短信"></a>发送短信</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SmsComponent</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">SmsConfig</span> smsConfig<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">URL_TEMPLATE</span> <span class="token operator">=</span> <span class="token string">"https://jmsms.market.alicloudapi.com/sms/send?mobile=%s&amp;templateId=%s&amp;value=%s"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token keyword">to</span><span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token constant">URL_TEMPLATE</span><span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">,</span> smsConfig<span class="token punctuation">.</span><span class="token function">getTemplateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        headers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> <span class="token string">"APPCODE "</span> <span class="token operator">+</span> smsConfig<span class="token punctuation">.</span><span class="token function">getAppCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">,</span> entity<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"发送短信成功,响应信息:{}"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"发送短信失败,响应信息:{}：{}"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountTest</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">SmsComponent</span> smsComponent<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">sendTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        smsComponent<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"18566668888"</span><span class="token punctuation">,</span> <span class="token string">"666888"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="短信验证码失效时间"><a href="#短信验证码失效时间" class="headerlink" title="短信验证码失效时间"></a>短信验证码失效时间</h2><p>开发中短信验证码，一般有两个过期时间，一个是60秒防止重复发送，一个验证码10分钟有效，通过一个redis的key来判断，可以通过过期时间差来判断</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">CODE_EXPIRE_SECONDS</span> <span class="token operator">=</span> <span class="token number">600L</span><span class="token punctuation">;</span>   <span class="token keyword">public</span> <span class="token class-name">JsonData</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">SendCodeEnum</span> sendCodeEnum<span class="token punctuation">,</span> <span class="token class-name">String</span> <span class="token keyword">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token class-name">String</span> cacheKey <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">RedisKey</span><span class="token punctuation">.</span><span class="token constant">CHECK_CODE_KEY</span><span class="token punctuation">,</span> sendCodeEnum<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token class-name">Long</span> expireSeconds <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">getExpire</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//判断是否是60秒内重复发送</span>       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">CODE_EXPIRE_SECONDS</span> <span class="token operator">-</span> expireSeconds <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token keyword">return</span> <span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">buildResult</span><span class="token punctuation">(</span><span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span><span class="token constant">CODE_LIMITED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>       <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">CommonUtil</span><span class="token punctuation">.</span><span class="token function">getRandomCode</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token constant">CODE_EXPIRE_SECONDS</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CheckUtil</span><span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token comment">//发送邮箱验证码</span>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CheckUtil</span><span class="token punctuation">.</span><span class="token function">isPhone</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token comment">//发送短信验证码</span>           smsComponent<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">,</span> smsConfig<span class="token punctuation">.</span><span class="token function">getTemplateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>       <span class="token keyword">return</span> <span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">buildSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 短信 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 短信 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQ安装-Docker</title>
      <link href="/rabbitmq/rabbitmq-an-zhuang-docker/"/>
      <url>/rabbitmq/rabbitmq-an-zhuang-docker/</url>
      
        <content type="html"><![CDATA[<h2 id="安装命令"><a href="#安装命令" class="headerlink" title="安装命令"></a>安装命令</h2><p>安装指定版本：3.8.15-management</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> rabbitmq <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">RABBITMQ_DEFAULT_USER</span><span class="token operator">=</span>admin <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">RABBITMQ_DEFAULT_PASS</span><span class="token operator">=</span>aacopy.cn <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">15672</span>:15672 <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">5672</span>:5672 <span class="token punctuation">\</span>rabbitmq:3.8.15-management<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>访问地址：<a href="http://192.168.80.128:15672/">http://192.168.80.128:15672/</a></p><p>账号密码：admin/aacopy.cn</p>]]></content>
      
      
      <categories>
          
          <category> RabbitMQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 消息队列 </tag>
            
            <tag> RabbitMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nacos安装-Docker</title>
      <link href="/springcloud/nacos-an-zhuang-docker/"/>
      <url>/springcloud/nacos-an-zhuang-docker/</url>
      
        <content type="html"><![CDATA[<h2 id="nacos安装"><a href="#nacos安装" class="headerlink" title="nacos安装"></a>nacos安装</h2><p>笔记安装版本 2.0.2</p><h3 id="创建数据库执行脚本"><a href="#创建数据库执行脚本" class="headerlink" title="创建数据库执行脚本"></a>创建数据库执行脚本</h3><h4 id="创建数据库：nacos-config"><a href="#创建数据库：nacos-config" class="headerlink" title="创建数据库：nacos_config"></a>创建数据库：nacos_config</h4><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE DATABASE `nacos_config` CHARACTER SET 'utf8mb4' COLLATE 'utf8mb4_bin';<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="执行建表脚本"><a href="#执行建表脚本" class="headerlink" title="执行建表脚本"></a>执行建表脚本</h4><p>脚本地址：<a href="https://github.com/alibaba/nacos/blob/2.0.2/distribution/conf/nacos-mysql.sql">https://github.com/alibaba/nacos/blob/2.0.2/distribution/conf/nacos-mysql.sql</a></p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">/* * Copyright 1999-2018 Alibaba Group Holding Ltd. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * *      http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. *//******************************************//*   数据库全名 = nacos_config   *//*   表名称 = config_info   *//******************************************/CREATE TABLE `config_info` (  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',  `data_id` varchar(255) NOT NULL COMMENT 'data_id',  `group_id` varchar(255) DEFAULT NULL,  `content` longtext NOT NULL COMMENT 'content',  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',  `src_user` text COMMENT 'source user',  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',  `app_name` varchar(128) DEFAULT NULL,  `tenant_id` varchar(128) DEFAULT '' COMMENT '租户字段',  `c_desc` varchar(256) DEFAULT NULL,  `c_use` varchar(64) DEFAULT NULL,  `effect` varchar(64) DEFAULT NULL,  `type` varchar(64) DEFAULT NULL,  `c_schema` text,  PRIMARY KEY (`id`),  UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info';/******************************************//*   数据库全名 = nacos_config   *//*   表名称 = config_info_aggr   *//******************************************/CREATE TABLE `config_info_aggr` (  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',  `data_id` varchar(255) NOT NULL COMMENT 'data_id',  `group_id` varchar(255) NOT NULL COMMENT 'group_id',  `datum_id` varchar(255) NOT NULL COMMENT 'datum_id',  `content` longtext NOT NULL COMMENT '内容',  `gmt_modified` datetime NOT NULL COMMENT '修改时间',  `app_name` varchar(128) DEFAULT NULL,  `tenant_id` varchar(128) DEFAULT '' COMMENT '租户字段',  PRIMARY KEY (`id`),  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='增加租户字段';/******************************************//*   数据库全名 = nacos_config   *//*   表名称 = config_info_beta   *//******************************************/CREATE TABLE `config_info_beta` (  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',  `data_id` varchar(255) NOT NULL COMMENT 'data_id',  `group_id` varchar(128) NOT NULL COMMENT 'group_id',  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',  `content` longtext NOT NULL COMMENT 'content',  `beta_ips` varchar(1024) DEFAULT NULL COMMENT 'betaIps',  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',  `src_user` text COMMENT 'source user',  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',  `tenant_id` varchar(128) DEFAULT '' COMMENT '租户字段',  PRIMARY KEY (`id`),  UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info_beta';/******************************************//*   数据库全名 = nacos_config   *//*   表名称 = config_info_tag   *//******************************************/CREATE TABLE `config_info_tag` (  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',  `data_id` varchar(255) NOT NULL COMMENT 'data_id',  `group_id` varchar(128) NOT NULL COMMENT 'group_id',  `tenant_id` varchar(128) DEFAULT '' COMMENT 'tenant_id',  `tag_id` varchar(128) NOT NULL COMMENT 'tag_id',  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',  `content` longtext NOT NULL COMMENT 'content',  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',  `src_user` text COMMENT 'source user',  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',  PRIMARY KEY (`id`),  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info_tag';/******************************************//*   数据库全名 = nacos_config   *//*   表名称 = config_tags_relation   *//******************************************/CREATE TABLE `config_tags_relation` (  `id` bigint(20) NOT NULL COMMENT 'id',  `tag_name` varchar(128) NOT NULL COMMENT 'tag_name',  `tag_type` varchar(64) DEFAULT NULL COMMENT 'tag_type',  `data_id` varchar(255) NOT NULL COMMENT 'data_id',  `group_id` varchar(128) NOT NULL COMMENT 'group_id',  `tenant_id` varchar(128) DEFAULT '' COMMENT 'tenant_id',  `nid` bigint(20) NOT NULL AUTO_INCREMENT,  PRIMARY KEY (`nid`),  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),  KEY `idx_tenant_id` (`tenant_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_tag_relation';/******************************************//*   数据库全名 = nacos_config   *//*   表名称 = group_capacity   *//******************************************/CREATE TABLE `group_capacity` (  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',  `group_id` varchar(128) NOT NULL DEFAULT '' COMMENT 'Group ID，空字符表示整个集群',  `quota` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '配额，0表示使用默认值',  `usage` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '使用量',  `max_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '单个配置大小上限，单位为字节，0表示使用默认值',  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '聚合子配置最大个数，，0表示使用默认值',  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值',  `max_history_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '最大变更历史数量',  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',  PRIMARY KEY (`id`),  UNIQUE KEY `uk_group_id` (`group_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='集群、各Group容量信息表';/******************************************//*   数据库全名 = nacos_config   *//*   表名称 = his_config_info   *//******************************************/CREATE TABLE `his_config_info` (  `id` bigint(64) unsigned NOT NULL,  `nid` bigint(20) unsigned NOT NULL AUTO_INCREMENT,  `data_id` varchar(255) NOT NULL,  `group_id` varchar(128) NOT NULL,  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',  `content` longtext NOT NULL,  `md5` varchar(32) DEFAULT NULL,  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,  `src_user` text,  `src_ip` varchar(50) DEFAULT NULL,  `op_type` char(10) DEFAULT NULL,  `tenant_id` varchar(128) DEFAULT '' COMMENT '租户字段',  PRIMARY KEY (`nid`),  KEY `idx_gmt_create` (`gmt_create`),  KEY `idx_gmt_modified` (`gmt_modified`),  KEY `idx_did` (`data_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='多租户改造';/******************************************//*   数据库全名 = nacos_config   *//*   表名称 = tenant_capacity   *//******************************************/CREATE TABLE `tenant_capacity` (  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',  `tenant_id` varchar(128) NOT NULL DEFAULT '' COMMENT 'Tenant ID',  `quota` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '配额，0表示使用默认值',  `usage` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '使用量',  `max_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '单个配置大小上限，单位为字节，0表示使用默认值',  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '聚合子配置最大个数',  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值',  `max_history_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '最大变更历史数量',  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',  PRIMARY KEY (`id`),  UNIQUE KEY `uk_tenant_id` (`tenant_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='租户容量信息表';CREATE TABLE `tenant_info` (  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',  `kp` varchar(128) NOT NULL COMMENT 'kp',  `tenant_id` varchar(128) default '' COMMENT 'tenant_id',  `tenant_name` varchar(128) default '' COMMENT 'tenant_name',  `tenant_desc` varchar(256) DEFAULT NULL COMMENT 'tenant_desc',  `create_source` varchar(32) DEFAULT NULL COMMENT 'create_source',  `gmt_create` bigint(20) NOT NULL COMMENT '创建时间',  `gmt_modified` bigint(20) NOT NULL COMMENT '修改时间',  PRIMARY KEY (`id`),  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),  KEY `idx_tenant_id` (`tenant_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='tenant_info';CREATE TABLE `users` (`username` varchar(50) NOT NULL PRIMARY KEY,`password` varchar(500) NOT NULL,`enabled` boolean NOT NULL);CREATE TABLE `roles` (`username` varchar(50) NOT NULL,`role` varchar(50) NOT NULL,UNIQUE INDEX `idx_user_role` (`username` ASC, `role` ASC) USING BTREE);CREATE TABLE `permissions` (    `role` varchar(50) NOT NULL,    `resource` varchar(255) NOT NULL,    `action` varchar(8) NOT NULL,    UNIQUE INDEX `uk_role_permission` (`role`,`resource`,`action`) USING BTREE);INSERT INTO users (username, password, enabled) VALUES ('nacos', '$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu', TRUE);INSERT INTO roles (username, role) VALUES ('nacos', 'ROLE_ADMIN');<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="docker创建命令"><a href="#docker创建命令" class="headerlink" title="docker创建命令"></a>docker创建命令</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">NACOS_AUTH_ENABLE</span><span class="token operator">=</span>true <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">MODE</span><span class="token operator">=</span>standalone <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">JVM_XMS</span><span class="token operator">=</span>128m <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">JVM_XMX</span><span class="token operator">=</span>128m <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">JVM_XMN</span><span class="token operator">=</span>128m <span class="token punctuation">\</span><span class="token parameter variable">-p</span> <span class="token number">8848</span>:8848 <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">SPRING_DATASOURCE_PLATFORM</span><span class="token operator">=</span>mysql <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_SERVICE_HOST</span><span class="token operator">=</span><span class="token number">192.168</span>.80.128 <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_SERVICE_PORT</span><span class="token operator">=</span><span class="token number">3306</span> <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_SERVICE_USER</span><span class="token operator">=</span>root <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_SERVICE_PASSWORD</span><span class="token operator">=</span>aacopy.cn <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_SERVICE_DB_NAME</span><span class="token operator">=</span>nacos_config <span class="token punctuation">\</span><span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_SERVICE_DB_PARAM</span><span class="token operator">=</span><span class="token string">'characterEncoding=utf8&amp;connectTimeout=10000&amp;socketTimeout=30000&amp;autoReconnect=true&amp;useSSL=false'</span> <span class="token punctuation">\</span><span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token punctuation">\</span><span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span><span class="token parameter variable">-v</span> /home/dockerdata/nacos/logs:/home/nacos/logs <span class="token punctuation">\</span><span class="token parameter variable">--name</span> nacos <span class="token punctuation">\</span>nacos/nacos-server:2.0.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数说明：</p><ul><li><p>NACOS_AUTH_ENABLE=true</p><p>开源版本不会对客户端鉴权，任何能访问 Nacos server 的用户，都可以直接获取 Nacos 中存储的配置，需要开启 Nacos server 的鉴权,在 Nacos server 中修改 application.properties 的 nacos.core.auth.enabled 值为 true</p></li></ul><h2 id="访问验证"><a href="#访问验证" class="headerlink" title="访问验证"></a>访问验证</h2><p>访问地址：<a href="http://192.168.80.128:8848/nacos/">http://192.168.80.128:8848/nacos/</a></p><p>默认账号密码：nacos/nacos</p>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
            <tag> Nacos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ElasticSearch-SpringBoot</title>
      <link href="/elasticsearch/elasticsearch-springboot/"/>
      <url>/elasticsearch/elasticsearch-springboot/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ElasticSearch-搜索</title>
      <link href="/elasticsearch/elasticserach-sou-suo/"/>
      <url>/elasticsearch/elasticserach-sou-suo/</url>
      
        <content type="html"><![CDATA[<h2 id="查询方式："><a href="#查询方式：" class="headerlink" title="查询方式："></a>查询方式：</h2><ul><li><p>词条查询（<code>term</code>）</p><p>不分析查询条件，当词条完全匹配时，才返回文档</p></li><li><p>全文查询（<code>full text</code>）</p><p>对搜索关键字进行解析，拆分成多个分词，只要文档中包含任意一个分词，就返回该文档</p></li></ul><h2 id="词条查询（term）"><a href="#词条查询（term）" class="headerlink" title="词条查询（term）"></a>词条查询（term）</h2>]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ElasticSearch-文档</title>
      <link href="/elasticsearch/elasticserach-wen-dang/"/>
      <url>/elasticsearch/elasticserach-wen-dang/</url>
      
        <content type="html"><![CDATA[<h2 id="新增文档"><a href="#新增文档" class="headerlink" title="新增文档"></a>新增文档</h2>为ES服务地址：http://192.168.80.128:9200/<p>在aacopy索引中新增自定id为1的文档，如果不指定id，ES也会自动生产一个id</p><ul><li><p>请求方式：<code>PUT</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy/_doc/1</code></p><p>接口可以添加参数<code>?op_type=create</code>，指定为新增，防止修改已存在的数据</p></li><li><p>Content-Type：application/json</p></li><li><p>请求参数：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"小明"</span><span class="token punctuation">,</span>    <span class="token property">"tags"</span><span class="token operator">:</span><span class="token string">"A"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">,</span>    <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>    <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>    <span class="token property">"_version"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">"result"</span><span class="token operator">:</span> <span class="token string">"created"</span><span class="token punctuation">,</span>    <span class="token property">"_shards"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>        <span class="token property">"successful"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token property">"failed"</span><span class="token operator">:</span> <span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"_seq_no"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token property">"_primary_term"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="查看文档"><a href="#查看文档" class="headerlink" title="查看文档"></a>查看文档</h2><h3 id="单个文档"><a href="#单个文档" class="headerlink" title="单个文档"></a>单个文档</h3><p>查看aacopy索引中id为1的文档</p><ul><li><p>请求方式：<code>GET</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy/_doc/1</code></p></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">,</span>    <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>    <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>    <span class="token property">"_version"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token property">"_seq_no"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token property">"_primary_term"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>    <span class="token property">"found"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"小明"</span><span class="token punctuation">,</span>        <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token string">"A"</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="多个文档"><a href="#多个文档" class="headerlink" title="多个文档"></a>多个文档</h3><p>在aacopy索引中新增自定id为1和2两个文档，再查出来</p><h4 id="方式一："><a href="#方式一：" class="headerlink" title="方式一："></a>方式一：</h4><ul><li><p>请求方式：<code>GET/POST</code></p></li><li><p>请求接口：<code>{{es_server}}/_mget</code></p></li><li><p>Content-Type：application/json</p></li><li><p>请求参数：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"docs"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">,</span>            <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"1"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>            <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">,</span>            <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"2"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"docs"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">,</span>            <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>            <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>            <span class="token property">"_version"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>            <span class="token property">"_seq_no"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token property">"_primary_term"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>            <span class="token property">"found"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"小明"</span><span class="token punctuation">,</span>                <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token string">"A"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>            <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">,</span>            <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>            <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>            <span class="token property">"_version"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>            <span class="token property">"_seq_no"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>            <span class="token property">"_primary_term"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>            <span class="token property">"found"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"张三"</span><span class="token punctuation">,</span>                <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token string">"三三三"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="方式二："><a href="#方式二：" class="headerlink" title="方式二："></a>方式二：</h4><ul><li><p>请求方式：<code>GET/POST</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy/_doc/_mget</code></p></li><li><p>Content-Type：application/json</p></li><li><p>请求参数：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"ids"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>响应结果：同方式一</p></li></ul><h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><h3 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h3><ul><li><p>请求方式：<code>POST</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy/_update/1</code></p></li><li><p>Content-Type：application/json</p></li><li><p>请求参数：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token string">"AA"</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">,</span>    <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>    <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>    <span class="token property">"_version"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token property">"result"</span><span class="token operator">:</span> <span class="token string">"updated"</span><span class="token punctuation">,</span>    <span class="token property">"_shards"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>        <span class="token property">"successful"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token property">"failed"</span><span class="token operator">:</span> <span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"_seq_no"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>    <span class="token property">"_primary_term"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="新增字段"><a href="#新增字段" class="headerlink" title="新增字段"></a>新增字段</h3><ul><li><p>请求方式：<code>POST</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy/_update/1</code></p></li><li><p>Content-Type：application/json</p></li><li><p>请求参数：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"script"</span><span class="token operator">:</span> <span class="token string">"ctx._source.age = 18"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">,</span>    <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>    <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>    <span class="token property">"_version"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>    <span class="token property">"result"</span><span class="token operator">:</span> <span class="token string">"updated"</span><span class="token punctuation">,</span>    <span class="token property">"_shards"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>        <span class="token property">"successful"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token property">"failed"</span><span class="token operator">:</span> <span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"_seq_no"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>    <span class="token property">"_primary_term"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h3><p>请求方式和接口与新增字段相同，参数不同</p><ul><li><p>请求参数：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"script"</span><span class="token operator">:</span> <span class="token string">"ctx._source.remove(\"age\")"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="传递参数更新文档"><a href="#传递参数更新文档" class="headerlink" title="传递参数更新文档"></a>传递参数更新文档</h3><p>请求方式和接口与新增字段相同，参数不同</p><ul><li><p>请求参数：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"script"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"ctx._source.tags += params.tags"</span><span class="token punctuation">,</span>        <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token string">"S"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="upsert"><a href="#upsert" class="headerlink" title="upsert"></a>upsert</h3><p>如果执行更新的文档不存在，则创建文档，并设置upsert中的初始值，如果文档存在，则执行script中的更新操作</p><p>更新id为3的这个不存在的文档</p><ul><li><p>请求接口：<code>{{es_server}}/aacopy/_update/3</code></p></li><li><p>请求参数</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"script"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"ctx._source.num += params.num"</span><span class="token punctuation">,</span>        <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"num"</span><span class="token operator">:</span> <span class="token number">10</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"upsert"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"num"</span><span class="token operator">:</span> <span class="token number">1</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h2><ul><li><p>请求方式：<code>DELETE</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy/_doc/3</code></p></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"_index"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">,</span>    <span class="token property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>    <span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>    <span class="token property">"_version"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>    <span class="token property">"result"</span><span class="token operator">:</span> <span class="token string">"deleted"</span><span class="token punctuation">,</span>    <span class="token property">"_shards"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>        <span class="token property">"successful"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token property">"failed"</span><span class="token operator">:</span> <span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"_seq_no"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>    <span class="token property">"_primary_term"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ElasticSearch-映射</title>
      <link href="/elasticsearch/elasticserach-ying-she/"/>
      <url>/elasticsearch/elasticserach-ying-she/</url>
      
        <content type="html"><![CDATA[<h2 id="新增映射"><a href="#新增映射" class="headerlink" title="新增映射"></a>新增映射</h2>为ES服务地址：http://192.168.80.128:9200/<ul><li><p>请求方式：<code>PUT</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy/_mapping</code></p></li><li><p>Content-Type：application/json</p></li><li><p>请求参数：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"acknowledged"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="查看映射"><a href="#查看映射" class="headerlink" title="查看映射"></a>查看映射</h2><ul><li><p>请求方式：<code>GET</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy/_mapping</code></p></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"aacopy"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="查看多个索引的映射"><a href="#查看多个索引的映射" class="headerlink" title="查看多个索引的映射"></a>查看多个索引的映射</h2><p>查看aacopy和hello两个索引的映射</p><ul><li><p>请求方式：<code>GET</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy,hello/_mapping</code></p></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"hello"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"aacopy"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="查看所有索引的映射"><a href="#查看所有索引的映射" class="headerlink" title="查看所有索引的映射"></a>查看所有索引的映射</h2><ul><li><p>请求方式：<code>GET</code></p></li><li><p>请求接口：</p><ul><li><code>{{es_server}}/_mapping</code></li><li><code>{{es_server}}/_all/_mapping</code></li></ul></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"hello"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"aacopy"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="增加映射字段"><a href="#增加映射字段" class="headerlink" title="增加映射字段"></a>增加映射字段</h2><p>新增一个<code>description</code>的字段</p><ul><li><p>请求方式：<code>PUT</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy/_mapping</code></p></li><li><p>Content-Type：application/json</p></li><li><p>请求参数：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"description"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"acknowledged"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ElasticSearch-索引</title>
      <link href="/elasticsearch/elasticserach-suo-yin/"/>
      <url>/elasticsearch/elasticserach-suo-yin/</url>
      
        <content type="html"><![CDATA[<h2 id="新增索引"><a href="#新增索引" class="headerlink" title="新增索引"></a>新增索引</h2><p>新增一个aacopy的索引，为ES服务地址：<a href="http://192.168.80.128:9200/">http://192.168.80.128:9200/</a></p><ul><li><p>请求方式：<code>PUT</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy</code></p></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"acknowledged"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"shards_acknowledged"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"index"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="获取索引"><a href="#获取索引" class="headerlink" title="获取索引"></a>获取索引</h2><p>获取索引名为aacopy的索引信息</p><ul><li><p>请求方式：<code>GET</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy</code></p></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"aacopy"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"aliases"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"index"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"routing"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"allocation"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                        <span class="token property">"include"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                            <span class="token property">"_tier_preference"</span><span class="token operator">:</span> <span class="token string">"data_content"</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token property">"number_of_shards"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>                <span class="token property">"provided_name"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">,</span>                <span class="token property">"creation_date"</span><span class="token operator">:</span> <span class="token string">"1641403730051"</span><span class="token punctuation">,</span>                <span class="token property">"number_of_replicas"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>                <span class="token property">"uuid"</span><span class="token operator">:</span> <span class="token string">"18l1JVJBQKKZWS0BHob8Ag"</span><span class="token punctuation">,</span>                <span class="token property">"version"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"7160299"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h2><p>删除索引名为aacopy的索引</p><ul><li><p>请求方式：<code>DELETE</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy</code></p></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"acknowledged"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="获取多个索引"><a href="#获取多个索引" class="headerlink" title="获取多个索引"></a>获取多个索引</h2><p>先创建两个索引，hello和aacopy，再同时获取这两个索引</p><ul><li><p>请求方式：<code>GET</code></p></li><li><p>请求接口：<code>{{es_server}}/hello,aacopy</code></p></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"aacopy"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"aliases"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"index"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"routing"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"allocation"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                        <span class="token property">"include"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                            <span class="token property">"_tier_preference"</span><span class="token operator">:</span> <span class="token string">"data_content"</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token property">"number_of_shards"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>                <span class="token property">"provided_name"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">,</span>                <span class="token property">"creation_date"</span><span class="token operator">:</span> <span class="token string">"1641404107223"</span><span class="token punctuation">,</span>                <span class="token property">"number_of_replicas"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>                <span class="token property">"uuid"</span><span class="token operator">:</span> <span class="token string">"5u-oJh8xSPivutUt6plnnA"</span><span class="token punctuation">,</span>                <span class="token property">"version"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"7160299"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"hello"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"aliases"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"index"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"routing"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"allocation"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                        <span class="token property">"include"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                            <span class="token property">"_tier_preference"</span><span class="token operator">:</span> <span class="token string">"data_content"</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token property">"number_of_shards"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>                <span class="token property">"provided_name"</span><span class="token operator">:</span> <span class="token string">"hello"</span><span class="token punctuation">,</span>                <span class="token property">"creation_date"</span><span class="token operator">:</span> <span class="token string">"1641404112594"</span><span class="token punctuation">,</span>                <span class="token property">"number_of_replicas"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>                <span class="token property">"uuid"</span><span class="token operator">:</span> <span class="token string">"295E_bNYSgGcSmU_FvXB-g"</span><span class="token punctuation">,</span>                <span class="token property">"version"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"7160299"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="获取所有索引"><a href="#获取所有索引" class="headerlink" title="获取所有索引"></a>获取所有索引</h2><p>获取所有索引的索引信息</p><h3 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h3><ul><li><p>请求方式：<code>GET</code></p></li><li><p>请求接口：<code>{{es_server}}/_all</code></p></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"aacopy"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"aliases"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"index"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"routing"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"allocation"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                        <span class="token property">"include"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                            <span class="token property">"_tier_preference"</span><span class="token operator">:</span> <span class="token string">"data_content"</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token property">"number_of_shards"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>                <span class="token property">"provided_name"</span><span class="token operator">:</span> <span class="token string">"aacopy"</span><span class="token punctuation">,</span>                <span class="token property">"creation_date"</span><span class="token operator">:</span> <span class="token string">"1641404107223"</span><span class="token punctuation">,</span>                <span class="token property">"number_of_replicas"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>                <span class="token property">"uuid"</span><span class="token operator">:</span> <span class="token string">"5u-oJh8xSPivutUt6plnnA"</span><span class="token punctuation">,</span>                <span class="token property">"version"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"7160299"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"hello"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"aliases"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"index"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                <span class="token property">"routing"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"allocation"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                        <span class="token property">"include"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                            <span class="token property">"_tier_preference"</span><span class="token operator">:</span> <span class="token string">"data_content"</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token property">"number_of_shards"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>                <span class="token property">"provided_name"</span><span class="token operator">:</span> <span class="token string">"hello"</span><span class="token punctuation">,</span>                <span class="token property">"creation_date"</span><span class="token operator">:</span> <span class="token string">"1641404112594"</span><span class="token punctuation">,</span>                <span class="token property">"number_of_replicas"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>                <span class="token property">"uuid"</span><span class="token operator">:</span> <span class="token string">"295E_bNYSgGcSmU_FvXB-g"</span><span class="token punctuation">,</span>                <span class="token property">"version"</span><span class="token operator">:</span> <span class="token punctuation">{</span>                    <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"7160299"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h3><ul><li><p>请求方式：<code>GET</code></p></li><li><p>请求接口：<code>{{es_server}}/_cat/indices?v</code></p></li><li><p>响应结果：</p><pre class="line-numbers language-none"><code class="language-none">health status index            uuid                   pri rep docs.count docs.deleted store.size pri.store.sizegreen  open   .geoip_databases XpWGyzoNQFKMixWiBt-Ffg   1   0         44            0     40.8mb         40.8mbyellow open   hello            295E_bNYSgGcSmU_FvXB-g   1   1          0            0       226b           226byellow open   aacopy           5u-oJh8xSPivutUt6plnnA   1   1          0            0       226b           226b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="索引是否存在"><a href="#索引是否存在" class="headerlink" title="索引是否存在"></a>索引是否存在</h2><p>判断是否存在索引名为aacopy的索引</p><ul><li>请求方式：<code>HEAD</code></li><li>请求接口：<code>{{es_server}}/aacopy</code></li><li>响应结果：如果存在Status为<code>200</code>，如果不存在Status为<code>404</code></li></ul><h2 id="关闭索引"><a href="#关闭索引" class="headerlink" title="关闭索引"></a>关闭索引</h2><p>关闭名为aacopy的索引</p><ul><li><p>请求方式：<code>POST</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy/_close</code></p></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"acknowledged"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"shards_acknowledged"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"indices"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"aacopy"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"closed"</span><span class="token operator">:</span> <span class="token boolean">true</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="打开索引"><a href="#打开索引" class="headerlink" title="打开索引"></a>打开索引</h2><p>打开名为aacopy的索引</p><ul><li><p>请求方式：<code>POST</code></p></li><li><p>请求接口：<code>{{es_server}}/aacopy/_open</code></p></li><li><p>响应结果：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"acknowledged"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"shards_acknowledged"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ElasticSearch-HelloWorld</title>
      <link href="/elasticsearch/elasticsearch-helloworld/"/>
      <url>/elasticsearch/elasticsearch-helloworld/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>ElasticSerach（简称ES）是⼀个基于Apache Lucene库构建的Restful开源搜索引擎，提供了⼀个分布式，多租户的全⽂搜索引擎，具有HTTP Web界⾯（REST）和⽆架构JSON⽂档，提供了Java，Groovy，PHP，Ruby，Perl，Python，.NET和Javascript客户端库</p><p>官方网站：<a href="https://www.elastic.co/cn/elasticsearch/">https://www.elastic.co/cn/elasticsearch/</a></p><h2 id="单节点安装docker版"><a href="#单节点安装docker版" class="headerlink" title="单节点安装docker版"></a>单节点安装docker版</h2><ol><li>创建挂载目录并分配权限：</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /dockerData/elasticsearch/config<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /dockerData/elasticsearch/data<span class="token function">chmod</span> <span class="token number">777</span> <span class="token parameter variable">-R</span> /dockerData/elasticsearch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="2"><li>修改配置文件，让ES可以对外访问</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"http.host: 0.0.0.0"</span> <span class="token operator">&gt;&gt;</span> /dockerData/elasticsearch/config/elasticsearch.yml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>启动应用</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> elasticsearch <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token parameter variable">-p</span> <span class="token number">9200</span>:9200 <span class="token parameter variable">-p</span> <span class="token number">9300</span>:9300 <span class="token punctuation">\</span>  <span class="token parameter variable">-e</span> <span class="token string">"discovery.type=single-node"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-e</span> <span class="token assign-left variable">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-Xms1024m -Xmx1024m"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-v</span> /dockerData/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml <span class="token punctuation">\</span>  <span class="token parameter variable">-v</span> /dockerData/elasticsearch/data:/usr/share/elasticsearch/data <span class="token punctuation">\</span>  <span class="token parameter variable">-v</span> /dockerData/elasticsearch/plugins:/usr/share/elasticsearch/plugins elasticsearch:7.16.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>9200是HTTP访问接口，9300是内部TCP通信端口</li><li><code>discovery.type=single-node</code>表示单节点运行</li><li><code>ES_JAVA_OPTS="-Xms1024m -Xmx1024m"</code>设置内存大小</li></ul><ol start="4"><li><p>验证是否启动</p><p>在浏览器输入<a href="http://192.168.80.128:9200/">http://192.168.80.128:9200/</a> (IP根据环境更换)，看到类似如下返回内容表示成功</p></li></ol><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"eece1579f720"</span><span class="token punctuation">,</span>  <span class="token property">"cluster_name"</span> <span class="token operator">:</span> <span class="token string">"elasticsearch"</span><span class="token punctuation">,</span>  <span class="token property">"cluster_uuid"</span> <span class="token operator">:</span> <span class="token string">"-WJ6WjtMQpGG10HlGUrC-w"</span><span class="token punctuation">,</span>  <span class="token property">"version"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"number"</span> <span class="token operator">:</span> <span class="token string">"7.16.2"</span><span class="token punctuation">,</span>    <span class="token property">"build_flavor"</span> <span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>    <span class="token property">"build_type"</span> <span class="token operator">:</span> <span class="token string">"docker"</span><span class="token punctuation">,</span>    <span class="token property">"build_hash"</span> <span class="token operator">:</span> <span class="token string">"2b937c44140b6559905130a8650c64dbd0879cfb"</span><span class="token punctuation">,</span>    <span class="token property">"build_date"</span> <span class="token operator">:</span> <span class="token string">"2021-12-18T19:42:46.604893745Z"</span><span class="token punctuation">,</span>    <span class="token property">"build_snapshot"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token property">"lucene_version"</span> <span class="token operator">:</span> <span class="token string">"8.10.1"</span><span class="token punctuation">,</span>    <span class="token property">"minimum_wire_compatibility_version"</span> <span class="token operator">:</span> <span class="token string">"6.8.0"</span><span class="token punctuation">,</span>    <span class="token property">"minimum_index_compatibility_version"</span> <span class="token operator">:</span> <span class="token string">"6.0.0-beta1"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"tagline"</span> <span class="token operator">:</span> <span class="token string">"You Know, for Search"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>ES类似于一个数据库，在数据库操作中有，库，表，表结构，字段，数据</p><h3 id="索引（index）"><a href="#索引（index）" class="headerlink" title="索引（index）"></a>索引（index）</h3><p>索引可以类比成数据库的库</p><h3 id="类型（type）"><a href="#类型（type）" class="headerlink" title="类型（type）"></a><del>类型（type）</del></h3><p>7.X版本已废弃，type可以类比成数据库的表</p><h3 id="映射（mapping）"><a href="#映射（mapping）" class="headerlink" title="映射（mapping）"></a>映射（mapping）</h3><p>映射可以类比成数据库的表结构</p><h3 id="字段（field）"><a href="#字段（field）" class="headerlink" title="字段（field）"></a>字段（field）</h3><p>对应数据库的字段</p><h3 id="文档（document）"><a href="#文档（document）" class="headerlink" title="文档（document）"></a>文档（document）</h3><p>对应数据库中的一行记录</p><h3 id="分片（shard）"><a href="#分片（shard）" class="headerlink" title="分片（shard）"></a>分片（shard）</h3><p>分片分为主分片和副本分片，一个索引数据分布在多个主分片上，每个主分片有多个副本，是主分片的备份</p>]]></content>
      
      
      <categories>
          
          <category> ElasticSearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ElasticSearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MinIO-HelloWorld</title>
      <link href="/minio/minio-helloworld/"/>
      <url>/minio/minio-helloworld/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>高性能对象存储，高性能，可扩展性，云的原生支持</p><p>官方网站：<a href="http://www.minio.org.cn/">http://www.minio.org.cn/</a></p><p>英文官网：<a href="https://min.io/">https://min.io/</a></p><p>中文文档：<a href="http://docs.minio.org.cn/docs/">http://docs.minio.org.cn/docs/</a></p><h2 id="单机版docker安装"><a href="#单机版docker安装" class="headerlink" title="单机版docker安装"></a>单机版docker安装</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-p</span> <span class="token number">9000</span>:9000 <span class="token punctuation">\</span>  <span class="token parameter variable">-p</span> <span class="token number">9001</span>:9001 <span class="token punctuation">\</span>  <span class="token parameter variable">--name</span> minio <span class="token punctuation">\</span>  <span class="token parameter variable">-v</span> /home/dockerdata/minio/data:/data <span class="token punctuation">\</span>  <span class="token parameter variable">-e</span> <span class="token string">"MINIO_ROOT_USER=root"</span> <span class="token punctuation">\</span>  <span class="token parameter variable">-e</span> <span class="token string">"MINIO_ROOT_PASSWORD=aacopy.cn"</span> <span class="token punctuation">\</span>  minio/minio server /data --console-address <span class="token string">":9001"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>客户端访问地址：<a href="http://192.168.80.128:9001/">http://192.168.80.128:9001/</a></li></ul><h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><ul><li>Object<ul><li>存储到MinIO的基本对象，如文件</li></ul></li><li>Bucket<ul><li>用来存放Object的空间，每个Bucket之间的数据是相互隔离的，相当于文件的顶层目录</li></ul></li><li>Drive<ul><li>存储数据的磁盘</li></ul></li><li>Set<ul><li>一组Drive集合，分布式部署，根据集群规模划分一个或多个Set，每个Set中的Drive分布在不同的位置。</li><li>一个对象存储在一个set上</li><li>一个集群划分为多个Set</li><li>一个Set包含的Drive数量是固定的，默认根据集群规模自动计算</li><li>Set中的Drive尽可能的分布在不同的节点上</li></ul></li></ul><h2 id="纠错码EC"><a href="#纠错码EC" class="headerlink" title="纠错码EC"></a>纠错码EC</h2><ul><li>MinIO通过纠错码来保证数据高可用，使用highwayhash来处理数据损坏。通过算法将丢失的数据进行还原。</li><li>将n份原始数据，增加m份，并能够通过m+n份文件中的任意n份数据还原数据</li></ul><h2 id="纠删码模式启动"><a href="#纠删码模式启动" class="headerlink" title="纠删码模式启动"></a>纠删码模式启动</h2><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker">podman run \  -p 9000:9000 \  -p 9001:9001 \  --name minio \  -v /mnt/data1:/data1 \  -v /mnt/data2:/data2 \  -v /mnt/data3:/data3 \  -v /mnt/data4:/data4 \  -v /mnt/data5:/data5 \  -v /mnt/data6:/data6 \  -v /mnt/data7:/data7 \  -v /mnt/data8:/data8 \  minio/minio server /data{1...8} --console-address ":9001"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> MinIO </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MinIO </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka-事务消息</title>
      <link href="/kafka/kafka-shi-wu-xiao-xi/"/>
      <url>/kafka/kafka-shi-wu-xiao-xi/</url>
      
        <content type="html"><![CDATA[<p>事务消息可以保障多个消息写入操作的原子性</p><ul><li><p>配置</p><ul><li>事务消息的acks必须为all或-1</li><li>事务消息id前缀：transaction-id-prefix</li></ul></li><li><p>创建事务消息</p><ul><li><p>注解方式</p><p>方法上添加注解@Transactional(rollbackFor = Exception.class)</p></li><li><p>executeInTransaction</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">kafkaTemplate<span class="token punctuation">.</span><span class="token function">executeInTransaction</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KafkaOperations<span class="token punctuation">.</span>OperationsCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doInOperations</span><span class="token punctuation">(</span><span class="token class-name">KafkaOperations</span> kafkaOperations<span class="token punctuation">)</span> <span class="token punctuation">{</span>                kafkaOperations<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span><span class="token string">"aaa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>                kafkaOperations<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span><span class="token string">"bbb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><h2 id="相关报错"><a href="#相关报错" class="headerlink" title="相关报错"></a>相关报错</h2><ul><li><p>Producer factory does not support transactions</p><ul><li><p>加上事务前缀</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">spring.kafka.producer.transaction-id-prefix</span><span class="token punctuation">=</span><span class="token value attr-value">tx_</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul></li><li><p>Must set retries to non-zero when using the idempotent producer.</p><ul><li><p>增加重试次数</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">spring.kafka.producer.retries</span><span class="token punctuation">=</span><span class="token value attr-value">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul></li><li><p>Must set acks to all in order to use the idempotent producer. Otherwise we cannot guarantee idempotence.</p><ul><li><p>修改ACK确认方式</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">spring.kafka.producer.acks</span><span class="token punctuation">=</span><span class="token value attr-value">-1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka-高性能总结</title>
      <link href="/kafka/kafka-gao-xing-neng-zong-jie/"/>
      <url>/kafka/kafka-gao-xing-neng-zong-jie/</url>
      
        <content type="html"><![CDATA[<ul><li><p>消息文件存储机制</p><ul><li><p>一个Kafka集群有多个broker</p></li><li><p>一个broker包含多个topic</p></li><li><p>一个topic中分为多个partition，每个partition是一个有序的队列，是topic物理上的分组</p></li><li><p>一个partition分为多个segment</p></li></ul></li><li><p>索引机制</p><ul><li>采用二分法和稀疏索引快速查找</li></ul></li><li><p>消息缓冲区</p><ul><li>生产的消息不会直接到队列中，而是经过一个缓冲区，等缓冲区满了或者超时后再批量发送</li></ul></li><li><p>磁盘顺序写入</p></li><li><p>采用操作系统的页缓存（Page cache），而不是JVM的缓存，使用JVM的缓存会导致GC</p></li><li><p>零拷贝（ZeroCopy）</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka-消息可靠性</title>
      <link href="/kafka/kafka-xiao-xi-ke-kao-xing/"/>
      <url>/kafka/kafka-xiao-xi-ke-kao-xing/</url>
      
        <content type="html"><![CDATA[<h2 id="Kafka的副本"><a href="#Kafka的副本" class="headerlink" title="Kafka的副本"></a>Kafka的副本</h2><p>kafka的每个partition可以有多个副本（replication），在这些副本中有一个leader和多个follower，leader负责与消息生产者和消费者进行交互，follower负责从leader拉去消息做数据备份，如果leader挂了，会从follower中选举一个新的leader。</p><h2 id="消息发送流程中的ACK"><a href="#消息发送流程中的ACK" class="headerlink" title="消息发送流程中的ACK"></a>消息发送流程中的ACK</h2><p>消息生产者producer发送消息到topic中的leader patition，patition收到消息后需要向producer发送ack确认消息已经收到。</p><h3 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h3><p>CAP: 指的是在一个分布式系统中，Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性）</p><p>三者是不能同时满足的，只能保证其二，P一般是要保证的，一致性和可用性根据具体业务情况选择，</p><h3 id="ACK级别"><a href="#ACK级别" class="headerlink" title="ACK级别"></a>ACK级别</h3><p>Kafka通过ACK的级别来确定消息的可靠性级别，如果消息要可靠性偏高选择CP，如果要性能偏高选择AP</p><p>Kafka通过acks参数来设置ACK级别</p><ul><li><p>acks=0</p><p>不确认，producer只发送一次消息，不管服务端是否收到消息。性能最高，但消息可靠性最低。如果在发生期间，leader partition所在的broker宕机了，就会消息丢失</p></li><li><p>acks=1</p><p>默认级别，leader patition收到消息并写入磁盘后就返回确认收到消息，不关心follower partition是否同步成功。</p></li><li><p>acks=all，leader等所有ISR中的follower都同步完成后，再返回确认收到消息。消息可靠性最高。也可以设置成-1，和all等同</p></li></ul><p>这一部分可以查看官方注释：ProducerConfig.ACKS_DOC</p><h3 id="ISR（in-sync-replica）"><a href="#ISR（in-sync-replica）" class="headerlink" title="ISR（in-sync replica）"></a>ISR（in-sync replica）</h3><p>一个副本集合，该集合中的副本都会保持与leader同步，leader也在该集合中。</p><ul><li>通过配置项<a href="https://kafka.apache.org/documentation/#topicconfigs_min.insync.replicas">min.insync.replicas</a>来设置ISR中的最小副本数，默认为1，当ISR中的副本数小于配置项中的值时，会返回异常。</li><li>当一个follower长时间未从leader同步消息时（通过<a href="https://kafka.apache.org/documentation/#brokerconfigs_replica.lag.time.max.ms">replica.lag.time.max.ms</a>配置超时时间，默认30秒），就会从ISR集合中移除，进入OSR集合</li><li>如果leader发生故障，会从ISR集合中选举一个新leader</li></ul><h3 id="OSR（out-of-sync-replica）"><a href="#OSR（out-of-sync-replica）" class="headerlink" title="OSR（out-of-sync-replica）"></a>OSR（out-of-sync-replica）</h3><p>与leader副本分区同步滞后过多的副本集合</p><h3 id="High-Watermark"><a href="#High-Watermark" class="headerlink" title="High Watermark"></a>High Watermark</h3><p><img src="/images/Kafka-%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7/image-20220103233304020.png"></p><ul><li><p>HW (High Watermark) </p><ul><li>ISR中所有副本都同步过的offset位置</li><li>HW线之前的数据才对消费者可见</li></ul></li><li><p>LEO（log end offset）</p><ul><li>partition中最后一条消息所在的offset位置</li></ul></li><li><p>HW用来保证消费数据的一致性和各个副本数据的一致性</p><ul><li>如果leader宕机，会从ISR中选举一个新的leader，此时其他follower会将log文件件中高于HW的数据删掉，然后从leader重新同步，这样可以确保各个副本数据的一致性</li><li>如果follower宕机，会被leader从ISR集合中移除，等follower再次恢复，会读取本地记录的宕机前的HW之后的数据删掉，然后重新同步，等follower的LEO追上新的HW时，重新加入ISR集合中</li></ul></li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>partition的多副本机制保障了消息存储的可靠性</li><li>ACK机制保障了producer消息投递的可靠性</li><li>High Watermark保障了消费数据的一致性和副本数据的一致性</li></ul>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VB-Excel发送邮件</title>
      <link href="/util/vb-excel-fa-song-you-jian/"/>
      <url>/util/vb-excel-fa-song-you-jian/</url>
      
        <content type="html"><![CDATA[<h2 id="设置OutLook"><a href="#设置OutLook" class="headerlink" title="设置OutLook"></a>设置OutLook</h2><ol><li><p>管理员模式启动OutLook</p><p>文件 -&gt; 选项 -&gt; 信任中心 -&gt; 信任中心设置 -&gt; 宏设置 -&gt; 选择启用所有宏，并勾选加载项：将宏安全设置应用于已安装的加载项 -&gt; 编程问题-&gt;选择从不向我发出可疑活动警告 -&gt; 确定</p><p><img src="/images/VB-Excel%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/image-20211229094726365.png"><img src="/images/VB-Excel%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/image-20211229094844423.png"></p></li></ol><img src="/images/VB-Excel%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/image-20211229094943107.png" alt="image-20211229095032284" style="zoom: 80%;"><p><img src="/images/VB-Excel%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/image-20211229095315203.png"><img src="/images/VB-Excel%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/image-20211229095331464.png" alt="image-20211229095331464"></p><h2 id="设置Excel"><a href="#设置Excel" class="headerlink" title="设置Excel"></a>设置Excel</h2><ol><li><p>新建一个excel文件，另存为xlsm，只有xlsm文件才可以执行宏</p></li><li><p>设置：文件 -&gt; 选项 -&gt; 信任中心 -&gt; 信任中心设置 -&gt; 宏设置 -&gt; 启用所有宏 -&gt; 勾选信任对VBA工程对象模型的访问 -&gt; 确定</p><p><img src="/images/VB-Excel%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/image-20211229095806437.png"></p></li></ol><h2 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h2><ol><li><p>alt + F11 打开编辑器</p></li><li><p>编写代码</p><pre class="line-numbers language-visual-basic" data-language="visual-basic"><code class="language-visual-basic"><span class="token keyword">Private</span> <span class="token keyword">Sub</span> 全自动发送邮件_Click<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">'要能正确发送并需要对Microseft Outlook进行有效配置</span>    <span class="token keyword">On</span> <span class="token keyword">Error</span> <span class="token keyword">Resume</span> <span class="token keyword">Next</span>    <span class="token keyword">Dim</span> rowCount<span class="token punctuation">,</span> endRowNo<span class="token punctuation">,</span> endColumnNo<span class="token punctuation">,</span> sFile<span class="token operator">$</span><span class="token punctuation">,</span> sFile1<span class="token operator">$</span><span class="token punctuation">,</span> A<span class="token operator">&amp;</span><span class="token punctuation">,</span> B<span class="token operator">&amp;</span><span class="token punctuation">,</span> lastM<span class="token operator">$</span><span class="token punctuation">,</span> C<span class="token operator">&amp;</span>    <span class="token keyword">Dim</span> objOutlook <span class="token keyword">As</span> <span class="token keyword">Object</span>    <span class="token keyword">Dim</span> objMail <span class="token keyword">As</span> MailItem    <span class="token comment">'取得当前工作表数据区行数列数</span>    endRowNo <span class="token operator">=</span> ActiveSheet<span class="token punctuation">.</span>UsedRange<span class="token punctuation">.</span>Rows<span class="token punctuation">.</span>Count    endColumnNo <span class="token operator">=</span> ActiveSheet<span class="token punctuation">.</span>UsedRange<span class="token punctuation">.</span>Columns<span class="token punctuation">.</span>Count    <span class="token comment">'取得当前工作表的名称，用来作为邮件主题进行发送</span>    <span class="token comment">'sFile1 = ActiveSheet.Name</span>    <span class="token comment">'创建objOutlook为Outlook应用程序对象</span>    <span class="token keyword">Set</span> objOutlook <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"Outlook.Application"</span><span class="token punctuation">)</span>   <span class="token comment">'开始循环发送电子邮件</span>    <span class="token comment">'For rowCount = 2 To endRowNo</span>    rowCount <span class="token operator">=</span> <span class="token number">2</span>    <span class="token keyword">Do</span> <span class="token keyword">While</span> rowCount <span class="token operator">&lt;</span> endRowNo   <span class="token comment">'创建objMail为一个邮件对象</span>    <span class="token keyword">Set</span> objMail <span class="token operator">=</span> objOutlook<span class="token punctuation">.</span>CreateItem<span class="token punctuation">(</span>olMailItem<span class="token punctuation">)</span>    <span class="token keyword">With</span> objMail       <span class="token comment">'设置收件人地址，数据源所在列数</span>    <span class="token punctuation">.</span><span class="token keyword">To</span> <span class="token operator">=</span> Cells<span class="token punctuation">(</span>rowCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment">'设置抄送人地址（从通讯录表的'E-mail地址'字段中获得）</span>    <span class="token comment">'.CC = "969312613@qq.com;969312613@qq.com"</span>    <span class="token comment">' Cells(rowCount, 0)</span>    <span class="token comment">'设置邮件主题,取值工作表名，</span>            <span class="token punctuation">.</span>Subject <span class="token operator">=</span> <span class="token string">"主题："</span> <span class="token operator">&amp;</span> <span class="token keyword">Date</span> <span class="token comment">'sFile1</span>  <span class="token comment">'设置邮件内容(从通讯录表的“内容”字段中获得)</span>  <span class="token comment">'align  单元格文本显示方式 left(向左)、center(居中)、right(向右)，默认是center, width-宽 height-高  border 单元格线粗细,bordercolor返回或设置对象的边框颜色</span>  <span class="token comment">'colSpan是一种编程语言，其属性可设置或返回表元横跨的列数</span> sFile <span class="token operator">=</span> <span class="token string">"&lt;tr&gt;您好！&lt;br&gt;XXXXX！&lt;/tr&gt;"</span>    sFile <span class="token operator">=</span> sFile <span class="token operator">+</span> <span class="token string">"&lt;table align='left' width='500' height='25' border= 1   bordercolor='#000000'&gt; &lt;tbody&gt; "</span>    C <span class="token operator">=</span> <span class="token number">1</span>    lastM <span class="token operator">=</span> Cells<span class="token punctuation">(</span>rowCount<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>    <span class="token keyword">Do</span> <span class="token keyword">While</span> rowCount <span class="token operator">&lt;</span> endRowNo <span class="token keyword">And</span> Cells<span class="token punctuation">(</span>rowCount<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> lastM    lastM <span class="token operator">=</span> Cells<span class="token punctuation">(</span>rowCount<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>    sFile <span class="token operator">=</span> sFile <span class="token operator">+</span> <span class="token string">"&lt;tr&gt;  &lt;td colspan ='8' align='center'&gt; XXX明细 "</span> <span class="token operator">+</span> Str<span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"&lt;/td&gt; &lt;/tr&gt; "</span>    C <span class="token operator">=</span> C <span class="token operator">+</span> <span class="token number">1</span>    B <span class="token operator">=</span> <span class="token number">1</span>    <span class="token keyword">For</span> A <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">To</span> endColumnNo    <span class="token comment">'数据表头中添加“X”后将不发送此字段</span>       <span class="token keyword">If</span> Application<span class="token punctuation">.</span>WorksheetFunction<span class="token punctuation">.</span>CountIf<span class="token punctuation">(</span>Cells<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> A<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"*X*"</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">Then</span>       <span class="token keyword">If</span> B <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">Then</span>         sFile <span class="token operator">=</span> sFile <span class="token operator">+</span> <span class="token string">"&lt;tr&gt;  &lt;td width='20%' height='25'&gt; "</span> <span class="token operator">+</span> Cells<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> A<span class="token punctuation">)</span><span class="token punctuation">.</span>Text <span class="token operator">+</span> <span class="token string">"   &lt;/td&gt; &lt;td  width='30%' height='25'&gt; "</span> <span class="token operator">+</span> Cells<span class="token punctuation">(</span>rowCount<span class="token punctuation">,</span> A<span class="token punctuation">)</span><span class="token punctuation">.</span>Text <span class="token operator">+</span> <span class="token string">"&lt;/td&gt;"</span>         B <span class="token operator">=</span> <span class="token number">0</span>       <span class="token keyword">Else</span>        sFile <span class="token operator">=</span> sFile <span class="token operator">+</span> <span class="token string">"&lt;td width='20%' height='25'&gt; "</span> <span class="token operator">+</span> Cells<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> A<span class="token punctuation">)</span><span class="token punctuation">.</span>Text <span class="token operator">+</span> <span class="token string">"   &lt;/td&gt; &lt;td  width='30%' height='25'&gt; "</span> <span class="token operator">+</span> Cells<span class="token punctuation">(</span>rowCount<span class="token punctuation">,</span> A<span class="token punctuation">)</span><span class="token punctuation">.</span>Text <span class="token operator">+</span> <span class="token string">"&lt;/td&gt; &lt;/tr&gt;"</span>        B <span class="token operator">=</span> <span class="token number">1</span>       <span class="token keyword">End</span> <span class="token keyword">If</span>     <span class="token keyword">End</span> <span class="token keyword">If</span>    <span class="token keyword">Next</span>    rowCount <span class="token operator">=</span> rowCount <span class="token operator">+</span> <span class="token number">1</span>    <span class="token keyword">Loop</span>   <span class="token punctuation">.</span>HTMLBody <span class="token operator">=</span> sFile    <span class="token comment">'设置附件(从通讯录表的“附件”字段中获得)</span>  <span class="token comment">'  .Attachments.Add Cells(rowCount, 24).Value</span>    <span class="token comment">'自动发送邮件</span>    <span class="token punctuation">.</span>Send     <span class="token keyword">End</span> <span class="token keyword">With</span>    <span class="token comment">'销毁objMail对象</span>    <span class="token keyword">Set</span> objMail <span class="token operator">=</span> <span class="token boolean">Nothing</span>    <span class="token comment">'Next</span>        <span class="token keyword">Loop</span>    <span class="token comment">'销毁objOutlook对象</span>    <span class="token keyword">Set</span> objOutlook <span class="token operator">=</span> <span class="token boolean">Nothing</span>    <span class="token comment">'所有电子邮件发送完成时提示</span>     MsgBox Time <span class="token operator">&amp;</span> <span class="token string">"XXX邮件发送成功！请持续跟进"</span><span class="token keyword">End</span> <span class="token keyword">Sub</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>功能为获取第一列的邮件地址，循环后面的列的内容并创建table表格发送，如果遇到第二列上下相同的行，合并多行一起发送</p><p><img src="/images/VB-Excel%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/image-20211229100656466.png"></p></li><li><p>点击绿色小箭头可以直接运行发送邮件，或者点击调试，通过编译，逐语句，运行到光标处等测试代码</p></li></ol><p><img src="/images/VB-Excel%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/image-20211229101145282.png"></p><ol start="5"><li><p>运行效果</p><p><img src="/images/VB-Excel%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/image-20211229101521594.png"></p></li><li><p>如果设置完还是发不了邮件，重启下电脑，或者再看下工具-&gt;引用中是否引入outlook包（Microsoft Outlook 16.0 Object Library）16.0是版本号，也可以通过调试代码，看下Set objOutlook = CreateObject(“Outlook.Application”) 这一行的返回值objOutlook 是不是Nothing，如果是则是配置哪里没有配好，检查outlook和excel的配置。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Util </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Util </tag>
            
            <tag> VB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka-AdminApi</title>
      <link href="/kafka/kafka-adminapi/"/>
      <url>/kafka/kafka-adminapi/</url>
      
        <content type="html"><![CDATA[<p>admin api操作kafka</p><p>gitee：<a href="https://gitee.com/aacopy/kafka-learn">https://gitee.com/aacopy/kafka-learn</a></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaAdminApiTest</span> <span class="token punctuation">{</span>    <span class="token comment">//创建AdminClient</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">AdminClient</span> adminClient<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">AdminClientConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        adminClient <span class="token operator">=</span> <span class="token class-name">AdminClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">//创建topic</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        <span class="token comment">//（topic名称，partition分区数量，副本数量）</span>        <span class="token class-name">NewTopic</span> newTopic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NewTopic</span><span class="token punctuation">(</span><span class="token string">"adminApiTest"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CreateTopicsResult</span> topics <span class="token operator">=</span> adminClient<span class="token punctuation">.</span><span class="token function">createTopics</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>newTopic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        topics<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">//查看topic</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">viewTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        <span class="token class-name">ListTopicsResult</span> listTopicsResult <span class="token operator">=</span> adminClient<span class="token punctuation">.</span><span class="token function">listTopics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> topicNames <span class="token operator">=</span> listTopicsResult<span class="token punctuation">.</span><span class="token function">names</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        topicNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">//查看topic详情</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">describeTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        <span class="token class-name">DescribeTopicsResult</span> describeTopicsResult <span class="token operator">=</span> adminClient<span class="token punctuation">.</span><span class="token function">describeTopics</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"adminApiTest"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TopicDescription</span><span class="token punctuation">&gt;</span></span> topicDescriptionMap <span class="token operator">=</span> describeTopicsResult<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        topicDescriptionMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token string">" -&gt; "</span> <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">//删除topic</span><span class="token comment">//    @Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        <span class="token class-name">DeleteTopicsResult</span> deleteTopics <span class="token operator">=</span> adminClient<span class="token punctuation">.</span><span class="token function">deleteTopics</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"adminApiTest"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        deleteTopics<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">//增加partition数量</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increasePartition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">NewPartitions</span><span class="token punctuation">&gt;</span></span> partitionsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">NewPartitions</span> newPartitions <span class="token operator">=</span> <span class="token class-name">NewPartitions</span><span class="token punctuation">.</span><span class="token function">increaseTo</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        partitionsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"adminApiTest"</span><span class="token punctuation">,</span> newPartitions<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CreatePartitionsResult</span> partitions <span class="token operator">=</span> adminClient<span class="token punctuation">.</span><span class="token function">createPartitions</span><span class="token punctuation">(</span>partitionsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>        partitions<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka-消费者</title>
      <link href="/kafka/kafka-xiao-fei-zhe/"/>
      <url>/kafka/kafka-xiao-fei-zhe/</url>
      
        <content type="html"><![CDATA[<h2 id="获取消息策略"><a href="#获取消息策略" class="headerlink" title="获取消息策略"></a>获取消息策略</h2><p>拉取（pull）的方式，消费者从partition中主动拉取消息。</p><p>优点：</p><ul><li>消费者可以根据性能处理消息，如果是push模式，可能会导致服务并发不够处理不过来，MQ的削峰也就没有了意义</li><li>如果服务端没有消息，客户端会定时发送请求，根据超时时间，阻塞一段时间后再返回</li></ul><h2 id="分区分配策略"><a href="#分区分配策略" class="headerlink" title="分区分配策略"></a>分区分配策略</h2><p>通过partition.assignment.strategy配置，ConsumerConfig.PARTITION_ASSIGNMENT_STRATEGY_CONFIG获取</p><p>默认策略：RangeAssignor（按照主题进行范围分配）</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token constant">PARTITION_ASSIGNMENT_STRATEGY_CONFIG</span><span class="token punctuation">,</span>            <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">LIST</span><span class="token punctuation">,</span>            <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token class-name">RangeAssignor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">CooperativeStickyAssignor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//默认值</span>            <span class="token keyword">new</span> <span class="token class-name">ConfigDef<span class="token punctuation">.</span>NonNullValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token class-name">Importance</span><span class="token punctuation">.</span><span class="token constant">MEDIUM</span><span class="token punctuation">,</span>            <span class="token constant">PARTITION_ASSIGNMENT_STRATEGY_DOC</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>kafka的分配策略</p><ul><li><p>RangeAssignor</p><p>按照主题进行范围分配</p></li><li><p>RoundRobinAssignor</p><p>轮询分配，以循环方式将分区分配给消费者</p></li><li><p>StickyAssignor</p><p>保证分配是最大限度的平衡，同时保留尽可能多的现有分区分配。</p></li><li><p>CooperativeStickyAssignor</p><p>遵循StickyAssignor相同的逻辑，但允许合作再平衡。</p></li></ul><p>默认的assignor是[RangeAssignor, CooperativeStickyAssignor]，默认使用RangeAssignor，但是允许升级到CooperativeStickyAssignor，只需从列表中移除RangeAssignor。</p><p>也可以自定义策略，通过实现org.apache.kafka.clients.consumer.ConsumerPartitionAssignor</p><h3 id="RoundRobinAssignor"><a href="#RoundRobinAssignor" class="headerlink" title="RoundRobinAssignor"></a>RoundRobinAssignor</h3><p>实现方式：获取一个消费者组中订阅的所有的Topic中的所有partition，和消费者组中所有的消费者列表，外层遍历partition列表，内存遍历消费者列表，将每个partition依次分配给消费者。</p><p>示例1：</p><p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20211230112141081.png"></p><p>示例2：</p><p>官方示例：</p><blockquote><p>When subscriptions differ across consumer instances, the assignment process still considers each consumer instance in round robin fashion but skips over an instance if it is not subscribed to the topic. Unlike the case when subscriptions are identical, this can result in imbalanced assignments. For example, we have three consumers C0, C1, C2, and three topics t0, t1, t2, with 1, 2, and 3 partitions, respectively. Therefore, the partitions are t0p0, t1p0, t1p1, t2p0, t2p1, t2p2. C0 is subscribed to t0; C1 is subscribed to t0, t1; and C2 is subscribed to t0, t1, t2.<br>That assignment will be:<br>C0: [t0p0]<br>C1: [t1p0]<br>C2: [t1p1, t2p0, t2p1, t2p2]</p></blockquote><p>我们有三个消费者C0、C1、C2和三个主题t0、t1、t2，分别有1、2和3个分区。因此，分区为t0p0, t1p0, t1p1, t2p0, t2p1, t2p2。C0订阅到t0;C1订阅t0, t1;C2订阅了t0 t1 t2。</p><p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20211230112332363.png"></p><p>如果同一个消费者组中不同的消费者订阅了不同的主题，就会不均匀分配，上面的T1P1完全可以分配给消费者2</p><p>源码实现：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoundRobinAssignor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractPartitionAssignor</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> partitionsPerTopic<span class="token punctuation">,</span>                                                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Subscription</span><span class="token punctuation">&gt;</span></span> subscriptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> assignment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//获取消费者组中所有的消费者</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberInfo</span><span class="token punctuation">&gt;</span></span> memberInfoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Subscription</span><span class="token punctuation">&gt;</span></span> memberSubscription <span class="token operator">:</span> subscriptions<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            assignment<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>memberSubscription<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            memberInfoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MemberInfo</span><span class="token punctuation">(</span>memberSubscription<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                              memberSubscription<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">groupInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">CircularIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberInfo</span><span class="token punctuation">&gt;</span></span> assigner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CircularIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span>memberInfoList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> partition <span class="token operator">:</span> <span class="token function">allPartitionsSorted</span><span class="token punctuation">(</span>partitionsPerTopic<span class="token punctuation">,</span> subscriptions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> <span class="token class-name">String</span> topic <span class="token operator">=</span> partition<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//判断当前遍历的partition所属的主题在当前消费者是否订阅，如果没有订阅继续获取下一个消费者</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>subscriptions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>assigner<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>memberId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">topics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">)</span>                assigner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            assignment<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>assigner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>memberId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>partition<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> assignment<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">//获取消费者组内订阅的topic中所有的patition集合</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span></span> <span class="token function">allPartitionsSorted</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> partitionsPerTopic<span class="token punctuation">,</span>                                                     <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Subscription</span><span class="token punctuation">&gt;</span></span> subscriptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">SortedSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> topics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Subscription</span> subscription <span class="token operator">:</span> subscriptions<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            topics<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>subscription<span class="token punctuation">.</span><span class="token function">topics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span></span> allPartitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> topic <span class="token operator">:</span> topics<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Integer</span> numPartitionsForTopic <span class="token operator">=</span> partitionsPerTopic<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>numPartitionsForTopic <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                allPartitions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">AbstractPartitionAssignor</span><span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> numPartitionsForTopic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> allPartitions<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"roundrobin"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="RangeAssignor"><a href="#RangeAssignor" class="headerlink" title="RangeAssignor"></a>RangeAssignor</h3><p>实现方式：获取消费者组中的所有主题，遍历主题，获取每个主题下面的所有消费者的数量和分区数量，用分区数量除以消费者数量，获取每个消费者应该分配到的分区数，如果有余数，按照顺序，排在前面的消费者每个多分配一个分区。</p><p>示例1：</p><p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20211230114834382.png"></p><p>官方示例2：</p><blockquote><p>For example, suppose there are two consumers C0 and C1, two topics t0 and t1, and each topic has 3 partitions, resulting in partitions t0p0, t0p1, t0p2, t1p0, t1p1, and t1p2.<br>The assignment will be:<br>C0: [t0p0, t0p1, t1p0, t1p1]<br>C1: [t0p2, t1p2]</p></blockquote><p>假设有两个消费者C0和C1，两个主题t0和t1，每个主题有3个分区，导致分区t0p0、t0p1、t0p2、t1p0、t1p1和t1p2。</p><p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20211230132133763.png"></p><p>如果有很多topic，这种方案会导致排在前面的消费者压力比后面的大</p><p>源码实现：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RangeAssignor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractPartitionAssignor</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"range"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">MemberInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">consumersPerTopic</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Subscription</span><span class="token punctuation">&gt;</span></span> consumerMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">MemberInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> topicToConsumers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Subscription</span><span class="token punctuation">&gt;</span></span> subscriptionEntry <span class="token operator">:</span> consumerMetadata<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> consumerId <span class="token operator">=</span> subscriptionEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">MemberInfo</span> memberInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberInfo</span><span class="token punctuation">(</span>consumerId<span class="token punctuation">,</span> subscriptionEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">groupInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> topic <span class="token operator">:</span> subscriptionEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">topics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">put</span><span class="token punctuation">(</span>topicToConsumers<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> memberInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> topicToConsumers<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> partitionsPerTopic<span class="token punctuation">,</span>                                                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Subscription</span><span class="token punctuation">&gt;</span></span> subscriptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">MemberInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumersPerTopic <span class="token operator">=</span> <span class="token function">consumersPerTopic</span><span class="token punctuation">(</span>subscriptions<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> assignment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> memberId <span class="token operator">:</span> subscriptions<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            assignment<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>memberId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//遍历所有的topic</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">MemberInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> topicEntry <span class="token operator">:</span> consumersPerTopic<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> topic <span class="token operator">=</span> topicEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//获取topic的订阅者</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberInfo</span><span class="token punctuation">&gt;</span></span> consumersForTopic <span class="token operator">=</span> topicEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取topic的分区数量</span>            <span class="token class-name">Integer</span> numPartitionsForTopic <span class="token operator">=</span> partitionsPerTopic<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>numPartitionsForTopic <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//对消费者进行排序</span>            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>consumersForTopic<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//计算每个消费者需要分配的分区数量</span>            <span class="token keyword">int</span> numPartitionsPerConsumer <span class="token operator">=</span> numPartitionsForTopic <span class="token operator">/</span> consumersForTopic<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//计算没法平均分配的分区数量</span>            <span class="token keyword">int</span> consumersWithExtraPartition <span class="token operator">=</span> numPartitionsForTopic <span class="token operator">%</span> consumersForTopic<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span></span> partitions <span class="token operator">=</span> <span class="token class-name">AbstractPartitionAssignor</span><span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> numPartitionsForTopic<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//遍历订阅过的每个消费者</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> consumersForTopic<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">//计算每个消费者分配的分区的开始index</span>                <span class="token keyword">int</span> start <span class="token operator">=</span> numPartitionsPerConsumer <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> consumersWithExtraPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//计算每个消费者是否需要额外分配一个分区</span>                <span class="token keyword">int</span> length <span class="token operator">=</span> numPartitionsPerConsumer <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> consumersWithExtraPartition <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                assignment<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>consumersForTopic<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>memberId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>partitions<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> start <span class="token operator">+</span> length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> assignment<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="StickyAssignor"><a href="#StickyAssignor" class="headerlink" title="StickyAssignor"></a>StickyAssignor</h3><p>粘性分配器有两个目的</p><ol><li>保证尽可能平衡的分配</li><li>当重新分配发生时，它尽可能多地保留了现有的分配。这有助于在主题分区从一个消费者转移到另一个消费者时节省一些开销处理。</li></ol><h4 id="示例1："><a href="#示例1：" class="headerlink" title="示例1："></a>示例1：</h4><p>假设有三个消费者C0、C1、C2，四个主题t0、t1、t2、t3，每个主题有2个分区，形成分区t0p0、t0p1、t1p0、t1p1、t2p0、t2p1、t3p0、t3p1。每个消费者都订阅了所有三个主题。</p><p>粘性分配器和轮询分配器的分配结果相同：</p><p>C0: [t0p0, t1p1, t3p0]<br>C1: [t0p1, t2p0, t3p1]<br>C2: [t1p0, t2p1]</p><p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20220101165705649.png"></p><p>假设C1被删除，</p><ul><li>轮询策略将会重新分配如下结果：</li></ul><p>C0: [t0p0, t1p0, t2p0, t3p0]<br>C2: [t0p1, t1p1, t2p1, t3p1]</p><p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20220101170347490.png"></p><ul><li>粘性分配器策略将会重新分配如下结果：</li></ul><p>C0 [t0p0, t1p1, t3p0, t2p0]<br>C2 [t1p0, t2p1, t0p1, t3p1]</p><p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20220101170400295.png"></p><p><strong>可以看出粘性分配器策略保留所有以前的分配</strong></p><h4 id="示例2"><a href="#示例2" class="headerlink" title="示例2"></a>示例2</h4><p>有三个消费者C0、C1、C2，以及三个主题t0、t1、t2，分别有1、2、3个分区。因此，分区为t0p0, t1p0, t1p1, t2p0, t2p1, t2p2。C0被订阅为t0；C1被订阅为t0、t1；C2被订阅为t0、t1、t2。</p><ul><li>轮询策略分配结果：</li></ul><p>C0 [t0p0]<br>C1 [t1p0]<br>C2 [t1p1, t2p0, t2p1, t2p2]</p><p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20220101171354358.png"></p><ul><li>粘性策略分配结果：</li></ul><p>C0 [t0p0]<br>C1 [t1p0, t1p1]<br>C2 [t2p0, t2p1, t2p2]</p><p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20220101171446089.png"></p><p>如果删除C0消费者</p><p>Round Robin重新分配结果如下：</p><p>C1 [t0p0, t1p1]<br>C2 [t1p0, t2p0, t2p1, t2p2]</p><p>Sticky重新分配结果如下：</p><p>C1 [t1p0, t1p1, t0p0]<br>C2 [t2p0, t2p1, t2p2]</p><h3 id="CooperativeStickyAssignor"><a href="#CooperativeStickyAssignor" class="headerlink" title="CooperativeStickyAssignor"></a>CooperativeStickyAssignor</h3><p>AbstractStickyAssignor的一个合作版本。它遵循与StickyAssignor相同的（粘性）分配逻辑，但允许合作式再平衡</p><p>Kafka的两种协议：EAGER，COOPERATIVE</p><ul><li><p>EAGER再平衡协议要求消费者在参与再平衡事件之前总是撤销其所有分区。因此，它允许完全重新洗牌分配。</p></li><li><p>COOPERATIVE重新平衡协议允许消费者在参与重新平衡事件之前保留其当前拥有的分区。而不是立即重新分配任何拥有的分区，分配者可以向消费者表示需要撤销该分区，这样被撤销的分区就可以在下一次重新平衡事件中重新分配给另一个消费者。这是为粘性分配逻辑设计的，该逻辑试图通过合作调整来尽量减少分区的重新分配。</p></li></ul><p>EAGER协议：RangeAssignor，RoundRobinAssignor，StickyAssignor</p><p>COOPERATIVE协议：CooperativeStickyAssignor</p><p>在集群庞大的情况下，频繁的发生集群节点上下线，消费订阅变更频繁，EAGER会操作全部的分区，COOPERATIVE只会操作部分，达到最终平衡</p><h2 id="消费记录offset"><a href="#消费记录offset" class="headerlink" title="消费记录offset"></a>消费记录offset</h2><ul><li><p>消费者利用offset记录每个消费者组消费到哪个位置</p><ul><li><p>通过group.id+topic+patitin.id来确定唯一的offset的key，value为offset的值</p></li><li><p>kafka通过将offset存放在一个名称为__consumer_offsets的内置topic中。默认有50个partition</p></li></ul></li><li><p>如何从头消费partition中的数据</p><ul><li>从头开始消费消息，需要两点<ul><li>设置auto.offset.reset属性为earliest，默认是latest</li><li>创建一个新的消费者组</li></ul></li></ul></li><li><p>offset手动提交</p><ul><li><p>offset默认是自动提交的，在实际很多场景中，需要业务服务确定消息是否被正常消费，正常消费后才可以提交offset</p></li><li><p>设置enable.auto.commit属性为false</p></li><li><p>手动提交分为两种：</p><ul><li>同步阻塞提交：kafkaConsumer.commitSync()</li><li>异步提交：kafkaConsumer.commitAsync()，实现onComplete方法处理自定义逻辑</li></ul></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka-生产者</title>
      <link href="/kafka/kafka-sheng-chan-zhe/"/>
      <url>/kafka/kafka-sheng-chan-zhe/</url>
      
        <content type="html"><![CDATA[<p>生产者如何将消息发送给kafka</p><p><img src="/images/Kafka-%E7%94%9F%E4%BA%A7%E8%80%85/kafka%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7.png"></p><ul><li><p>batch缓冲区</p><ul><li>生产者发送消息到服务端不是一条一条发的，而是经过一个内存缓冲区，当缓冲区达到一定条件后，再一次性将消息数据发送到topic</li><li>缓冲区大小默认为16KB，通过batch.size配置，单位：字节，当消息数据超过阀值后，就会执行提交</li><li>如果消息大小一直没有满设置的缓冲区大小阀值，则会根据超过某个时间后进行发送，通过配置linger.ms实现，默认为0，表示即使缓冲区没满，消息也会立刻发送。</li><li>batch.size和linger.ms，两个配置，满足其一，消息就会被发送</li></ul></li><li><p>消息发送到partition分区的策略</p><ul><li>如果指定了partition的id，就会被发送到指定的partition中</li><li>如果指定了key，ProducerRecord会根据key的hash值，发送到对应的partition中，拥有相同key的消息会被写到同一个partition，实现顺序消息</li><li>如果id和key都没有指定，则会按照粘性（sticky）分区策略的方式依次发送到每个partition中</li><li>如果同时指定id和key，则以id为准</li></ul></li><li><p>partition分区策略的改变</p><ul><li><p>2.4版本以前，默认round-robin（轮询）方式，2.3.1版本源码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * The default partitioning strategy: * &lt;ul&gt; * &lt;li&gt;If a partition is specified in the record, use it * &lt;li&gt;If no partition is specified but a key is present choose a partition based on a hash of the key * &lt;li&gt;If no partition or key is present choose a partition in a round-robin fashion */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">&gt;</span></span> topicCounterMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment">/**     * Compute the partition for the given record.     *     * @param topic The topic name     * @param key The key to partition on (or null if no key)     * @param keyBytes serialized key to partition on (or null if no key)     * @param value The value to partition on or null     * @param valueBytes serialized value to partition on or null     * @param cluster The current cluster metadata     */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> partitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> numPartitions <span class="token operator">=</span> partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> nextValue <span class="token operator">=</span> <span class="token function">nextValue</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> availablePartitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">availablePartitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>availablePartitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">int</span> part <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span>nextValue<span class="token punctuation">)</span> <span class="token operator">%</span> availablePartitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> availablePartitions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>part<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment">// no partitions are available, give a non-available partition</span>                <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span>nextValue<span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">// hash the keyBytes to choose a partition</span>            <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">murmur2</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">nextValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">AtomicInteger</span> counter <span class="token operator">=</span> topicCounterMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> counter<span class="token punctuation">)</span> <span class="token punctuation">{</span>            counter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">AtomicInteger</span> currentCounter <span class="token operator">=</span> topicCounterMap<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentCounter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                counter <span class="token operator">=</span> currentCounter<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> counter<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>2.4版本以后，默认为：sticky （粘性）</p><p>参考文档：<a href="https://www.confluent.io/blog/apache-kafka-producer-improvements-sticky-partitioner/">https://www.confluent.io/blog/apache-kafka-producer-improvements-sticky-partitioner/</a></p><blockquote><p>If we send several records to the same partition at around the same time, they can be sent as a batch</p><p>如果我们在同一时间将多条记录发送到同一个分区，它们可以作为批处理发送</p><p>Generally, smaller batches lead to more requests and queuing, resulting in higher latency.</p><p>一般来说，更小的批量会导致更多的请求和排队，从而导致更高的延迟。</p><p>A batch is completed either when it reaches a certain size (batch.size) or after a period of time (linger.ms) is up.</p><p>一个批处理要么在达到某个大小(batch.size)时完成，要么在一段时间(linger.ms)结束后完成。</p><p>The default for batch. size is 16,384 bytes, and the default of linger. ms is 0 milliseconds. </p><p>默认值，batch.size为16KB，linger. ms为0ms</p><p>At first glance, it might seem like setting <code>linger.ms</code> to 0 would only lead to the production of single-record batches. However, this is usually not the case. Even when <code>linger.ms</code> is 0, the producer will group records into batches when they are produced to the same partition around the same time. This is because the system needs a bit of time to handle each request, and batches form when the system cannot attend to them all right away.</p><p>乍一看，似乎设置<code>linger.ms</code>为 0 只会导致生成单记录批次。然而，通常情况并非如此。即使<code>linger.ms</code>是 0，生产者也会将记录在同一时间生产到同一分区时分批进行。这是因为系统需要一点时间来处理每个请求，并且当系统无法立即处理它们时会批量形成。</p><p>Due to the potential for increased latency with small batches, the original strategy for partitioning records with null keys can be inefficient. This changes with <a href="https://www.confluent.io/blog/apache-kafka-2-4-latest-version-updates">Apache Kafka version 2.4</a>, which introduces sticky partitioning, a new strategy for assigning records to partitions with proven lower latency.</p><p>由于小批量可能会增加延迟，因此使用空键对记录进行分区的原始策略可能效率低下。这在<a href="https://www.confluent.io/blog/apache-kafka-2-4-latest-version-updates">Apache Kafka 2.4 版中</a>发生了变化，它引入了粘性分区，这是一种将记录分配给具有低延迟的分区的新策略。</p><p>The sticky partitioner addresses the problem of spreading out records without keys into smaller batches by picking a single partition to send all non-keyed records. Once the batch at that partition is filled or otherwise completed, the sticky partitioner randomly chooses and “sticks” to a new partition. That way, over a larger period of time, records are about evenly distributed among all the partitions while getting the added benefit of larger batch sizes.</p><p>粘性分区器通过选择单个分区来发送所有非键记录，解决了将没有键的记录分散成较小批次的问题。一旦该分区的批次被填满或以其他方式完成，粘性分区程序会随机选择并“粘”到一个新分区。这样，在更长的时间内，记录大致均匀地分布在所有分区中，同时获得更大批量的额外好处。</p><p>The main goal of the sticky partitioner is to increase the number of records in each batch in order to decrease the total number of batches and eliminate excess queuing. When there are fewer batches with more records in each batch, the cost per record is lower and the same number of records can be sent more quickly using the sticky partitioning strategy. The data shows that this strategy does decrease latency in cases where null keys are used, and the effect becomes more pronounced when the number of partitions increases. In addition, CPU usage is often decreased when using the sticky partitioning strategy. By sticking to a partition and sending fewer but bigger batches, the producer sees great performance improvements.</p><p>粘性分区器的主要目标是增加每个批次中的记录数，以减少批次总数并消除多余的排队。当每个批次中有更多记录的批次较少时，每条记录的成本较低，并且使用粘性分区策略可以更快地发送相同数量的记录。数据显示，在使用空键的情况下，这种策略确实减少了延迟，并且当分区数量增加时效果会更加明显。此外，在使用粘性分区策略时，CPU 使用率通常会降低。通过坚持分区并发送更少但更大的批次，生产者看到了巨大的性能改进。</p></blockquote></li></ul></li></ul><p>​<img src="/images/Kafka-%E7%94%9F%E4%BA%A7%E8%80%85/sticky-partitioner-strategy.png"></p><p>3.0.0版本的源码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * The default partitioning strategy: * &lt;ul&gt; * &lt;li&gt;If a partition is specified in the record, use it * &lt;li&gt;If no partition is specified but a key is present choose a partition based on a hash of the key * &lt;li&gt;If no partition or key is present choose the sticky partition that changes when the batch is full. *  * See KIP-480 for details about sticky partitioning. */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StickyPartitionCache</span> stickyPartitionCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StickyPartitionCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment">/**     * Compute the partition for the given record.     *     * @param topic The topic name     * @param key The key to partition on (or null if no key)     * @param keyBytes serialized key to partition on (or null if no key)     * @param value The value to partition on or null     * @param valueBytes serialized value to partition on or null     * @param cluster The current cluster metadata     */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">partition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> key<span class="token punctuation">,</span> keyBytes<span class="token punctuation">,</span> value<span class="token punctuation">,</span> valueBytes<span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * Compute the partition for the given record.     *     * @param topic The topic name     * @param numPartitions The number of partitions of the given {@code topic}     * @param key The key to partition on (or null if no key)     * @param keyBytes serialized key to partition on (or null if no key)     * @param value The value to partition on or null     * @param valueBytes serialized value to partition on or null     * @param cluster The current cluster metadata     */</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">,</span>                         <span class="token keyword">int</span> numPartitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> stickyPartitionCache<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// hash the keyBytes to choose a partition</span>        <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">murmur2</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token comment">/**     * If a batch completed for the current sticky partition, change the sticky partition.      * Alternately, if no sticky partition has been determined, set one.     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNewBatch</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">,</span> <span class="token keyword">int</span> prevPartition<span class="token punctuation">)</span> <span class="token punctuation">{</span>        stickyPartitionCache<span class="token punctuation">.</span><span class="token function">nextPartition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> prevPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * An internal class that implements a cache used for sticky partitioning behavior. The cache tracks the current sticky * partition for any given topic. This class should not be used externally.  */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StickyPartitionCache</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> indexCache<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">StickyPartitionCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>indexCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Integer</span> part <span class="token operator">=</span> indexCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>part <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">nextPartition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> part<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">nextPartition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">,</span> <span class="token keyword">int</span> prevPartition<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> partitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Integer</span> oldPart <span class="token operator">=</span> indexCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Integer</span> newPart <span class="token operator">=</span> oldPart<span class="token punctuation">;</span>        <span class="token comment">// Check that the current sticky partition for the topic is either not set or that the partition that </span>        <span class="token comment">// triggered the new batch matches the sticky partition that needs to be changed.</span>        <span class="token comment">// oldPart == null表示新建的topic被第一次调用，oldPart == prevPartition在新的batch被创建时为true</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPart <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> oldPart <span class="token operator">==</span> prevPartition<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> availablePartitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">availablePartitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>availablePartitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">Integer</span> random <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                newPart <span class="token operator">=</span> random <span class="token operator">%</span> partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>availablePartitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                newPart <span class="token operator">=</span> availablePartitions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">while</span> <span class="token punctuation">(</span>newPart <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> newPart<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>oldPart<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">int</span> random <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    newPart <span class="token operator">=</span> availablePartitions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>random <span class="token operator">%</span> availablePartitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment">// Only change the sticky partition if it is null or prevPartition matches the current sticky partition.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPart <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                indexCache<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> newPart<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                indexCache<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> prevPartition<span class="token punctuation">,</span> newPart<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> indexCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> indexCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码验证：</p><ol><li><p>创建一个topic：aacopy，5个分区，1个副本</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>       <span class="token comment">//（topic名称，partition分区数量，副本数量）</span>       <span class="token class-name">NewTopic</span> newTopic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NewTopic</span><span class="token punctuation">(</span><span class="token string">"aacopy"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token class-name">CreateTopicsResult</span> topics <span class="token operator">=</span> adminClient<span class="token punctuation">.</span><span class="token function">createTopics</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>newTopic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       topics<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>没有指定id和key的情况</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sandWithNothing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sendMsg <span class="token operator">=</span> kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"aacopy"</span><span class="token punctuation">,</span> <span class="token string">"aacopy-msg-"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//增加回调函数，打印返回值</span>           sendMsg<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>success <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>               <span class="token class-name">RecordMetadata</span> rm <span class="token operator">=</span> success<span class="token punctuation">.</span><span class="token function">getRecordMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息发送成功：topic-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", partition-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", offset-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">,</span> failure <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息发送失败："</span> <span class="token operator">+</span> failure<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>控制台打印日志截取：</p><blockquote><p>……</p><p>消息发送成功：topic-&gt;aacopy, partition-&gt;2, offset-&gt;403<br>消息发送成功：topic-&gt;aacopy, partition-&gt;2, offset-&gt;404<br>消息发送成功：topic-&gt;aacopy, partition-&gt;2, offset-&gt;405<br>消息发送成功：topic-&gt;aacopy, partition-&gt;2, offset-&gt;406<br>消息发送成功：topic-&gt;aacopy, partition-&gt;2, offset-&gt;407<br>消息发送成功：topic-&gt;aacopy, partition-&gt;1, offset-&gt;319<br>消息发送成功：topic-&gt;aacopy, partition-&gt;1, offset-&gt;320<br>消息发送成功：topic-&gt;aacopy, partition-&gt;1, offset-&gt;321<br>消息发送成功：topic-&gt;aacopy, partition-&gt;1, offset-&gt;322</p><p>……</p></blockquote></li><li><p>指定id</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendWithId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sendMsg <span class="token operator">=</span> kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"aacopy"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"aacopy-msg-"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>           sendMsg<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>success <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>               <span class="token class-name">RecordMetadata</span> rm <span class="token operator">=</span> success<span class="token punctuation">.</span><span class="token function">getRecordMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息发送成功：topic-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", partition-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", offset-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">,</span> failure <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息发送失败："</span> <span class="token operator">+</span> failure<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>控制台打印日志截取：</p><blockquote><p>……</p><p>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;93<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;94<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;95<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;96<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;97<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;98<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;99</p></blockquote><p>所有消息都推送到id为4的partition中</p></li><li><p>指定key</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendWithKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sendMsg <span class="token operator">=</span> kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"aacopy"</span><span class="token punctuation">,</span> <span class="token string">"HelloWorld"</span><span class="token punctuation">,</span> <span class="token string">"aacopy-msg-"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>           sendMsg<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>success <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>               <span class="token class-name">RecordMetadata</span> rm <span class="token operator">=</span> success<span class="token punctuation">.</span><span class="token function">getRecordMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息发送成功：topic-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", partition-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", offset-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">,</span> failure <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息发送失败："</span> <span class="token operator">+</span> failure<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>控制台打印日志截取：</p><blockquote><p>……</p><p>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;102<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;103<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;104<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;105<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;106<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;107</p><p>……</p></blockquote></li><li><p>同时指定id和key</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendWithIdAndKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sendMsg <span class="token operator">=</span> kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"aacopy"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"HelloWorld"</span><span class="token punctuation">,</span> <span class="token string">"aacopy-msg-"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>           sendMsg<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>success <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>               <span class="token class-name">RecordMetadata</span> rm <span class="token operator">=</span> success<span class="token punctuation">.</span><span class="token function">getRecordMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息发送成功：topic-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", partition-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", offset-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">,</span> failure <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息发送失败："</span> <span class="token operator">+</span> failure<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>控制台打印日志截取：</p><blockquote><p>……</p><p>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;333<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;334<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;335<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;336<br>消息发送成功：topic-&gt;aacopy, partition-&gt;4, offset-&gt;337</p><p>……</p></blockquote></li></ol><p>​打印验证，id和key同时存在，以id为准</p><ul><li><p>自定义分区规则</p><p>自定义分区规则需要实现Partitioner接口，或者继承实现了Partitioner接口的类，这里继承DefaultPartitioner，可以在不需要自定义的消息时走默认的策略</p><ol><li>编写自定义分区规则类</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomizedPartitioner</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultPartitioner</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> keyStr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> key<span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>keyStr<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"aacopy_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"自定义分区策略...... key -&gt;"</span> <span class="token operator">+</span> keyStr<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> key<span class="token punctuation">,</span> keyBytes<span class="token punctuation">,</span> value<span class="token punctuation">,</span> valueBytes<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>添加配置文件，</li></ol><pre class="line-numbers language-none"><code class="language-none">#定义分区策略spring.kafka.producer.properties.partitioner.class=cn.aacopy.learn.kafka.CustomizedPartitioner<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="3"><li>编写测试代码</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendWithCustomizedPartitioner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sendMsg <span class="token operator">=</span> kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"aacopy"</span><span class="token punctuation">,</span> <span class="token string">"aacopy_"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">"aacopy-msg-"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>           sendMsg<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>success <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>               <span class="token class-name">RecordMetadata</span> rm <span class="token operator">=</span> success<span class="token punctuation">.</span><span class="token function">getRecordMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息发送成功：topic-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", partition-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", offset-&gt;"</span> <span class="token operator">+</span> rm<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token punctuation">}</span><span class="token punctuation">,</span> failure <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消息发送失败："</span> <span class="token operator">+</span> failure<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>控制台打印日志截取：</li></ol><blockquote><p>……</p><p>自定义分区策略…… key -&gt;aacopy_96<br>自定义分区策略…… key -&gt;aacopy_97<br>自定义分区策略…… key -&gt;aacopy_98<br>自定义分区策略…… key -&gt;aacopy_98<br>自定义分区策略…… key -&gt;aacopy_99</p><p>……</p><p>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;729<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;730<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;731<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;732<br>消息发送成功：topic-&gt;aacopy, partition-&gt;0, offset-&gt;733</p><p>……</p></blockquote></li></ul>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Aspose-Excel</title>
      <link href="/util/aspose-excel/"/>
      <url>/util/aspose-excel/</url>
      
        <content type="html"><![CDATA[<p>支持任意位置插入动态行列</p><p>支持对单个单元格自定义处理方法</p><h2 id="定义注解annotation"><a href="#定义注解annotation" class="headerlink" title="定义注解annotation"></a>定义注解annotation</h2><ul><li>ExcelChunk</li><li>ExcelEntity</li><li>ExcelValue</li><li>ExcelValues</li></ul><h3 id="ExcelChunk"><a href="#ExcelChunk" class="headerlink" title="ExcelChunk"></a>ExcelChunk</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * excel注解 * 用于在excel中规划一块区域，来存放一类字段 * @author iseven.yang * @date 2021/12/15 13:14 */</span><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">ExcelChunk</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 一块区域的唯一标识，多个字段上标识的name相同，标识放在同一块区域     */</span>    <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 相对块的name，如果为空，则表示参照的基本块，一个sheet中只能有一个块的dependChunk为空     */</span>    <span class="token class-name">String</span> <span class="token function">dependChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 相对位置，四个位置，用，top，down，left， right来表示上下左右，默认在相对块的下面     */</span>    <span class="token class-name">ShipEnum</span> <span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">ShipEnum</span><span class="token punctuation">.</span><span class="token constant">DOWN</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 行偏移量     */</span>    <span class="token keyword">int</span> <span class="token function">offsetX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 列偏移量     */</span>    <span class="token keyword">int</span> <span class="token function">offsetY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 一块区域中固定部分的单元格     */</span>    <span class="token class-name">ExcelValue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">fixCells</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token annotation punctuation">@ExcelValue</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ExcelEntity"><a href="#ExcelEntity" class="headerlink" title="ExcelEntity"></a>ExcelEntity</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * excel注解 * 标识某个类，设置excel中的属性 * @author iseven.yang * @date 2021/12/15 14:13 */</span><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">ExcelEntity</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 生成excel的文件名     */</span>    <span class="token class-name">String</span> <span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token comment">/**     * sheet名称     */</span>    <span class="token class-name">String</span> <span class="token function">sheetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 列宽，从第一列宽度开始写     * @return     */</span>    <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">cellsWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">8.43</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 行高     * @return     */</span>    <span class="token keyword">double</span> <span class="token function">rowHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">25</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 单元格锁定     * @return     */</span>    <span class="token class-name">LockModeEnum</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">LockModeEnum</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 全局不锁定，只锁定传入的单元格，（英文逗号，中间不要带空格）     * String格式     * 如果为整行参数格式：R,rowNum,startCell （行索引，开始列）     * 如果为整列参数格式：C,cellNum,startRow （列索引，开始行）     * 如果取范围内的cell，参数格式：beginRow,beginCell,rowNum,cellNum （开始行,开始列,总行数,总列数）     * @return     */</span>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">lockInclude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 全局锁定，排除传入的单元格，（英文逗号，中间不要带空格）     * String格式     * 如果为整行参数格式：rowNum,startCell （行索引，开始列）     * 如果为整列参数格式：cellNum,startRow （列索引，开始行）     * 如果取范围内的cell，参数格式：beginRow,beginCell,rowNum,cellNum （开始行,开始列,总行数,总列数）     * @return     */</span>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">lockExclude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 划分块，主要用来解决存在动态行或列的情况下定位单元格位置     */</span>    <span class="token class-name">ExcelChunk</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chunks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token annotation punctuation">@ExcelChunk</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ExcelValue"><a href="#ExcelValue" class="headerlink" title="ExcelValue"></a>ExcelValue</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * @author iseven.yang * @date 2021/12/15 13:59 */</span><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">ExcelValue</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 所属区域，在字段上的注解，需要设置该值，绑定区域；在类上的注解不需要设置该值     */</span>    <span class="token class-name">String</span> <span class="token function">chunkName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 起始位置行坐标x，x为相对于块（ExcelChunk）中的位置，不是excel中的绝对位置     */</span>    <span class="token keyword">int</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 起始位置列坐标y，y为相对于块（ExcelChunk）中的位置，不是excel中的绝对位置     */</span>    <span class="token keyword">int</span> <span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 如果有单元格合并，需要跨的行数     */</span>    <span class="token keyword">int</span> <span class="token function">xNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 如果有单元格合并，需要跨的列数     */</span>    <span class="token keyword">int</span> <span class="token function">yNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 单元格样式     */</span>    <span class="token class-name">StyleEnum</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">COMMON</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 单元格内容，在字段上的注解：填写对象属性中需要获取的值     * 在类上的注解需要设置该值，用于设置单元格中固定的数据     */</span>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 如果字段使一个列表，需要指定列表中的数据填充方向，允许的值：down，right。默认往下     */</span>    <span class="token class-name">DirectionEnum</span> <span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">DirectionEnum</span><span class="token punctuation">.</span><span class="token constant">DOWN</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 获取值的方式，value表示直接获取，obj，表示需要从对象内部属性获取，嵌套获取     * @return     */</span>    <span class="token class-name">ValueTypeEnum</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">ValueTypeEnum</span><span class="token punctuation">.</span><span class="token constant">VALUE</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 自定义处理方法，入参为静态方法名，无返回值，方法入参固定两个（Object value, Worksheet worksheet, Cell cell）     * @return     */</span>    <span class="token class-name">String</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ExcelValues"><a href="#ExcelValues" class="headerlink" title="ExcelValues"></a>ExcelValues</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 多个value * @author iseven.yang * @date 2021/12/21 10:23 */</span><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">ExcelValues</span> <span class="token punctuation">{</span>    <span class="token class-name">ExcelValue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token annotation punctuation">@ExcelValue</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="定义枚举Enum"><a href="#定义枚举Enum" class="headerlink" title="定义枚举Enum"></a>定义枚举Enum</h2><ul><li>DirectionEnum</li><li>LockModeEnum</li><li>ShipEnum</li><li>StyleEnum</li><li>ValueTypeEnum</li></ul><h3 id="DirectionEnum"><a href="#DirectionEnum" class="headerlink" title="DirectionEnum"></a>DirectionEnum</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * excel list数据填充数据 * @author iseven.yang * @date 2021/12/15 15:28 */</span><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">DirectionEnum</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 向下填充     */</span>    <span class="token constant">DOWN</span><span class="token punctuation">,</span>    <span class="token comment">/**     * 向右填充     */</span>    <span class="token constant">RIGHT</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="LockModeEnum"><a href="#LockModeEnum" class="headerlink" title="LockModeEnum"></a>LockModeEnum</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * @author iseven.yang * @date 2021/12/17 10:58 */</span><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">LockModeEnum</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 全局不锁定     */</span>    <span class="token constant">NONE</span><span class="token punctuation">,</span>    <span class="token comment">/**     * 全局锁定     */</span>    <span class="token constant">ALL</span><span class="token punctuation">,</span>    <span class="token comment">/**     * 全局锁定，排除部分单元格     */</span>    <span class="token constant">EXCLUDE</span><span class="token punctuation">,</span>    <span class="token comment">/**     * 全局不锁定，只锁定设置的单元格     */</span>    <span class="token constant">INCLUDE</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ShipEnum"><a href="#ShipEnum" class="headerlink" title="ShipEnum"></a>ShipEnum</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 块关系 * @author iseven.yang * @date 2021/12/15 15:31 */</span><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ShipEnum</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 向上     */</span>    <span class="token constant">TOP</span><span class="token punctuation">,</span>    <span class="token comment">/**     * 向下     */</span>    <span class="token constant">DOWN</span><span class="token punctuation">,</span>    <span class="token comment">/**     * 向左     */</span>    <span class="token constant">LEFT</span><span class="token punctuation">,</span>    <span class="token comment">/**     * 向右     */</span>    <span class="token constant">RIGHT</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="StyleEnum"><a href="#StyleEnum" class="headerlink" title="StyleEnum"></a>StyleEnum</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * @author iseven.yang * @date 2021/12/16 19:49 */</span><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">StyleEnum</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 通用样式     */</span>    <span class="token constant">COMMON</span><span class="token punctuation">,</span>    <span class="token comment">/**     * 通用标题样式     */</span>    <span class="token constant">TITLE</span><span class="token punctuation">,</span>    <span class="token comment">/**     * 模块标题样式     */</span>    <span class="token constant">MODULE_TITLE</span><span class="token punctuation">,</span>    <span class="token comment">/**     * KEY样式     */</span>    <span class="token constant">KEY</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ValueTypeEnum"><a href="#ValueTypeEnum" class="headerlink" title="ValueTypeEnum"></a>ValueTypeEnum</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 值类型 * @author iseven.yang * @date 2021/12/17 17:16 */</span><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ValueTypeEnum</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 直接取值     */</span>    <span class="token constant">VALUE</span><span class="token punctuation">,</span>    <span class="token comment">/**     * 对象     */</span>    <span class="token constant">OBJ</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="定义样式"><a href="#定义样式" class="headerlink" title="定义样式"></a>定义样式</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>excel<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>excel<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">StyleEnum</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>cells<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author iseven.yang * @date 2021/12/16 19:35 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExcelStyle</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 初始化所有样式     * @param workbook     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initAllStyle</span><span class="token punctuation">(</span><span class="token class-name">Workbook</span> workbook<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">StyleEnum</span><span class="token punctuation">[</span><span class="token punctuation">]</span> styles <span class="token operator">=</span> <span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">initStyles</span><span class="token punctuation">(</span>workbook<span class="token punctuation">,</span> styles<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 初始化选的的样式     * @param workbook     * @param styles     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initStyles</span><span class="token punctuation">(</span><span class="token class-name">Workbook</span> workbook<span class="token punctuation">,</span> <span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> styles<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>styles <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">StyleEnum</span> style<span class="token operator">:</span> styles<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>style<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">case</span> <span class="token constant">COMMON</span><span class="token operator">:</span> <span class="token function">commonStyle</span><span class="token punctuation">(</span>workbook<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> <span class="token constant">TITLE</span><span class="token operator">:</span> <span class="token function">titleStyle</span><span class="token punctuation">(</span>workbook<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> <span class="token constant">MODULE_TITLE</span><span class="token operator">:</span> <span class="token function">moduleTitleStyle</span><span class="token punctuation">(</span>workbook<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> <span class="token constant">KEY</span><span class="token operator">:</span> <span class="token function">keyStyle</span><span class="token punctuation">(</span>workbook<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 基础样式     * @param style     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">baseStyle</span><span class="token punctuation">(</span><span class="token class-name">Style</span> style<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//字体</span>        <span class="token class-name">Font</span> font <span class="token operator">=</span> style<span class="token punctuation">.</span><span class="token function">getFont</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        font<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"微软雅黑"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        font<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//自动换行</span>        style<span class="token punctuation">.</span><span class="token function">setTextWrapped</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//居中显示</span>        style<span class="token punctuation">.</span><span class="token function">setVerticalAlignment</span><span class="token punctuation">(</span><span class="token class-name">TextAlignmentType</span><span class="token punctuation">.</span><span class="token constant">CENTER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        style<span class="token punctuation">.</span><span class="token function">setHorizontalAlignment</span><span class="token punctuation">(</span><span class="token class-name">TextAlignmentType</span><span class="token punctuation">.</span><span class="token constant">CENTER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//白底背景色</span>        style<span class="token punctuation">.</span><span class="token function">setForegroundColor</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">fromArgb</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        style<span class="token punctuation">.</span><span class="token function">setPattern</span><span class="token punctuation">(</span><span class="token class-name">BackgroundType</span><span class="token punctuation">.</span><span class="token constant">SOLID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//全边框</span>        style<span class="token punctuation">.</span><span class="token function">setBorder</span><span class="token punctuation">(</span><span class="token class-name">BorderType</span><span class="token punctuation">.</span><span class="token constant">TOP_BORDER</span><span class="token punctuation">,</span> <span class="token class-name">CellBorderType</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">getBlack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        style<span class="token punctuation">.</span><span class="token function">setBorder</span><span class="token punctuation">(</span><span class="token class-name">BorderType</span><span class="token punctuation">.</span><span class="token constant">BOTTOM_BORDER</span><span class="token punctuation">,</span> <span class="token class-name">CellBorderType</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">getBlack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        style<span class="token punctuation">.</span><span class="token function">setBorder</span><span class="token punctuation">(</span><span class="token class-name">BorderType</span><span class="token punctuation">.</span><span class="token constant">LEFT_BORDER</span><span class="token punctuation">,</span> <span class="token class-name">CellBorderType</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">getBlack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        style<span class="token punctuation">.</span><span class="token function">setBorder</span><span class="token punctuation">(</span><span class="token class-name">BorderType</span><span class="token punctuation">.</span><span class="token constant">RIGHT_BORDER</span><span class="token punctuation">,</span> <span class="token class-name">CellBorderType</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">getBlack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 通用样式     * @param workbook     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">commonStyle</span><span class="token punctuation">(</span><span class="token class-name">Workbook</span> workbook<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Style</span> style <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        style<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">COMMON</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">baseStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 创建标题样式     * @param workbook     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">titleStyle</span><span class="token punctuation">(</span><span class="token class-name">Workbook</span> workbook<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Style</span> style <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        style<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">TITLE</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">baseStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Font</span> font <span class="token operator">=</span> style<span class="token punctuation">.</span><span class="token function">getFont</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//字体大小</span>        font<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//加粗</span>        font<span class="token punctuation">.</span><span class="token function">setBold</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//字体红色</span>        font<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">fromArgb</span><span class="token punctuation">(</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//灰色背景</span>        style<span class="token punctuation">.</span><span class="token function">setForegroundColor</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">fromArgb</span><span class="token punctuation">(</span><span class="token number">242</span><span class="token punctuation">,</span> <span class="token number">242</span><span class="token punctuation">,</span> <span class="token number">242</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 模块标题样式     * @param workbook     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">moduleTitleStyle</span><span class="token punctuation">(</span><span class="token class-name">Workbook</span> workbook<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Style</span> style <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        style<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">MODULE_TITLE</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">baseStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Font</span> font <span class="token operator">=</span> style<span class="token punctuation">.</span><span class="token function">getFont</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//加粗</span>        font<span class="token punctuation">.</span><span class="token function">setBold</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//灰色背景</span>        style<span class="token punctuation">.</span><span class="token function">setForegroundColor</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">fromArgb</span><span class="token punctuation">(</span><span class="token number">242</span><span class="token punctuation">,</span> <span class="token number">242</span><span class="token punctuation">,</span> <span class="token number">242</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        style<span class="token punctuation">.</span><span class="token function">setHorizontalAlignment</span><span class="token punctuation">(</span><span class="token class-name">TextAlignmentType</span><span class="token punctuation">.</span><span class="token constant">LEFT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * key样式     * @param workbook     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">keyStyle</span><span class="token punctuation">(</span><span class="token class-name">Workbook</span> workbook<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Style</span> style <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        style<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">KEY</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">baseStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Font</span> font <span class="token operator">=</span> style<span class="token punctuation">.</span><span class="token function">getFont</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//字体灰色</span>        font<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">fromArgb</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>excel<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>excel<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>export<span class="token punctuation">.</span></span><span class="token class-name">ExcelChunk</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>excel<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>export<span class="token punctuation">.</span></span><span class="token class-name">ExcelEntity</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>excel<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>export<span class="token punctuation">.</span></span><span class="token class-name">ExcelValue</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>excel<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>export<span class="token punctuation">.</span></span><span class="token class-name">ExcelValues</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>excel<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Zzz</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>excel<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>cells<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationTargetException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author iseven.yang * @date 2021/12/15 14:28 */</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExcelUtil</span> <span class="token punctuation">{</span>    <span class="token comment">//背景图片</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BACKGROUND_IMG</span> <span class="token operator">=</span> <span class="token string">"iVBORw0KGgoAAAANSUhEUgAAAsQAAAHmCAIAAAD7uw90AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAx2SURBVHhe7d09VxrbAoBhz+2UUk9Lm1hqnZ+fOiljWtpIKZa5gxKZQYkhr2vddeV5GtHZe6DbL/PlPz9//jwBAPhb/9n8BAD4K2ICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJGICAEjEBACQiAkAIBETAEAiJgCAREwAAImYAAASMQEAJP/8/Plz85K3sloub3/8WN7fn9zd3a3/MJvNTs/n8/n52cP2XYeOf7BaLW8Xi+XTnP2TVsvF4g/3/jB0tfnl7N+P8/P1+yy+L+4f566nzj983M5cLW4Wv8YPM+Yf5zs7ne7x+XYA/v+JiTe1Wnz9snhc218wm19fTRfTQ8c/WC1vvi9uNwkxNZ2xXsgXw8jNr7te+TjD5g8n31/6eKOJy5vP324fXq1dXH76eL55/Wi8/flWAN4Fpzne0up2uW/lXrtbLJabl48OHb9e7m++fvn2ckkMq/z5xbYkhjD4tthbEoO7xffRUYXB5OPMTpZf9oTOC5/rZcubbWlcXCoJgHdKTLyhh8V4djGfX15ff9q4nl9stj538Pj1gYNRHsyGuZeP5hez2agllkNyjELg4T02wzZ/ejCtgmnarM9rPL3BzryT+7tNhZyejTbMzk43rx5ICYAj4TTHG1qtVmdnk/MGa/uP9B82fnpGYc8pkLXpuZPdgdOtozeYbtidt2enkz9PpjjBAXA0HJl4QztlMLTCarlc/Ljf/D6sttOv7oeMH3/NHxbnvSUxLO/fR0lwcbk78Gw2+QxPpsclns+bOJ1tNu7b2+jjDomhJADeNTHxltZXPN58/fr184Mvg2/jyxbGlzQ8+OPxOykxup1i17DHbRO8dHJhdbeNlVGtTFrihXn3q+3m3Sh6ZpISH35XJQC8A2LijayvjPz85dv65ok9V0dOW+Kg8csf25Q4ufj3N9/zXx05iYbtO0xb4vm8aYLsRtGUlAA4MmLiLSxvPm+vjNxctXg9+HQ5uppytAQfOP5/3xLT4x3zUSBMrsBcG6XEK+dKAHgnxES2WnwdXx/w6erq4/z8/PxsMF7bn5bgQ8dPC+G3ZxheHbknCl5pidViMdrv/po5nZ1NUsKlEgDHQUxU4/V58p19ugY/LcGHjt9xtxqdbzjQ5MqL2Xz+6x0mLbG97XNjeTO+yeO3ifBDSgAcIzERTQ4GbK2W0xstty1x4Phnbr/dLEer/TDx5uVHSK0fIvE0cL3/8Z2l4zMQ05Y4uVve/pq33vn2MMrgeSKMb+e4vd0MdQMHwFHxnIlo+vSHYR2dzR4f+DSxfdDCoePXdufsGA1+ZeTGxeWw1j8dEtl5vsR+02m/PH/LyeMmAHj/HJl4Y0MXrMtgNh8/yXL/cYY/Gn8+n+9c5Tg2Hvz7kYPZxfx6SI/xyZXJJZnrtHnJ7OWSGOxegekGDoCjIyai84+XO4+aXt+ccX01W22/rk+W+wPHPzibX13vPtH60Ww2nwxej9x9g0ezdQ9cX+3+287ptZfzqw/PZq/nfbr6zaMtxtzAAXCEnOZ4G6vl8n74ln56uvNUy30OHf/LarX+X+KDYeruEzSnVqvV/cPQ346cnON4Ol+yeZc/+Xgv7wCAYyImjlpNgckFE1IC4Eg5zXHMXnm+xCvGD8xwAwfAERMTR2z6CKs/aYnV4uZmsVgu17eMfh7dA+JSCYBjJiaO1+SRF3/WErfL29vF4tv035E93Oix+QWAIyQmjtZftcT2SMaDdUj86Y0eALxXLsA8VqvF1+9PT848nQ9JsHm912q5+P70sM3T8/n84vywW1EAeJ/EBACQOM0BACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAIiYAgERMAACJmAAAEjEBACRiAgBIxAQAkIgJACAREwBAcHLyX9fTIjc2vymcAAAAAElFTkSuQmCC"</span><span class="token punctuation">;</span>    <span class="token comment">//map中字段的key</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">KEY_FIELD</span> <span class="token operator">=</span> <span class="token string">"field"</span><span class="token punctuation">;</span>    <span class="token comment">//map中数据对象的key</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">KEY_OBJ</span> <span class="token operator">=</span> <span class="token string">"obj"</span><span class="token punctuation">;</span>    <span class="token comment">//map中字段所属的excelValue注解中chunkName的值</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">KEY_EXCEL_VALUE</span> <span class="token operator">=</span> <span class="token string">"excelValue"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//测试用，正式用spring加载</span>        <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>cells<span class="token punctuation">.</span></span>License</span> license <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>cells<span class="token punctuation">.</span></span>License</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        license<span class="token punctuation">.</span><span class="token function">setLicense</span><span class="token punctuation">(</span><span class="token class-name">ExcelUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"Aspose.Total.Java.lic"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        AaTest aaTest = new AaTest();</span><span class="token comment">//        aaTest.setName("哇哇哇哇哇哇哇哇哇哇哇哇哇哇");</span><span class="token comment">//        aaTest.setList(Arrays.asList(1,2,3,4,5,6,7,8,8,9));</span><span class="token comment">//        BbTest bbTest = new BbTest();</span><span class="token comment">//        aaTest.setBbTest(bbTest);</span><span class="token comment">//        export(aaTest);</span>        <span class="token class-name">Zzz</span> zzz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Zzz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">export</span><span class="token punctuation">(</span>zzz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        File file = new File("E:\\Zzz.xlsx");</span><span class="token comment">//        try (FileInputStream fileInputStream = new FileInputStream(file)) {</span><span class="token comment">//            Object[][] objects = importData(fileInputStream);</span><span class="token comment">//            for (Object[] objects1: objects) {</span><span class="token comment">//                System.out.println(Arrays.toString(objects1));</span><span class="token comment">//            }</span><span class="token comment">//</span><span class="token comment">//        }</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"===================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 导入转二维数组     * @param inputStream     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">importData</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">Workbook</span> workbook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Workbook</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Worksheet</span> worksheet <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">getWorksheets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Cells</span> cells <span class="token operator">=</span> worksheet<span class="token punctuation">.</span><span class="token function">getCells</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dataTable <span class="token operator">=</span> worksheet<span class="token punctuation">.</span><span class="token function">getCells</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exportArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cells<span class="token punctuation">.</span><span class="token function">getMaxRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> cells<span class="token punctuation">.</span><span class="token function">getMaxColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> dataTable<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 导出     * @param obj     * @throws Exception     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">export</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> sheetList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">findAllSheet</span><span class="token punctuation">(</span>sheetList<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//创建excel</span>        <span class="token class-name">Workbook</span> workbook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Workbook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//初始化样式</span>        <span class="token class-name">ExcelStyle</span><span class="token punctuation">.</span><span class="token function">initAllStyle</span><span class="token punctuation">(</span>workbook<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ExcelStyle</span><span class="token punctuation">.</span><span class="token function">initAllStyle</span><span class="token punctuation">(</span>workbook<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">WorksheetCollection</span> worksheets <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">getWorksheets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> fileName <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".xlsx"</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>sheetList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>sheetList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    worksheets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token class-name">Worksheet</span> sheet <span class="token operator">=</span> worksheets<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">Object</span> o <span class="token operator">=</span> sheetList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//生成sheet</span>                <span class="token function">createSheet</span><span class="token punctuation">(</span>sheet<span class="token punctuation">,</span> o<span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        workbook<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token string">"E:\\"</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 递归获取所有需要生成sheet的对象，放在sheetList集合中,如果循环依赖，就直接抛出异常，调用方自己处理     * @param sheetList     * @param obj     * @throws IllegalAccessException     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">findAllSheet</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> sheetList<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> aClass <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ExcelEntity</span> excelEntityAnno <span class="token operator">=</span> aClass<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">ExcelEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>excelEntityAnno <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            sheetList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> aClass<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>fields <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Field</span> field<span class="token operator">:</span> fields<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">ExcelEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">findAllSheet</span><span class="token punctuation">(</span>sheetList<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 创建sheet     * @param sheet     * @param obj     * @throws Exception     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createSheet</span><span class="token punctuation">(</span><span class="token class-name">Worksheet</span> sheet<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Class</span> rootClass<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> aClass <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ExcelEntity</span> excelEntityAnno <span class="token operator">=</span> aClass<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">ExcelEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>excelEntityAnno <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">//如果类上没有标识时一个excel导出类，就在字段上找@ExcelSheet注解</span>            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"类未添加ExcelEntity注解"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">//设置默认sheet名</span>        <span class="token class-name">String</span> sheetName <span class="token operator">=</span> excelEntityAnno<span class="token punctuation">.</span><span class="token function">sheetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>sheetName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            sheetName <span class="token operator">=</span> aClass<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        sheet<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>sheetName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Cells</span> cells <span class="token operator">=</span> sheet<span class="token punctuation">.</span><span class="token function">getCells</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置列宽</span>        <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> widths <span class="token operator">=</span> excelEntityAnno<span class="token punctuation">.</span><span class="token function">cellsWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> widths<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            cells<span class="token punctuation">.</span><span class="token function">setColumnWidth</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> widths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">//通过两个坐标（x,y）和（m,n）确定每个块的边界，Integer数字长度为4，0：x, 1:y, 2:m, 3:n</span>        <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> chunkArea <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//获取chunk</span>        <span class="token class-name">ExcelChunk</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chunkAnnos <span class="token operator">=</span> excelEntityAnno<span class="token punctuation">.</span><span class="token function">chunks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//按照chunk依赖关系分组，同一个依赖放一组</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ExcelChunk</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> dependGroup <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>chunkAnnos<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>excelChunk <span class="token operator">-&gt;</span> excelChunk<span class="token punctuation">.</span><span class="token function">dependChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//获取字段数据</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> allValueField <span class="token operator">=</span> <span class="token function">getAllValueField</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//需要按照chunk名称分组，同一个chunk的放一组，方便按依赖顺序生成，如果存在多层级需要递归出所有的分组数据</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> filedGroup <span class="token operator">=</span> allValueField<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>fieldMap <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ExcelValue</span><span class="token punctuation">)</span> fieldMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">KEY_EXCEL_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chunkName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//从依赖关系根节点往下生成，可以避免循环依赖问题</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExcelChunk</span><span class="token punctuation">&gt;</span></span> rootList <span class="token operator">=</span> dependGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>rootList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"根chunk错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">//设置根chunk数据</span>        <span class="token class-name">ExcelChunk</span> rootChunk <span class="token operator">=</span> rootList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rootArea <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>rootChunk<span class="token punctuation">.</span><span class="token function">offsetX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rootChunk<span class="token punctuation">.</span><span class="token function">offsetY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rootChunk<span class="token punctuation">.</span><span class="token function">offsetY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rootChunk<span class="token punctuation">.</span><span class="token function">offsetY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        chunkArea<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>rootChunk<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rootArea<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//处理固定数据</span>        <span class="token function">setFixData</span><span class="token punctuation">(</span>rootArea<span class="token punctuation">,</span> rootChunk<span class="token punctuation">,</span> sheet<span class="token punctuation">,</span> rootClass<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//处理字段数据</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> rootChunkFields <span class="token operator">=</span> filedGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rootChunk<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setFieldData</span><span class="token punctuation">(</span>rootArea<span class="token punctuation">,</span> rootChunkFields<span class="token punctuation">,</span> sheet<span class="token punctuation">,</span> rootClass<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置依赖根节点后面的节点数据</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> temp0 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//用于存放下一级需要遍历的数据，避免使用递归</span>        temp0<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rootChunk<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> temp1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> temp <span class="token operator">=</span> temp0<span class="token punctuation">;</span>        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>temp<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> dependChunk <span class="token operator">=</span> temp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>dependChunk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExcelChunk</span><span class="token punctuation">&gt;</span></span> chunks <span class="token operator">=</span> dependGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dependChunk<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>chunks <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ExcelChunk</span> e <span class="token operator">:</span> chunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token class-name">String</span> name <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            temp1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            temp0<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token comment">//处理该chunk的数据</span>                        <span class="token comment">//获取依赖的chunk，计算当前chunk的初始位置，并将边界放在chunkArea中</span>                        <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> area <span class="token operator">=</span> <span class="token function">initPosition</span><span class="token punctuation">(</span>dependChunk<span class="token punctuation">,</span> chunkArea<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">//处理固定数据</span>                        <span class="token function">setFixData</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> e<span class="token punctuation">,</span> sheet<span class="token punctuation">,</span> rootClass<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">//处理字段数据</span>                        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> chunkFields <span class="token operator">=</span> filedGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">setFieldData</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> chunkFields<span class="token punctuation">,</span> sheet<span class="token punctuation">,</span> rootClass<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment">//当执行到最后一条数据的时候，切换list</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span>temp<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                temp<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                temp <span class="token operator">=</span> flag<span class="token operator">?</span>temp1<span class="token operator">:</span>temp0<span class="token punctuation">;</span>                flag <span class="token operator">=</span> <span class="token operator">!</span>flag<span class="token punctuation">;</span>                i<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment">//quectel背景</span>        sheet<span class="token punctuation">.</span><span class="token function">setBackgroundImage</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token constant">BACKGROUND_IMG</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//找到整个sheet的最后行列边界</span>        <span class="token keyword">int</span> maxRow <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> maxCell <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> is<span class="token operator">:</span> chunkArea<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>is<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> maxRow<span class="token punctuation">)</span> <span class="token punctuation">{</span>                maxRow <span class="token operator">=</span> is<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>is<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> maxCell<span class="token punctuation">)</span> <span class="token punctuation">{</span>                maxCell <span class="token operator">=</span> is<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment">//调整行高</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>rootArea<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span>maxRow<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">//自适应行高</span>            sheet<span class="token punctuation">.</span><span class="token function">autoFitRow</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">double</span> rowHeight <span class="token operator">=</span> cells<span class="token punctuation">.</span><span class="token function">getRowHeight</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            cells<span class="token punctuation">.</span><span class="token function">setRowHeight</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>excelEntityAnno<span class="token punctuation">.</span><span class="token function">rowHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rowHeight<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>rootArea<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> j<span class="token operator">&lt;=</span>maxCell<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">Cell</span> cell <span class="token operator">=</span> cells<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//将在数据区没有样式的cell补充上通用样式</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>cell<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    cell<span class="token punctuation">.</span><span class="token function">setStyle</span><span class="token punctuation">(</span>sheet<span class="token punctuation">.</span><span class="token function">getWorkbook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNamedStyle</span><span class="token punctuation">(</span><span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">COMMON</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment">//锁定单元格</span>        <span class="token class-name">LockModeEnum</span> lock <span class="token operator">=</span> excelEntityAnno<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">StyleFlag</span> styleFlag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StyleFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        styleFlag<span class="token punctuation">.</span><span class="token function">setLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">LockModeEnum</span><span class="token punctuation">.</span><span class="token constant">ALL</span> <span class="token operator">==</span> lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>            sheet<span class="token punctuation">.</span><span class="token function">protect</span><span class="token punctuation">(</span><span class="token class-name">ProtectionType</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">LockModeEnum</span><span class="token punctuation">.</span><span class="token constant">EXCLUDE</span> <span class="token operator">==</span> lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strings <span class="token operator">=</span> excelEntityAnno<span class="token punctuation">.</span><span class="token function">lockExclude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">setLock</span><span class="token punctuation">(</span>cells<span class="token punctuation">,</span> strings<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> styleFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>            sheet<span class="token punctuation">.</span><span class="token function">protect</span><span class="token punctuation">(</span><span class="token class-name">ProtectionType</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">LockModeEnum</span><span class="token punctuation">.</span><span class="token constant">INCLUDE</span> <span class="token operator">==</span> lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strings <span class="token operator">=</span> excelEntityAnno<span class="token punctuation">.</span><span class="token function">lockInclude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">255</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">Style</span> style <span class="token operator">=</span> cells<span class="token punctuation">.</span><span class="token function">getColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                style<span class="token punctuation">.</span><span class="token function">setLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                cells<span class="token punctuation">.</span><span class="token function">getColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">applyStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> styleFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">setLock</span><span class="token punctuation">(</span>cells<span class="token punctuation">,</span> strings<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> styleFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>            sheet<span class="token punctuation">.</span><span class="token function">protect</span><span class="token punctuation">(</span><span class="token class-name">ProtectionType</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 获取所有的填充在excel中的字段     * @param obj     * @return map中两个key，field和dataObj     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllValueField</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Field</span> field<span class="token operator">:</span> fields<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">ExcelValues</span> excelValues <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">ExcelValues</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>excelValues <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">ExcelValue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> excelValues<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">ExcelValue</span> excelValue<span class="token operator">:</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">getExcelValueAnno</span><span class="token punctuation">(</span>excelValue<span class="token punctuation">,</span> field<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token class-name">ExcelValue</span> excelValue <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">ExcelValue</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">getExcelValueAnno</span><span class="token punctuation">(</span>excelValue<span class="token punctuation">,</span> field<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 设置单个excelValue注解     * @param excelValue     * @param field     * @param obj     * @param result     * @throws IllegalAccessException     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getExcelValueAnno</span><span class="token punctuation">(</span><span class="token class-name">ExcelValue</span> excelValue<span class="token punctuation">,</span> <span class="token class-name">Field</span> field<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>excelValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">//获取字段属性值</span>            field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Object</span> value <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">ValueTypeEnum</span><span class="token punctuation">.</span><span class="token constant">OBJ</span> <span class="token operator">==</span> excelValue<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token function">getAllValueField</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">ValueTypeEnum</span><span class="token punctuation">.</span><span class="token constant">VALUE</span> <span class="token operator">==</span> excelValue<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">KEY_FIELD</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span>                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">KEY_OBJ</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">KEY_EXCEL_VALUE</span><span class="token punctuation">,</span> excelValue<span class="token punctuation">)</span><span class="token punctuation">;</span>                result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 初始化块的位置,并将位置放在map中     * @param dependChunk 依赖块的名称     * @param chunkArea 块位置集合     * @param e 当前块配置     * @return     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">initPosition</span><span class="token punctuation">(</span><span class="token class-name">String</span> dependChunk<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> chunkArea<span class="token punctuation">,</span> <span class="token class-name">ExcelChunk</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> integers <span class="token operator">=</span> chunkArea<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dependChunk<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> beginX<span class="token punctuation">;</span>        <span class="token keyword">int</span> beginY<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">ShipEnum</span><span class="token punctuation">.</span><span class="token constant">RIGHT</span> <span class="token operator">==</span> e<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//相对位置在右边</span>            beginX <span class="token operator">=</span> integers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">offsetX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            beginY <span class="token operator">=</span> integers<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">offsetY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//默认相对位置在下面</span>            beginX <span class="token operator">=</span> integers<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">offsetX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            beginY <span class="token operator">=</span> integers<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">offsetY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> beginX<span class="token punctuation">;</span>        result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> beginY<span class="token punctuation">;</span>        result<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> beginX<span class="token punctuation">;</span>        result<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> beginY<span class="token punctuation">;</span>        <span class="token comment">//将数据放在map中</span>        chunkArea<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 设置固定数据，并且修改块区域位置     * @param area     * @param e     * @param sheet     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFixData</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> area<span class="token punctuation">,</span> <span class="token class-name">ExcelChunk</span> e<span class="token punctuation">,</span> <span class="token class-name">Worksheet</span> sheet<span class="token punctuation">,</span> <span class="token class-name">Class</span> rootClazz<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">{</span>        <span class="token comment">//获取固定单元格数据</span>        <span class="token class-name">ExcelValue</span><span class="token punctuation">[</span><span class="token punctuation">]</span> excelFixCellAnnos <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">fixCells</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">ExcelValue</span> excelFixCell<span class="token operator">:</span> excelFixCellAnnos<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">setExcelValue</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> excelFixCell<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> excelFixCell<span class="token punctuation">,</span> sheet<span class="token punctuation">,</span> rootClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 设置字段数据     * @param area 块区域数据     * @param chunkFields 字段     * @param sheet     * @throws IllegalAccessException     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldData</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> area<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> chunkFields<span class="token punctuation">,</span> <span class="token class-name">Worksheet</span> sheet<span class="token punctuation">,</span> <span class="token class-name">Class</span> rootClazz<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchFieldException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>chunkFields <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> chunkFields<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> fieldMap<span class="token operator">:</span> chunkFields<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">)</span> fieldMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">KEY_FIELD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">ExcelValue</span> excelValueAnno <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExcelValue</span><span class="token punctuation">)</span> fieldMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">KEY_EXCEL_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//获取字段属性值</span>                field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">Object</span> value <span class="token operator">=</span> fieldMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">KEY_OBJ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//如果是多层级取值</span>                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueKeys <span class="token operator">=</span> excelValueAnno<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>valueKeys<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>valueKeys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        value <span class="token operator">=</span> <span class="token function">getFiledValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> valueKeys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\."</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>valueKeys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token class-name">List</span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> vk<span class="token operator">:</span> valueKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>vk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            values<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getFiledValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> vk<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\."</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            values<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vk<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                    value <span class="token operator">=</span> values<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token function">setExcelValue</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> value<span class="token punctuation">,</span> excelValueAnno<span class="token punctuation">,</span> sheet<span class="token punctuation">,</span> rootClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 递归获取字段的数据     * @param dataObj     * @param keys     * @param index     * @return     * @throws IllegalAccessException     * @throws NoSuchFieldException     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getFiledValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> dataObj<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keys<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchFieldException</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>dataObj <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> dataObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keys<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>keys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> index<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> o <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果还需要取下级</span>                <span class="token keyword">return</span> <span class="token function">getFiledValue</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> o<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>dataObj <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">||</span> dataObj <span class="token keyword">instanceof</span> <span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果是集合，需要取集合内的数据</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>dataObj <span class="token keyword">instanceof</span> <span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                dataObj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> dataObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token class-name">List</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> dataObj<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//循环获取集合中的数据</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>keys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> index<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> o <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果还需要取下级</span>                    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getFiledValue</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//递归获取数据</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token class-name">Field</span> field <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>keys<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//获取字段属性值</span>                    field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token class-name">Object</span> value <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>                    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> result<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//如果是对象</span>            <span class="token class-name">Field</span> field <span class="token operator">=</span> dataObj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>keys<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//获取字段属性值</span>            field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Object</span> value <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dataObj<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>keys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> index<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果还需要取下级</span>                <span class="token keyword">return</span> <span class="token function">getFiledValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> value<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 在excel中设置数据     * @param area 区域     * @param value 数据     * @param excelValueAnno 配置     * @param sheet excel     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setExcelValue</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> area<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">ExcelValue</span> excelValueAnno<span class="token punctuation">,</span> <span class="token class-name">Worksheet</span> sheet<span class="token punctuation">,</span> <span class="token class-name">Class</span> rootClazz<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">{</span>        <span class="token comment">//获取数据填充的起始位置</span>        <span class="token keyword">int</span> x <span class="token operator">=</span> excelValueAnno<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> y <span class="token operator">=</span> excelValueAnno<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> realX <span class="token operator">=</span> area<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">;</span> <span class="token comment">//excel中的真实坐标</span>        <span class="token keyword">int</span> realY <span class="token operator">=</span> area<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> y<span class="token punctuation">;</span> <span class="token comment">//excel中的真实坐标</span>        <span class="token keyword">int</span> stepX <span class="token operator">=</span> excelValueAnno<span class="token punctuation">.</span><span class="token function">xNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//添加单个数据时的X步进</span>        <span class="token keyword">int</span> stepY <span class="token operator">=</span> excelValueAnno<span class="token punctuation">.</span><span class="token function">yNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//添加单个数据时的Y步进</span>        <span class="token comment">//自定义处理方法</span>        <span class="token class-name">Method</span> handlerMethod <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> handler <span class="token operator">=</span> excelValueAnno<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            handlerMethod <span class="token operator">=</span> rootClazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Worksheet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Cell</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Collection</span> <span class="token operator">||</span> value <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> value<span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>values <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> values<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">//获取填充方向</span>                <span class="token class-name">DirectionEnum</span> direction <span class="token operator">=</span> excelValueAnno<span class="token punctuation">.</span><span class="token function">direction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>direction <span class="token operator">==</span> <span class="token class-name">DirectionEnum</span><span class="token punctuation">.</span><span class="token constant">RIGHT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//向右填充</span>                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>j<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            realY<span class="token operator">+=</span>stepY<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token function">setCellValue</span><span class="token punctuation">(</span>sheet<span class="token punctuation">,</span> excelValueAnno<span class="token punctuation">.</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> values<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> realX<span class="token punctuation">,</span> realY<span class="token punctuation">,</span> stepX<span class="token punctuation">,</span> stepY<span class="token punctuation">,</span> handlerMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token comment">//计算边界位置</span>                    realY<span class="token operator">+=</span><span class="token punctuation">(</span>stepY<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    realX<span class="token operator">+=</span><span class="token punctuation">(</span>stepX<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//默认向下填充</span>                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>j<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            realX<span class="token operator">+=</span>stepX<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token function">setCellValue</span><span class="token punctuation">(</span>sheet<span class="token punctuation">,</span> excelValueAnno<span class="token punctuation">.</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> values<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> realX<span class="token punctuation">,</span> realY<span class="token punctuation">,</span> stepX<span class="token punctuation">,</span> stepY<span class="token punctuation">,</span> handlerMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    realX<span class="token operator">+=</span><span class="token punctuation">(</span>stepX<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    realY<span class="token operator">+=</span><span class="token punctuation">(</span>stepY<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">setCellValue</span><span class="token punctuation">(</span>sheet<span class="token punctuation">,</span> excelValueAnno<span class="token punctuation">.</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> realX<span class="token punctuation">,</span> realY<span class="token punctuation">,</span> stepX<span class="token punctuation">,</span> stepY<span class="token punctuation">,</span> handlerMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>            realX <span class="token operator">=</span> realX<span class="token operator">+</span>stepX<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            realY <span class="token operator">=</span> realY<span class="token operator">+</span>stepY<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">//更新area最大位置记录</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>realX <span class="token operator">&gt;</span> area<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            area<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> realX<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>realY <span class="token operator">&gt;</span> area<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            area<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> realY<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 设置单元格     * @param sheet     * @param style     * @param o     * @param realX     * @param realY     * @param stepX     * @param stepY     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token class-name">Worksheet</span> sheet<span class="token punctuation">,</span> <span class="token class-name">StyleEnum</span> style<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">int</span> realX<span class="token punctuation">,</span> <span class="token keyword">int</span> realY<span class="token punctuation">,</span> <span class="token keyword">int</span> stepX<span class="token punctuation">,</span> <span class="token keyword">int</span> stepY<span class="token punctuation">,</span> <span class="token class-name">Method</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">{</span>        <span class="token class-name">Cells</span> cells <span class="token operator">=</span> sheet<span class="token punctuation">.</span><span class="token function">getCells</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Cell</span> cell <span class="token operator">=</span> cells<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>realX<span class="token punctuation">,</span> realY<span class="token punctuation">)</span><span class="token punctuation">;</span>        cell<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>        cell<span class="token punctuation">.</span><span class="token function">setStyle</span><span class="token punctuation">(</span>sheet<span class="token punctuation">.</span><span class="token function">getWorkbook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNamedStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//自定义处理方法执行</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">//执行自定义代码静态方法</span>            handler<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> o<span class="token punctuation">,</span> sheet<span class="token punctuation">,</span> cell<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>stepX<span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">||</span>stepY<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    cells<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>realX<span class="token punctuation">,</span> realY<span class="token punctuation">,</span> stepX<span class="token punctuation">,</span> stepY<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"合并单元格冲突..."</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 设置单元格锁     * @param cells     * @param strings     * @param lockFlag     * @param styleFlag     */</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setLock</span><span class="token punctuation">(</span><span class="token class-name">Cells</span> cells<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strings<span class="token punctuation">,</span> <span class="token keyword">boolean</span> lockFlag<span class="token punctuation">,</span> <span class="token class-name">StyleFlag</span> styleFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Style</span> style<span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token operator">:</span> strings<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>split<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//整行，或者整列</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"R"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//整行</span>                    <span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    style <span class="token operator">=</span> cells<span class="token punctuation">.</span><span class="token function">getRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    style<span class="token punctuation">.</span><span class="token function">setLocked</span><span class="token punctuation">(</span>lockFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>                    cells<span class="token punctuation">.</span><span class="token function">getRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">applyStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> styleFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token class-name">Style</span> style1 <span class="token operator">=</span> cells<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        style1<span class="token punctuation">.</span><span class="token function">setLocked</span><span class="token punctuation">(</span><span class="token operator">!</span>lockFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>                        cells<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStyle</span><span class="token punctuation">(</span>style1<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//整列</span>                    <span class="token keyword">int</span> cell <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    style <span class="token operator">=</span> cells<span class="token punctuation">.</span><span class="token function">getColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    style<span class="token punctuation">.</span><span class="token function">setLocked</span><span class="token punctuation">(</span>lockFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>                    cells<span class="token punctuation">.</span><span class="token function">getColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">applyStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> styleFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token class-name">Style</span> style1 <span class="token operator">=</span> cells<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> cell<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        style1<span class="token punctuation">.</span><span class="token function">setLocked</span><span class="token punctuation">(</span><span class="token operator">!</span>lockFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>                        cells<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> cell<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStyle</span><span class="token punctuation">(</span>style1<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>split<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//范围</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">&lt;=</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        style <span class="token operator">=</span> cells<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        style<span class="token punctuation">.</span><span class="token function">setLocked</span><span class="token punctuation">(</span>lockFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>                        cells<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul><li>Zzz</li><li>FormItemInfoVo</li><li>StandardProduct</li><li>ConfigParam</li></ul><h3 id="Zzz"><a href="#Zzz" class="headerlink" title="Zzz"></a>Zzz</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * @author iseven.yang * @date 2021/12/20 17:15 */</span><span class="token annotation punctuation">@ExcelEntity</span><span class="token punctuation">(</span>lock <span class="token operator">=</span> <span class="token class-name">LockModeEnum</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">,</span> cellsWidth <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        chunks <span class="token operator">=</span> <span class="token annotation punctuation">@ExcelChunk</span><span class="token punctuation">(</span>offsetY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> fixCells <span class="token operator">=</span> <span class="token punctuation">{</span>                <span class="token annotation punctuation">@ExcelValue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"Product Definition"</span><span class="token punctuation">,</span> yNum <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> style <span class="token operator">=</span> <span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">TITLE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token annotation punctuation">@ExcelValue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"基本信息"</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> yNum <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> style <span class="token operator">=</span> <span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">MODULE_TITLE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token annotation punctuation">@ExcelValue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"产品线"</span><span class="token punctuation">,</span> <span class="token string">"产品类别"</span><span class="token punctuation">,</span> <span class="token string">"产品级别"</span><span class="token punctuation">,</span> <span class="token string">"芯片厂商"</span><span class="token punctuation">,</span> <span class="token string">"封装方式"</span><span class="token punctuation">,</span> <span class="token string">"应用行业"</span><span class="token punctuation">,</span> <span class="token string">"Share Level"</span><span class="token punctuation">,</span> <span class="token string">"计划认证"</span><span class="token punctuation">,</span> <span class="token string">"产品经理"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> style <span class="token operator">=</span> <span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">KEY</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token annotation punctuation">@ExcelValue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"产品名称"</span><span class="token punctuation">,</span> <span class="token string">"产品等级"</span><span class="token punctuation">,</span> <span class="token string">"芯片平台"</span><span class="token punctuation">,</span> <span class="token string">"Flash大小"</span><span class="token punctuation">,</span> <span class="token string">"客户"</span><span class="token punctuation">,</span> <span class="token string">"目标市场区域"</span><span class="token punctuation">,</span> <span class="token string">"竞争对手"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"销售负责人"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> style <span class="token operator">=</span> <span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">KEY</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Zzz</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@ExcelValue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"productClassification.code"</span><span class="token punctuation">,</span> <span class="token string">"competitors"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">StandardProduct</span> standardProduct <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@ExcelValues</span><span class="token punctuation">(</span>values <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@ExcelValue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"formItemName"</span><span class="token punctuation">,</span> x <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">,</span> style <span class="token operator">=</span> <span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">KEY</span><span class="token punctuation">,</span> handler <span class="token operator">=</span> <span class="token string">"handler"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token annotation punctuation">@ExcelValue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"formItemName"</span><span class="token punctuation">,</span> x <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span> style <span class="token operator">=</span> <span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">KEY</span><span class="token punctuation">,</span> handler <span class="token operator">=</span> <span class="token string">"handler"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FormItemInfoVo</span><span class="token punctuation">&gt;</span></span> formItemInfoVos<span class="token punctuation">;</span>    <span class="token annotation punctuation">@ExcelValue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"answerResource"</span><span class="token punctuation">,</span> x <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> yNum <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> style <span class="token operator">=</span> <span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">KEY</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FormItemInfoVo</span><span class="token punctuation">&gt;</span></span> fi<span class="token punctuation">;</span>    <span class="token punctuation">{</span>        formItemInfoVos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">FormItemInfoVo</span> formItemInfoVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormItemInfoVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        formItemInfoVo<span class="token punctuation">.</span><span class="token function">setFormItemName</span><span class="token punctuation">(</span><span class="token string">"aaaaa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">FormItemInfoVo</span> formItemInfoVo2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormItemInfoVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">FormItemInfoVo</span> formItemInfoVo3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormItemInfoVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">FormItemInfoVo</span> formItemInfoVo4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormItemInfoVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        formItemInfoVo4<span class="token punctuation">.</span><span class="token function">setFormItemName</span><span class="token punctuation">(</span><span class="token string">"bbbbb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">FormItemInfoVo</span> formItemInfoVo5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormItemInfoVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        formItemInfoVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>formItemInfoVo<span class="token punctuation">)</span><span class="token punctuation">;</span>        formItemInfoVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>formItemInfoVo2<span class="token punctuation">)</span><span class="token punctuation">;</span>        formItemInfoVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>formItemInfoVo3<span class="token punctuation">)</span><span class="token punctuation">;</span>        formItemInfoVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>formItemInfoVo4<span class="token punctuation">)</span><span class="token punctuation">;</span>        formItemInfoVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>formItemInfoVo5<span class="token punctuation">)</span><span class="token punctuation">;</span>        fi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fi<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>formItemInfoVos<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">Worksheet</span> worksheet<span class="token punctuation">,</span> <span class="token class-name">Cell</span> cell<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"aaaaa"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"bbbbb"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>worksheet<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> row <span class="token operator">=</span> cell<span class="token punctuation">.</span><span class="token function">getRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> column <span class="token operator">=</span> cell<span class="token punctuation">.</span><span class="token function">getColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            cell<span class="token punctuation">.</span><span class="token function">setStyle</span><span class="token punctuation">(</span>worksheet<span class="token punctuation">.</span><span class="token function">getWorkbook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNamedStyle</span><span class="token punctuation">(</span><span class="token class-name">StyleEnum</span><span class="token punctuation">.</span><span class="token constant">MODULE_TITLE</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            worksheet<span class="token punctuation">.</span><span class="token function">getCells</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> column<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="FormItemInfoVo"><a href="#FormItemInfoVo" class="headerlink" title="FormItemInfoVo"></a>FormItemInfoVo</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FormItemInfoVo</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> attributeId<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> formItemName <span class="token operator">=</span> <span class="token string">"klaskljkwwwwwwwwwwwwwwwwwww cwwwwwwwww擦啊啊啊啊啊啊啊啊啊啊啊啊啊啊"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> formItemEnName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> answerResource <span class="token operator">=</span> <span class="token string">"wowowowo"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="StandardProduct"><a href="#StandardProduct" class="headerlink" title="StandardProduct"></a>StandardProduct</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StandardProduct</span> <span class="token punctuation">{</span><span class="token keyword">private</span> <span class="token class-name">ConfigParam</span> productClassification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> competitors <span class="token operator">=</span> <span class="token string">"竞争对手ccc"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ConfigParam"><a href="#ConfigParam" class="headerlink" title="ConfigParam"></a>ConfigParam</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigParam</span> <span class="token punctuation">{</span><span class="token keyword">private</span> <span class="token class-name">String</span> id <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token string">"xxxxx"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="导出效果"><a href="#导出效果" class="headerlink" title="导出效果"></a>导出效果</h2><p><img src="/images/Aspose-Excel/image-20211222100222737.png" alt="image-20211222100222737"></p>]]></content>
      
      
      <categories>
          
          <category> Util </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Aspose </tag>
            
            <tag> Excel </tag>
            
            <tag> Util </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka-命令</title>
      <link href="/kafka/kafka-ming-ling/"/>
      <url>/kafka/kafka-ming-ling/</url>
      
        <content type="html"><![CDATA[<h2 id="kafka创建"><a href="#kafka创建" class="headerlink" title="kafka创建"></a>kafka创建</h2><h3 id="安装zookeeper"><a href="#安装zookeeper" class="headerlink" title="安装zookeeper"></a>安装zookeeper</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--name</span> zookeeper <span class="token parameter variable">-p</span> <span class="token number">2181</span>:2181 <span class="token parameter variable">-d</span> zookeeper<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="安装kafka"><a href="#安装kafka" class="headerlink" title="安装kafka"></a>安装kafka</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--name</span> kafka <span class="token parameter variable">-p</span> <span class="token number">9092</span>:9092 <span class="token parameter variable">-e</span> <span class="token assign-left variable">KAFKA_BROKER_ID</span><span class="token operator">=</span><span class="token number">0</span> <span class="token parameter variable">-e</span> <span class="token assign-left variable">KAFKA_ZOOKEEPER_CONNECT</span><span class="token operator">=</span><span class="token number">10.66</span>.106.86:2181 <span class="token parameter variable">-e</span> <span class="token assign-left variable">ALLOW_PLAINTEXT_LISTENER</span><span class="token operator">=</span>yes <span class="token parameter variable">-e</span> <span class="token assign-left variable">KAFKA_ADVERTISED_LISTENERS</span><span class="token operator">=</span>PLAINTEXT://10.66.106.86:9092 <span class="token parameter variable">-e</span> <span class="token assign-left variable">KAFKA_LISTENERS</span><span class="token operator">=</span>PLAINTEXT://0.0.0.0:9092 <span class="token parameter variable">-v</span> C:<span class="token punctuation">\</span>dockerData<span class="token punctuation">\</span>kafka<span class="token punctuation">\</span>data:/bitnami/kafka/data <span class="token parameter variable">-d</span> bitnami/kafka:3.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="进入kafka容器"><a href="#进入kafka容器" class="headerlink" title="进入kafka容器"></a>进入kafka容器</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> kafka <span class="token function">bash</span><span class="token builtin class-name">cd</span> opt/bitnami/kafka/bin/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="Topic相关"><a href="#Topic相关" class="headerlink" title="Topic相关"></a>Topic相关</h2><h3 id="查看topic"><a href="#查看topic" class="headerlink" title="查看topic"></a>查看topic</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-topics.sh <span class="token parameter variable">--list</span> --bootstrap-server <span class="token number">10.66</span>.106.86:9092<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="创建topic"><a href="#创建topic" class="headerlink" title="创建topic"></a>创建topic</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-topics.sh <span class="token parameter variable">--create</span> --bootstrap-server <span class="token number">10.66</span>.106.86:9092 --replication-factor <span class="token number">1</span> <span class="token parameter variable">--partitions</span> <span class="token number">2</span> <span class="token parameter variable">--topic</span> aacopy-topic<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="删除topic"><a href="#删除topic" class="headerlink" title="删除topic"></a>删除topic</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-topics.sh <span class="token parameter variable">--delete</span> --bootstrap-server <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--topic</span> aacopy-topic有问题，会报错ERROR Shutdown broker because all log <span class="token function">dirs</span> <span class="token keyword">in</span> /bitnami/kafka/data have failed <span class="token punctuation">(</span>kafka.log.LogManager<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="插入消息"><a href="#插入消息" class="headerlink" title="插入消息"></a>插入消息</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-producer-perf-test.sh <span class="token parameter variable">--topic</span> aacopy-log-test --num-records <span class="token number">10000</span> --record-size <span class="token number">100</span> <span class="token parameter variable">--throughput</span> <span class="token parameter variable">-1</span> --producer-props <span class="token assign-left variable">bootstrap.servers</span><span class="token operator">=</span><span class="token number">10.66</span>.106.86:9092<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="segment"><a href="#segment" class="headerlink" title="segment"></a>segment</h2><h3 id="查看segment-index-Dump"><a href="#查看segment-index-Dump" class="headerlink" title="查看segment index Dump"></a>查看segment index Dump</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-run-class.sh kafka.tools.DumpLogSegments <span class="token parameter variable">--files</span> /bitnami/kafka/data/aacopy-log-test-0/00000000000000000000.index --print-data-log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="查看segment-log-Dump"><a href="#查看segment-log-Dump" class="headerlink" title="查看segment log Dump"></a>查看segment log Dump</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-run-class.sh kafka.tools.DumpLogSegments <span class="token parameter variable">--files</span> /bitnami/kafka/data/aacopy-log-test-0/00000000000000000000.log --print-data-log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka-文件存储机制</title>
      <link href="/kafka/kafka-wen-jian-cun-chu-ji-zhi/"/>
      <url>/kafka/kafka-wen-jian-cun-chu-ji-zhi/</url>
      
        <content type="html"><![CDATA[<ul><li><p>一个Kafka集群有多个broker</p></li><li><p>一个kafka节点就是一个broker，broker包含多个topic</p></li><li><p>一个topic中分为多个partition，每个partition是一个有序的队列，是topic物理上的分组</p></li><li><p>一个partition分为多个segment</p><p><img src="/images/Kafka-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6/kafka%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8.png"></p></li></ul><h2 id="文件存储位置"><a href="#文件存储位置" class="headerlink" title="文件存储位置"></a>文件存储位置</h2><p>在kafka的配置文件中，有一个server.properties配置文件，配置项log.dirs可以配置或查看数据文件存储位置</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment"># A comma separated list of directories under which to store log files</span><span class="token key attr-name">log.dirs</span><span class="token punctuation">=</span><span class="token value attr-value">/bitnami/kafka/data</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>查看文件存储目录</p><p><img src="/images/Kafka-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6/image-20211214083650998.png"></p><p>同一个topic有多个不同的partition，命名：topic名+序号，序号从0开始，例如aacopy-topic，有两个partition，aacopy-topic-0和aacopy-topic-1。</p><ul><li><p>为什么一个topic对应多个partition</p><p>如果只有一个partition，就限定了topic只能在一个服务器节点上使用，没办法扩展肯定存在性能瓶颈</p></li></ul><h2 id="文件说明"><a href="#文件说明" class="headerlink" title="文件说明"></a>文件说明</h2><h2 id="partition中的segment"><a href="#partition中的segment" class="headerlink" title="partition中的segment"></a>partition中的segment</h2><h3 id="存储结构"><a href="#存储结构" class="headerlink" title="存储结构"></a>存储结构</h3><p><img src="/images/Kafka-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6/image-20211214090427777.png"></p><ul><li><p>segment file组成：由2大部分组成，分别为index file和data file，此2个文件一一对应，成对出现，后缀”.index”和“.log”分别表示为segment索引文件、数据文件.</p></li><li><p>segment文件命名规则：partion全局的第一个segment从0开始，后续每个segment文件名为上一个segment文件最后一条消息的offset值+1。数值最大为64位long大小，20位数字字符长度，没有数字用0填充。</p></li><li><p>index索引文件，包含两个值，offset（消息唯一标识）和position（消息存储在log中的物理地址）</p><p>index文件中的offset并不是连续的，是因为index不是为每条消息都建立索引，而是采用稀疏索引的方式，每隔一段建立索引，间隔大小通过配置log.index.interval.bytes查看，默认4KB，稀疏索引可以使内存中存放更多的索引数据。</p></li><li><p>消息查找过程</p><ul><li>因为offset是连续的，只需要使用二分法很快找到要找的offset在哪个文件里，再次通过二分查找就能找到索引文件中的位置，因为是稀疏索引有可能并不能直接命中，需要再次遍历就能找到offset对应的物理位置，此时需要遍历的范围也很小。</li><li>在二分查找索引的时候，标准的二分查找对缓存不友好，可能会造成不必要的缺页中断(线程被阻塞等待从磁盘加载没有被缓存到page cache 的数据)，至少会产生从几毫秒跳到1秒的延迟。Kafka通过将索引项分为热区和冷区，查询热数据部分时，遍历的Page永远是固定的，这样避免缺页中断</li></ul></li><li><p>Kafka中有三大类索引：位移索引、时间戳索引和已中止事务索引。分别是.index、.timeindex、.txnindex文件。</p></li><li><p>为什么segment会被分为多个文件</p><p>为了方便删除历史数据，节约空间，如果在一个文件里，一边写，一边清理前面的历史数据效率很低</p></li></ul><h3 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h3><ol><li><p>创建一个新的topic，设置1个partition，限制segment文件的大小</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-topics.sh <span class="token parameter variable">--create</span> --bootstrap-server <span class="token number">10.66</span>.106.86:9092 --replication-factor <span class="token number">1</span> <span class="token parameter variable">--partitions</span> <span class="token number">1</span> <span class="token parameter variable">--config</span> <span class="token assign-left variable">segment.bytes</span><span class="token operator">=</span><span class="token number">1024000</span> <span class="token parameter variable">--config</span> <span class="token assign-left variable">segment.index.bytes</span><span class="token operator">=</span><span class="token number">512000</span> <span class="token parameter variable">--topic</span> aacopy-log-test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>使用命令或者编写代码向topic中插入大量数据</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-producer-perf-test.sh <span class="token parameter variable">--topic</span> aacopy-log-test --num-records <span class="token number">10000</span> --record-size <span class="token number">100</span> <span class="token parameter variable">--throughput</span> <span class="token parameter variable">-1</span> --producer-props <span class="token assign-left variable">bootstrap.servers</span><span class="token operator">=</span><span class="token number">10.66</span>.106.86:9092<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>查看index文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> <span class="token parameter variable">-l</span> /bitnami/kafka/data/aacopy-log-test-0/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/images/Kafka-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6/image-20211214154556787.png"></p></li><li><p>查看segment index Dump</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-run-class.sh kafka.tools.DumpLogSegments <span class="token parameter variable">--files</span> /bitnami/kafka/data/aacopy-log-test-0/00000000000000000000.index --print-data-log./kafka-run-class.sh kafka.tools.DumpLogSegments <span class="token parameter variable">--files</span> /bitnami/kafka/data/aacopy-log-test-0/00000000000000009261.index --print-data-log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/images/Kafka-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6/image-20211214154455665.png"></p></li><li><p>查看segment log Dump</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-run-class.sh kafka.tools.DumpLogSegments <span class="token parameter variable">--files</span> /bitnami/kafka/data/aacopy-log-test-0/00000000000000000000.log --print-data-log./kafka-run-class.sh kafka.tools.DumpLogSegments <span class="token parameter variable">--files</span> /bitnami/kafka/data/aacopy-log-test-0/00000000000000009261.log --print-data-log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/images/Kafka-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6/image-20211214155428442.png"></p></li><li><p>编写代码自己插入两条随机double数据</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initLargeAmountMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           template<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">}</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/Kafka-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6/image-20211214155802944.png"></p></li><li><p>log文件中的第一条消息的offset，和文件名的的编号是一致的</p><p><img src="/images/Kafka-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6/image-20211215091613046.png"></p></li></ol><h2 id="消息数据清理"><a href="#消息数据清理" class="headerlink" title="消息数据清理"></a>消息数据清理</h2><p>kafka会启动一个定时任务，定时监测要删除的日志文件，通过log.retention.check.interval.ms进行配置时间间隔，默认5分钟执行一次。通过log.cleaner.threads配置执行清理任务的线程数</p><p>日志删除策略（log.cleanup.policy）</p><ul><li><p>直接删除，log.cleanup.policy=delete</p><ul><li><p>超过指定时间后删除</p><p>log.retention.hours=168，默认168小时（7天） </p><p>每个segment都会维护一个写入消息的时间戳，当当前segment写满后就不再更新时间戳，kafka根据当前时间和时间戳的差确定是否要删除该segment</p></li><li><p>超过指定文件大小后删除</p><p>log.retention.bytes=1073741824，超过1G后删除</p><p>当已经写满的日志文件总大小大于设置的阀值时，执行删除</p></li></ul></li><li><p>日志压缩，log.cleanup.policy=compact</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Netty-SpringBoot</title>
      <link href="/netty/netty-springboot/"/>
      <url>/netty/netty-springboot/</url>
      
        <content type="html"><![CDATA[<p>git地址：<a href="https://gitee.com/aacopy/netty-learn.git">https://gitee.com/aacopy/netty-learn.git</a></p><ol><li><p>创建一个springboot项目</p></li><li><p>添加maven依赖</p></li></ol><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.netty<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>netty-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>编写消息处理的自定义handler</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ChannelGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelGroup</span><span class="token punctuation">(</span><span class="token class-name">GlobalEventExecutor</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> msg <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"已上线, channel："</span> <span class="token operator">+</span> <span class="token punctuation">(</span>group<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        group<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        group<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelInactive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> msg <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"已下线, channel："</span> <span class="token operator">+</span> group<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        group<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> message <span class="token operator">=</span>channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>        group<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>编写netty服务端</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServer</span> <span class="token punctuation">{</span>    <span class="token comment">//NIO线程组</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        <span class="token class-name">ServerBootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// 添加一个基于行的解码器</span>                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LineBasedFrameDecoder</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Netty Server start..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> future<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Netty Server destroy..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>springboot容器启动 启动与关闭netty服务端</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyLearnApplication</span> <span class="token keyword">implements</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">NettyLearnApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">NettyServer</span> nettyServer<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> nettyServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> nettyServer<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="6"><li>服务端编写完成</li><li>编写netty客户端自定义消息处理handler</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到消息："</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="8"><li>编写netty客户端</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyClient</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                        <span class="token class-name">ChannelPipeline</span> channelPipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        channelPipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LineBasedFrameDecoder</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        channelPipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        channelPipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        channelPipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SocketAddress</span> remoteAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">,</span>  <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="9"><li><p>测试，启动springboot服务，并且启动3个NettyClient，idea中，多次启动需要打开Allow multiple instances</p><img src="/images/Netty-SpringBoot/image-20211208132604946.png" alt="image-20211208132604946" style="zoom: 80%;"></li></ol><p>服务端打印</p><p><img src="/images/Netty-SpringBoot/image-20211208132727512.png"></p><p>客户端</p><p><img src="/images/Netty-SpringBoot/image-20211208132758543.png"></p><ol start="10"><li>在其中一个客户端中输入消息，可以看到在其他客户端能够接收到消息</li></ol><p><img src="/images/Netty-SpringBoot/image-20211208133004534.png"></p><p><img src="/images/Netty-SpringBoot/image-20211208133018288.png"></p><p><img src="/images/Netty-SpringBoot/image-20211208133043512.png"></p><p>另外一种方式：</p><p>第4步和第5步不执行，执行如下操作，使用@PostConstruct和@PreDestroy注解使netty服务随容器一起启动关闭</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServer</span> <span class="token punctuation">{</span>    <span class="token comment">//NIO线程组</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@PostConstruct</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        <span class="token class-name">ServerBootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// 添加一个基于行的解码器</span>                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LineBasedFrameDecoder</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Netty Server start..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@PreDestroy</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Netty Server destroy..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Netty </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Netty-HelloWorld</title>
      <link href="/netty/netty-helloworld/"/>
      <url>/netty/netty-helloworld/</url>
      
        <content type="html"><![CDATA[<p>Netty是由JBOSS提供的一个java开源框架，现为 Github上的独立项目。Netty提供异步的、事件驱动的网络应用程序框架和工具，用以快速开发高性能、高可靠性的网络服务器和客户端程序。</p><p>官方网站：<a href="https://netty.io/">https://netty.io/</a></p><p>Netty主要针对在TCP协议下，面向Clients端的高并发应用，或者Peer to Peer场景下的大量数据持续传输的应用</p><p>Netty本质上是一个NIO框架</p><p><img src="/images/Netty-HelloWorld/image-20220623080925391.png"></p><ul><li>应用场景<ul><li>服务间的通讯，比如RPC框架Dubbo</li><li>大数据领域</li></ul></li></ul><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><p>Channel可以看作是传入或者传出数据的载体.可以打开关闭,连接或者断开连接.</p><h3 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h3><p>Netty使用回调来处理事件,当一个回调被触发时,相关的事件会被一个ChannelHandler接口的实现处理,例如:当有新的连接创建时,ChannelHandler的channelActivce()方法会被调用</p><h3 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h3><p>ChannelFuture提供了额外方法可以注册一个或多个ChannelFutureListener实例.operationComplete方法在操作完成时被调用</p><ul><li>每个Netty的出站I/O都会返回一个ChannelFuture</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//异步连接</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>注册ChannelFutureListener示例</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      channelFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>              <span class="token comment">//如果连接成功</span>              <span class="token keyword">if</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                  future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                  <span class="token comment">//失败打印异常</span>                  <span class="token class-name">Throwable</span> throwable <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  throwable<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="事件和ChannelHandler"><a href="#事件和ChannelHandler" class="headerlink" title="事件和ChannelHandler"></a>事件和ChannelHandler</h3><p>事件是按照入站出站数据流的相关性进行分类的，每个事件都可以被分发给ChannelHandler的实现类</p><ul><li>入站事件<ul><li>连接已被激活或者连接失活</li><li>数据读取</li><li>用户事件</li><li>错误事件</li></ul></li><li>出站事件<ul><li>打开或关闭连接</li><li>数据写入</li></ul></li></ul><h2 id="编码入门：Echo"><a href="#编码入门：Echo" class="headerlink" title="编码入门：Echo"></a>编码入门：Echo</h2><p>Echo客户端和服务端之间的交互：客户端和服务端建立连接后，客户端向服务端发送消息，服务端返回给客户端相同的消息</p><h3 id="服务端："><a href="#服务端：" class="headerlink" title="服务端："></a>服务端：</h3><ol><li>编写ChannelHandler，用于处理从客户端接收到的消息，实现业务逻辑</li><li>引导类配置<ol><li>绑定到服务器将监听并接受传入连接请求的端口</li><li>配置Channel，将入站消息通知给对应的Handler</li></ol></li></ol><h4 id="消息处理类"><a href="#消息处理类" class="headerlink" title="消息处理类"></a>消息处理类</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//Sharable标记一个ChannelHandler可以被多个Channel安全的共享，</span><span class="token comment">//如果未指定此注释，则每次将其添加到管道时都必须创建一个新的处理程序实例，因为它具有非共享状态，例如成员变量</span><span class="token annotation punctuation">@ChannelHandler.Sharable</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>    <span class="token comment">//对于每个传入的消息都会调用</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">ByteBuf</span> byteBuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"服务端收到消息："</span> <span class="token operator">+</span> byteBuf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//将接收到的消息写给发送者，而不冲刷出站消息</span>        ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">//读取到当前批量读取中的最后一条消息时调用</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//将消息冲刷到远程节点，并关闭该Channel</span>        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token constant">EMPTY_BUFFER</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span><span class="token constant">CLOSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">//在读取时有异常会被调用</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//打印异常信息</span>        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//关闭Channel</span>        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="服务端引导类"><a href="#服务端引导类" class="headerlink" title="服务端引导类"></a>服务端引导类</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServerTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//创建一个Event-LoopGroup，使用NIO传输，所以指定NioEventLoopGroup来接收和处理新的连接</span>        <span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment">//创建ServerBootstrap，创建一个服务端引导类</span>            <span class="token class-name">ServerBootstrap</span> serverBootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            serverBootstrap                    <span class="token comment">//指定线程组</span>                    <span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>                    <span class="token comment">//指定使用NIO传输Channel</span>                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                    <span class="token comment">//指定服务端的地址端口</span>                    <span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token comment">//添加ChannelHandler到pipeline</span>                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                            ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//异步绑定服务器，调用sync()方法阻塞等待直到完成绑定</span>            <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> serverBootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"服务端启动成功..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//关闭Channel，通讯时，线程会在这等待，直到完成关闭</span>            channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"服务端已关闭..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程资源已释放..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="客户端："><a href="#客户端：" class="headerlink" title="客户端："></a>客户端：</h3><ul><li>连接服务端</li><li>发送消息</li><li>接收服务端回执的消息</li><li>关闭连接’</li></ul><h4 id="消息处理类-1"><a href="#消息处理类-1" class="headerlink" title="消息处理类"></a>消息处理类</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ChannelHandler.Sharable</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuf</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token comment">//当Channel活跃时被调用</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token comment">//发送消息给服务端</span>        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span><span class="token string">"Hello aacopy"</span><span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">//当有消息时触发</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户端接收到消息："</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="客户端引导类"><a href="#客户端引导类" class="headerlink" title="客户端引导类"></a>客户端引导类</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyClientTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment">//创建客户端引导类</span>            <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//设置线程池</span>            bootstrap                    <span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>                    <span class="token comment">//设置Channel传输类型为NIO</span>                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                    <span class="token comment">//设置远程服务端地址</span>                    <span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token comment">//设置消息处理类</span>                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token annotation punctuation">@Override</span>                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>                            ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EchoClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户端与服务端已连接成功..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户端已关闭..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment">//关闭线程池，释放资源</span>            group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户端资源已释放..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h3><ul><li><p>服务端</p><pre class="line-numbers language-none"><code class="language-none">服务端启动成功...服务端收到消息：Hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>客户端</p><pre class="line-numbers language-none"><code class="language-none">客户端与服务端已连接成功...客户端接收到消息：Hello客户端已关闭...客户端资源已释放...进程已结束,退出代码0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ChannelInboundHandlerAdapter和SimpleChannelInboundHandler的区别</p><blockquote><p>在服务端用的ChannelInboundHandlerAdapter，而在客户端用的SimpleChannelInboundHandler，主要时处理消息时的实现方式不一样。</p><p>在客户端，channelRead0方法完成后，SimpleChannelInboundHandler方法会把包含该消息的ByteBuf的引用从内存中释放掉。</p><p>在服务端，需要将接收到的消息，通过write方法异步的发送，在channelRead方法执行完，write可能还没有执行完，不能释放ByteBuf。ByteBuf会在channelReadComplete的writeAndFlush执行完后释放</p></blockquote></li></ul>]]></content>
      
      
      <categories>
          
          <category> Netty </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka-SpringBoot</title>
      <link href="/kafka/kafka-springboot/"/>
      <url>/kafka/kafka-springboot/</url>
      
        <content type="html"><![CDATA[<p>官方网站：<a href="https://spring.io/projects/spring-kafka">https://spring.io/projects/spring-kafka</a></p><p>官方文档：<a href="https://docs.spring.io/spring-kafka/docs/current/reference/html/">https://docs.spring.io/spring-kafka/docs/current/reference/html/</a></p><h2 id="最简集成"><a href="#最简集成" class="headerlink" title="最简集成"></a>最简集成</h2><ol><li>环境：spring boot 2.6.1，kafka 3.0.0</li><li>添加maven依赖</li></ol><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>使用默认配置，最简单执行</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaLearnApplication</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">KafkaLearnApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">NewTopic</span> <span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name">TopicBuilder</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"topic1"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">replicas</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">ApplicationRunner</span> <span class="token function">runner</span><span class="token punctuation">(</span><span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> template<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> args <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"生产者发送消息：test"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                template<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"topic1"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">"myId"</span><span class="token punctuation">,</span> topics <span class="token operator">=</span> <span class="token string">"topic1"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token class-name">String</span> in<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者消费消息："</span><span class="token operator">+</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="spring-web"><a href="#spring-web" class="headerlink" title="spring web"></a>spring web</h2><p>消息生产者KafkaProducer</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducer</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> template<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${kafka_topic}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> topic<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        template<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>消息消费者KafkaConsumer</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumer</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">"${kafka_topic}"</span><span class="token punctuation">,</span> groupId <span class="token operator">=</span> <span class="token string">"${kafka_groupId}"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者消费消息："</span><span class="token operator">+</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>controller</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">KafkaProducer</span> kafkaProducer<span class="token punctuation">;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/send"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        kafkaProducer<span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置文件application.properties</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">server.servlet.context-path</span><span class="token punctuation">=</span><span class="token value attr-value">/kafka-learn</span><span class="token key attr-name">kafka_topic</span><span class="token punctuation">=</span><span class="token value attr-value">topic1</span><span class="token key attr-name">kafka_groupId</span><span class="token punctuation">=</span><span class="token value attr-value">group1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>浏览器访问</p><p><a href="http://127.0.0.1:8080/kafka-learn/send?msg=aacopy">http://127.0.0.1:8080/kafka-learn/send?msg=aacopy</a></p><p>查看控制台打印</p>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka-消息模型</title>
      <link href="/kafka/kafka-xiao-xi-mo-xing/"/>
      <url>/kafka/kafka-xiao-xi-mo-xing/</url>
      
        <content type="html"><![CDATA[<p>Kafka消息模型分为：点对点和发布订阅</p><h2 id="点对点"><a href="#点对点" class="headerlink" title="点对点"></a>点对点</h2><p>所有的消费者在同一个组中，一条消息只会被一个消费者消费。</p><p>启动一个消息生产者</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-console-producer.sh --broker-list <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--topic</span> aacopy-topic<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在两个命令窗口，分别执行命令，创建在同一个组（group参数相同）中的两个消费者</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-console-consumer.sh --bootstrap-server <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--topic</span> aacopy-topic <span class="token parameter variable">--group</span> group1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在生产者中输入消息，可以看到消息会在两个消费者中轮询消费，且一条消息只会被一个消费者消费</p><p><img src="/images/Kafka-%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B/image-20211207100533850.png"></p><p>查看组信息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-consumer-groups.sh --bootstrap-server <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--list</span>./kafka-consumer-groups.sh --bootstrap-server <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--group</span> group1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>注意：</p><p>docker中退出生产消费者的命令窗口，ctrl+C，不能直接用ctrl+P+Q或者ctrl+Z直接退出，不然消费者并没有结束进程，还在消费数据</p><h2 id="发布订阅"><a href="#发布订阅" class="headerlink" title="发布订阅"></a>发布订阅</h2><p>消费者在不同的组，所有组都可以消费发布的消息</p><p>启动一个消息生产者</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-console-producer.sh --broker-list <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--topic</span> aacopy-topic<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在两个命令窗口，创建在不同组（group参数相同）的两个消费者</p><p>命令窗口一执行：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-console-consumer.sh --bootstrap-server <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--topic</span> aacopy-topic <span class="token parameter variable">--group</span> group1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>命令窗口二执行：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-console-consumer.sh --bootstrap-server <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--topic</span> aacopy-topic <span class="token parameter variable">--group</span> group2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在生产者中输入消息，可以看到消息会在两个消费者中同时被消费</p><p><img src="/images/Kafka-%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B/image-20211207105443935.png"></p><h2 id="两种方式结合"><a href="#两种方式结合" class="headerlink" title="两种方式结合"></a>两种方式结合</h2><p>创建四个消费者，</p><p>两个执行命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-console-consumer.sh --bootstrap-server <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--topic</span> aacopy-topic <span class="token parameter variable">--group</span> group1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>另外两个执行命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-console-consumer.sh --bootstrap-server <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--topic</span> aacopy-topic <span class="token parameter variable">--group</span> group2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看所有消费者组消息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-consumer-groups.sh --bootstrap-server <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--describe</span> --all-groups<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/images/Kafka-%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B/image-20211207110515140.png"></p><p>创建一个消息生产者</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-console-producer.sh --broker-list <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--topic</span> aacopy-topic<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>发送生产消息，消息会在两个消费者组中同时被消费，且同一个组中只能被消费一次</p><p><img src="/images/Kafka-%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B/image-20211207111105831.png"></p>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kafka-HelloWorld</title>
      <link href="/kafka/kafka-helloworld/"/>
      <url>/kafka/kafka-helloworld/</url>
      
        <content type="html"><![CDATA[<p>kafka是一个高吞吐量的分布式发布订阅系统，可以实时的处理大量数据</p><h2 id="docker安装kafka"><a href="#docker安装kafka" class="headerlink" title="docker安装kafka"></a>docker安装kafka</h2><ol><li>安装zookeeper</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--name</span> zookeeper <span class="token parameter variable">-p</span> <span class="token number">2181</span>:2181 <span class="token parameter variable">-d</span> zookeeper<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>安装kafka（10.66.106.86为本机ip）</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--name</span> kafka <span class="token parameter variable">-p</span> <span class="token number">9092</span>:9092 <span class="token parameter variable">-e</span> <span class="token assign-left variable">KAFKA_BROKER_ID</span><span class="token operator">=</span><span class="token number">0</span> <span class="token parameter variable">-e</span> <span class="token assign-left variable">KAFKA_ZOOKEEPER_CONNECT</span><span class="token operator">=</span><span class="token number">10.66</span>.106.86:2181 <span class="token parameter variable">-e</span> <span class="token assign-left variable">ALLOW_PLAINTEXT_LISTENER</span><span class="token operator">=</span>yes <span class="token parameter variable">-e</span> <span class="token assign-left variable">KAFKA_ADVERTISED_LISTENERS</span><span class="token operator">=</span>PLAINTEXT://10.66.106.86:9092 <span class="token parameter variable">-e</span> <span class="token assign-left variable">KAFKA_LISTENERS</span><span class="token operator">=</span>PLAINTEXT://0.0.0.0:9092 <span class="token parameter variable">-d</span> bitnami/kafka:3.0.0<span class="token comment">#如果在win版本docker中挂载kafka数据目录加上以下启动参数</span><span class="token parameter variable">-v</span> C:<span class="token punctuation">\</span>dockerData<span class="token punctuation">\</span>kafka<span class="token punctuation">\</span>data:/bitnami/kafka/data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>具体的启动配置可以查看官方文档：<a href="https://hub.docker.com/r/bitnami/kafka%EF%BC%8CConfiguration%E9%83%A8%E5%88%86">https://hub.docker.com/r/bitnami/kafka，Configuration部分</a></p><ol start="3"><li>进入kafka容器</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> kafka <span class="token function">bash</span><span class="token builtin class-name">cd</span> opt/bitnami/kafka/bin/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="4"><li>创建toptic</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-topics.sh <span class="token parameter variable">--create</span> --bootstrap-server <span class="token number">10.66</span>.106.86:9092 --replication-factor <span class="token number">1</span> <span class="token parameter variable">--partitions</span> <span class="token number">2</span> <span class="token parameter variable">--topic</span> aacopy-topic<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="5"><li>查看toptic</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-topics.sh <span class="token parameter variable">--list</span> --bootstrap-server <span class="token number">10.66</span>.106.86:9092<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="6"><li>创建消息生产者</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-console-producer.sh --broker-list <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--topic</span> aacopy-topic<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="7"><li>新打开一个命令窗口，创建消息消费者</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./kafka-console-consumer.sh --bootstrap-server <span class="token number">10.66</span>.106.86:9092 <span class="token parameter variable">--topic</span> aacopy-topic --from-beginning<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="8"><li>在消息生产者中输入消息，可以在消费者窗口查看到输入的消息</li></ol><p><img src="/images/Kafka-HelloWorld/image-20211206145618666.png"></p><p>可以用命令加–help查看相关参数 eg: ./kafka-console-consumer.sh –help</p><h2 id="docker按照Kakfa-UI"><a href="#docker按照Kakfa-UI" class="headerlink" title="docker按照Kakfa-UI"></a>docker按照Kakfa-UI</h2><p>github：<a href="https://github.com/provectus/kafka-ui">https://github.com/provectus/kafka-ui</a></p><pre class="line-numbers language-none"><code class="language-none">docker run -p 9090:8080 --name kafka-ui \-e KAFKA_CLUSTERS_0_NAME=dev \-e KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=192.168.80.128:9092,192.168.80.128:9093,192.168.80.128:9094 \-e KAFKA_CLUSTERS_1_NAME=release \-e KAFKA_CLUSTERS_1_BOOTSTRAPSERVERS=192.168.80.129:9092,192.168.80.129:9093,192.168.80.129:9094 \-d provectuslabs/kafka-ui:latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>访问地址：部署的ip:9090</p><p><img src="/images/Kafka-HelloWorld/image-20220801162316796.png"></p><h2 id="kafka相关概念"><a href="#kafka相关概念" class="headerlink" title="kafka相关概念"></a>kafka相关概念</h2><ul><li><p>Broker</p><p>kafka服务端程序，一个mq节点就是一个broker</p></li><li><p>Producer</p><p>消息生产者，生成消息发送到topic中</p></li><li><p>Consumer</p><p>消息消费者</p></li><li><p>ConsumerGroup</p><p>消费者组，一条广播消息，发送给多个消费者组，在同一个消费者组中只能有一个消费者可以消费</p></li><li><p>Topic</p><p>主题，即消息的类别</p></li><li><p>Partition</p><p>topic物理上的分组，数据存储的基本单元，每个partition都由一系列有序的、不可变的消息组成，这些消息被连续的追加到partition中，一个topic中有至少一个partition，多个partition被分配到集群的多个server上，partition的数量要大于等于同一个消费者组中消息者数量，如果一个组中的消费者数量大于partition数量，有消费者会获取不到数据，所有在处理消息堆积的问题时，单纯加消费者数量是没有用的。</p></li><li><p>Replication</p><p>副本，一个partition有多个副本，每个副本的数据是一样的，用于宕机后的切换，保证服务可用，默认是没有副本，副本数不能大于集群中的节点数</p></li><li><p>ReplicationLeader</p><p>只存在一个leader副本，用于和生产者、消费者进行交互</p></li><li><p>ReplicationFollower</p><p>只做备份，从leader同步数据</p></li><li><p>ReplicationManager</p><p>负责副本状态切换</p></li><li><p>Segment</p><p>partition物理上由多个segment组成</p></li><li><p>offset</p><p>每个partition都由一系列有序的、不可变的消息组成，这些消息被连续的追加到partition中。partition中的每个消息都有一个连续的序列号叫做offset,用于partition唯一标识一条消息</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flowable-RestAPI</title>
      <link href="/flowable/flowable-restapi/"/>
      <url>/flowable/flowable-restapi/</url>
      
        <content type="html"><![CDATA[<p>官方文档：<a href="https://wwv.flowable.com/open-source/docs/bpmn/ch15-REST/">https://wwv.flowable.com/open-source/docs/bpmn/ch15-REST/</a></p><h2 id="使用docker启动flowable-rest"><a href="#使用docker启动flowable-rest" class="headerlink" title="使用docker启动flowable-rest"></a>使用docker启动flowable-rest</h2><ol><li>编写docker-compose.yml</li></ol><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.6'</span><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token key atrule">flowable-ui-app</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> flowable/flowable<span class="token punctuation">-</span>rest    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> SERVER_PORT=8098      <span class="token punctuation">-</span> SPRING_DATASOURCE_DRIVER<span class="token punctuation">-</span>CLASS<span class="token punctuation">-</span>NAME=com.mysql.cj.jdbc.Driver      <span class="token punctuation">-</span> SPRING_DATASOURCE_URL=jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//10.66.106.86<span class="token punctuation">:</span>3306/flowable_learn<span class="token punctuation">?</span>characterEncoding=UTF<span class="token punctuation">-</span><span class="token number">8</span>      <span class="token punctuation">-</span> SPRING_DATASOURCE_USERNAME=root      <span class="token punctuation">-</span> SPRING_DATASOURCE_PASSWORD=123456      <span class="token punctuation">-</span> FLOWABLE.IDM.APP.ADMIN.USER<span class="token punctuation">-</span>ID=admin      <span class="token punctuation">-</span> FLOWABLE.IDM.APP.ADMIN.PASSWORD=123456      <span class="token punctuation">-</span> FLOWABLE_COMMON_APP_IDM<span class="token punctuation">-</span>ADMIN_USER=admin      <span class="token punctuation">-</span> FLOWABLE_COMMON_APP_IDM<span class="token punctuation">-</span>ADMIN_PASSWORD=123456    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> 8098<span class="token punctuation">:</span><span class="token number">8098</span>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> /d/maven/repository/mysql/mysql<span class="token punctuation">-</span>connector<span class="token punctuation">-</span>java/8.0.27/mysql<span class="token punctuation">-</span>connector<span class="token punctuation">-</span>java<span class="token punctuation">-</span>8.0.27.jar<span class="token punctuation">:</span>/app/WEB<span class="token punctuation">-</span>INF/lib/mysql<span class="token punctuation">-</span>connector<span class="token punctuation">-</span>java<span class="token punctuation">-</span>8.0.27.jar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>备注：</p><p>（1）修改admin的密码，需要先设置SPRING_DATASOURCE_PASSWORD，单独设置FLOWABLE_COMMON_APP_IDM-ADMIN_PASSWORD是不起作用的</p><p>（2）volumes，这里用的是windows的docker，因为flowable本身不带mysql的驱动，所以需要把本地的驱动挂载到容器，前面的**/d**表示在D盘下。windows下也可以写成D:</p><p>（3）docker-compose文件名有规定，4种文件，这里就使用docker-compose.yml</p><ol start="2"><li>启动服务</li></ol><p>（1）先进入docker-compose.yml所在文件夹的目录</p><p>（2）执行命令 <code>docker-compose up -d</code></p><ol start="3"><li>测试</li></ol><p>（1）登录<a href="http://localhost:8098/flowable-rest/docs">http://localhost:8098/flowable-rest/docs</a></p><p>（2）账号密码：admin/123456</p>]]></content>
      
      
      <categories>
          
          <category> Flowable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flowable </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flowable-UI</title>
      <link href="/flowable/flowable-ui/"/>
      <url>/flowable/flowable-ui/</url>
      
        <content type="html"><![CDATA[<p>官方文档：<a href="https://wwv.flowable.com/open-source/docs/bpmn/ch14-Applications/">https://wwv.flowable.com/open-source/docs/bpmn/ch14-Applications/</a></p><h2 id="使用docker启动flowable-UI"><a href="#使用docker启动flowable-UI" class="headerlink" title="使用docker启动flowable-UI"></a>使用docker启动flowable-UI</h2><ol><li>编写docker-compose.yml</li></ol><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.6'</span><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token key atrule">flowable-ui-app</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> flowable/flowable<span class="token punctuation">-</span>ui    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> SERVER_PORT=8099      <span class="token punctuation">-</span> SPRING_DATASOURCE_DRIVER<span class="token punctuation">-</span>CLASS<span class="token punctuation">-</span>NAME=com.mysql.cj.jdbc.Driver      <span class="token punctuation">-</span> SPRING_DATASOURCE_URL=jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//10.66.106.86<span class="token punctuation">:</span>3306/flowable_learn<span class="token punctuation">?</span>characterEncoding=UTF<span class="token punctuation">-</span><span class="token number">8</span>      <span class="token punctuation">-</span> SPRING_DATASOURCE_USERNAME=root      <span class="token punctuation">-</span> SPRING_DATASOURCE_PASSWORD=123456      <span class="token punctuation">-</span> FLOWABLE.IDM.APP.ADMIN.USER<span class="token punctuation">-</span>ID=admin      <span class="token punctuation">-</span> FLOWABLE.IDM.APP.ADMIN.PASSWORD=123456      <span class="token punctuation">-</span> FLOWABLE_COMMON_APP_IDM<span class="token punctuation">-</span>ADMIN_USER=admin      <span class="token punctuation">-</span> FLOWABLE_COMMON_APP_IDM<span class="token punctuation">-</span>ADMIN_PASSWORD=123456    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> 8099<span class="token punctuation">:</span><span class="token number">8099</span>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> /d/maven/repository/mysql/mysql<span class="token punctuation">-</span>connector<span class="token punctuation">-</span>java/8.0.27/mysql<span class="token punctuation">-</span>connector<span class="token punctuation">-</span>java<span class="token punctuation">-</span>8.0.27.jar<span class="token punctuation">:</span>/app/WEB<span class="token punctuation">-</span>INF/lib/mysql<span class="token punctuation">-</span>connector<span class="token punctuation">-</span>java<span class="token punctuation">-</span>8.0.27.jar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>备注：</p><p>（1）修改admin的密码，需要先设置SPRING_DATASOURCE_PASSWORD，单独设置FLOWABLE_COMMON_APP_IDM-ADMIN_PASSWORD是不起作用的</p><p>（2）volumes，这里用的是windows的docker，因为flowable本身不带mysql的驱动，所以需要把本地的驱动挂载到容器，前面的**/d**表示在D盘下。windows下也可以写成D:</p><p>（3）docker-compose文件名有规定，4种文件，这里就使用docker-compose.yml</p><ol start="2"><li>启动服务</li></ol><p>（1）先进入docker-compose.yml所在文件夹的目录</p><p>（2）执行命令 <code>docker-compose up -d</code></p><ol start="3"><li>测试</li></ol><p>（1）登录<a href="http://127.0.0.1:8099/flowable-ui">http://127.0.0.1:8099/flowable-ui</a></p><p>（2）账号密码：admin/123456</p>]]></content>
      
      
      <categories>
          
          <category> Flowable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flowable </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker-Compose</title>
      <link href="/docker/docker-compose/"/>
      <url>/docker/docker-compose/</url>
      
        <content type="html"><![CDATA[<p>docker-compose是一个用于定义和运行多容器 Docker 的应用程序工具，可以帮助我们可以轻松、高效的管理容器</p><ul><li><p>文件名要求</p><p>文件名只能是docker-compose或者compose，文件后缀只能是yml或者yaml</p></li><li><p>windows下的文件挂载</p><p>文件所在盘符表示以/开头，如：D盘下的test.txt文件 应该成 /d/test.txt，也可以用D:开头</p></li></ul><p>compose操作容器（一定要进入配置文件目录）</p><ul><li>后台启动容器：docker-compose up -d</li><li>查看容器运行情况：docker-compose ps</li><li>停止并删除容器：docker-compose down</li><li>停止并删除容器并删除volume：docker-compose down –volumes</li><li>停止启动容器：docker-compose stop；docker-compose start</li><li>docker-compose exec的使用：docker-compose exec redis bash</li></ul><p>总结：</p><ul><li>操作docker-compose一定要在配置文件docker-compose.yml文件路径下操作</li><li>格式一定要注意，该空格要空格</li></ul>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flowable-数据库表</title>
      <link href="/flowable/flowable-shu-ju-ku-biao/"/>
      <url>/flowable/flowable-shu-ju-ku-biao/</url>
      
        <content type="html"><![CDATA[<p>Flowable 开源代码库相关的数据库表名以ACT _开头。特定于 Flowable Work 或 Engage 的数据库表以FLW _前缀开头。</p><ul><li><p>**ACT_RE_ ***：“RE”代表存储库（repository）。带有此前缀的表包含“静态”信息，例如流程定义和流程资源（图像、规则等）。</p></li><li><p>**ACT_RU_ ***：“RU”代表运行时间（runtime）。这些是包含流程实例、用户任务、变量、作业等的运行时数据的运行时表。Flowable 仅在流程实例执行期间存储运行时数据，并在流程实例结束时删除记录。这使运行时表既小又快。</p></li><li><p><strong>ACT_HI_</strong> *：’HI’ 代表历史（history）。这些是包含历史数据的表，例如历史的流程实例、变量、任务等。</p></li><li><p><strong>ACT_GE_</strong> *：通用数据（general ），用于各种用例。</p></li></ul><table><thead><tr><th>App  Engine</th><th></th></tr></thead><tbody><tr><td>ACT _ APP _ DEPLOYMENT</td><td>当通过应用引擎部署应用模型时，会存储一条记录以指示此部署。部署的实际内容被引用，并存储在ACT_APP_DEPLOYMENT_RESOURCE表。</td></tr><tr><td>ACT_APP_DEPLOYMENT_RESOURCE</td><td>此表包含构成应用程序部署的实际资源（以字节形式存储）。当引擎需要实际模型时，从该表中获取资源。</td></tr><tr><td>ACT _ APP _ APPDEF</td><td>应用程序模型产生应用程序定义。这个定义，如流程/案例/等。是已成功部署到应用程序引擎的应用程序模型的表示。</td></tr><tr><td><strong>CMMN引擎</strong></td><td></td></tr><tr><td>ACT _ CMMN _ HI _ CASE _ INST</td><td>该表包含由 CMMN 引擎启动的每个案例实例的条目。</td></tr><tr><td>ACT _ CMMN _ HI _ MIL _ INST</td><td>此表包含案例实例中达到的每个里程碑的条目。</td></tr><tr><td>ACT _ CMMN _ HI _ PLAN _ ITEM _ INST</td><td>该表包含作为案例实例执行的一部分创建的每个计划项目实例的条目。</td></tr><tr><td>ACT _ CMMN _ RU _ CASE _ INST</td><td>此表包含每个已开始但尚未完成的案例实例的条目。</td></tr><tr><td>ACT _ CMMN _ RU _ MIL _ INST</td><td>该表包含作为运行案例实例的一部分达到的每个里程碑的条目。</td></tr><tr><td>ACT _ CMMN _ RU _ PLAN _ ITEM _ INST</td><td>案例实例执行由案例定义中定义的计划项目的多个实例组成。此表包含在案例实例执行期间创建的每个实例的条目。</td></tr><tr><td>ACT _ CMMN _ RU _ SENTRY _ PART _ INST</td><td>计划项目实例可以有守护状态转换的哨兵。这样的哨兵可以包含在状态改变发生之前需要满足的多个部分。该表存储满足的此类哨兵的任何部分。</td></tr><tr><td><strong>DMN</strong></td><td></td></tr><tr><td>ACT _ DMN _ DECISION _ TABLE</td><td>该表包含已部署决策表的元数据，并与其他引擎的定义相对应。</td></tr><tr><td>ACT _ DMN _ HI _ DECISION _ EXECUTION</td><td>该表包含有关 DMN 决策表执行的审计信息。</td></tr><tr><td><strong>流程引擎</strong></td><td></td></tr><tr><td>ACT _ RU _ EXECUTION</td><td>存储流程实例和指向流程实例当前状态的指针（称为执行）。</td></tr><tr><td>ACT _ RU _ ACTINST</td><td>流程实例中的每个活动在该表中都有一行指示活动的当前状态。</td></tr><tr><td>ACT _ RU _ &lt; TYPE &gt; _ JOB</td><td>Flowable  引擎使用作业表来实现异步逻辑、计时器或历史处理。这些表存储每个作业所需的数据。</td></tr><tr><td>ACT _ RU _ ENTITYLINK</td><td>此表存储有关实例的父子关系的信息。例如，如果流程实例启动子案例实例，则此关系存储在此表中。这可以轻松查询关系。</td></tr><tr><td>ACT _ RU _ EVENT _ SUBSCR</td><td>当流程定义使用事件（信号/消息/等或开始/中间/边界）时，引擎在此表中存储对此表的引用。这简化了查询哪些实例正在等待某种类型的事件。</td></tr><tr><td>ACT _ RU _ IDENTITYLINK</td><td>此表存储有关用户或组及其与（流程/案例/等）实例相关的角色的数据。该表也被需要身份链接的其他引擎使用。</td></tr><tr><td>ACT _ RU _ TASK</td><td>该表包含正在运行的实例的每个未完成的用户任务的条目。然后在查询用户的任务列表时使用该表。CMMN  引擎也使用该表。</td></tr><tr><td>ACT _ RU _ VARIABLES</td><td>此表存储与实例相关的变量。CMMN 引擎也使用该表。</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Flowable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flowable </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Win10环境安装Docker</title>
      <link href="/docker/win10-an-zhuang-docker/"/>
      <url>/docker/win10-an-zhuang-docker/</url>
      
        <content type="html"><![CDATA[<ol><li><p>下载安装包</p><p><a href="https://www.docker.com/get-started">https://www.docker.com/get-started</a></p><p>选择Download for Windows</p></li><li><p>开启Hyper-V</p><p>控制面板 -&gt; 程序 -&gt; 启用或关闭Windows功能 -&gt; 勾选Hyper-V</p></li><li><p>安装下载的docker安装包，并运行安装号的文件</p></li></ol><p>如果启动报错：WSL 2 installation is incomplete.</p><p><img src="/images/Win10%E5%AE%89%E8%A3%85Docker/error1.png"></p><p>点击提示的链接，</p><p><a href="https://docs.microsoft.com/zh-cn/windows/wsl/install-manual#step-4---download-the-linux-kernel-update-package">https://docs.microsoft.com/zh-cn/windows/wsl/install-manual#step-4---download-the-linux-kernel-update-package</a></p><p>或者直接<a href="https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi">下载</a>update文件，然后运行，安装完成后重启docker</p><ol start="4"><li><p>验证：cmd，输入docker info</p></li><li><p>设置阿里云镜像加速</p><p>（1）登录阿里云，访问地址</p><p><a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</a></p><p>（2）复制加速器地址</p><p>https://系统分配前缀.mirror.aliyuncs.com</p><p>（3）在系统右下角托盘图标内右键菜单选择 Settings，打开配置窗口后左侧导航菜单选择 Docker Daemon。编辑窗口内的JSON串，填写下方加速器地址，注意json的逗号</p><pre class="line-numbers language-none"><code class="language-none">{    "registry-mirrors": ["&lt;your accelerate address&gt;"]}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/images/Win10%E5%AE%89%E8%A3%85Docker/image-20211202135835856.png"></p><p>（4）点击Apply&amp;Restart重启</p><p>（5）docker info 查看镜像是否设置生效</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>性能分析工具-Jconsole</title>
      <link href="/xing-neng/xing-neng-fen-xi-gong-ju-jconsole/"/>
      <url>/xing-neng/xing-neng-fen-xi-gong-ju-jconsole/</url>
      
        <content type="html"><![CDATA[<p>JDK自带的图形化分析工具，可以链接本地和远程的服务</p><p>位置：jdk1.8.0_301\bin\jconsole.exe</p><p>windows查看端口对应的进程：</p><pre class="line-numbers language-none"><code class="language-none">C:\&gt;netstat -ano | findstr "9083"  TCP    0.0.0.0:9083           0.0.0.0:0              LISTENING       35720  TCP    [::]:9083              [::]:0                 LISTENING       35720C:\&gt;tasklist | findstr 35720java.exe                     35720 Console                    1    736,804 K<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h2><ol><li>打开后，本地进程列表没有数据</li></ol><p>打开文件夹：C:\Users\Iseven.yang\AppData\Local\Temp\hsperfdata_Iseven.yang</p><p>空白处“右键”-&gt;“属性”-&gt;“安全”-&gt;“编辑”-&gt;选择当前用户-&gt;下方勾选“完全控制”中的“允许”-&gt;“确定”</p><p>重启jconsole，重启java服务</p><ol start="2"><li>本地进程列表中的进程显示灰色，提示“未对此进程启用管理代理”</li></ol><p>在启动配置里，VM options中添加参数</p><pre class="line-numbers language-none"><code class="language-none">-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=19083-Dcom.sun.management.jmxremote.ssl=false  -Dcom.sun.management.jmxremote.authenticate=false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>打开jconsole，选择远程进程</p><p>输入：127.0.0.1:19083 后点连接</p>]]></content>
      
      
      <categories>
          
          <category> 性能 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 性能 </tag>
            
            <tag> Jconsole </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>性能分析工具-jvisualvm</title>
      <link href="/xing-neng/xing-neng-fen-xi-gong-ju-jvisualvm/"/>
      <url>/xing-neng/xing-neng-fen-xi-gong-ju-jvisualvm/</url>
      
        <content type="html"><![CDATA[<p>位置：jdk1.8.0_301\bin\jvisualvm.exe</p><h2 id="1-远程监控"><a href="#1-远程监控" class="headerlink" title="1. 远程监控"></a>1. 远程监控</h2><ul><li><p>监控远程服务需要在服务器上启动jstatd服务</p></li><li><p>找一个随意文件夹，创建文件，并添加内容</p><ul><li>touch jstatd.all.policy</li></ul><pre class="line-numbers language-none"><code class="language-none">grant codebase "file:${java.home}/../lib/tools.jar" {     permission java.security.AllPermission;  };<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>启动jstatd</p><ul><li>jstatd -J-Djava.security.policy=jstatd.all.policy -J-Djava.rmi.server.hostname=192.168.10.66 &amp;</li></ul></li><li><p>本地启动jvisualvm，添加远程</p><ul><li>输入主机ip</li></ul></li></ul><h2 id="2-问题："><a href="#2-问题：" class="headerlink" title="2. 问题："></a>2. 问题：</h2><ol><li>打开提示“无法监视本地JAVA应用程序”<ul><li>关闭所有Java程序</li><li>按Win + R，然后输入：%TMP%；</li><li>找到hsperfdata_开头的文件夹，把后面的系统名中大写改成小写</li><li>实在不行，把hsperfdata_开头的文件删了，再重启java程序</li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> 性能 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 性能 </tag>
            
            <tag> Jconsole </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>压测工具-Jmeter</title>
      <link href="/xing-neng/ya-ce-gong-ju-jmeter/"/>
      <url>/xing-neng/ya-ce-gong-ju-jmeter/</url>
      
        <content type="html"><![CDATA[<p>官网地址：<a href="http://jmeter.apache.org/">http://jmeter.apache.org/</a></p><p>下载地址：<a href="http://jmeter.apache.org/download_jmeter.cgi">http://jmeter.apache.org/download_jmeter.cgi</a></p><p>下载慢可以更换其他镜像地址下载</p><p>启动方式：下载后，启动bin目录下的jmeter.bat (windows)</p><h2 id="修改jmeter为中文"><a href="#修改jmeter为中文" class="headerlink" title="修改jmeter为中文"></a>修改jmeter为中文</h2><p>临时：Options -&gt; Choose Language -&gt; Chinese(Simplified)</p><p>永久：在bin目录下找到配置文件jmeter.properties，</p><p>搜索language，将language=en，改为language=zh_CN</p><p>操作：</p><p>创建压测计划（Hello World)</p><p>（1）测试计划（右键）-&gt; 添加 -&gt; 线程（用户） -&gt; setUp线程组</p><p>（2）线程数和Ramp-up时间 都填写 10</p><p>（3）线程组右键 -&gt; 添加 -&gt; 取样器 -&gt; HTTP请求 -&gt; 填写服务器ip，端口号，路径</p><p>（4）如果需要添加头信息，在配置元件中-&gt;HTTP信息头管理器</p><p>（5）线程组右键 -&gt; 添加 -&gt; 监听器 -&gt; 查看结果树</p><p>（6）点击头部绿色启动箭头开始压测，再点击否，开始执行</p><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><ul><li><p>线程组：一组线程并发执行，每个线程就是一个请求</p></li><li><p>线程数：线程组内的线程个数，模拟并发数</p></li><li><p>准备时长（Ramp-Up Period(in seconds)）：全部线程启动的时长，比如100个线程，20秒，则表示20秒内 100个线程都要启动完成，每秒启动5个线程</p></li><li><p>循环次数：每个线程发送的次数，假如值为5，100个线程，则会发送500次请求，可以勾选永远循环</p></li><li><p>特殊线程组</p><ul><li>setUP：最先执行，前置工作</li><li>线程组：中级执行，常规处理</li><li>tearDown：最后执行，收尾工作</li></ul></li><li><p>聚合报告（Aggregate Report）</p><ul><li>lable: sampler的名称</li><li>Samples（样本）: 一共发出去多少请求,例如10个用户，循环10次，则是 100</li><li>Average（平均值）: 平均响应时间</li><li>Median（中位数）: 50％ 用户的响应时间</li><li>90% Line : 90％ 用户的响应不会超过该时间 （90% of the samples took no more than this time.  The remaining samples at least as long as this）</li><li>95% Line : 95％ 用户的响应不会超过该时间</li><li>99% Line : 99％ 用户的响应不会超过该时间</li><li>min : 最小响应时间</li><li>max : 最大响应时间</li><li>Error%：错误的请求的数量/请求的总数</li><li>Throughput： 吞吐量——默认情况下表示每秒完成的请求数（Request per Second) 可类比为qps</li><li>KB/Sec: 每秒接收数据量</li></ul></li></ul><h2 id="性能测试的关键点"><a href="#性能测试的关键点" class="headerlink" title="性能测试的关键点"></a>性能测试的关键点</h2><ul><li>TPS<ul><li>Transactions Per Second 每秒事务数,  可以是一个接口、多个接口、一个业务流程</li><li>包括增删改操作</li></ul></li><li>QPS<ul><li>Queries Per Second， 每秒查询数,  指一台服务器每秒能够响应的查询次数</li><li>QPS 只是一个简单查询的统计，不能描述增删改等操作</li><li>如果单压测查询接口 TPS=QPS</li></ul></li><li>RT<ul><li>响应时间</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 性能 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Jmeter </tag>
            
            <tag> 性能 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-备份</title>
      <link href="/mysql/mysql-bei-fen/"/>
      <url>/mysql/mysql-bei-fen/</url>
      
        <content type="html"><![CDATA[<ul><li>数据备份的意义：</li></ul><p>（1）保护数据的安全；</p><p>（2）在出现意外的时候（硬盘的损坏，断电，黑客的攻击），以便数据的恢复；</p><p>（3）导出生产的数据以便研发人员或者测试人员测试学习；</p><p>（4）高权限的人员操作失误导致数据丢失，以便恢复；</p><ul><li>数据库的备份类型：</li></ul><p>（1）完全备份：对整个数据库的数据进行备份</p><p>（2）部分备份：对部分数据进行备份（可以是一张表也可以是多张表）</p><p>  增量备份：是以上一次备份为基础来备份变更数据的，节约空间</p><p>  差异备份：是以第一次完全备份的基础来备份变更备份的，浪费空间</p><ul><li>数据库备份的方式：</li></ul><p>（1）逻辑备份：直接生成sql语句保存起来，在恢复数据的时候执行备份的sql语句来实现数据的恢复</p><p>（2）物理备份：直接拷贝相关的物理数据</p><p>区别：逻辑备份效率低，恢复数据效率低，但是逻辑备份节约空间；物理备份浪费空间，但是相对逻辑备份而言效率比较高</p><ul><li>数据库备份的场景：</li></ul><p>（1）热备份：备份时，数据库的读写操作不会受到影响</p><p>（2）温备份：备份时，数据库的读操作可以进行，但是写操作不能执行</p><p>（3）冷备份：备份时，不能进行任何操作</p><ul><li>mysqldump使用语法：</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysqldump <span class="token operator">-</span>u 用户 <span class="token operator">-</span>h host <span class="token operator">-</span>p 密码 dbname <span class="token keyword">table</span> <span class="token operator">&gt;</span> 路径<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p>远程备份单库例子：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysqldump <span class="token operator">-</span>uroot <span class="token operator">-</span>pabc123456 <span class="token operator">-</span>h120<span class="token punctuation">.</span><span class="token number">25.93</span><span class="token number">.69</span> zabbix <span class="token operator">|</span> gzip  <span class="token operator">&gt;</span> <span class="token operator">/</span>mysql_data_back<span class="token operator">/</span>zabbix_users<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">.</span>gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>远程备份单库例子并保留创建库语句：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysqldump <span class="token operator">-</span>uroot <span class="token operator">-</span>pabc123456 <span class="token operator">-</span>h120<span class="token punctuation">.</span><span class="token number">25.93</span><span class="token number">.69</span> <span class="token comment">--databases zabbix | gzip  &gt; /mysql_data_back/zabbix_bak.sql.gz</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>远程备份单库单表的例子：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysqldump <span class="token operator">-</span>uroot <span class="token operator">-</span>pabc123456 <span class="token operator">-</span>h120<span class="token punctuation">.</span><span class="token number">25.93</span><span class="token number">.69</span> zabbix  users <span class="token operator">|</span> gzip  <span class="token operator">&gt;</span> <span class="token operator">/</span>mysql_data_back<span class="token operator">/</span>zabbix_users<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">.</span>gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>远程备份多库的例子：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysqldump <span class="token operator">-</span>uroot <span class="token operator">-</span>pabc123456 <span class="token operator">-</span>h120<span class="token punctuation">.</span><span class="token number">25.93</span><span class="token number">.69</span> <span class="token comment">--databases zabbix XD | gzip  &gt; /mysql_data_back/zabbix_XD.sql.gz</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>远程备份全库的例子：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysqldump <span class="token operator">-</span>uroot <span class="token operator">-</span>pabc123456 <span class="token operator">-</span>h120<span class="token punctuation">.</span><span class="token number">25.93</span><span class="token number">.69</span> <span class="token comment">--all-databases  | gzip  &gt; /mysql_data_back/all.sql.gz</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h2 id="数据的恢复"><a href="#数据的恢复" class="headerlink" title="数据的恢复"></a>数据的恢复</h2><p>远程恢复数据（备份的数据文件里有创建库的语句）：</p><p>mysql -uroot -pabc123456 -h120.25.93.69  &lt; zabbix_bak.sql</p><p>远程恢复数据（备份的数据文件里没有创建库的语句）：</p><p>mysql -uroot -pabc123456 -h120.25.93.69  zabbix &lt; zabbix_bak.sql</p><h2 id="物理备份"><a href="#物理备份" class="headerlink" title="物理备份"></a>物理备份</h2><ul><li><p>看找数据库源文件路径（一）：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'datadir%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>看找数据库源文件路径（二）：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">cat <span class="token operator">/</span>etc<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>MyISAM表源文件：</p><p>db.opt：创建库的时候生成，主要存储着当前库的默认字符集和字符校验规则</p><p>.frm ：记录着表结构信息的文件</p><p>.MYI：记录着索引的文件</p><p>.MYD :记录着表的数据</p></li><li><p>InnoDB表源文件：InnoDB有着共享表空间跟独立表空间的概念。</p><p>db.opt：创建库的时候生成，主要存储着当前库的默认字符集和字符校验规则</p><p>.frm ：记录着表结构信息的文件</p><p>.ibd ：独立表空间，里边记录这个表的数据和索引</p><p>ibdata1：共享表空间，里边记录表的数据和索引</p></li><li><p>请求全局读锁：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">flush <span class="token keyword">tables</span> <span class="token keyword">with</span> <span class="token keyword">read</span> <span class="token keyword">lock</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>解锁：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h2 id="二进制日志mysqlbinlog备份数据"><a href="#二进制日志mysqlbinlog备份数据" class="headerlink" title="二进制日志mysqlbinlog备份数据"></a>二进制日志mysqlbinlog备份数据</h2><p>二进制日志就是记录着mysql数据库中的一些写入性操作，比如一些增删改，但是，不包括查询！</p><p>一般情况下，二进制日志有着数据复制和数据恢复的功能</p><p>注意：开启二进制日志会有1%的性能消耗！</p><ul><li>查看二进制日志是否开启：</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'log_bin%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>开启二进制日志 : vi /etc/my.cnf</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>log<span class="token operator">-</span>bin<span class="token operator">=</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mydata<span class="token operator">/</span>log_bin<span class="token operator">/</span>mysql<span class="token operator">-</span>binserver<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>查看所有的binlog日志列表：</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> master logs<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>刷新二进制日志：</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">flush logs<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>重置(清空）二进制日志文件：</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> master logs<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>使用mysqldump备份数据时，加上-F选项可以重新生成一个新的二进制日志文件</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysqldump <span class="token operator">-</span>uroot <span class="token operator">-</span>p XD <span class="token keyword">user</span> <span class="token operator">-</span>F  <span class="token operator">&gt;</span> user_bak<span class="token punctuation">.</span><span class="token keyword">sql</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="二进制日志mysqlbinlog恢复数据"><a href="#二进制日志mysqlbinlog恢复数据" class="headerlink" title="二进制日志mysqlbinlog恢复数据"></a>二进制日志mysqlbinlog恢复数据</h2><ul><li><p>查看二进制日志文件的内容报错：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span>root<span class="token variable">@xdclass</span><span class="token operator">-</span><span class="token keyword">public</span> log_bin<span class="token punctuation">]</span><span class="token comment"># mysqlbinlog mysql-bin.000002</span>mysqlbinlog: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> unknown variable <span class="token string">'default-character-set=utf8'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p>解决：</p><p>第一种：在mysqlbinlog 后边加上 –no-defaults </p><p>第二种：注释掉配置文件里边的default-character-set=utf8</p></li></ul></li><li><p>把二进制日志文件导出成普通文件：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysqlbinlog <span class="token comment">--base64-output=DECODE-ROWS -v mysql-bin.000002 &gt; mysqlbin.sql</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>找出要恢复的位置：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">（<span class="token number">1</span>）找出关键字的行数：mysqlbinlog <span class="token comment">--no-defaults mysql-bin.000002 | cat -n  | grep -iw 'drop'</span><span class="token punctuation">[</span>root<span class="token variable">@xdclass</span><span class="token operator">-</span><span class="token keyword">public</span> log_bin<span class="token punctuation">]</span><span class="token comment"># mysqlbinlog --no-defaults mysql-bin.000002 | cat -n  | grep -iw 'drop'</span>  <span class="token number">4180</span>  <span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token comment">/* generated by server */</span>（<span class="token number">2</span>）打印出相关内容：mysqlbinlog <span class="token comment">--no-defaults mysql-bin.000002 | cat -n | sed -n '4170,4180p'</span><span class="token punctuation">[</span>root<span class="token variable">@xdclass</span><span class="token operator">-</span><span class="token keyword">public</span> log_bin<span class="token punctuation">]</span><span class="token comment"># mysqlbinlog --no-defaults mysql-bin.000002 | cat -n | sed -n '4170,4180p'</span> <span class="token number">4170</span>  <span class="token comment"># at 59578</span> <span class="token number">4180</span>  <span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token comment">/* generated by server */</span> <span class="token number">4171</span>  <span class="token comment">#190419  0:41:48 server id 1  end_log_pos 59609 CRC32 0x36cda2b7        Xid = 6380</span> <span class="token number">4172</span>  <span class="token keyword">COMMIT</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span> <span class="token number">4173</span>  <span class="token comment"># at 59609</span> <span class="token number">4174</span>  <span class="token comment">#190419  0:41:48 server id 1  end_log_pos 59674 CRC32 0x8de2f06a        Anonymous_GTID  last_committed=145      sequence_number=146</span> <span class="token number">4175</span>  <span class="token keyword">SET</span> @<span class="token variable">@SESSION.GTID_NEXT</span><span class="token operator">=</span> <span class="token string">'ANONYMOUS'</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span> <span class="token number">4176</span>  <span class="token comment"># at 59674</span> <span class="token number">4177</span>  <span class="token comment">#190419  0:41:48 server id 1  end_log_pos 59787 CRC32 0x6b2edd2b        Query   thread_id=14    exec_time=0     error_code=0</span> <span class="token number">4178</span>  <span class="token keyword">use</span> <span class="token identifier"><span class="token punctuation">`</span>XD<span class="token punctuation">`</span></span><span class="token comment">/*!*/</span><span class="token punctuation">;</span> <span class="token number">4179</span>  <span class="token keyword">SET</span> <span class="token keyword">TIMESTAMP</span><span class="token operator">=</span><span class="token number">1555605708</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span> <span class="token number">4180</span>  <span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token comment">/* generated by server */</span> <span class="token punctuation">[</span>root<span class="token variable">@xdclass</span><span class="token operator">-</span><span class="token keyword">public</span> log_bin<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>恢复数据：</p><ul><li><p>第一步：把备份的数据表user恢复到数据库中：mysql -uroot -p XD &lt; /mysql_data_back/user_bak.sql</p></li><li><p>第二步：利用上面找到的删除的位置进行恢复数据</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysqlbinlog <span class="token comment">--no-defaults --set-charset=utf8  --stop-position="59674" /data/mydata/log_bin/mysql-bin.000002 | mysql -uroot -p </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul></li><li><p>登录数据库查看数据是否恢复回来</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Aspose-Project</title>
      <link href="/util/aspose-project/"/>
      <url>/util/aspose-project/</url>
      
        <content type="html"><![CDATA[<p>1.<br>2. Apose.Total.Java.lic放在配置文件目录下<br>3. 添加依赖</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repositories</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>AsposeJavaAPI<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Aspose Java API<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>http://repository.aspose.com/repo/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repositories</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.aspose<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>aspose-tasks<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>21.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>classifier</span><span class="token punctuation">&gt;</span></span>jdk18<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>classifier</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>编写单元测试</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProjectTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> dataDir <span class="token operator">=</span> <span class="token string">"E:\\"</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@BeforeAll</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initLicense</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//每个类型的License，包名不一样</span>        <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>License</span> license <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>aspose<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span></span>License</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        license<span class="token punctuation">.</span><span class="token function">setLicense</span><span class="token punctuation">(</span><span class="token class-name">ProjectTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"Aspose.Total.Java.lic"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"init seccess..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>        <span class="token class-name">Project</span> newProject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Project</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        newProject<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>dataDir <span class="token operator">+</span> <span class="token string">"hello.xml"</span><span class="token punctuation">,</span> <span class="token class-name">SaveFileFormat</span><span class="token punctuation">.</span><span class="token constant">XML</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>目前，Aspose.Tasks for Java 仅提供创建 XML 项目文件的工具</p><ul><li>创建mpp项目</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Project</span> project <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Project</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>project<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token string">"E:\\aacopy.mpp"</span><span class="token punctuation">,</span> <span class="token class-name">SaveFileFormat</span><span class="token punctuation">.</span><span class="token constant">MPP</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>设置时间表开始时间</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>calendar<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>project<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Prj</span><span class="token punctuation">.</span><span class="token constant">START_DATE</span><span class="token punctuation">,</span> calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>设置任务属性</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Project</span> project <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Project</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置时间表开始时间</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>calendar<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>project<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Prj</span><span class="token punctuation">.</span><span class="token constant">START_DATE</span><span class="token punctuation">,</span> calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建一个任务</span><span class="token class-name">Task</span> task1 <span class="token operator">=</span> project<span class="token punctuation">.</span><span class="token function">getRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Task 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置工期</span>task1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Tsk</span><span class="token punctuation">.</span><span class="token constant">DURATION</span><span class="token punctuation">,</span> task1<span class="token punctuation">.</span><span class="token function">getParentProject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDuration</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnitType<span class="token punctuation">.</span>Hour</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Task</span> task2 <span class="token operator">=</span> project<span class="token punctuation">.</span><span class="token function">getRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Task 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>task2<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Tsk</span><span class="token punctuation">.</span><span class="token constant">DURATION</span><span class="token punctuation">,</span> task2<span class="token punctuation">.</span><span class="token function">getParentProject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDuration</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnitType<span class="token punctuation">.</span>Day</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置前置任务</span><span class="token class-name">TaskLink</span> link12 <span class="token operator">=</span> project<span class="token punctuation">.</span><span class="token function">getTaskLinks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task1<span class="token punctuation">,</span> task2<span class="token punctuation">,</span> <span class="token class-name">TaskLinkType<span class="token punctuation">.</span>FinishToStart</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//前置任务-延隔时间</span>link12<span class="token punctuation">.</span><span class="token function">setLinkLag</span><span class="token punctuation">(</span><span class="token number">4800</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Task</span> task3 <span class="token operator">=</span> project<span class="token punctuation">.</span><span class="token function">getRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Task 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>task3<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Tsk</span><span class="token punctuation">.</span><span class="token constant">DURATION</span><span class="token punctuation">,</span> task3<span class="token punctuation">.</span><span class="token function">getParentProject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDuration</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnitType<span class="token punctuation">.</span>Day</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//任务模式：手动计划</span>task3<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Tsk</span><span class="token punctuation">.</span><span class="token constant">IS_MANUAL</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NullableBool</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建资源</span><span class="token class-name">Resource</span> rsc <span class="token operator">=</span> project<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Rsc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//给任务分配资源</span><span class="token class-name">ResourceAssignment</span> assn <span class="token operator">=</span> project<span class="token punctuation">.</span><span class="token function">getResourceAssignments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task3<span class="token punctuation">,</span> rsc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Task</span> task4 <span class="token operator">=</span> project<span class="token punctuation">.</span><span class="token function">getRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Task 4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>task4<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Tsk</span><span class="token punctuation">.</span><span class="token constant">DURATION</span><span class="token punctuation">,</span> task4<span class="token punctuation">.</span><span class="token function">getParentProject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDuration</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnitType<span class="token punctuation">.</span>Day</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置里程碑</span>task4<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Tsk</span><span class="token punctuation">.</span><span class="token constant">IS_MILESTONE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NullableBool</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//导出</span>project<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token string">"E:\\aacopy.mpp"</span><span class="token punctuation">,</span> <span class="token class-name">SaveFileFormat</span><span class="token punctuation">.</span><span class="token constant">MPP</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Util </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Aspose </tag>
            
            <tag> Util </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Poi-Excel</title>
      <link href="/util/poi-excel/"/>
      <url>/util/poi-excel/</url>
      
        <content type="html"><![CDATA[<h2 id="导出多级联动、单元格合并"><a href="#导出多级联动、单元格合并" class="headerlink" title="导出多级联动、单元格合并"></a>导出多级联动、单元格合并</h2><p>导入maven依赖</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.poi<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>poi-ooxml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PoiUtil类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PoiUtil</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DICT_DATA</span> <span class="token operator">=</span> <span class="token string">"dict_data"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">XSSFColor</span> <span class="token constant">TITLE_COLOR</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XSSFColor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span></span>Color</span><span class="token punctuation">(</span><span class="token number">139</span><span class="token punctuation">,</span> <span class="token number">155</span><span class="token punctuation">,</span> <span class="token number">171</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultIndexedColorMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">ExcelDTO</span> excelDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExcelDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        excelDTO<span class="token punctuation">.</span><span class="token function">setFileName</span><span class="token punctuation">(</span><span class="token string">"aa.xlsx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        excelDTO<span class="token punctuation">.</span><span class="token function">setSheetName</span><span class="token punctuation">(</span><span class="token string">"xx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        excelDTO<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DictCellDTO</span><span class="token punctuation">&gt;</span></span> dictCellDTOS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"AAAA"</span><span class="token punctuation">,</span> <span class="token string">"BBBB"</span><span class="token punctuation">,</span> <span class="token string">"CCCC"</span><span class="token punctuation">,</span> <span class="token string">"DDDD"</span><span class="token punctuation">,</span> <span class="token string">"EEEE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"AAAA"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"aa"</span><span class="token punctuation">,</span> <span class="token string">"bb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"BBBB"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"cc"</span><span class="token punctuation">,</span> <span class="token string">"dd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"CCCC"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"ee"</span><span class="token punctuation">,</span> <span class="token string">"ff"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"DDDD"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"gg"</span><span class="token punctuation">,</span> <span class="token string">"hh"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"EEEE"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"jj"</span><span class="token punctuation">,</span> <span class="token string">"kk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"aa"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"aa1"</span><span class="token punctuation">,</span> <span class="token string">"b2b"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"bb"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"c3c"</span><span class="token punctuation">,</span> <span class="token string">"ddd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"cc"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"ese"</span><span class="token punctuation">,</span> <span class="token string">"ff2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"dd"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"ggs"</span><span class="token punctuation">,</span> <span class="token string">"hfh"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"ee"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"jsj"</span><span class="token punctuation">,</span> <span class="token string">"kke"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"ff"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"a3a"</span><span class="token punctuation">,</span> <span class="token string">"bgb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"gg"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"c3c"</span><span class="token punctuation">,</span> <span class="token string">"ddd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"hh"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"gee"</span><span class="token punctuation">,</span> <span class="token string">"fhf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"jj"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"g2g"</span><span class="token punctuation">,</span> <span class="token string">"hfh"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dictCellDTOS<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DictCellDTO</span><span class="token punctuation">(</span><span class="token string">"kk"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"4jj"</span><span class="token punctuation">,</span> <span class="token string">"kk5"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        excelDTO<span class="token punctuation">.</span><span class="token function">setDictCellList</span><span class="token punctuation">(</span>dictCellDTOS<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        f<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        f<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"$E"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        f<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">"$F"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        excelDTO<span class="token punctuation">.</span><span class="token function">setFormula</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"xx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"cc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"vv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"bb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"xx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"ww"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"dd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"ff"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map3<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"xx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map3<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"ww"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map3<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"ee"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map3<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"rr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map4<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"qq"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map4<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"ww"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map4<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"ee"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map4<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"rr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        source<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map1<span class="token punctuation">)</span><span class="token punctuation">;</span>        source<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map2<span class="token punctuation">)</span><span class="token punctuation">;</span>        source<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map3<span class="token punctuation">)</span><span class="token punctuation">;</span>        source<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map4<span class="token punctuation">)</span><span class="token punctuation">;</span>        excelDTO<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>        excelDTO<span class="token punctuation">.</span><span class="token function">setGroupBy</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">createXlsx</span><span class="token punctuation">(</span>excelDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createXlsx</span><span class="token punctuation">(</span><span class="token class-name">ExcelDTO</span> excelDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">XSSFWorkbook</span> workbook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XSSFWorkbook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//添加样式</span>        <span class="token function">addCellStyle</span><span class="token punctuation">(</span>workbook<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置标题</span>        <span class="token class-name">XSSFSheet</span> xssfSheet <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createSheet</span><span class="token punctuation">(</span>excelDTO<span class="token punctuation">.</span><span class="token function">getSheetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">XSSFRow</span> titleRow <span class="token operator">=</span> xssfSheet<span class="token punctuation">.</span><span class="token function">createRow</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> title <span class="token operator">=</span> excelDTO<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> title<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">XSSFCell</span> titleRowCell <span class="token operator">=</span> titleRow<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            titleRowCell<span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>title<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            titleRowCell<span class="token punctuation">.</span><span class="token function">setCellStyle</span><span class="token punctuation">(</span>workbook<span class="token punctuation">.</span><span class="token function">getCellStyleAt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            xssfSheet<span class="token punctuation">.</span><span class="token function">setDefaultColumnStyle</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> workbook<span class="token punctuation">.</span><span class="token function">getCellStyleAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">//设置字典</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>excelDTO<span class="token punctuation">.</span><span class="token function">getDictCellList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">createDictData</span><span class="token punctuation">(</span>workbook<span class="token punctuation">,</span> excelDTO<span class="token punctuation">.</span><span class="token function">getDictCellList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">//填充数据,并设置单元格合并</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> excelDTO<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">//根据合并规则，重新处理数据</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> groupBy <span class="token operator">=</span> excelDTO<span class="token punctuation">.</span><span class="token function">getGroupBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>groupBy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">addMergeRegion</span><span class="token punctuation">(</span>xssfSheet<span class="token punctuation">,</span> source<span class="token punctuation">,</span> groupBy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> source<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token class-name">XSSFRow</span> row <span class="token operator">=</span> xssfSheet<span class="token punctuation">.</span><span class="token function">createRow</span><span class="token punctuation">(</span>xssfSheet<span class="token punctuation">.</span><span class="token function">getLastRowNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    source<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k1<span class="token punctuation">,</span> v1<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>  <span class="token punctuation">{</span>                        <span class="token class-name">XSSFCell</span> cell <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span>k1<span class="token punctuation">)</span><span class="token punctuation">;</span>                        cell<span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>                        cell<span class="token punctuation">.</span><span class="token function">setCellStyle</span><span class="token punctuation">(</span>workbook<span class="token punctuation">.</span><span class="token function">getCellStyleAt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment">//设置下拉联动</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> formula <span class="token operator">=</span> excelDTO<span class="token punctuation">.</span><span class="token function">getFormula</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>formula<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> rowNum <span class="token operator">=</span> <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token operator">?</span>source<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rowNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entry<span class="token operator">:</span> formula<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token class-name">CellRangeAddressList</span> regions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CellRangeAddressList</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token class-name">XSSFDataValidationHelper</span> xssfDataValidationHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XSSFDataValidationHelper</span><span class="token punctuation">(</span>xssfSheet<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token class-name">String</span> value <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    value <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"$"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token string">"INDIRECT("</span><span class="token operator">+</span>value<span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">")"</span><span class="token operator">:</span>value<span class="token punctuation">;</span>                    <span class="token class-name">DataValidationConstraint</span> explicitListConstraint <span class="token operator">=</span> xssfDataValidationHelper<span class="token punctuation">.</span><span class="token function">createFormulaListConstraint</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token class-name">DataValidation</span> dataValidation <span class="token operator">=</span> xssfDataValidationHelper<span class="token punctuation">.</span><span class="token function">createValidation</span><span class="token punctuation">(</span>explicitListConstraint<span class="token punctuation">,</span> regions<span class="token punctuation">)</span><span class="token punctuation">;</span>                    xssfSheet<span class="token punctuation">.</span><span class="token function">addValidationData</span><span class="token punctuation">(</span>dataValidation<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment">//导出文件</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            workbook<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"E:\\"</span><span class="token operator">+</span>excelDTO<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addCellStyle</span><span class="token punctuation">(</span><span class="token class-name">XSSFWorkbook</span> workbook<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//设置标题样式</span>        <span class="token class-name">XSSFCellStyle</span> normalStyle <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createCellStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置边框</span>        normalStyle<span class="token punctuation">.</span><span class="token function">setBorderBottom</span><span class="token punctuation">(</span><span class="token class-name">BorderStyle</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//下边框</span>        normalStyle<span class="token punctuation">.</span><span class="token function">setBorderLeft</span><span class="token punctuation">(</span><span class="token class-name">BorderStyle</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//左边框</span>        normalStyle<span class="token punctuation">.</span><span class="token function">setBorderTop</span><span class="token punctuation">(</span><span class="token class-name">BorderStyle</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上边框</span>        normalStyle<span class="token punctuation">.</span><span class="token function">setBorderRight</span><span class="token punctuation">(</span><span class="token class-name">BorderStyle</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//右边框</span>        <span class="token comment">//设置标题样式</span>        <span class="token class-name">XSSFCellStyle</span> titleStyle <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createCellStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置标题背景色</span>        titleStyle<span class="token punctuation">.</span><span class="token function">setFillForegroundColor</span><span class="token punctuation">(</span><span class="token constant">TITLE_COLOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        titleStyle<span class="token punctuation">.</span><span class="token function">setFillPattern</span><span class="token punctuation">(</span><span class="token class-name">FillPatternType</span><span class="token punctuation">.</span><span class="token constant">SOLID_FOREGROUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置边框</span>        titleStyle<span class="token punctuation">.</span><span class="token function">setBorderBottom</span><span class="token punctuation">(</span><span class="token class-name">BorderStyle</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//下边框</span>        titleStyle<span class="token punctuation">.</span><span class="token function">setBorderLeft</span><span class="token punctuation">(</span><span class="token class-name">BorderStyle</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//左边框</span>        titleStyle<span class="token punctuation">.</span><span class="token function">setBorderTop</span><span class="token punctuation">(</span><span class="token class-name">BorderStyle</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上边框</span>        titleStyle<span class="token punctuation">.</span><span class="token function">setBorderRight</span><span class="token punctuation">(</span><span class="token class-name">BorderStyle</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//右边框</span>        <span class="token class-name">Font</span> titleFont <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createFont</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        titleFont<span class="token punctuation">.</span><span class="token function">setBold</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        titleStyle<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span>titleFont<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置数据填充样式</span>        <span class="token class-name">XSSFCellStyle</span> sourceStyle <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createCellStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置边框</span>        sourceStyle<span class="token punctuation">.</span><span class="token function">setBorderBottom</span><span class="token punctuation">(</span><span class="token class-name">BorderStyle</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//下边框</span>        sourceStyle<span class="token punctuation">.</span><span class="token function">setBorderLeft</span><span class="token punctuation">(</span><span class="token class-name">BorderStyle</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//左边框</span>        sourceStyle<span class="token punctuation">.</span><span class="token function">setBorderTop</span><span class="token punctuation">(</span><span class="token class-name">BorderStyle</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上边框</span>        sourceStyle<span class="token punctuation">.</span><span class="token function">setBorderRight</span><span class="token punctuation">(</span><span class="token class-name">BorderStyle</span><span class="token punctuation">.</span><span class="token constant">THIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//右边框</span>        <span class="token class-name">Font</span> sourceFont <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createFont</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sourceFont<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span><span class="token class-name">IndexedColors</span><span class="token punctuation">.</span><span class="token constant">GREY_50_PERCENT</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sourceStyle<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span>sourceFont<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addMergeRegion</span><span class="token punctuation">(</span><span class="token class-name">XSSFSheet</span> xssfSheet<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> source<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> groupBy<span class="token punctuation">,</span> <span class="token keyword">int</span> deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Integer</span> cellIndex <span class="token operator">=</span> groupBy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>deep<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>map <span class="token operator">-&gt;</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cellIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        collect<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token comment">//最后一个分组后，开始excel插入数据</span>            <span class="token keyword">int</span> lastRowNum <span class="token operator">=</span> xssfSheet<span class="token punctuation">.</span><span class="token function">getLastRowNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//下一级递归</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>deep <span class="token operator">&lt;</span> groupBy<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">addMergeRegion</span><span class="token punctuation">(</span>xssfSheet<span class="token punctuation">,</span> v<span class="token punctuation">,</span> groupBy<span class="token punctuation">,</span> deep<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>deep <span class="token operator">==</span> groupBy<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token class-name">XSSFRow</span> row <span class="token operator">=</span> xssfSheet<span class="token punctuation">.</span><span class="token function">createRow</span><span class="token punctuation">(</span>xssfSheet<span class="token punctuation">.</span><span class="token function">getLastRowNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k1<span class="token punctuation">,</span> v1<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>  <span class="token punctuation">{</span>                        <span class="token class-name">XSSFCell</span> cell <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span>k1<span class="token punctuation">)</span><span class="token punctuation">;</span>                        cell<span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>                        cell<span class="token punctuation">.</span><span class="token function">setCellStyle</span><span class="token punctuation">(</span>xssfSheet<span class="token punctuation">.</span><span class="token function">getWorkbook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCellStyleAt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">//合并单元格</span>                <span class="token class-name">CellRangeAddress</span> cellRangeAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CellRangeAddress</span><span class="token punctuation">(</span>lastRowNum <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> lastRowNum <span class="token operator">+</span> v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cellIndex<span class="token punctuation">,</span> cellIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>                xssfSheet<span class="token punctuation">.</span><span class="token function">addMergedRegion</span><span class="token punctuation">(</span>cellRangeAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 添加字典值     * @param workbook     * @param dict     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createDictData</span><span class="token punctuation">(</span><span class="token class-name">XSSFWorkbook</span> workbook<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DictCellDTO</span><span class="token punctuation">&gt;</span></span> dict<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">XSSFSheet</span> sheet <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createSheet</span><span class="token punctuation">(</span><span class="token constant">DICT_DATA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//隐藏字典值</span><span class="token comment">//        workbook.setSheetHidden(workbook.getSheetIndex(sheet), true);</span>        <span class="token keyword">int</span> currentRow <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DictCellDTO</span> dictCell<span class="token operator">:</span> dict<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">XSSFRow</span> row <span class="token operator">=</span> sheet<span class="token punctuation">.</span><span class="token function">createRow</span><span class="token punctuation">(</span>currentRow<span class="token punctuation">)</span><span class="token punctuation">;</span>            row<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>dictCell<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dictData <span class="token operator">=</span> dictCell<span class="token punctuation">.</span><span class="token function">getDictData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dictData<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                row<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>dictData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment">//设置名称管理</span>            <span class="token class-name">String</span> range <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> currentRow<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> dictData<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> formula <span class="token operator">=</span> <span class="token constant">DICT_DATA</span> <span class="token operator">+</span> <span class="token string">"!"</span> <span class="token operator">+</span> range<span class="token punctuation">;</span>            <span class="token class-name">Name</span> name <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            name<span class="token punctuation">.</span><span class="token function">setNameName</span><span class="token punctuation">(</span>dictCell<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            name<span class="token punctuation">.</span><span class="token function">setRefersToFormula</span><span class="token punctuation">(</span>formula<span class="token punctuation">)</span><span class="token punctuation">;</span>            currentRow<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 计算formula     *     * @param offset   偏移量，如果给0，表示从A列开始，1，就是从B列     * @param rowId    第几行     * @param colCount 一共多少列     * @return 如果给入参 1,1,10. 表示从B1-K1。最终返回 $B$1:$K$1     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getRange</span><span class="token punctuation">(</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> rowId<span class="token punctuation">,</span> <span class="token keyword">int</span> colCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>colCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            colCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">char</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token char">'A'</span> <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>colCount <span class="token operator">&lt;=</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">char</span> end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>start <span class="token operator">+</span> colCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token string">"$"</span> <span class="token operator">+</span> start <span class="token operator">+</span> <span class="token string">"$"</span> <span class="token operator">+</span> rowId <span class="token operator">+</span> <span class="token string">":$"</span> <span class="token operator">+</span> end <span class="token operator">+</span> <span class="token string">"$"</span> <span class="token operator">+</span> rowId<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">char</span> endPrefix <span class="token operator">=</span> <span class="token char">'A'</span><span class="token punctuation">;</span>            <span class="token keyword">char</span> endSuffix <span class="token operator">=</span> <span class="token char">'A'</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>colCount <span class="token operator">-</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">26</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> colCount <span class="token operator">==</span> <span class="token number">51</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 26-51之间，包括边界（仅两次字母表计算）</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>colCount <span class="token operator">-</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">26</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 边界值</span>                    endSuffix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token char">'A'</span> <span class="token operator">+</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    endSuffix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token char">'A'</span> <span class="token operator">+</span> <span class="token punctuation">(</span>colCount <span class="token operator">-</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">26</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>colCount <span class="token operator">&gt;</span> <span class="token number">51</span> <span class="token operator">&amp;&amp;</span> colCount <span class="token operator">&lt;=</span> <span class="token number">701</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 51以上</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>colCount <span class="token operator">-</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">26</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    endSuffix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token char">'A'</span> <span class="token operator">+</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    endPrefix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>endPrefix <span class="token operator">+</span> <span class="token punctuation">(</span>colCount <span class="token operator">-</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">26</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    endSuffix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token char">'A'</span> <span class="token operator">+</span> <span class="token punctuation">(</span>colCount <span class="token operator">-</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">26</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    endPrefix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>endPrefix <span class="token operator">+</span> <span class="token punctuation">(</span>colCount <span class="token operator">-</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>colCount <span class="token operator">&gt;</span> <span class="token number">16383</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    colCount <span class="token operator">=</span> <span class="token number">16383</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">char</span> left <span class="token operator">=</span> <span class="token char">'A'</span><span class="token punctuation">;</span>                <span class="token keyword">char</span> centre <span class="token operator">=</span> <span class="token char">'A'</span><span class="token punctuation">;</span>                <span class="token keyword">char</span> right <span class="token operator">=</span> <span class="token char">'A'</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>colCount <span class="token operator">/</span> <span class="token number">26</span> <span class="token operator">%</span> <span class="token number">26</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    centre <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token char">'A'</span> <span class="token operator">+</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 边界值</span>                    left <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> <span class="token punctuation">(</span>colCount <span class="token operator">/</span> <span class="token number">26</span> <span class="token operator">/</span> <span class="token number">26</span> <span class="token operator">%</span> <span class="token number">26</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    left <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> <span class="token punctuation">(</span>colCount <span class="token operator">/</span> <span class="token number">26</span> <span class="token operator">/</span> <span class="token number">26</span> <span class="token operator">%</span> <span class="token number">26</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    centre <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>centre <span class="token operator">+</span> <span class="token punctuation">(</span>colCount <span class="token operator">/</span> <span class="token number">26</span> <span class="token operator">%</span> <span class="token number">26</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                right <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>right <span class="token operator">+</span> colCount <span class="token operator">%</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token string">"$"</span> <span class="token operator">+</span> start <span class="token operator">+</span> <span class="token string">"$"</span> <span class="token operator">+</span> rowId <span class="token operator">+</span> <span class="token string">":$"</span> <span class="token operator">+</span> left <span class="token operator">+</span> centre <span class="token operator">+</span> right <span class="token operator">+</span> <span class="token string">"$"</span> <span class="token operator">+</span> rowId<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token string">"$"</span> <span class="token operator">+</span> start <span class="token operator">+</span> <span class="token string">"$"</span> <span class="token operator">+</span> rowId <span class="token operator">+</span> <span class="token string">":$"</span> <span class="token operator">+</span> endPrefix <span class="token operator">+</span> endSuffix <span class="token operator">+</span> <span class="token string">"$"</span> <span class="token operator">+</span> rowId<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ExcelDTO类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExcelDTO</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * excel文件名     */</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> fileName<span class="token punctuation">;</span>    <span class="token comment">/**     * sheet名称     */</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> sheetName<span class="token punctuation">;</span>    <span class="token comment">/**     * 带下拉框的数据，支持多级联动     */</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DictCellDTO</span><span class="token punctuation">&gt;</span></span> dictCellList<span class="token punctuation">;</span>    <span class="token comment">/**     * 标题行     */</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> title<span class="token punctuation">;</span>    <span class="token comment">/**     * 需要显示在excel中的数据,map中Integer为列索引     */</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> source<span class="token punctuation">;</span>    <span class="token comment">/**     * 列和字典表达式的对应关系     */</span>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> formula<span class="token punctuation">;</span>    <span class="token comment">/**     * 分组的列索引，用于单元格合并     */</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> groupBy<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>DictCellDTO类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token annotation punctuation">@NoArgsConstructor</span><span class="token annotation punctuation">@AllArgsConstructor</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DictCellDTO</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * 名称管理器的标示     */</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>    <span class="token comment">/**     * 字典值     */</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dictData<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Util </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Util </tag>
            
            <tag> Poi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-优化</title>
      <link href="/mysql/mysql-you-hua/"/>
      <url>/mysql/mysql-you-hua/</url>
      
        <content type="html"><![CDATA[<h2 id="开启慢查询日志"><a href="#开启慢查询日志" class="headerlink" title="开启慢查询日志"></a>开启慢查询日志</h2><pre class="line-numbers language-none"><code class="language-none">#查看是否开启show variables like 'slow%';#开启set global slow_query_log = on ;#查看慢查询的时间临界值show variables like '%long%';#设置慢查询的时间标准set long_query_time=0.4;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意：重启mysql服务会让在交互界面设置的慢查询恢复到默认</p><p>永久生效的设置方法：修改配置文件 vi /etc/my.cnf</p><pre class="line-numbers language-none"><code class="language-none">[mysqld]slow_query_log = 1long_query_time = 0.1slow_query_log_file =/usr/local/mysql/mysql_slow.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>最后必须重启服务才能生效！</p><h2 id="开启性能详情"><a href="#开启性能详情" class="headerlink" title="开启性能详情"></a>开启性能详情</h2><pre class="line-numbers language-none"><code class="language-none">#查看性能详情是否开启show variables like '%profiling%';#开启性能记录功能set profiling = on ;#查看性能的记录show profiles;#查看语句的执行性能详情show profile for query 4;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="sql语句"><a href="#sql语句" class="headerlink" title="sql语句"></a>sql语句</h2><ul><li><p>尽量避免使用select *from ，尽量精确到想要的结果字段</p></li><li><p>尽量避免条件使用or</p></li><li><p>加上limit 限制行数，避免数据量过大消耗性能</p></li><li><p>使用模糊查询时，%放在前面是会使索引失效，执行过程查看explain </p></li><li><p>条件字段类型的转换</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-索引</title>
      <link href="/mysql/mysql-suo-yin/"/>
      <url>/mysql/mysql-suo-yin/</url>
      
        <content type="html"><![CDATA[<p>索引是一个单独的，存储在磁盘中上的数据库结构，它们包含着对数据表里的所有记录的引用指针。使用索引可以快速的找出在某列或多列中有特定值的行。</p><ul><li>索引类型</li></ul><p>index：普通索引</p><p>unique：唯一索引</p><p>primary key：主键索引</p><p>foreign key：外键索引</p><p>fulltext: 全文索引</p><p>组合索引</p><ul><li>创建索引</li></ul><pre class="line-numbers language-none"><code class="language-none">create index 索引名 on 表名 (字段名);alter table 表名 add index 索引名称 (字段名称);alter table 表名 add primary key (字段名);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>查看索引</li></ul><pre class="line-numbers language-none"><code class="language-none">show index from 表名\G<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>删除索引</li></ul><pre class="line-numbers language-none"><code class="language-none">drop index 索引名称 on 表名;alter table 表名 drop primary key;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>联合索引</li></ul><pre class="line-numbers language-none"><code class="language-none">alter table 表名 add index(字段1,字段2,字段3);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>联合索引的最左原则</p><ul><li>索引的优点：</li></ul><p>通过创建唯一索引，来保证数据库表中的每一行数据的唯一性。<br>•   可以加快数据的检索速度。<br>•   可以保证表数据的完整性与准确性</p><ul><li>索引的缺点：</li></ul><p>索引需要占用物理空间。<br>•   对表中的数据进行改动时，索引也需要跟着动态维护，降低了数据的维护速度。</p><p> 索引并非越多越好，过多的索引会增加数据的维护速度还有磁盘空间的浪费。</p><p>• 当表的数据量很大的时候，可以考虑建立索引。</p><p>• 表中经常查数据的字段，可以考虑建立索引。</p><p>• 想要保证表中数据的唯一性，可以考虑建立唯一索引。</p><p>• 想要保证俩张表中的数据的完整性跟准确性，可以考虑建立外键约束。</p><p>• 经常对多列数据进行查询时，可以考虑建立联合索引。</p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-DQL</title>
      <link href="/mysql/mysql-dql/"/>
      <url>/mysql/mysql-dql/</url>
      
        <content type="html"><![CDATA[<p>对数据表中的数据进行各种查询</p><h2 id="简单查询"><a href="#简单查询" class="headerlink" title="简单查询"></a>简单查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee<span class="token punctuation">;</span><span class="token keyword">select</span> empno<span class="token punctuation">,</span>ename<span class="token punctuation">,</span>job <span class="token keyword">as</span> ename_job <span class="token keyword">from</span> employee<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="精确条件查询"><a href="#精确条件查询" class="headerlink" title="精确条件查询"></a>精确条件查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee <span class="token keyword">where</span> ename<span class="token operator">=</span><span class="token string">'后裔'</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee <span class="token keyword">where</span> sal <span class="token operator">!=</span> <span class="token number">50000</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee <span class="token keyword">where</span> sal <span class="token operator">&lt;&gt;</span> <span class="token number">50000</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee <span class="token keyword">where</span> sal <span class="token operator">&gt;</span> <span class="token number">10000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="模糊条件查询"><a href="#模糊条件查询" class="headerlink" title="模糊条件查询"></a>模糊条件查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%aracter%'</span><span class="token punctuation">;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee  <span class="token keyword">where</span> ename <span class="token operator">like</span> <span class="token string">'林%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee <span class="token keyword">where</span> sal <span class="token operator">between</span> <span class="token number">10000</span> <span class="token operator">and</span> <span class="token number">30000</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee <span class="token keyword">where</span> hiredate <span class="token operator">between</span> <span class="token string">'2011-01-01'</span> <span class="token operator">and</span> <span class="token string">'2017-12-1'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="离散查询"><a href="#离散查询" class="headerlink" title="离散查询"></a>离散查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee <span class="token keyword">where</span> ename <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'猴子'</span><span class="token punctuation">,</span><span class="token string">'林俊杰'</span><span class="token punctuation">,</span><span class="token string">'小红'</span><span class="token punctuation">,</span><span class="token string">'小胡'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="清除重复值"><a href="#清除重复值" class="headerlink" title="清除重复值"></a>清除重复值</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span> <span class="token keyword">from</span> employee<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="统计查询（聚合函数）"><a href="#统计查询（聚合函数）" class="headerlink" title="统计查询（聚合函数）:"></a>统计查询（聚合函数）:</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token function">count</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>或者<span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> employee<span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>ename<span class="token punctuation">)</span> <span class="token keyword">from</span> employee<span class="token punctuation">;</span>        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  计算总和 <span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> employee<span class="token punctuation">;</span>        <span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    计算最大值<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee <span class="token keyword">where</span> sal<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">select</span>  <span class="token function">max</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> employee<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   计算平均值<span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> employee<span class="token punctuation">;</span>        <span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   计算最低值<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee <span class="token keyword">where</span> sal<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">select</span>  <span class="token function">min</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> employee<span class="token punctuation">)</span><span class="token punctuation">;</span>        concat函数： 起到连接作用<span class="token keyword">select</span> concat<span class="token punctuation">(</span>ename<span class="token punctuation">,</span><span class="token string">' 是 '</span><span class="token punctuation">,</span>job<span class="token punctuation">)</span> <span class="token keyword">as</span> aaaa <span class="token keyword">from</span> employee<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="分组查询"><a href="#分组查询" class="headerlink" title="分组查询"></a>分组查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> deptnu<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> employee <span class="token keyword">group</span> <span class="token keyword">by</span> deptnu<span class="token punctuation">;</span><span class="token keyword">select</span> deptnu<span class="token punctuation">,</span>job<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> employee <span class="token keyword">group</span> <span class="token keyword">by</span> deptnu<span class="token punctuation">,</span>job<span class="token punctuation">;</span><span class="token keyword">select</span> job<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> employee <span class="token keyword">group</span> <span class="token keyword">by</span> job<span class="token punctuation">;</span><span class="token comment">#分组筛选</span><span class="token keyword">select</span> job<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> employee <span class="token keyword">group</span> <span class="token keyword">by</span> job <span class="token keyword">having</span> job <span class="token operator">=</span><span class="token string">'文员'</span><span class="token punctuation">;</span><span class="token keyword">select</span>  deptnu<span class="token punctuation">,</span>job<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> employee <span class="token keyword">group</span> <span class="token keyword">by</span> deptnu<span class="token punctuation">,</span>job <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">select</span>  deptnu<span class="token punctuation">,</span>job<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 总数 <span class="token keyword">from</span> employee <span class="token keyword">group</span> <span class="token keyword">by</span> deptnu<span class="token punctuation">,</span>job <span class="token keyword">having</span> 总数<span class="token operator">&gt;=</span><span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="限制查询"><a href="#限制查询" class="headerlink" title="限制查询"></a>限制查询</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> XD<span class="token punctuation">.</span>employee <span class="token keyword">limit</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="exists"><a href="#exists" class="headerlink" title="exists"></a>exists</h2><p>exists型子查询后面是一个受限的select查询语句，如果exists后的内层查询能查出数据，则返回 TRUE 表示存在；为空则返回 FLASE则不存在。</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名 a <span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> 表名<span class="token number">2</span> <span class="token keyword">where</span> 条件<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept a <span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> employee b <span class="token keyword">where</span> a<span class="token punctuation">.</span>deptnu<span class="token operator">=</span>b<span class="token punctuation">.</span>deptnu<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept a <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> employee b <span class="token keyword">where</span> a<span class="token punctuation">.</span>deptnu<span class="token operator">=</span>b<span class="token punctuation">.</span>deptnu<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="连接查询"><a href="#连接查询" class="headerlink" title="连接查询"></a>连接查询</h2><ul><li>左连接称之为左外连接 右连接称之为右外连接 这俩个连接都是属于外连接</li><li>左连接关键字：left join 表名 on 条件 / left outer 表名 join on 条件 右连接关键字：right join 表名 on 条件/ right outer 表名 join on 条件</li><li>左连接说明： left join 是left outer join的简写，左(外)连接，左表(a_table)的记录将会全部表示出来， 而右表(b_table)只会显示符合搜索条件的记录。右表记录不足的地方均为NULL。</li><li>右连接说明：right join是right outer join的简写，与左(外)连接相反，右(外)连接，左表(a_table)只会显示符合搜索条件的记录，而右表(b_table)的记录将会全部表示出来。左表记录不足的地方均为NULL。</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> a<span class="token punctuation">.</span>dname<span class="token punctuation">,</span>b<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> dept a  <span class="token keyword">left</span> <span class="token keyword">join</span> employee b <span class="token keyword">on</span> a<span class="token punctuation">.</span>deptnu<span class="token operator">=</span>b<span class="token punctuation">.</span>deptnu<span class="token punctuation">;</span><span class="token keyword">select</span> b<span class="token punctuation">.</span>dname<span class="token punctuation">,</span>a<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> employee a  <span class="token keyword">right</span> <span class="token keyword">join</span>  dept b <span class="token keyword">on</span> b<span class="token punctuation">.</span>deptnu<span class="token operator">=</span>a<span class="token punctuation">.</span>deptnu<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="联合查询"><a href="#联合查询" class="headerlink" title="联合查询"></a>联合查询</h2><ul><li>内连接：获取两个表中字段匹配关系的记录</li><li>主要语法：INNER JOIN 表名 ON 条件;</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> a<span class="token punctuation">.</span>addr  <span class="token keyword">from</span> dept a <span class="token keyword">inner</span> <span class="token keyword">join</span> employee b <span class="token keyword">on</span> a<span class="token punctuation">.</span>deptnu<span class="token operator">=</span>b<span class="token punctuation">.</span>deptnu <span class="token operator">and</span> b<span class="token punctuation">.</span>ename<span class="token operator">=</span><span class="token string">'张飞'</span><span class="token punctuation">;</span><span class="token keyword">select</span> a<span class="token punctuation">.</span>addr <span class="token keyword">from</span> dept a<span class="token punctuation">,</span>employee b <span class="token keyword">where</span> a<span class="token punctuation">.</span>deptnu<span class="token operator">=</span>b<span class="token punctuation">.</span>deptnu <span class="token operator">and</span> b<span class="token punctuation">.</span>ename<span class="token operator">=</span><span class="token string">'张飞'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>联合查询：就是把多个查询语句的查询结果结合在一起</li></ul><p>​主要语法1：… UNION … （去除重复） 主要语法2：… UNION ALL …（不去重复）</p><ul><li><p>union查询的注意事项：</p><ol><li><p>两个select语句的查询结果的“字段数”必须一致；</p></li><li><p>通常，也应该让两个查询语句的字段类型具有一致性；</p></li><li><p>也可以联合更多的查询结果；</p></li><li><p>用到order by排序时，需要加上limit（加上最大条数就行），需要对子句用括号括起来</p></li></ol></li></ul><p>#eg:对销售员的工资从低到高排序，而文员的工资从高到低排序</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee a <span class="token keyword">where</span> a<span class="token punctuation">.</span>job <span class="token operator">=</span> <span class="token string">'销售员'</span>  <span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>sal <span class="token keyword">limit</span> <span class="token number">999999</span> <span class="token punctuation">)</span> <span class="token keyword">union</span>  <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee b <span class="token keyword">where</span> b<span class="token punctuation">.</span>job <span class="token operator">=</span> <span class="token string">'文员'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span>sal <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">999999</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-存储引擎</title>
      <link href="/mysql/mysql-cun-chu-yin-qing/"/>
      <url>/mysql/mysql-cun-chu-yin-qing/</url>
      
        <content type="html"><![CDATA[<p>数据库引擎是数据库底层软件组件，不同的存储引擎提供不同的存储机制，索引技巧，锁定水平等功能，使用不同的数据库引擎，可以获得特定的功能</p><ul><li>查看引擎</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#如何查看数据库支持的引擎</span><span class="token keyword">show</span> engines<span class="token punctuation">;</span><span class="token comment">#查看当前数据的引擎：</span><span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> 表名\G<span class="token comment">#查看当前库所有表的引擎：</span><span class="token keyword">show</span> <span class="token keyword">table</span> <span class="token keyword">status</span>\G<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建和修改</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> yingqin <span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">,</span>name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token string">'InnoDB'</span><span class="token punctuation">;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> 表名 <span class="token keyword">engine</span><span class="token operator">=</span><span class="token string">'MyiSAm'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>MyISAM与InnoDB的区别</li></ul><table><thead><tr><th align="center">区别项</th><th align="center">Innodb</th><th align="center">myisam</th></tr></thead><tbody><tr><td align="center">事务</td><td align="center">支持</td><td align="center">不支持</td></tr><tr><td align="center">锁粒度</td><td align="center">行锁，适合高并发</td><td align="center">表锁，不适合高并发</td></tr><tr><td align="center">是否默认</td><td align="center">默认</td><td align="center">非默认</td></tr><tr><td align="center">支持外键</td><td align="center">支持外键</td><td align="center">不支持</td></tr><tr><td align="center">适合场景</td><td align="center">读写均衡,写大于读场景，需要事务</td><td align="center">读多写少场景，不需要事务</td></tr><tr><td align="center">全文索引</td><td align="center">不支持，可以通过插件实现, 更多使用ElasticSearch</td><td align="center">支持全文索引</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-存储过程</title>
      <link href="/mysql/mysql-cun-chu-guo-cheng/"/>
      <url>/mysql/mysql-cun-chu-guo-cheng/</url>
      
        <content type="html"><![CDATA[<p>存储过程是为了完成特定功能的SQL语句集</p><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><p>创建</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">procedure</span> 名称 <span class="token punctuation">(</span>参数<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>        <span class="token keyword">begin</span>         过程体<span class="token punctuation">;</span>         过程体<span class="token punctuation">;</span>         <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数：in、out、inout 参数名称 类型（长度）<br>        in：表示调用者向过程传入值（传入值可以是字面量或变量）<br>        out：表示过程向调用者传出值(可以返回多个值)（传出值只能是变量）<br>        inout：既表示调用者向过程传入值，又表示过程向调用者传出值（值只能是变量）</p><p>删除</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">procedure</span> 名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">procedure</span> 名称\G<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">声明变量：<span class="token keyword">declare</span> 变量名 类型<span class="token punctuation">(</span>长度<span class="token punctuation">)</span> <span class="token keyword">default</span> 默认值<span class="token punctuation">;</span>给变量赋值：<span class="token keyword">set</span> @变量名<span class="token operator">=</span>值<span class="token punctuation">;</span>调用存储命令：<span class="token keyword">call</span> 名称<span class="token punctuation">(</span>@变量名<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>eg:</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">delimiter</span> <span class="token comment">//</span>    mysql<span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">procedure</span>  name<span class="token punctuation">(</span><span class="token operator">in</span> n <span class="token keyword">int</span><span class="token punctuation">)</span>        <span class="token operator">-</span><span class="token operator">&gt;</span>             <span class="token keyword">begin</span>        <span class="token operator">-</span><span class="token operator">&gt;</span>             <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> employee <span class="token keyword">limit</span> n<span class="token punctuation">;</span>        <span class="token operator">-</span><span class="token operator">&gt;</span>             <span class="token keyword">end</span>        <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token comment">//</span>    Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>    mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token variable">@n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>        <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token comment">//</span>    Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>    mysql<span class="token operator">&gt;</span>     mysql<span class="token operator">&gt;</span> <span class="token keyword">call</span> name<span class="token punctuation">(</span><span class="token variable">@n</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-触发器</title>
      <link href="/mysql/mysql-hong-fa-qi/"/>
      <url>/mysql/mysql-hong-fa-qi/</url>
      
        <content type="html"><![CDATA[<p>触发器就是监视某种情况，并触发某种操作</p><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><p>新增触发器</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">trigger</span> 触发器名称  <span class="token keyword">after</span><span class="token operator">/</span>before   <span class="token keyword">insert</span><span class="token operator">/</span><span class="token keyword">update</span><span class="token operator">/</span><span class="token keyword">delete</span> <span class="token keyword">on</span> 表名          <span class="token keyword">for each row</span>        <span class="token keyword">begin</span>        <span class="token keyword">sql</span>语句<span class="token punctuation">;</span>        <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>after/before:可以设置为事件发生前或后</p></li><li><p>insert/update/delete:它们可以在执行insert、update或delete的过程中触发</p></li><li><p>for each row:每隔一行执行一次动作</p></li></ul><p>删除触发器</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">trigger</span> 触发器名称<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>eg:</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">delimiter</span> <span class="token comment">// 自定义语句的结束符号</span>    mysql<span class="token operator">&gt;</span> <span class="token keyword">delimiter</span> <span class="token comment">//</span>    mysql<span class="token operator">&gt;</span>     mysql<span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">trigger</span> trig_work <span class="token keyword">after</span> <span class="token keyword">insert</span> <span class="token keyword">on</span> work_time_delay        <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">for each row</span>        <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">begin</span>        <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">update</span> employee <span class="token keyword">set</span> sal<span class="token operator">=</span>sal<span class="token operator">-</span><span class="token number">100</span> <span class="token keyword">where</span> empno<span class="token operator">=</span>new<span class="token punctuation">.</span>empno<span class="token punctuation">;</span>        <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">end</span>        <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token comment">//</span>    Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>new：指的是事件发生before或者after保存的新数据</p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-视图</title>
      <link href="/mysql/mysql-shi-tu/"/>
      <url>/mysql/mysql-shi-tu/</url>
      
        <content type="html"><![CDATA[<p>视图（view）是一种虚拟存在的表，是一个逻辑表，它本身是不包含数据的。作为一个select语句保存在数据字典中的。<br>通过视图，可以展现基表（用来创建视图的表叫做基表base table）的部分数据，视图的数据就是来自于基表</p><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><ul><li>创建</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">view</span> <span class="token operator">&lt;</span>视图名称<span class="token operator">&gt;</span> <span class="token keyword">as</span> <span class="token keyword">select</span> 语句<span class="token punctuation">;</span><span class="token keyword">create</span> <span class="token keyword">view</span> <span class="token operator">&lt;</span>视图名称<span class="token operator">&gt;</span> <span class="token punctuation">(</span>字段<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">select</span> 语句<span class="token punctuation">;</span><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">view</span> <span class="token operator">&lt;</span>视图名称<span class="token operator">&gt;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>修改</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">view</span> <span class="token operator">&lt;</span>视图名称<span class="token operator">&gt;</span> <span class="token keyword">as</span> <span class="token keyword">select</span> 语句<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>删除</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">view</span> <span class="token operator">&lt;</span>视图名称<span class="token operator">&gt;</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><p>1）简单：使用视图的用户完全不需要关心后面对应的表的结构、关联条件和筛选条件，对用户来说已经是过滤好的复合条件的结果集。</p><p>2）安全：使用视图的用户只能访问他们被允许查询的结果集，对表的权限管理并不能限制到某个行某个列，但是通过视图就可以简单的实现。</p><p>3）数据独立：一旦视图的结构确定了，可以屏蔽表结构变化对用户的影响，源表增加列对视图没有影响;源表修改列名，则可以通过修改视图来解决，不会造成对访问者的影响。<br>　　<br>4）不占用空间：视图是逻辑上的表，不占用内存空间</p><p>总而言之，使用视图的大部分情况是为了保障数据安全性，提高查询效率。</p><h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><p> 1)性能差：sql server必须把视图查询转化成对基本表的查询，如果这个视图是由一个复杂的多表查询所定义，那么，即使是视图的一个简单查询，sql server也要把它变成一个复杂的结合体，需要花费一定的时间。</p><p> 2)修改限制：当用户试图修改试图的某些信息时，数据库必须把它转化为对基本表的某些信息的修改，对于简单的试图来说，这是很方便的，但是，对于比较复杂的试图，可能是不可修改的。</p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-事务</title>
      <link href="/mysql/mysql-shi-wu/"/>
      <url>/mysql/mysql-shi-wu/</url>
      
        <content type="html"><![CDATA[<ul><li>事务的开启与提交：</li><li>事务的开启：begin; start transaction;</li><li>事务的提交：commit;</li><li>事务的回滚：rollback;</li></ul><p>开启autocommit（临时生效）：</p><p>OFF（0）：表示关闭 ON （1）：表示开启</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">set</span> autocommit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'autocommit'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Drools-动态加载规则</title>
      <link href="/drools/drools-dong-tai-jia-zai-gui-ze/"/>
      <url>/drools/drools-dong-tai-jia-zai-gui-ze/</url>
      
        <content type="html"><![CDATA[<p>drools规则引擎从数据动态读取规则，并执行</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Drools规则引擎实现 * @author Iseven.yang * @date 2021/10/4 19:52 */</span><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"droolsRuleEngineService"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DroolsRuleEngineServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">RuleEngineService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">RuleDao</span> ruleDao<span class="token punctuation">;</span>    <span class="token comment">//由于创建KieBase性能消耗大,将ruleId对于的对象放在本地缓存中</span>    <span class="token keyword">private</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">KieBase</span><span class="token punctuation">&gt;</span></span> kieBaseCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment">// 设置最后一次写入或访问后经过固定时间过期,一周不再访问，就过期</span>            <span class="token punctuation">.</span><span class="token function">expireAfterAccess</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span>            <span class="token comment">// 初始的缓存空间大小</span>            <span class="token punctuation">.</span><span class="token function">initialCapacity</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>            <span class="token comment">// 缓存的最大条数</span>            <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 执行规则     * @param ruleId     * @param param     * @return java.lang.Object     * @author Iseven.yang     * @date 2021/10/5 11:22     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">executeRule</span><span class="token punctuation">(</span><span class="token class-name">String</span> ruleId<span class="token punctuation">,</span> <span class="token class-name">JSONObject</span> param<span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"执行规则：ruleId={}, param={}"</span><span class="token punctuation">,</span> ruleId<span class="token punctuation">,</span> param<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//获取规则库</span>        <span class="token class-name">KieBase</span> kieBase <span class="token operator">=</span> <span class="token function">getKieBase</span><span class="token punctuation">(</span>ruleId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//创建规则库执行对象</span>        <span class="token class-name">KieSession</span> kieSession <span class="token operator">=</span> kieBase<span class="token punctuation">.</span><span class="token function">newKieSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//插入规则执行参数</span>        <span class="token class-name">JSONObject</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        root<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"reqParam"</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>        root<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        kieSession<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//执行规则库中的所有规则</span>        kieSession<span class="token punctuation">.</span><span class="token function">fireAllRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//销毁</span>        kieSession<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 根据规则id获取规则引擎中的执行库对象     * @param ruleId     * @return org.kie.api.KieBase     * @author Iseven.yang     * @date 2021/10/4 21:11     */</span>    <span class="token keyword">private</span> <span class="token class-name">KieBase</span> <span class="token function">getKieBase</span><span class="token punctuation">(</span><span class="token class-name">String</span> ruleId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//查看缓存是否存在KieBase</span>        <span class="token keyword">return</span> kieBaseCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ruleId<span class="token punctuation">,</span> key <span class="token operator">-&gt;</span> <span class="token function">loadKieBase</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 从数据库获取规则脚本生成规则对象     * @param key     * @return org.kie.api.KieBase     * @author Iseven.yang     * @date 2021/10/5 11:18     */</span>    <span class="token keyword">private</span> <span class="token class-name">KieBase</span> <span class="token function">loadKieBase</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"从数据库获取规则加载新的规则库对象，ruleId=${}"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//查询规则详情</span>        <span class="token class-name">RuleDO</span> rule <span class="token operator">=</span> ruleDao<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//创建一个新的KieBase</span>        <span class="token class-name">KieHelper</span> kieHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KieHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        kieHelper<span class="token punctuation">.</span><span class="token function">addContent</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ResourceType</span><span class="token punctuation">.</span><span class="token constant">DRL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">KieBase</span> kieBase <span class="token operator">=</span> kieHelper<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"从数据库获取规则加载新的规则库对象，ruleId=${}, 规则加载成功"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> kieBase<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Drools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Drools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-DML</title>
      <link href="/mysql/mysql-dml/"/>
      <url>/mysql/mysql-dml/</url>
      
        <content type="html"><![CDATA[<p>对表的数据进行增删改</p><h2 id="插入表数据"><a href="#插入表数据" class="headerlink" title="插入表数据"></a>插入表数据</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> 表名（字段名） <span class="token keyword">values</span>（字段对应值）<span class="token punctuation">;</span><span class="token keyword">insert</span> <span class="token keyword">into</span> 表名 <span class="token keyword">values</span>（所有字段对应值）<span class="token punctuation">;</span><span class="token keyword">insert</span> <span class="token keyword">into</span> 表名<span class="token number">1</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名<span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">insert</span> <span class="token keyword">into</span> 表名<span class="token number">1</span>（字段名<span class="token number">1</span>，字段名<span class="token number">2</span>） <span class="token keyword">select</span> 字段名<span class="token number">1</span>，字段名<span class="token number">2</span> <span class="token keyword">from</span> 表名<span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">create</span> <span class="token keyword">table</span> 表名<span class="token number">1</span> <span class="token keyword">as</span> <span class="token keyword">select</span> 字段名<span class="token number">1</span>，字段名<span class="token number">2</span> <span class="token keyword">from</span> 表名<span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">insert</span> <span class="token keyword">into</span> 表名  <span class="token punctuation">(</span>字段名<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>对应值<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>对应值<span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>对应值<span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">update</span> 表名 <span class="token keyword">set</span> 字段名<span class="token number">1</span><span class="token operator">=</span>值<span class="token number">1</span> <span class="token keyword">where</span> 字段名<span class="token operator">=</span>值<span class="token punctuation">;</span><span class="token keyword">update</span> 表名 <span class="token keyword">set</span> 字段名<span class="token number">1</span><span class="token operator">=</span>值<span class="token number">1</span><span class="token punctuation">,</span>字段名<span class="token number">2</span><span class="token operator">=</span>值<span class="token number">2</span> <span class="token keyword">where</span> 字段名<span class="token operator">=</span>值<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#删除表记录</span><span class="token keyword">delete</span> <span class="token keyword">from</span> 表名 <span class="token keyword">where</span> 字段名<span class="token operator">=</span>值<span class="token punctuation">;</span>删除整个表<span class="token keyword">truncate</span> <span class="token keyword">table</span> 表名<span class="token punctuation">;</span><span class="token keyword">drop</span> <span class="token keyword">table</span> 表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>delele 会把删除的操作记录给记录起来，以便数据回退，不会释放空间，而且不会删除定义。</li><li>truncate不会记录删除操作，会把表占用的空间恢复到最初，不会删除定义</li><li>drop会删除整张表，释放表占用的空间</li><li>删除速度：drop &gt; truncate &gt; delete</li></ul>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flowable-自定义规则引擎</title>
      <link href="/flowable/flowable-zi-ding-yi-gui-ze-yin-qing/"/>
      <url>/flowable/flowable-zi-ding-yi-gui-ze-yin-qing/</url>
      
        <content type="html"><![CDATA[<p>业务中需要复杂的规则判断，或者flowable无法满足规则需求，或者需要调用自己的规则服务做判断</p><h2 id="编写一个规则服务"><a href="#编写一个规则服务" class="headerlink" title="编写一个规则服务"></a>编写一个规则服务</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RuleService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">RuleEngineService</span> ruleEngineService<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">String</span> ruleExpression<span class="token punctuation">,</span> <span class="token class-name">DelegateExecution</span> execution<span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"开始执行规则 ================&gt; {}"</span><span class="token punctuation">,</span> ruleExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variables <span class="token operator">=</span> execution<span class="token punctuation">.</span><span class="token function">getVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取全局变量</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> variablesLocal <span class="token operator">=</span> execution<span class="token punctuation">.</span><span class="token function">getVariablesLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取局部变量</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"variables -&gt; {} "</span><span class="token punctuation">,</span> variables<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"variablesLocal -&gt; {} "</span><span class="token punctuation">,</span> variablesLocal<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> param <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        param<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>variables<span class="token punctuation">)</span><span class="token punctuation">;</span>        param<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>variablesLocal<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Boolean</span> ruleResult <span class="token operator">=</span> ruleEngineService<span class="token punctuation">.</span><span class="token function">executeRule</span><span class="token punctuation">(</span>ruleExpression<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"规则[{}]执行结果 -&gt; {}"</span><span class="token punctuation">,</span> ruleExpression<span class="token punctuation">,</span> ruleResult<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> ruleResult<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>RuleEngineService服务可以使用Groovy或者Drools实现，<a href="https://aacopy.gitee.io/2021/11/22/Groovy/Groovy-%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/">点击查看Groovy示例</a></p><p>在xml编写规则表达式时，可以直接改为调用RuleService.execute()</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sequenceFlow</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Flow_1kh3iy1<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>审批通过<span class="token entity" title="&amp;">&amp;#38;</span><span class="token entity" title="&amp;">&amp;#38;</span>f3==a<span class="token punctuation">"</span></span> <span class="token attr-name">sourceRef</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Gateway_0corauh<span class="token punctuation">"</span></span> <span class="token attr-name">targetRef</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Activity_1wg31no<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditionExpression</span> <span class="token attr-name"><span class="token namespace">xsi:</span>type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tFormalExpression<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>${ruleService.execute('<span class="token cdata">&lt;![CDATA[latestActionButton=="SP"&amp;&amp;formValue.f3=="a"]]&gt;</span>', execution)}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditionExpression</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sequenceFlow</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Flowable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flowable </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis-plus-多数据源</title>
      <link href="/mybatis/mybatis-plus-duo-shu-ju-yuan/"/>
      <url>/mybatis/mybatis-plus-duo-shu-ju-yuan/</url>
      
        <content type="html"><![CDATA[<p>官方文档地址：<a href="https://mp.baomidou.com/guide/dynamic-datasource.html#%E6%96%87%E6%A1%A3-documentation">https://mp.baomidou.com/guide/dynamic-datasource.html#%E6%96%87%E6%A1%A3-documentation</a></p><h2 id="1-常规使用"><a href="#1-常规使用" class="headerlink" title="1. 常规使用"></a>1. 常规使用</h2><ol><li>引入dynamic-datasource-spring-boot-starter</li></ol><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dynamic-datasource-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>配置数据源</li></ol><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>    <span class="token key atrule">dynamic</span><span class="token punctuation">:</span>      <span class="token key atrule">primary</span><span class="token punctuation">:</span> master <span class="token comment">#设置默认的数据源或者数据源组,默认值即为master</span>      <span class="token key atrule">strict</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#严格匹配数据源,默认false. true未匹配到指定数据源时抛异常,false使用默认数据源</span>      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>        <span class="token key atrule">master</span><span class="token punctuation">:</span>          <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//xx.xx.xx.xx<span class="token punctuation">:</span>3306/dynamic          <span class="token key atrule">username</span><span class="token punctuation">:</span> root          <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>          <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver <span class="token comment"># 3.2.0开始支持SPI可省略此配置</span>        <span class="token key atrule">slave_1</span><span class="token punctuation">:</span>          <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//xx.xx.xx.xx<span class="token punctuation">:</span>3307/dynamic          <span class="token key atrule">username</span><span class="token punctuation">:</span> root          <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>          <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver        <span class="token key atrule">slave_2</span><span class="token punctuation">:</span>          <span class="token key atrule">url</span><span class="token punctuation">:</span> ENC(xxxxx) <span class="token comment"># 内置加密,使用请查看详细文档</span>          <span class="token key atrule">username</span><span class="token punctuation">:</span> ENC(xxxxx)          <span class="token key atrule">password</span><span class="token punctuation">:</span> ENC(xxxxx)          <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver       <span class="token comment">#......省略</span>       <span class="token comment">#以上会配置一个默认库master，一个组slave下有两个子库slave_1,slave_2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>切换数据源</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token annotation punctuation">@DS</span><span class="token punctuation">(</span><span class="token string">"slave"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>  <span class="token annotation punctuation">@Autowired</span>  <span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token class-name">List</span> <span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForList</span><span class="token punctuation">(</span><span class="token string">"select * from user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>  <span class="token annotation punctuation">@DS</span><span class="token punctuation">(</span><span class="token string">"slave_1"</span><span class="token punctuation">)</span>  <span class="token keyword">public</span> <span class="token class-name">List</span> <span class="token function">selectByCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForList</span><span class="token punctuation">(</span><span class="token string">"select * from user where age &gt;10"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-动态添加数据源并执行动态sql"><a href="#2-动态添加数据源并执行动态sql" class="headerlink" title="2. 动态添加数据源并执行动态sql"></a>2. 动态添加数据源并执行动态sql</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * @author iseven.yang * @date 2021/11/2 16:51 */</span><span class="token annotation punctuation">@Service</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlQueryServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SqlQueryService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"hikariDataSourceCreator"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">DataSourceCreator</span> dataSourceCreator<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">REGEX</span> <span class="token operator">=</span> <span class="token string">"#\\{(\\w*)\\}"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">REPLACE</span> <span class="token operator">=</span> <span class="token string">"?"</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">DynamicRoutingDataSource</span> dynamicRoutingDataSource <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DynamicRoutingDataSource</span><span class="token punctuation">)</span> dataSource<span class="token punctuation">;</span>        <span class="token keyword">return</span> dynamicRoutingDataSource<span class="token punctuation">.</span><span class="token function">getDataSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">addDataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSourceQry</span> dataSourceQry<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">DataSourceProperty</span> dataSourceProperty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataSourceProperty<span class="token punctuation">.</span><span class="token function">setPoolName</span><span class="token punctuation">(</span>dataSourceQry<span class="token punctuation">.</span><span class="token function">getDbKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataSourceProperty<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataSourceProperty<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>dataSourceQry<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataSourceProperty<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>dataSourceQry<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        dataSourceProperty<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>dataSourceQry<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DataSource</span> newDataSource <span class="token operator">=</span> dataSourceCreator<span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span>dataSourceProperty<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DynamicRoutingDataSource</span> dynamicRoutingDataSource <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DynamicRoutingDataSource</span><span class="token punctuation">)</span> dataSource<span class="token punctuation">;</span>        dynamicRoutingDataSource<span class="token punctuation">.</span><span class="token function">addDataSource</span><span class="token punctuation">(</span>dataSourceQry<span class="token punctuation">.</span><span class="token function">getDbKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> dynamicRoutingDataSource<span class="token punctuation">.</span><span class="token function">getDataSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryForMap</span><span class="token punctuation">(</span><span class="token class-name">DbQueryQry</span> dbQueryQry<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isAnyBlank</span><span class="token punctuation">(</span>dbQueryQry<span class="token punctuation">.</span><span class="token function">getDbKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dbQueryQry<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> sql <span class="token operator">=</span> dbQueryQry<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> param <span class="token operator">=</span> dbQueryQry<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//将#{xxx}转成?， 将map参数结构转成数组</span>        <span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token constant">REGEX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> matchList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            matchList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        sql <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token constant">REPLACE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sqlArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>matchList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>matchList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            sqlArgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>matchList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> matchList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dbQueryQry<span class="token punctuation">.</span><span class="token function">getDbKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> queryList <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> sqlArgs<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ColumnMapRowMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>queryList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> queryList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"移除当前线程数据源"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-多数据源测试全量代码"><a href="#3-多数据源测试全量代码" class="headerlink" title="3. 多数据源测试全量代码"></a>3. 多数据源测试全量代码</h2><ul><li>创建springboot工程，引入maven依赖</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.7.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.aacopy.learn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatisplus-learn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>mybatisplus-learn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>mybatisplus-learn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dynamic-datasource-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>添加配置项application.yml</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>    <span class="token key atrule">dynamic</span><span class="token punctuation">:</span>      <span class="token key atrule">primary</span><span class="token punctuation">:</span> aacopy      <span class="token key atrule">strict</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>        <span class="token key atrule">aacopy</span><span class="token punctuation">:</span>          <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.25.216<span class="token punctuation">:</span>3306/aacopy<span class="token punctuation">?</span>useSSL=false<span class="token important">&amp;autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8</span>          <span class="token key atrule">username</span><span class="token punctuation">:</span> root          <span class="token key atrule">password</span><span class="token punctuation">:</span> aacopy.cn        <span class="token key atrule">aacopy1</span><span class="token punctuation">:</span>          <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.25.216<span class="token punctuation">:</span>3306/aacopy1<span class="token punctuation">?</span>useSSL=false<span class="token important">&amp;autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8</span>          <span class="token key atrule">username</span><span class="token punctuation">:</span> root          <span class="token key atrule">password</span><span class="token punctuation">:</span> aacopy.cn<span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>    <span class="token key atrule">log-impl</span><span class="token punctuation">:</span> org.apache.ibatis.logging.stdout.StdOutImpl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>启动类上添加扫描注解</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"cn.aacopy.learn.mybatisplus.mapper"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisplusLearnApplication</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MybatisplusLearnApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>创建两个数据库。这里创建了aacopy和aacopy1</p><ul><li>aacopy中创建表goods</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- aacopy.goods definition</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>goods<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>num<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>version<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'1'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">11</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_unicode_ci<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>aacopy1中创建表</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- aacopy1.`user` definition</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_unicode_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_unicode_ci<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>用代码生成工具生成对应的代码文件</p></li></ul><p><img src="/images/Mybatis-plus-%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90/image-20221103233842920.png"></p><ul><li>因为user表不是默认数据源中的表，所以需要指定对应的数据源，类上添加@DS(“aacopy1”)属性</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token annotation punctuation">@DS</span><span class="token punctuation">(</span><span class="token string">"aacopy1"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserMapper</span><span class="token punctuation">,</span> <span class="token class-name">UserDO</span><span class="token punctuation">&gt;</span></span>    <span class="token keyword">implements</span> <span class="token class-name">UserService</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>编写一个测试类</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>mybatisplus</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>domain<span class="token punctuation">.</span></span><span class="token class-name">GoodsDO</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>domain<span class="token punctuation">.</span></span><span class="token class-name">UserDO</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">GoodsService</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">UserService</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author iseven.yang * @date 2022/11/3 23:22 */</span><span class="token annotation punctuation">@SpringBootTest</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicDsTest</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">GoodsService</span> goodsService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>    <span class="token comment">/**     * 测试多数据源     */</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">GoodsDO</span> goodsDO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GoodsDO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        goodsDO<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"测试物品"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        goodsDO<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span><span class="token number">100L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        goodsService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>goodsDO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GoodsDO</span><span class="token punctuation">&gt;</span></span> goodsDOS <span class="token operator">=</span> goodsService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        goodsDOS<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>o <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"物品："</span> <span class="token operator">+</span> o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"================================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">UserDO</span> userDO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userDO<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"测试人员"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userDO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDO</span><span class="token punctuation">&gt;</span></span> userDOS <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userDOS<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>o <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"人员："</span> <span class="token operator">+</span> o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>执行结果</li></ul><pre class="line-numbers language-none"><code class="language-none">Creating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@25be445f] was not registered for synchronization because synchronization is not activeJDBC Connection [HikariProxyConnection@1330143761 wrapping com.mysql.cj.jdbc.ConnectionImpl@51e3d37e] will not be managed by Spring==&gt;  Preparing: INSERT INTO goods ( name, num ) VALUES ( ?, ? )==&gt; Parameters: 测试物品(String), 100(Long)&lt;==    Updates: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@25be445f]Creating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@5c134052] was not registered for synchronization because synchronization is not activeJDBC Connection [HikariProxyConnection@1112569408 wrapping com.mysql.cj.jdbc.ConnectionImpl@51e3d37e] will not be managed by Spring==&gt;  Preparing: SELECT id,name,num,version FROM goods==&gt; Parameters: &lt;==    Columns: id, name, num, version&lt;==        Row: 11, 测试物品, 100, 1&lt;==      Total: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@5c134052]2022-11-03 23:29:12.757  INFO 17156 --- [           main] c.a.learn.mybatisplus.DynamicDsTest      : 物品：GoodsDO(id=11, name=测试物品, num=100, version=1)2022-11-03 23:29:12.757  INFO 17156 --- [           main] c.a.learn.mybatisplus.DynamicDsTest      : =================================Creating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3c232051] was not registered for synchronization because synchronization is not activeJDBC Connection [HikariProxyConnection@366008009 wrapping com.mysql.cj.jdbc.ConnectionImpl@3ab35b9c] will not be managed by Spring==&gt;  Preparing: INSERT INTO user ( name ) VALUES ( ? )==&gt; Parameters: 测试人员(String)&lt;==    Updates: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3c232051]Creating a new SqlSessionSqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@4130a648] was not registered for synchronization because synchronization is not activeJDBC Connection [HikariProxyConnection@1644128841 wrapping com.mysql.cj.jdbc.ConnectionImpl@3ab35b9c] will not be managed by Spring==&gt;  Preparing: SELECT id,name FROM user==&gt; Parameters: &lt;==    Columns: id, name&lt;==        Row: 1, 测试人员&lt;==      Total: 1Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@4130a648]2022-11-03 23:29:12.769  INFO 17156 --- [           main] c.a.learn.mybatisplus.DynamicDsTest      : 人员：UserDO(id=1, name=测试人员)2022-11-03 23:29:12.785  INFO 17156 --- [ionShutdownHook] c.b.d.d.DynamicRoutingDataSource         : dynamic-datasource start closing ....2022-11-03 23:29:12.785  INFO 17156 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : aacopy1 - Shutdown initiated...2022-11-03 23:29:12.791  INFO 17156 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : aacopy1 - Shutdown completed.2022-11-03 23:29:12.791  INFO 17156 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : aacopy - Shutdown initiated...2022-11-03 23:29:12.792  INFO 17156 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : aacopy - Shutdown completed.2022-11-03 23:29:12.792  INFO 17156 --- [ionShutdownHook] c.b.d.d.DynamicRoutingDataSource         : dynamic-datasource all closed success,bye<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-SQL表名的动态替换（多租户场景）"><a href="#4-SQL表名的动态替换（多租户场景）" class="headerlink" title="4. SQL表名的动态替换（多租户场景）"></a>4. SQL表名的动态替换（多租户场景）</h2><p>在多租户场景中，如果使用物理隔离，将不同的租户的数据放在不同的表里，在查询SQL是，需要通过动态变更表名来路由到对应的租户表中</p><ul><li>代码逻辑实现</li></ul><pre class="line-numbers language-none"><code class="language-none">@Configurationpublic class MybatisPlusConfig {    @Bean    public MybatisPlusInterceptor mybatisPlusInterceptor() {        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();        // 添加乐观锁插件        interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());        //设置动态更新表名插件        DynamicTableNameInnerInterceptor dynamicTableNameInnerInterceptor                = new DynamicTableNameInnerInterceptor();        //设置表名替换规则        dynamicTableNameInnerInterceptor.setTableNameHandler((sql, tableName) -&gt; {            // 模拟从当前线程变量中获取当前用户的租户id            Long tenantId = 1L;            // 将表面后面加上 _tenantId            return tableName + "_" + tenantId;        });        interceptor.addInnerInterceptor(dynamicTableNameInnerInterceptor);        return interceptor;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改后的sql：<code>INSERT INTO goods_1 ( name, num ) VALUES ( ?, ? )</code></p><ul><li>官方代码示例：<a href="https://gitee.com/baomidou/mybatis-plus-samples/blob/master/mybatis-plus-sample-dynamic-tablename/src/main/java/com/baomidou/mybatisplus/samples/dytablename/config/MybatisPlusConfig.java">https://gitee.com/baomidou/mybatis-plus-samples/blob/master/mybatis-plus-sample-dynamic-tablename/src/main/java/com/baomidou/mybatisplus/samples/dytablename/config/MybatisPlusConfig.java</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mybatis </tag>
            
            <tag> Mybatis-plus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flowable-自定义属性</title>
      <link href="/flowable/flowable-zi-ding-yi-shu-xing/"/>
      <url>/flowable/flowable-zi-ding-yi-shu-xing/</url>
      
        <content type="html"><![CDATA[<p>​flowable已经存在一些通用的流程属性，在业务中常有自定义的属性，本节内容主要记录，如何创建自定义标签，获取标签中的内容，在流程事件中获取自定义属性，并做相应的处理</p><h2 id="设置自定义属性"><a href="#设置自定义属性" class="headerlink" title="设置自定义属性"></a>设置自定义属性</h2><p>​首先我们自定义的属性要使用flowable的api获取并解析，需要贵自定义属性标签做如下规范</p><ul><li>自定义标签必须放在<code>&lt;extensionElements&gt;</code>标签内</li><li>标签名必须以flowable:开头</li><li>标签的属性值最好使用<code>&lt;![CDATA[]]&gt;</code>包裹起来，防止有特殊字符导致flowable解析出错</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extensionElements</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">flowable:</span>selfDefAttr_startCondition</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[formValue.f1&gt;3&amp;&amp;bizObj.a=="xxx"]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">flowable:</span>selfDefAttr_startCondition</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extensionElements</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="获取自定义属性"><a href="#获取自定义属性" class="headerlink" title="获取自定义属性"></a>获取自定义属性</h2><ol><li>获取流程定义id（processDefinitionId）和节点id（activityId），可以通过以下方式获取</li></ol><ul><li>TaskEntity的方法<code>taskEntity.getProcessDefinitionId()</code>和<code>taskEntity.getTaskDefinitionKey()</code></li><li>DelegateExecution的方法<code>delegateExecution.getProcessDefinitionId()</code>和<code>delegateExecution.getCurrentActivityId()</code></li></ul><ol start="2"><li>获取BpmnModel，<code>BpmnModel bpmnModel = repositoryService.getBpmnModel(processDefinitionId);</code></li><li>通过bpmnModel可以获取流程定义里的标签和属性值</li></ol><p>完整示例（场景：从事件监听中获取自定义属性）：</p><p>监听器代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SelfDefAttrListener</span> <span class="token keyword">implements</span> <span class="token class-name">FlowableEventListener</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">FlowableEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"自定义任务属性监听...{}"</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">FlowableEngineEventType</span><span class="token punctuation">.</span><span class="token constant">TASK_CREATED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">TaskEntity</span> taskEntity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TaskEntity</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>flowable<span class="token punctuation">.</span>common<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span>FlowableEntityEventImpl</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> attribute <span class="token operator">=</span> <span class="token function">getSelfDefineTaskAttribute</span><span class="token punctuation">(</span>taskEntity<span class="token punctuation">.</span><span class="token function">getProcessDefinitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> taskEntity<span class="token punctuation">.</span><span class="token function">getTaskDefinitionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//TODO 下面编写页面代码处理自定义属性</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">FlowableEngineEventType</span><span class="token punctuation">.</span><span class="token constant">TASK_COMPLETED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//任务完成</span>            <span class="token class-name">TaskEntity</span> taskEntity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TaskEntity</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>flowable<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>delegate<span class="token punctuation">.</span>event<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>FlowableEntityEventImpl</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> attribute <span class="token operator">=</span> <span class="token function">getSelfDefineTaskAttribute</span><span class="token punctuation">(</span>taskEntity<span class="token punctuation">.</span><span class="token function">getProcessDefinitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> taskEntity<span class="token punctuation">.</span><span class="token function">getTaskDefinitionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">FlowableEngineEventType</span><span class="token punctuation">.</span><span class="token constant">ACTIVITY_CANCELLED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//处理节点取消事件（驳回，撤回）</span>            <span class="token class-name">DelegateExecution</span> delegateExecution <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FlowableActivityCancelledEventImpl</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExecution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> attribute <span class="token operator">=</span> <span class="token function">getSelfDefineTaskAttribute</span><span class="token punctuation">(</span>delegateExecution<span class="token punctuation">.</span><span class="token function">getProcessDefinitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delegateExecution<span class="token punctuation">.</span><span class="token function">getCurrentActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getSelfDefineTaskAttribute</span><span class="token punctuation">(</span><span class="token class-name">String</span> processDefinitionId<span class="token punctuation">,</span> <span class="token class-name">String</span> activityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//获取自定义用户任务节点属性</span>        <span class="token class-name">BpmnModel</span> bpmnModel <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">getBpmnModel</span><span class="token punctuation">(</span>processDefinitionId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> selfDefineAttribute <span class="token operator">=</span> <span class="token class-name">FlowableUtils</span><span class="token punctuation">.</span><span class="token function">getSelfDefineAttribute</span><span class="token punctuation">(</span>bpmnModel<span class="token punctuation">,</span> activityId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>selfDefineAttribute<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">//直接放在一个大json中，解析json中的各个字段，这里get的参数，就是自定义的key，不包括flowable:</span>            <span class="token keyword">return</span> selfDefineAttribute<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"selfDefAttr_taskAll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>FlowableUtils类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSelfDefineAttribute</span><span class="token punctuation">(</span><span class="token class-name">BpmnModel</span> bpmnModel<span class="token punctuation">,</span> <span class="token class-name">String</span> activityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Process</span><span class="token punctuation">&gt;</span></span> processes <span class="token operator">=</span> bpmnModel<span class="token punctuation">.</span><span class="token function">getProcesses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Process</span> p<span class="token operator">:</span> processes<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">FlowElement</span> flowElement <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">getFlowElement</span><span class="token punctuation">(</span>activityId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>flowElement <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ExtensionElement</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> extensionElements <span class="token operator">=</span> flowElement<span class="token punctuation">.</span><span class="token function">getExtensionElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            extensionElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"selfDefAttr_"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getElementText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getElementText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这里默认一个属性对应一个值，如果业务有一对多的情况再改为&lt;String, Object&gt;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"获取任务节点中自定义的属性-&gt;{}"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> result<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果自定义属性设置在主流程里可以直接从主流程获取，不用遍历</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">BpmnModel</span> bpmnModel <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">getBpmnModel</span><span class="token punctuation">(</span>processDefId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Process</span> mainProcess <span class="token operator">=</span> bpmnModel<span class="token punctuation">.</span><span class="token function">getMainProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ExtensionElement</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> extensionElements <span class="token operator">=</span> mainProcess<span class="token punctuation">.</span><span class="token function">getExtensionElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExtensionElement</span><span class="token punctuation">&gt;</span></span> elements <span class="token operator">=</span> extensionElements<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"selfDefAttr_startCondition"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Flowable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flowable </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flowable-事件处理</title>
      <link href="/flowable/flowable-shi-jian-chu-li/"/>
      <url>/flowable/flowable-shi-jian-chu-li/</url>
      
        <content type="html"><![CDATA[<p>事件处理器主要用于工作流引擎处理相应的操作时，通知到程序，程序中可以根据业务需求编写处理逻辑</p><p>实现事件监听器需要实现<code>org.flowable.common.engine.api.delegate.event.FlowableEventListener</code>接口</p><h2 id="可以被监听的对象"><a href="#可以被监听的对象" class="headerlink" title="可以被监听的对象"></a>可以被监听的对象</h2><p>entityType可用的值有：attachment（附件）, comment（备注）, execution（执行）, identity-link（身份关联）, job（作业）, process-instance（流程实例）, process-definition（流程定义）, task（任务）。</p><h2 id="支持的事件类型"><a href="#支持的事件类型" class="headerlink" title="支持的事件类型"></a>支持的事件类型</h2><p>每种类型对应<code>org.flowable.engine.common.api.delegate.event.FlowableEventType</code>中的一个枚举值</p><table><thead><tr><th>事件名称</th><th>说明</th></tr></thead><tbody><tr><td>ENGINE_CREATED</td><td>本监听器所属的流程引擎已经创建，并可以响应API调用。</td></tr><tr><td>ENGINE_CLOSED</td><td>本监听器所属的流程引擎已经关闭，不能再对该引擎进行API调用。</td></tr><tr><td>ENTITY_CREATED</td><td>新的实体已经创建。该实体包含在本事件里。</td></tr><tr><td>ENTITY_INITIALIZED</td><td>新的实体已经创建并完全初始化。如果任何子实体作为该实体的一部分被创建，本事件会在子实体创建/初始化后触发，与  ENTITY_CREATE 事件相反。</td></tr><tr><td>ENTITY_UPDATED</td><td>实体已经更新。该实体包含在本事件里。</td></tr><tr><td>ENTITY_DELETED</td><td>实体已经删除。该实体包含在本事件里。</td></tr><tr><td>ENTITY_SUSPENDED</td><td>实体已经暂停。该实体包含在本事件里。ProcessDefinitions（流程定义）,  ProcessInstances（流程实例）与Tasks（任务）会分发本事件。</td></tr><tr><td>ENTITY_ACTIVATED</td><td>实体已经激活。该实体包含在本事件里。ProcessDefinitions,  ProcessInstances与Tasks会分发本事件。</td></tr><tr><td>JOB_EXECUTION_SUCCESS</td><td>作业已经成功执行。该作业包含在本事件里。</td></tr><tr><td>JOB_EXECUTION_FAILURE</td><td>作业执行失败。该作业与异常包含在本事件里。</td></tr><tr><td>JOB_RETRIES_DECREMENTED</td><td>作业重试次数已经由于执行失败而减少。该作业包含在本事件里。</td></tr><tr><td>TIMER_SCHEDULED</td><td>已创建一个定时作业，并预计在未来时间点执行。</td></tr><tr><td>TIMER_FIRED</td><td>定时器已经触发。</td></tr><tr><td>JOB_CANCELED</td><td>作业已经取消。该作业包含在本事件里。作业会由于API调用取消，任务完成导致关联的边界定时器取消，也会由于新流程定义的部署而取消。</td></tr><tr><td>ACTIVITY_STARTED</td><td>节点开始执行</td></tr><tr><td>ACTIVITY_COMPLETED</td><td>节点成功完成</td></tr><tr><td>ACTIVITY_CANCELLED</td><td>节点将要取消。节点的取消有三个原因（MessageEventSubscriptionEntity,  SignalEventSubscriptionEntity, TimerEntity）。</td></tr><tr><td>ACTIVITY_SIGNALED</td><td>节点收到了一个信号</td></tr><tr><td>ACTIVITY_MESSAGE_RECEIVED</td><td>节点收到了一个消息。事件在节点接收消息前分发。节点接收消息后，会为该节点分发  ACTIVITY_SIGNAL 或 ACTIVITY_STARTED  事件，取决于其类型（边界事件，或子流程启动事件）。</td></tr><tr><td>ACTIVITY_MESSAGE_WAITING</td><td>一个节点已经创建了一个消息事件订阅，并正在等待接收消息。</td></tr><tr><td>ACTIVITY_MESSAGE_CANCELLED</td><td>一个节点已经取消了一个消息事件订阅，因此接收这个消息不会再触发该节点。</td></tr><tr><td>ACTIVITY_ERROR_RECEIVED</td><td>节点收到了错误事件。在节点实际处理错误前分发。该事件的activityId为处理错误的节点。如果错误成功传递，后续会为节点发送  ACTIVITY_SIGNALLED 或 ACTIVITY_COMPLETE 消息。</td></tr><tr><td>UNCAUGHT_BPMN_ERROR</td><td>抛出了未捕获的BPMN错误。流程没有该错误的处理器。该事件的activityId为空。</td></tr><tr><td>ACTIVITY_COMPENSATE</td><td>节点将要被补偿(compensate)。该事件包含将要执行补偿的节点id。</td></tr><tr><td>MULTI_INSTANCE_ACTIVITY_STARTED</td><td>多实例节点开始执行</td></tr><tr><td>MULTI_INSTANCE_ACTIVITY_COMPLETED</td><td>多实例节点成功完成</td></tr><tr><td>MULTI_INSTANCE_ACTIVITY_CANCELLED</td><td>多实例节点将要取消。多实例节点的取消有三个原因（MessageEventSubscriptionEntity,  SignalEventSubscriptionEntity, TimerEntity）。</td></tr><tr><td>VARIABLE_CREATED</td><td>流程变量已经创建。本事件包含变量名、取值，及关联的执行和任务（若有）。</td></tr><tr><td>VARIABLE_UPDATED</td><td>变量已经更新。本事件包含变量名、取值，及关联的执行和任务（若有）。</td></tr><tr><td>VARIABLE_DELETED</td><td>变量已经删除。本事件包含变量名、最后取值，及关联的执行和任务（若有）。</td></tr><tr><td>TASK_ASSIGNED</td><td>任务已经分派给了用户。该任务包含在本事件里。</td></tr><tr><td>TASK_CREATED</td><td>任务已经创建。本事件在  ENTITY_CREATE  事件之后分发。若该任务是流程的一部分，本事件会在任务监听器执行前触发。</td></tr><tr><td>TASK_COMPLETED</td><td>任务已经完成。本事件在  ENTITY_DELETE  事件前分发。若该任务是流程的一部分，本事件会在流程前进之前触发，并且会跟随一个 ACTIVITY_COMPLETE 事件，指向代表该任务的节点。</td></tr><tr><td>PROCESS_CREATED</td><td>流程实例已经创建。已经设置所有的基础参数，但还未设置变量。</td></tr><tr><td>PROCESS_STARTED</td><td>流程实例已经启动。在启动之前创建的流程时分发。PROCESS_STARTED事件在相关的ENTITY_INITIALIZED事件，以及设置变量之后分发。</td></tr><tr><td>PROCESS_COMPLETED</td><td>流程实例已经完成。在最后一个节点的  ACTIVITY_COMPLETED 事件后分发。当流程实例没有任何路径可以继续时，流程结束。</td></tr><tr><td>PROCESS_COMPLETED_WITH_TERMINATE_END_EVENT</td><td>流程已经到达终止结束事件(terminate  end event)并结束。</td></tr><tr><td>PROCESS_CANCELLED</td><td>流程已经被取消。在流程实例从运行时中删除前分发。流程实例由API调用RuntimeService.deleteProcessInstance取消。</td></tr><tr><td>MEMBERSHIP_CREATED</td><td>用户已经加入组。本事件包含了相关的用户和组的id。</td></tr><tr><td>MEMBERSHIP_DELETED</td><td>用户已经从组中移出。本事件包含了相关的用户和组的id。</td></tr><tr><td>MEMBERSHIPS_DELETED</td><td>组的所有用户将被移出。本事件在用户移出前抛出，因此关联关系仍然可以访问。因为性能原因，不会再为每个被移出的用户抛出  MEMBERSHIP_DELETED 事件。</td></tr></tbody></table><h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p>在bpmn20.xml的process节点下面添加全局监听</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>process</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aacopy<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aacopy<span class="token punctuation">"</span></span> <span class="token attr-name">isExecutable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extensionElements</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">flowable:</span>eventListener</span> <span class="token attr-name">delegateExpression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${myEventListener}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extensionElements</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>startEvent</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>startEvent1<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>process</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编写java代码，这里监听了任务的创建，任务审批完成，任务回退事件，用于常见工作流业务需求中的，审批，驳回等操作，可以在此操作中修改流程变量，调用业务系统接口，或者给消息队列发送消息</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyEventListener</span> <span class="token keyword">implements</span> <span class="token class-name">FlowableEventListener</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">FlowableEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">FlowableEngineEventType</span><span class="token punctuation">.</span><span class="token constant">TASK_CREATED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//任务创建</span>            <span class="token class-name">TaskEntity</span> taskEntity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TaskEntity</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>flowable<span class="token punctuation">.</span>common<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span>FlowableEntityEventImpl</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// TODO 通过taskEntity获取任务相关数据，执行业务逻辑</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">FlowableEngineEventType</span><span class="token punctuation">.</span><span class="token constant">TASK_COMPLETED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//任务完成</span>            <span class="token class-name">TaskEntity</span> taskEntity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TaskEntity</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>flowable<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>delegate<span class="token punctuation">.</span>event<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>FlowableEntityEventImpl</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">FlowableEngineEventType</span><span class="token punctuation">.</span><span class="token constant">ACTIVITY_CANCELLED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//处理节点取消事件（驳回，撤回）</span>            <span class="token class-name">DelegateExecution</span> delegateExecution <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FlowableActivityCancelledEventImpl</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExecution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Flowable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flowable </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redisson-HelloWorld</title>
      <link href="/redis/redisson-helloworld/"/>
      <url>/redis/redisson-helloworld/</url>
      
        <content type="html"><![CDATA[<p>Redisson是架设在Redis基础上的一个Java驻内存数据网格</p><p>中文文档：<a href="https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95">https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95</a></p><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>pom添加依赖</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.16.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>本地启动一个默认配置的redis客户端</p><p>编写一个controller测试</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonTest</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/redisson"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">redissonTest</span><span class="token punctuation">(</span><span class="token class-name">String</span> xx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">RLock</span> rLock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">"aacopy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        rLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        rLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> xx<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用浏览器访问地址，10秒内传入不同的参数，查看后台打印的顺序</p>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
            <tag> Redisson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Groovy-规则引擎</title>
      <link href="/groovy/groovy-gui-ze-yin-qing/"/>
      <url>/groovy/groovy-gui-ze-yin-qing/</url>
      
        <content type="html"><![CDATA[<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>在java代码中通过groovy脚本语言实现简单的规则，用于结合flowable使用，这里规则引擎简单返回true或者false，表达式是通过参数传过来的，如需从数据库查询规则表达式，可以传个id，从数据库查出来，加载到表达式中，通过id作为缓存key，分布式缓存的问题，可以简单通过变更规则表达式后，同时变更规则版本，重写加载</p><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.codehaus.groovy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>groovy-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.ben-manes.caffeine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>caffeine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.8.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.hutool<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hutool-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.7.15<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">SecureUtil</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>benmanes<span class="token punctuation">.</span>caffeine<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">Cache</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>benmanes<span class="token punctuation">.</span>caffeine<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">Caffeine</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">groovy<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleTemplateEngine</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">groovy<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">Template</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">StringWriter</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Writer</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span><span class="token comment">/** * groovy脚本实现规则引擎 * @author Iseven.yang * @date 2021/10/17 18:59 */</span><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"groovyRuleEngineService"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GroovyRuleEngineServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">RuleEngineService</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">SimpleTemplateEngine</span> <span class="token constant">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleTemplateEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//由于创建Template性能消耗大,且会重复生成class，导致OOM,所以将ruleId对于的对象放在本地缓存中</span>    <span class="token keyword">private</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Template</span><span class="token punctuation">&gt;</span></span> scriptTemplateCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment">// 设置最后一次写入或访问后经过固定时间过期</span>            <span class="token punctuation">.</span><span class="token function">expireAfterAccess</span><span class="token punctuation">(</span><span class="token number">365</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span>            <span class="token comment">// 初始的缓存空间大小</span>            <span class="token punctuation">.</span><span class="token function">initialCapacity</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>            <span class="token comment">// 缓存的最大条数</span>            <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">executeRule</span><span class="token punctuation">(</span><span class="token class-name">String</span> ruleExpression<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> param<span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"执行规则：ruleExpression={}, param={}"</span><span class="token punctuation">,</span> ruleExpression<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Template</span> template <span class="token operator">=</span> <span class="token function">getTemplate</span><span class="token punctuation">(</span>ruleExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">Writer</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">//执行完这句后，groovy会在map中塞一个out的key，flowable在设置变量的时候无法解析out，导致报错，所有要么换个map（更保险），要么执行后，把out删掉</span>            template<span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>writer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"规则执行结果：ruleId={}, result={}"</span><span class="token punctuation">,</span> ruleExpression<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> result<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 根据规则id获取规则引擎中的执行库对象     * @param ruleExpression     * @return groovy.text.Template     * @author Iseven.yang     * @date 2021/10/17 19:24     */</span>    <span class="token keyword">private</span> <span class="token class-name">Template</span> <span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token class-name">String</span> ruleExpression<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">SecureUtil</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>ruleExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//查看缓存是否存在Template</span>        <span class="token class-name">Template</span> template <span class="token operator">=</span> scriptTemplateCache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>template <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                template <span class="token operator">=</span> <span class="token constant">ENGINE</span><span class="token punctuation">.</span><span class="token function">createTemplate</span><span class="token punctuation">(</span><span class="token string">"${"</span> <span class="token operator">+</span> ruleExpression <span class="token operator">+</span> <span class="token string">" ? true : false}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"创建新规则缓存模板成功，key={}, expression={}"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> ruleExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>            scriptTemplateCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> template<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> template<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Groovy </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Groovy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-DDL</title>
      <link href="/mysql/mysql-ddl/"/>
      <url>/mysql/mysql-ddl/</url>
      
        <content type="html"><![CDATA[<p>DDL(Data Definition Language) 数据定义语言,eg:建库，建表</p><h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><ul><li>创建数据库</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">database</span> dbName<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查看当前所在库</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>使用具体库</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">use</span> dbName<span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>判断是否存在，如果不存在则创建数据库</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> dbName<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>创建数据库并指定字符集</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">database</span> dbName <span class="token keyword">default</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查看字符集</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">database</span> dbName<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查看当前mysql使用的字符集</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'character%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="mysql常见数据类型"><a href="#mysql常见数据类型" class="headerlink" title="mysql常见数据类型"></a>mysql常见数据类型</h2><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span>整数型     类型      大小      范围（有符号）               范围（无符号<span class="token keyword">unsigned</span>）    用途     <span class="token keyword">TINYINT</span>   <span class="token number">1</span> 字节    <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">128</span>，<span class="token number">127</span><span class="token punctuation">)</span>                <span class="token punctuation">(</span><span class="token number">0</span>，<span class="token number">255</span><span class="token punctuation">)</span>                 小整数值     <span class="token keyword">SMALLINT</span>  <span class="token number">2</span> 字节    <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">32768</span>，<span class="token number">32767</span><span class="token punctuation">)</span>            <span class="token punctuation">(</span><span class="token number">0</span>，<span class="token number">65535</span><span class="token punctuation">)</span>               大整数值     <span class="token keyword">MEDIUMINT</span> <span class="token number">3</span> 字节    <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">8388608</span>，<span class="token number">8388607</span><span class="token punctuation">)</span>        <span class="token punctuation">(</span><span class="token number">0</span>，<span class="token number">16777215</span><span class="token punctuation">)</span>            大整数值     <span class="token keyword">INT</span>       <span class="token number">4</span> 字节    <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2147483648</span>，<span class="token number">2147483647</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token number">0</span>，<span class="token number">4294967295</span><span class="token punctuation">)</span>          大整数值     <span class="token keyword">BIGINT</span>    <span class="token number">8</span> 字节     （）                       <span class="token punctuation">(</span><span class="token number">0</span>，<span class="token number">2</span>的<span class="token number">64</span>次方减<span class="token number">1</span><span class="token punctuation">)</span>        极大整数值<span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span>浮点型 <span class="token keyword">FLOAT</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>d）  <span class="token number">4</span> 字节    单精度浮点型  备注：m代表总个数，d代表小数位个数 <span class="token keyword">DOUBLE</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>d） <span class="token number">8</span> 字节    双精度浮点型  备注：m代表总个数，d代表小数位个数 <span class="token operator">&lt;</span><span class="token number">3</span><span class="token operator">&gt;</span>定点型 <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>d）    依赖于M和D的值    备注：m代表总个数，d代表小数位个数 <span class="token operator">&lt;</span><span class="token number">4</span><span class="token operator">&gt;</span>字符串类型  类型          大小              用途 <span class="token keyword">CHAR</span>          <span class="token number">0</span><span class="token operator">-</span><span class="token number">255</span>字节         定长字符串 <span class="token keyword">VARCHAR</span>       <span class="token number">0</span><span class="token operator">-</span><span class="token number">65535</span>字节       变长字符串 <span class="token keyword">TINYTEXT</span>      <span class="token number">0</span><span class="token operator">-</span><span class="token number">255</span>字节         短文本字符串 <span class="token keyword">TEXT</span>          <span class="token number">0</span><span class="token operator">-</span><span class="token number">65535</span>字节       长文本数据 <span class="token keyword">MEDIUMTEXT</span>    <span class="token number">0</span><span class="token operator">-</span><span class="token number">16777215</span>字节    中等长度文本数据 <span class="token keyword">LONGTEXT</span>      <span class="token number">0</span><span class="token operator">-</span><span class="token number">4294967295</span>字节  极大文本数据  <span class="token keyword">char</span>的优缺点：存取速度比<span class="token keyword">varchar</span>更快，但是比<span class="token keyword">varchar</span>更占用空间 <span class="token keyword">varchar</span>的优缺点：比<span class="token keyword">char</span>省空间。但是存取速度没有<span class="token keyword">char</span>快 <span class="token operator">&lt;</span><span class="token number">5</span><span class="token operator">&gt;</span>时间型 数据类型    字节数            格式                    备注 <span class="token keyword">date</span>        <span class="token number">3</span>                yyyy<span class="token operator">-</span>MM<span class="token operator">-</span>dd              存储日期值 <span class="token keyword">time</span>        <span class="token number">3</span>                HH:mm:ss                存储时分秒 <span class="token keyword">year</span>        <span class="token number">1</span>                yyyy                    存储年 <span class="token keyword">datetime</span>    <span class="token number">8</span>                yyyy<span class="token operator">-</span>MM<span class="token operator">-</span>dd HH:mm:ss     存储日期<span class="token operator">+</span>时间 <span class="token keyword">timestamp</span>   <span class="token number">4</span>                yyyy<span class="token operator">-</span>MM<span class="token operator">-</span>dd HH:mm:ss     存储日期<span class="token operator">+</span>时间<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h2><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名 <span class="token punctuation">(</span>                  字段名<span class="token number">1</span> 字段类型<span class="token number">1</span> 约束条件<span class="token number">1</span> 说明<span class="token number">1</span><span class="token punctuation">,</span>                  字段名<span class="token number">2</span> 字段类型<span class="token number">2</span> 约束条件<span class="token number">2</span> 说明<span class="token number">2</span><span class="token punctuation">,</span>                  字段名<span class="token number">3</span> 字段类型<span class="token number">3</span> 约束条件<span class="token number">3</span> 说明<span class="token number">3</span>                  <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> 新表名 <span class="token keyword">as</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 旧表名 <span class="token keyword">where</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">(</span>注意：建议这种创建表的方式用于日常测试，索引复制不过来<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> 新表名 <span class="token operator">like</span> 旧表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="约束条件"><a href="#约束条件" class="headerlink" title="约束条件"></a>约束条件</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">comment</span>         <span class="token comment">----说明解释</span><span class="token operator">not</span> <span class="token boolean">null</span>        <span class="token comment">----不为空</span><span class="token keyword">default</span>         <span class="token comment">----默认值</span><span class="token keyword">unsigned</span>        <span class="token comment">----无符号（即正数）</span><span class="token keyword">auto_increment</span>  <span class="token comment">----自增</span>zerofill        <span class="token comment">----自动填充</span><span class="token keyword">unique</span> <span class="token keyword">key</span>      <span class="token comment">----唯一值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看表的基本结构信息"><a href="#查看表的基本结构信息" class="headerlink" title="查看表的基本结构信息"></a>查看表的基本结构信息</h3><ul><li>查看数据库中的所有表：show tables；</li><li>查看表结构：desc 表名;</li><li>查看创建表的sql语句：show create table 表名;</li><li>\G :有结束sql语句的作用，还有把显示的数据纵向旋转90度</li><li>\g :有结束sql语句的作用</li></ul><h3 id="表结构维护与删除"><a href="#表结构维护与删除" class="headerlink" title="表结构维护与删除"></a>表结构维护与删除</h3><ul><li>修改表名</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">rename</span> <span class="token keyword">table</span> 旧表名 <span class="token keyword">to</span> 新表名<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>添加列</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">给表添加一列：<span class="token keyword">alter</span> <span class="token keyword">table</span> 表名 <span class="token keyword">add</span> 列名 类型<span class="token punctuation">;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">add</span> addr <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token keyword">add</span> 列名 类型 <span class="token keyword">comment</span> <span class="token string">'说明'</span><span class="token punctuation">;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">add</span> famliy <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'家庭'</span><span class="token punctuation">;</span>给表最前面添加一列：<span class="token keyword">alter</span> <span class="token keyword">table</span> 表名 <span class="token keyword">add</span> 列名 类型 <span class="token keyword">first</span><span class="token punctuation">;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">add</span> job <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">first</span><span class="token punctuation">;</span>给表某个字段后添加一列：<span class="token keyword">alter</span> <span class="token keyword">table</span> 表名 <span class="token keyword">add</span> 列名 类型 <span class="token keyword">after</span> 字段名<span class="token punctuation">;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">add</span> servnumber <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">after</span> id<span class="token punctuation">;</span>注意：没有给表某个字段前添加一列的说法。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>修改列类型</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> 表名 <span class="token keyword">modify</span> 列名 新类型<span class="token punctuation">;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">modify</span> servnumber <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>修改列名</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> 表名 change 旧列名 新列名 类型<span class="token punctuation">;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token keyword">user</span> change servnumber telephone <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>删除列</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> 表名 <span class="token keyword">drop</span> 列名<span class="token punctuation">;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">drop</span> famliy<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>修改字符集</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> 表名 <span class="token keyword">character</span> <span class="token keyword">set</span> 字符集<span class="token punctuation">;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">character</span>  <span class="token keyword">set</span> GBK<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>mysql表的删除</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> 表名；<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">user</span><span class="token punctuation">;</span>看表是否存在，若存在则删除表：<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> 表名<span class="token punctuation">;</span><span class="token keyword">drop</span> <span class="token keyword">table</span>  <span class="token keyword">if</span> <span class="token keyword">exists</span> teacher<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>查看所有的表信息</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">table</span> <span class="token keyword">status</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql-DCL</title>
      <link href="/mysql/mysql-dcl/"/>
      <url>/mysql/mysql-dcl/</url>
      
        <content type="html"><![CDATA[<p>设置或者更改数据库用户或角色权限的语句</p><h2 id="限制root用户指定ip登录"><a href="#限制root用户指定ip登录" class="headerlink" title="限制root用户指定ip登录"></a>限制root用户指定ip登录</h2><ul><li>查看root用户可以在哪台机器登录</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">user</span><span class="token punctuation">,</span>host <span class="token keyword">from</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token keyword">where</span> <span class="token keyword">user</span><span class="token operator">=</span><span class="token string">'root'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>修改mysql库里边的user表</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">update</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token keyword">set</span> host<span class="token operator">=</span><span class="token string">'localhost'</span> <span class="token keyword">where</span> <span class="token keyword">user</span><span class="token operator">=</span><span class="token string">'root'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>刷新权限</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">flush <span class="token keyword">privileges</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="修改用户密码"><a href="#修改用户密码" class="headerlink" title="修改用户密码"></a>修改用户密码</h2><ul><li>修改用户密码分三种方法：</li></ul><ol><li><p>第一种：set password for 用户@ip = password(‘密码’);</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">set</span> password <span class="token keyword">for</span> root<span class="token variable">@localhost</span> <span class="token operator">=</span> password<span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>第二种：mysqladmin -u用户 -p旧密码 password 新密码;</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysqladmin <span class="token operator">-</span>urootmysqladmin <span class="token operator">-</span>uroot <span class="token operator">-</span>proot password<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>第三种：update mysql.user set authentication_string=password(‘密码’) where user=’用户’ and host=’ip’;</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">update</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token keyword">set</span> authentication_string<span class="token operator">=</span>password<span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token keyword">user</span><span class="token operator">=</span><span class="token string">'root'</span> <span class="token operator">and</span> host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><ul><li>忘记密码:</li></ul><ol><li>第一步：修改配置文件my.cnf (默认在/etc/my.cnf)，在[mysqld]下面加上 skip-grant-tables （跳过权限的意思）</li><li>第二步：重启mysql服务</li><li>第三步：mysql -uroot -p 无需密码登录进入</li><li>第四步：修改密码</li></ol><h2 id="新建删除用户并限制IP登录"><a href="#新建删除用户并限制IP登录" class="headerlink" title="新建删除用户并限制IP登录"></a>新建删除用户并限制IP登录</h2><ul><li>创建用户的语法：create user ‘username‘@’host’ identified by ‘password’;</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">username：你将创建的用户名host：指定该用户在哪个主机上可以登陆，如果是本地用户可用localhost，如果想让该用户可以从任意远程主机    登陆，可以使用通配符<span class="token operator">%</span>password：该用户的登陆密码，密码可以为空，如果为空则该用户可以不需要密码登陆服务器<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建用户语法：</li></ul><p>创建一个pig用户，并指定登录密码：123456，可以在任何一台远程主机都可以登录</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">user</span> <span class="token string">'pig'</span><span class="token variable">@'%'</span> identified <span class="token keyword">by</span> <span class="token string">'123456'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>创建一个pig用户，并指定登录密码：为空，指定在120网段的机器登录</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">user</span> <span class="token string">'pig'</span><span class="token variable">@'120.%.%.%'</span> identified <span class="token keyword">by</span> <span class="token string">''</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查看权限：</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token keyword">where</span> <span class="token keyword">user</span><span class="token operator">=</span><span class="token string">'pig'</span>\G mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> grants <span class="token keyword">for</span> <span class="token string">'pig'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span> <span class="token operator">+</span><span class="token comment">---------------------------------+</span> <span class="token operator">|</span> Grants <span class="token keyword">for</span> pig@<span class="token operator">%</span>                <span class="token operator">|</span> <span class="token operator">+</span><span class="token comment">---------------------------------+</span> <span class="token operator">|</span> <span class="token keyword">GRANT</span> <span class="token keyword">USAGE</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'pig'</span><span class="token variable">@'%'</span> <span class="token operator">|</span> <span class="token operator">+</span><span class="token comment">---------------------------------+</span> <span class="token keyword">USAGE</span>：无权限的意思 mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> grants <span class="token keyword">for</span> <span class="token string">'root'</span><span class="token variable">@'localhost'</span><span class="token punctuation">;</span> <span class="token operator">+</span><span class="token comment">---------------------------------------------------------------------+</span> <span class="token operator">|</span> Grants <span class="token keyword">for</span> root<span class="token variable">@localhost</span>                                           <span class="token operator">|</span> <span class="token operator">+</span><span class="token comment">---------------------------------------------------------------------+</span> <span class="token operator">|</span> <span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'root'</span><span class="token variable">@'localhost'</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span> <span class="token operator">|</span> <span class="token operator">+</span><span class="token comment">---------------------------------------------------------------------+</span> <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span>:表示这个用户拥有<span class="token keyword">grant</span>权限，即可以对其他用户授权<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>删除用户语法：drop user ‘username‘@’host’;</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">user</span> <span class="token string">'pig'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span><span class="token keyword">delete</span> <span class="token keyword">from</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token keyword">where</span> <span class="token keyword">user</span><span class="token operator">=</span><span class="token string">'pig'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="限制用户对库表的增删改查权限"><a href="#限制用户对库表的增删改查权限" class="headerlink" title="限制用户对库表的增删改查权限"></a>限制用户对库表的增删改查权限</h2><ul><li>授权语法：grant 权限1,权限2….. on 数据库对象 to ‘用户’</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">grant</span> 权限<span class="token number">1</span><span class="token punctuation">,</span>权限<span class="token number">2.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">on</span> 数据库对象 <span class="token keyword">to</span> <span class="token string">'用户'</span><span class="token variable">@'host'</span> identified <span class="token keyword">by</span> <span class="token string">'password'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>all privileges:代表所有权限</li><li><em>.</em> :代表所有库所有表</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">对现有用户进行授权：对现有用户pig授予所有库所有表所有权限。<span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span>  <span class="token keyword">to</span> <span class="token string">'pig'</span><span class="token punctuation">;</span>对没有的用户进行授权：创建一个新用户dog授予XD库的所有权限，登录密码<span class="token number">123456</span>，任何一台主机登录<span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> XD<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> <span class="token string">'dog'</span><span class="token variable">@'%'</span> identified <span class="token keyword">by</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>对没有的用户进行授权：创建一个新用户cat授予XD库的employee表 查与修改权限，登录密码<span class="token number">123456</span>，任何一台主机登录<span class="token keyword">grant</span> <span class="token keyword">select</span><span class="token punctuation">,</span><span class="token keyword">update</span> <span class="token keyword">on</span> XD<span class="token punctuation">.</span>employee <span class="token keyword">to</span> <span class="token string">'cat'</span><span class="token variable">@'%'</span> identified <span class="token keyword">by</span> <span class="token string">'123456'</span>对没有的用户进行授权：对用户cat授予XD库的employee表<span class="token keyword">insert</span> 权限，登录密码<span class="token number">123456</span>，任何一台主机登录<span class="token keyword">grant</span> <span class="token keyword">insert</span> <span class="token keyword">on</span> XD<span class="token punctuation">.</span>employee <span class="token keyword">to</span> <span class="token string">'cat'</span><span class="token variable">@'%'</span> identified <span class="token keyword">by</span> <span class="token string">'123456'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>回收语法：revoke 权限1,权限2….. on 数据库对象 from ‘用户‘@’host’;</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">回收pig用户的所有权限（注意：并没有回收它的登录权限）<span class="token keyword">revoke</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span>  <span class="token keyword">from</span> <span class="token string">'pig'</span> @ <span class="token string">'%'</span><span class="token punctuation">;</span>flush <span class="token keyword">privileges</span><span class="token punctuation">;</span>回收pig用户的所有权限（并回收它的登录权限）<span class="token keyword">delete</span> <span class="token keyword">from</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token keyword">where</span> <span class="token keyword">user</span><span class="token operator">=</span><span class="token string">'pig'</span><span class="token punctuation">;</span>flush <span class="token keyword">privileges</span><span class="token punctuation">;</span>回收cat用户对XD库的employee的查与修改权限<span class="token keyword">revoke</span> <span class="token keyword">select</span><span class="token punctuation">,</span><span class="token keyword">update</span> <span class="token keyword">on</span> XD<span class="token punctuation">.</span>employee <span class="token keyword">from</span> <span class="token string">'cat'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>flush <span class="token keyword">privileges</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flowable-自定义权限</title>
      <link href="/flowable/flowable-zi-ding-yi-quan-xian/"/>
      <url>/flowable/flowable-zi-ding-yi-quan-xian/</url>
      
        <content type="html"><![CDATA[<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>在实际项目使用flowable时，一般公司都有自己的人员权限系统，并不会直接使用flowable的idm模块，本节内容记录，如何让flowable调用自己的权限系统</p><h2 id="idm基本操作"><a href="#idm基本操作" class="headerlink" title="idm基本操作"></a>idm基本操作</h2><h3 id="核心类：IdentityService"><a href="#核心类：IdentityService" class="headerlink" title="核心类：IdentityService"></a>核心类：IdentityService</h3><p>通过该类可以获取，在流程的整个生命周期中的相关人，和组信息</p><p>例如：</p><p>获取可提交流程的人：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> authorizedUsers <span class="token operator">=</span> identityService<span class="token punctuation">.</span><span class="token function">getPotentialStarterUsers</span><span class="token punctuation">(</span>processDefId<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>获取组内的人：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> identityService<span class="token punctuation">.</span><span class="token function">createUserQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">memberOfGroups</span><span class="token punctuation">(</span>groupIds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>两个核心的方法，createUserQuery()和createUserQuery()，用来构建获取人和组的方法</p><h3 id="实现类IdmIdentityServiceImpl"><a href="#实现类IdmIdentityServiceImpl" class="headerlink" title="实现类IdmIdentityServiceImpl"></a>实现类IdmIdentityServiceImpl</h3><p>上面人员权限认证服务的默认实现类</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdmIdentityServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">CommonEngineServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IdmEngineConfiguration</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IdmIdentityService</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看两个核心方法createUserQuery()和createUserQuery()</p><p>如果自定义idm，需要实现UserQuery，和 GroupQuery两个接口</p><p>官方默认的实现类是UserQueryImpl，和GroupQueryImpl</p><p>为了实现简单，只需要修改自定义业务用的方法，所以我们可以直接继承这两个类就可以</p><h2 id="代码改造"><a href="#代码改造" class="headerlink" title="代码改造"></a>代码改造</h2><h3 id="实现UserQuery"><a href="#实现UserQuery" class="headerlink" title="实现UserQuery"></a>实现UserQuery</h3><p>主要重写executeList方法。</p><p>该方法是查询数据的核心方法，在这个方法里，写自定义获取用户的代码就可以了</p><p>getId()获取当前查询里的用户id。</p><p>getIds()获取当前查询里的用户id列表。</p><p>getGroupId()获取当前查询里的组id。</p><p>getGroupIds()获取当前查询里的组id列表，</p><p>为什么要用这些数据做判断，是因为在构建查询的时候，代码里编写了创建查询的指令，如果存在指令，对应的get方法里就会有我们传入的值，例如：</p><p>获取组内的人：identityService.createUserQuery().memberOfGroups(groupIds).list();</p><p>.memberOfGroups(groupIds)这个指令就会使getGroupIds()时获取到传入的groupIds。</p><p>具体实例代码实现如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 集成自己的用户实现方式 * @author iseven.yang * @date 2021/11/1 10:18 */</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUserQueryImpl</span> <span class="token keyword">extends</span> <span class="token class-name">UserQueryImpl</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">executeCount</span><span class="token punctuation">(</span><span class="token class-name">CommandContext</span> commandContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">executeList</span><span class="token punctuation">(</span>commandContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">executeList</span><span class="token punctuation">(</span><span class="token class-name">CommandContext</span> commandContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"开始获取人员信息***********************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            users<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> users<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">findByIds</span><span class="token punctuation">(</span><span class="token function">getIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">findByGroup</span><span class="token punctuation">(</span><span class="token function">getGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getGroupIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">findByGroups</span><span class="token punctuation">(</span><span class="token function">getGroupIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SHIP</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span> <span class="token number">9L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">,</span> <span class="token number">11L</span><span class="token punctuation">,</span> <span class="token number">12L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ccc"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">11L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ddd"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">13L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"eee"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">14L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token class-name">QtUser</span> <span class="token function">getQtUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">USERS</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">QtUser</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QtUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token constant">USERS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            user<span class="token punctuation">.</span><span class="token function">setTenantId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> user<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">USERS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        <span class="token constant">USERS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">8L</span><span class="token punctuation">,</span> <span class="token string">"ie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">USERS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">9L</span><span class="token punctuation">,</span> <span class="token string">"he"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">USERS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">,</span> <span class="token string">"tom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">USERS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">11L</span><span class="token punctuation">,</span> <span class="token string">"cat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">USERS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">12L</span><span class="token punctuation">,</span> <span class="token string">"java"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">USERS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">13L</span><span class="token punctuation">,</span> <span class="token string">"python"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">USERS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">111L</span><span class="token punctuation">,</span> <span class="token string">"li"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">USERS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">222L</span><span class="token punctuation">,</span> <span class="token string">"qa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">User</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">USERS</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">UserEntity</span> userEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserEntityImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userEntity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>        userEntity<span class="token punctuation">.</span><span class="token function">setDisplayName</span><span class="token punctuation">(</span><span class="token constant">USERS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userEntity<span class="token punctuation">.</span><span class="token function">setTenantId</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> userEntity<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> userIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> userIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">findById</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByGroup</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> groupId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> userIds <span class="token operator">=</span> <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>userIds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">findByIds</span><span class="token punctuation">(</span>userIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByGroups</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> groupIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        groupIds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>g <span class="token operator">-&gt;</span> users<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token function">findByGroup</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> users<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="实现GroupQuery"><a href="#实现GroupQuery" class="headerlink" title="实现GroupQuery"></a>实现GroupQuery</h3><p>和上面一样，也是主要实现executeList方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * @author iseven.yang * @date 2021/11/1 10:18 */</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyGroupQueryImpl</span> <span class="token keyword">extends</span> <span class="token class-name">GroupQueryImpl</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">executeCount</span><span class="token punctuation">(</span><span class="token class-name">CommandContext</span> commandContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">executeList</span><span class="token punctuation">(</span>commandContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Group</span><span class="token punctuation">&gt;</span></span> <span class="token function">executeList</span><span class="token punctuation">(</span><span class="token class-name">CommandContext</span> commandContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"开始获取组信息***********************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">findGroupsByUser</span><span class="token punctuation">(</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Group</span><span class="token punctuation">&gt;</span></span> groups <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            groups<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">findGroupById</span><span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> groups<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">findGroupsByIds</span><span class="token punctuation">(</span><span class="token function">getIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SHIP</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">8L</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">9L</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">11L</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">,</span><span class="token string">"ccc"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">12L</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">13L</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"ddd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">14L</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"eee"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">GROUPS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        <span class="token constant">GROUPS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">,</span> <span class="token string">"权限1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">GROUPS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">,</span> <span class="token string">"权限2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">GROUPS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ccc"</span><span class="token punctuation">,</span> <span class="token string">"权限3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">GROUPS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ddd"</span><span class="token punctuation">,</span> <span class="token string">"权限4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token constant">GROUPS</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"eee"</span><span class="token punctuation">,</span> <span class="token string">"权限5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Group</span><span class="token punctuation">&gt;</span></span> <span class="token function">findGroupsByUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> strings <span class="token operator">=</span> <span class="token constant">SHIP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>g <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">Group</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupEntityImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            group<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>            group<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token constant">GROUPS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> group<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">Group</span> <span class="token function">findGroupById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">GROUPS</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Group</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupEntityImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        group<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>        group<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token constant">GROUPS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> group<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Group</span><span class="token punctuation">&gt;</span></span> <span class="token function">findGroupsByIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> ids<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">findGroupById</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="重写IdmIdentityServiceImpl"><a href="#重写IdmIdentityServiceImpl" class="headerlink" title="重写IdmIdentityServiceImpl"></a>重写IdmIdentityServiceImpl</h3><p>IdmIdentityServiceImpl为构建查询的默认实现类，需要重写一个类，使idm调用自定义的MyUserQueryImpl和MyGroupQueryImpl</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyIdmIdentityServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">IdmIdentityServiceImpl</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">UserQuery</span> <span class="token function">createUserQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyUserQueryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">GroupQuery</span> <span class="token function">createGroupQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyGroupQueryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使flowable加载自定义实现的Idm"><a href="#使flowable加载自定义实现的Idm" class="headerlink" title="使flowable加载自定义实现的Idm"></a>使flowable加载自定义实现的Idm</h3><p>在配置类里加入bean</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>   <span class="token keyword">public</span> <span class="token class-name">EngineConfigurationConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpringIdmEngineConfiguration</span><span class="token punctuation">&gt;</span></span> <span class="token function">idmEngineConfigurationConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">return</span> idmEngineConfiguration <span class="token operator">-&gt;</span> idmEngineConfiguration<span class="token punctuation">.</span><span class="token function">setIdmIdentityService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyIdmIdentityServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>至此，自定义idm模块改造完成，重启服务，测试一下</p>]]></content>
      
      
      <categories>
          
          <category> Flowable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flowable </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flowable-HelloWorld</title>
      <link href="/flowable/flowable-helloworld/"/>
      <url>/flowable/flowable-helloworld/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>轻量级工作流引擎，使用Java编写，Flowable是Activiti的fork</p><p>github地址：<a href="https://github.com/flowable/flowable-engine">https://github.com/flowable/flowable-engine</a></p><p>开源文档：<a href="https://wwv.flowable.com/open-source/docs/bpmn/ch02-GettingStarted/">https://wwv.flowable.com/open-source/docs/bpmn/ch02-GettingStarted/</a></p><p>6.5.0版本中文文档：<a href="https://jeesite.gitee.io/front/flowable/6.5.0/bpmn/index.html">https://jeesite.gitee.io/front/flowable/6.5.0/bpmn/index.html</a></p><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>Gitee地址：<a href="https://gitee.com/aacopy/flowable-learn.git">https://gitee.com/aacopy/flowable-learn.git</a></p><h3 id="创建一个spring-boot项目"><a href="#创建一个spring-boot项目" class="headerlink" title="创建一个spring boot项目"></a>创建一个spring boot项目</h3><p>需要加入 spring web，</p><p>本示例，spring boot 2.6.1，flowable 6.7.1， mysql 5.7</p><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><p>新建一个mysql数据库，名称为flowable_learn</p><h3 id="编写示例"><a href="#编写示例" class="headerlink" title="编写示例"></a>编写示例</h3><ol><li>加入maven依赖</li></ol><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.flowable<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flowable-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>6.7.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>在application.properties新增配置项</li></ol><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">server.servlet.context-path</span><span class="token punctuation">=</span><span class="token value attr-value">/flowable-learn</span><span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://127.0.0.1:3306/flowable_learn?characterEncoding=UTF-8</span><span class="token key attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span><span class="token key attr-name">spring.datasource.password</span><span class="token punctuation">=</span><span class="token value attr-value">123456</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>此处有坑：</strong></p><p>如果启动服务，报错找不到flowable的表</p><p>​原因：使用root用户登录，程序检测到该用户下的其他数据库中有flowable相关的表，就不再创建表了，但是在使用的时候又找不到表。</p><p>​解决：在url后面追加<code>&amp;nullCatalogMeansCurrent=true</code></p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://127.0.0.1:3306/flowable_learn?characterEncoding=UTF-8&amp;nullCatalogMeansCurrent=true</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>在resources文件夹下新建文件夹<em>processes</em></li><li>创建一个流程文件<em>hello-world.bpmn20.xml</em>，复制以下内容到文件</li></ol><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>definitions</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.omg.org/spec/BPMN/20100524/MODEL<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>flowable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://flowable.org/bpmn<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>bpmndi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.omg.org/spec/BPMN/20100524/DI<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>omgdc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.omg.org/spec/DD/20100524/DC<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>omgdi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.omg.org/spec/DD/20100524/DI<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsd</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema<span class="token punctuation">"</span></span> <span class="token attr-name">targetNamespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://flowable.org/test<span class="token punctuation">"</span></span> <span class="token attr-name">exporter</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Flowable Open Source Modeler<span class="token punctuation">"</span></span> <span class="token attr-name">exporterVersion</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.1.0-SNAPSHOT<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>process</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>helloWorldProcess<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Hello World Process<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>startEvent</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theStart<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sequenceFlow</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>flow1<span class="token punctuation">"</span></span> <span class="token attr-name">sourceRef</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theStart<span class="token punctuation">"</span></span> <span class="token attr-name">targetRef</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theTask<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>userTask</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theTask<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>my task<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">flowable:</span>assignee</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aacopy<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sequenceFlow</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>flow2<span class="token punctuation">"</span></span> <span class="token attr-name">sourceRef</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theTask<span class="token punctuation">"</span></span> <span class="token attr-name">targetRef</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theEnd<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>endEvent</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theEnd<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>process</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">bpmndi:</span>BPMNDiagram</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BPMNDiagram_helloWorldProcess<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">bpmndi:</span>BPMNPlane</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BPMNPlane_helloWorldProcess<span class="token punctuation">"</span></span> <span class="token attr-name">bpmnElement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>helloWorldProcess<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">bpmndi:</span>BPMNEdge</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>flow1_di<span class="token punctuation">"</span></span> <span class="token attr-name">bpmnElement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>flow1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">omgdi:</span>waypoint</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>130<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>178<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">omgdi:</span>waypoint</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>180<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>178<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">bpmndi:</span>BPMNEdge</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">bpmndi:</span>BPMNEdge</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>flow2_di<span class="token punctuation">"</span></span> <span class="token attr-name">bpmnElement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>flow2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">omgdi:</span>waypoint</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>280<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>178<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">omgdi:</span>waypoint</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>332<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>178<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">bpmndi:</span>BPMNEdge</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">bpmndi:</span>BPMNShape</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BPMNShape_theStart<span class="token punctuation">"</span></span> <span class="token attr-name">bpmnElement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theStart<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">omgdc:</span>Bounds</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>163<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>30<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>30<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">bpmndi:</span>BPMNShape</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">bpmndi:</span>BPMNShape</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theTask_di<span class="token punctuation">"</span></span> <span class="token attr-name">bpmnElement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theTask<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">omgdc:</span>Bounds</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>180<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>138<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>80<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">bpmndi:</span>BPMNShape</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">bpmndi:</span>BPMNShape</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theEnd_di<span class="token punctuation">"</span></span> <span class="token attr-name">bpmnElement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theEnd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">omgdc:</span>Bounds</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>332<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>160<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>36<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>36<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">bpmndi:</span>BPMNShape</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">bpmndi:</span>BPMNPlane</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">bpmndi:</span>BPMNDiagram</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>definitions</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>编写HelloWorldController类</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>aacopy<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>flowable</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>flowable<span class="token punctuation">.</span>common<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">IoUtil</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>flowable<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span><span class="token class-name">RepositoryService</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>flowable<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span><span class="token class-name">RuntimeService</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>flowable<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span><span class="token class-name">TaskService</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>flowable<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>repository<span class="token punctuation">.</span></span><span class="token class-name">ProcessDefinition</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>flowable<span class="token punctuation">.</span>task<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Task</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span><span class="token comment">/** * @author iseven.yang * @date 2021/12/2 15:40 */</span><span class="token annotation punctuation">@RestController</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/helloWorld"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorldController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">RuntimeService</span> runtimeService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">TaskService</span> taskService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">RepositoryService</span> repositoryService<span class="token punctuation">;</span>    <span class="token comment">/**     * 查看流程图     * @param response     * @throws IOException     */</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/image"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">image</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>        <span class="token class-name">ProcessDefinition</span> processDefinition <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">createProcessDefinitionQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">processDefinitionKey</span><span class="token punctuation">(</span><span class="token string">"helloWorldProcess"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">latestVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">InputStream</span> imageStream <span class="token operator">=</span> repositoryService<span class="token punctuation">.</span><span class="token function">getProcessDiagram</span><span class="token punctuation">(</span>processDefinition<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token class-name">IoUtil</span><span class="token punctuation">.</span><span class="token function">readInputStream</span><span class="token punctuation">(</span>imageStream<span class="token punctuation">,</span> <span class="token string">"image inputStream name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">IMAGE_PNG_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 启动流程     * @return     */</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/start"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        runtimeService<span class="token punctuation">.</span><span class="token function">startProcessInstanceByKey</span><span class="token punctuation">(</span><span class="token string">"helloWorldProcess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 获取待办列表     * @param assignee     * @return     */</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/todo"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">todo</span><span class="token punctuation">(</span><span class="token class-name">String</span> assignee<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">taskAssignee</span><span class="token punctuation">(</span>assignee<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderByTaskCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>task <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> taskMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            taskMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            taskMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            taskMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"createTime"</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> taskMap<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 提交任务     * @param taskId     * @return     */</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/complete"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token class-name">String</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        taskService<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="运行示例"><a href="#运行示例" class="headerlink" title="运行示例"></a>运行示例</h3><p>第一次启动，程序会自动创建flowable相关表，启动需要的时间较长</p><p>打开浏览器测试</p><ol><li>查看流程图</li></ol><p><a href="http://127.0.0.1:8080/flowable-learn/helloWorld/image">http://127.0.0.1:8080/flowable-learn/helloWorld/image</a></p><p><img src="/images/Flowable-HelloWorld/image-20211202211702240.png"></p><ol start="2"><li>启动流程</li></ol><p><a href="http://127.0.0.1:8080/flowable-learn/helloWorld/start">http://127.0.0.1:8080/flowable-learn/helloWorld/start</a></p><ol start="3"><li>查看待办任务</li></ol><p><a href="http://127.0.0.1:8080/flowable-learn/helloWorld/todo?assignee=aacopy">http://127.0.0.1:8080/flowable-learn/helloWorld/todo?assignee=aacopy</a></p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"createTime"</span><span class="token operator">:</span><span class="token string">"2021-12-02T08:57:27.886+00:00"</span><span class="token punctuation">,</span><span class="token property">"name"</span><span class="token operator">:</span><span class="token string">"my task"</span><span class="token punctuation">,</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token string">"e0193bb3-534d-11ec-ac8c-d08e7902fe33"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>提交任务</li></ol><p>taskId入参填写“查看待办任务”接口返回列表中的id值</p><p><a href="http://127.0.0.1:8080/flowable-learn/helloWorld/complete?taskId=e0193bb3-534d-11ec-ac8c-d08e7902fe33">http://127.0.0.1:8080/flowable-learn/helloWorld/complete?taskId=e0193bb3-534d-11ec-ac8c-d08e7902fe33</a></p>]]></content>
      
      
      <categories>
          
          <category> Flowable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flowable </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis安装-Docker版</title>
      <link href="/redis/redis-an-zhuang-docker/"/>
      <url>/redis/redis-an-zhuang-docker/</url>
      
        <content type="html"><![CDATA[<h2 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-itd</span> <span class="token parameter variable">--name</span> redis <span class="token parameter variable">-p</span> <span class="token number">6379</span>:6379 <span class="token parameter variable">-v</span> /home/dockerdata/redis/data:/data redis:6.2.6 <span class="token parameter variable">--requirepass</span> aacopy.cn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用redis可视化工具查看链接:</p><p>mac版本：<a href="https://pan.baidu.com/s/1PlD6U-D-hgWnNAWMnZS0NA">https://pan.baidu.com/s/1PlD6U-D-hgWnNAWMnZS0NA</a>  密码: 3iqa</p>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql安装-docker版</title>
      <link href="/mysql/mysql-an-zhuang-docker-ban/"/>
      <url>/mysql/mysql-an-zhuang-docker-ban/</url>
      
        <content type="html"><![CDATA[<h2 id="5-7版本安装指令"><a href="#5-7版本安装指令" class="headerlink" title="5.7版本安装指令"></a>5.7版本安装指令</h2><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker">docker run -p 3306:3306 --name mysql5.7 --privileged=true \-v /home/dockerdata/mysql5.7/conf:/etc/mysql \-v /home/dockerdata/mysql5.7/logs:/var/log/mysql \-v /home/dockerdata/mysql5.7/data:/var/lib/mysql \-e MYSQL_ROOT_PASSWORD=aacopy.cn \-d mysql:5.7 \--character-set-server=utf8mb4 \--collation-server=utf8mb4_unicode_ci \--lower_case_table_names=1 \--sql_mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>docker ps 查看是否启动成功</p><p>lower_case_table_names标识忽略表大小写</p><p>sql_mode取消ONLY_FULL_GROUP_BY</p><p>问题：</p><ol><li><p>docker ps 中没mysql的信息，服务没有启动成功</p><ul><li><p>docker ps -a 查看全部内容</p></li><li><p>找到mysql，查看状态Exited (1) 16 seconds ago</p></li><li><p>docker logs -f containerid 查看日志</p></li><li><p>日志信息：Entrypoint script for MySQL Server 5.7.36-1debian10 started.</p><p>chown: changing ownership of ‘/var/lib/mysql/‘: Permission denied</p></li></ul></li></ol><p>​解决：权限不足的问题，在启动命令里加上 –privileged=true，现把原来容器中的mysql删掉。docker rm ,再执行下面的命令</p><h2 id="8-0版本安装"><a href="#8-0版本安装" class="headerlink" title="8.0版本安装"></a>8.0版本安装</h2><p>安装命令</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token punctuation">\</span>    <span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token punctuation">\</span>    <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>aacopy.cn <span class="token punctuation">\</span>    <span class="token parameter variable">-v</span> /home/dockerdata/mysql8.0/data:/var/lib/mysql:rw <span class="token punctuation">\</span>    <span class="token parameter variable">-v</span> /etc/localtime:/etc/localtime:ro <span class="token punctuation">\</span>    <span class="token parameter variable">--name</span> mysql8.0 <span class="token punctuation">\</span>    <span class="token parameter variable">--restart</span><span class="token operator">=</span>always <span class="token punctuation">\</span>    <span class="token parameter variable">-d</span> mysql:8.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改最大连接数</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查看当前最大连接数</span><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%max_connections%'</span><span class="token punctuation">;</span><span class="token comment">-- 设置最大连接数</span><span class="token keyword">set</span> <span class="token keyword">GLOBAL</span> max_connections<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">;</span><span class="token keyword">set</span> <span class="token keyword">GLOBAL</span> mysqlx_max_connections<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux环境安装Docker</title>
      <link href="/docker/linux-an-zhuang-docker/"/>
      <url>/docker/linux-an-zhuang-docker/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>应用容器引擎，可以快速部署启动应用，实现虚拟化，完整资源隔离</p><p>官方地址：<a href="https://www.docker.com/">https://www.docker.com/</a></p><p>仓库地址：<a href="https://hub.docker.com/">https://hub.docker.com/</a></p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum updateyum <span class="token function">install</span> epel-release <span class="token parameter variable">-y</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="安装并运行"><a href="#安装并运行" class="headerlink" title="安装并运行"></a>安装并运行</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> docker-io <span class="token parameter variable">-y</span>systemctl start <span class="token function">docker</span><span class="token function">docker</span> info<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="运行常用指令"><a href="#运行常用指令" class="headerlink" title="运行常用指令"></a>运行常用指令</h2><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker">systemctl start docker     #运行Docker守护进程systemctl stop docker      #停止Docker守护进程systemctl restart docker   #重启Docker守护进程docker ps #查看容器，后面加上-a，显示全部docker start 容器id #启动容器docker stop 容器id #停止容器docker rm 容器id #移除容器docker images #查看容器中的镜像docker search xxx #搜索镜像docker pull xxx #拉取镜像，xxx(格式 REPOSITORY:TAG)docker inspect 容器名称 #检查容器内部信息docker rmi IMAGE_NAME #删除镜像docker logs -f containerid #查看日志docker exec -it 容器id /bin/bash  #进入容器内部,退出exit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="修改镜像仓库"><a href="#修改镜像仓库" class="headerlink" title="修改镜像仓库"></a>修改镜像仓库</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/docker/daemon.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在花括号内加入json格式的配置，全量信息如下：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"debug"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">"experimental"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">"registry-mirrors"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"https://mle62as6.mirror.aliyuncs.com"</span><span class="token punctuation">,</span><span class="token string">"https://hub-mirror.c.163.com"</span><span class="token punctuation">,</span><span class="token string">"https://docker.mirrors.ustc.edu.cn"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>可以通过”data-root”: “/home/docker”,指定docker的数据目录</p><p>重启systemctl restart docker</p><p>再次查看验证docker info</p><h2 id="部署一个nginx"><a href="#部署一个nginx" class="headerlink" title="部署一个nginx"></a>部署一个nginx</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--name</span> nginx <span class="token parameter variable">-p</span> <span class="token number">8080</span>:80 <span class="token parameter variable">-d</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>–name nginx：容器的名字叫做nginx,名字自己定义.<br>-p: 端口进行映射，将本地 8080 端口映射到容器内部的 80 端口<br>-d：容器启动后，在后台运行</p><p>浏览器访问部署的服务器ip加8080端口，显示nginx页面</p><h2 id="部署DockerCompose"><a href="#部署DockerCompose" class="headerlink" title="部署DockerCompose"></a>部署DockerCompose</h2><p>一个用于定义和运行多容器 Docker 的容器编排工具</p><p>官方地址：<a href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a></p><p>下载地址：<a href="https://github.com/docker/compose/tags">https://github.com/docker/compose/tags</a></p><ul><li><p>选择：docker-compose-linux-x86_64</p></li><li><p>上传至/usr/local/bin/</p></li><li><p><code>mv docker-compose-linux-x86_64 docker-compose</code></p></li><li><p><code>chmod 777 docker-compose</code></p></li><li><p>安装完成</p></li></ul><h2 id="集成jenkins的问题"><a href="#集成jenkins的问题" class="headerlink" title="集成jenkins的问题"></a>集成jenkins的问题</h2><p>docker 1.13.1版本，在jenkins使用docker命令时，提示找不到配置文件，通过以下方式重新安装</p><h3 id="卸载docker"><a href="#卸载docker" class="headerlink" title="卸载docker"></a>卸载docker</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum remove <span class="token function">docker</span> <span class="token punctuation">\</span>docker-client <span class="token punctuation">\</span>docker-client-latest <span class="token punctuation">\</span>docker-common <span class="token punctuation">\</span>docker-latest <span class="token punctuation">\</span>docker-latest-logrotate <span class="token punctuation">\</span>docker-logrotate <span class="token punctuation">\</span>docker-engine<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装指定版本"><a href="#安装指定版本" class="headerlink" title="安装指定版本"></a>安装指定版本</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#添加依赖</span>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils device-mapper-persistent-data lvm2<span class="token comment">#配置yum源</span>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<span class="token comment">#查看docker版本</span>yum list docker-ce <span class="token parameter variable">--showduplicates</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-r</span><span class="token comment">#安装指定版本的docker</span>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> docker-ce-20.10.10-3.el7<span class="token comment">#安装完成，查看版本</span><span class="token function">docker</span> <span class="token parameter variable">-v</span><span class="token comment">#修改镜像仓库</span><span class="token function">vim</span> /etc/docker/daemon.json<span class="token comment">#添加如下镜像配置，并保存</span><span class="token punctuation">{</span><span class="token string">"debug"</span>:true,<span class="token string">"experimental"</span>:true,<span class="token string">"registry-mirrors"</span>:<span class="token punctuation">[</span><span class="token string">"https://mle62as6.mirror.aliyuncs.com"</span>,<span class="token string">"https://hub-mirror.c.163.com"</span>,<span class="token string">"https://docker.mirrors.ustc.edu.cn"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token comment">#启动docker</span>systemctl start <span class="token function">docker</span><span class="token comment">#查看docker信息</span><span class="token function">docker</span> info<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux安装JDK</title>
      <link href="/java/linux-an-zhuang-jdk/"/>
      <url>/java/linux-an-zhuang-jdk/</url>
      
        <content type="html"><![CDATA[<h2 id="JDK8下载"><a href="#JDK8下载" class="headerlink" title="JDK8下载"></a>JDK8下载</h2><p>官方下载地址：<a href="https://www.oracle.com/java/technologies/downloads/#java8">https://www.oracle.com/java/technologies/downloads/#java8</a></p><p>下载jdk-8uxxx-linux-x64.tar.gz</p><h2 id="上传解压"><a href="#上传解压" class="headerlink" title="上传解压"></a>上传解压</h2><ol><li><p>使用Xshell或其它工具连接linux服务器</p></li><li><p>在usr/local目录下新建java文件夹（mkdir java），使用rz将jdk的压缩包上传至该文件夹下</p><p>如果没有rz命令，使用yum -y install lrzsz进行安装</p></li><li><p>tar -zxvf jdk-8uxxx-linux-x64.tar.gz</p></li></ol><h2 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h2><ol><li>vim /etc/profile，如果没有vim命令，先安装：yum -y install vim*</li><li>在最后加上如下配置，版本号根据具体情况修改</li></ol><pre class="line-numbers language-none"><code class="language-none">JAVA_HOME=/usr/local/java/jdk1.8.0_291CLASSPATH=$JAVA_HOME/lib/PATH=$PATH:$JAVA_HOME/binexport PATH JAVA_HOME CLASSPATH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li><p>source /etc/profile，让环境变量立即生效</p></li><li><p>java -version 查看是否安装成功</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JDK8 </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Seata-HelloWorld</title>
      <link href="/seata/seata-helloworld/"/>
      <url>/seata/seata-helloworld/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Seata 是一款开源的分布式事务解决方案</p><p>官方网站：<a href="http://seata.io/">http://seata.io/</a></p><p>github地址：<a href="https://github.com/seata/seata">https://github.com/seata/seata</a></p><p>文档：<a href="http://seata.io/zh-cn/docs/overview/what-is-seata.html">http://seata.io/zh-cn/docs/overview/what-is-seata.html</a></p><p>下载地址：<a href="http://seata.io/zh-cn/blog/download.html">http://seata.io/zh-cn/blog/download.html</a></p>]]></content>
      
      
      <categories>
          
          <category> Seata </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seata </tag>
            
            <tag> 分布式事务 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDK8新特性-stream</title>
      <link href="/java/jdk8-xin-te-xing-stream/"/>
      <url>/java/jdk8-xin-te-xing-stream/</url>
      
        <content type="html"><![CDATA[<h2 id="map"><a href="#map" class="headerlink" title="map"></a>map</h2><p>作用：将流中的每一个元素转换为另外一类元素</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h2><p>作用：过滤流中的每一个元素，符合条件的保留下来</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> user<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">18</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="sorted"><a href="#sorted" class="headerlink" title="sorted"></a>sorted</h2><p>作用：对元素进行排序</p><p>自然排序sorted()：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>自定义排序sorted(Comparator comparator) ：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparingInt</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>反转排序</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparingInt</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reversed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="limit"><a href="#limit" class="headerlink" title="limit"></a>limit</h2><p>作用：返回的集合最多包涵的元素个数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="allMatch"><a href="#allMatch" class="headerlink" title="allMatch"></a>allMatch</h2><p>作用：所有元素都匹配成功返回true</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">boolean</span> result <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">allMatch</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> user<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="anyMatch"><a href="#anyMatch" class="headerlink" title="anyMatch"></a>anyMatch</h2><p>作用：任意一个元素匹配成功返回true</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">boolean</span> result <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> user<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="max-x2F-min"><a href="#max-x2F-min" class="headerlink" title="max/min"></a>max/min</h2><p>作用：返回规则中结果最大/最小的一个元素</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">User</span> result <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparingInt</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h2><p>作用：聚合操作，根据规则将流中的元素计算后返回一个唯一的值</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//返回年龄最大的User</span><span class="token class-name">User</span> result <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>user1<span class="token punctuation">,</span> user2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> user1<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>user2<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span>user1<span class="token operator">:</span>user2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>带有初始值的</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//在100基础上，加每一个user的年龄</span><span class="token keyword">int</span> sum <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>age1<span class="token punctuation">,</span> age2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> age1 <span class="token operator">+</span> age2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a>forEach</h2><p>作用：迭代元素，</p><p>注意：不能continue;break;return;不能修改外部变量值</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>map<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>k<span class="token operator">+</span><span class="token string">"-&gt;"</span><span class="token operator">+</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="collect"><a href="#collect" class="headerlink" title="collect"></a>collect</h2><p>作用：对流数据进行归集</p><pre class="line-numbers language-none"><code class="language-none">&lt;R, A&gt; R collect(Collector&lt;? super T, A, R&gt; collector);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Collectors可以创建多种Collector的实现</p><p>Collectors.toList()收集为一个list</p><p>Collectors.toMap()收集为一个map，用于list转map</p><pre class="line-numbers language-none"><code class="language-none">把用户集合转为key是name，value是age的mapMap&lt;String, Integer&gt; result = userList.stream()                .collect(Collectors.toMap(User::getName, User::getAge));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Collectors.toSet()</p><p>Collectors.toCollection() ：⽤⾃定义的实现Collection的数据结构收集</p><ul><li>Collectors.toCollection(LinkedList::new)</li><li>Collectors.toCollection(CopyOnWriteArrayList::new)</li><li>Collectors.toCollection(TreeSet::new)</li></ul><h2 id="joining"><a href="#joining" class="headerlink" title="joining"></a>joining</h2><p>作用：拼接字符串</p><p>直接拼接</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> r <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>以逗号分隔符拼接（可以换其它符号）</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> r <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>以括号开头和结尾逗号分隔拼接（可以换其它符号）</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> r <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span><span class="token string">"("</span><span class="token punctuation">,</span><span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JDK8 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDK8新特性-Lambda表达式</title>
      <link href="/java/jdk8-xin-te-xing-lambda-biao-da-shi/"/>
      <url>/java/jdk8-xin-te-xing-lambda-biao-da-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>​lambda表达式就是函数编程，就是将一个函数作为方法的入参，本质上是以匿名内部类的方式实现。</p><p>eg：创建线程</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello AaCopy"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>eg：集合排序</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> b<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><p>(params) -&gt; {expression}</p><p>params：</p><ul><li>参数列表数据类型省略</li><li>没有参数列表时，使用()</li><li>只有一个参数时，()可以省略，eg：a -&gt; System.out.println(a)</li><li>有多个参数时，（a, b）-&gt; a+b</li></ul><p> expression:</p><ul><li>只有一行代码时，{}、return、分号都可以省略</li><li>有多行代码时，和正常方法一样写法</li></ul><h2 id="使用自定义函数式接口"><a href="#使用自定义函数式接口" class="headerlink" title="使用自定义函数式接口"></a>使用自定义函数式接口</h2><ol><li>定义函数（行为）接口，接口需要添加注解@FunctionalInterface，接口内只有一个需要被实现的方法，如果有其他方法，需要设置defalut</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FunctionalInterface</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OperFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token class-name">R</span> <span class="token function">operator</span><span class="token punctuation">(</span><span class="token class-name">T</span> t1<span class="token punctuation">,</span> <span class="token class-name">T</span> t2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>编写一个方法，参数为，需要操作的数据和函数接口</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> <span class="token function">operator</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> x<span class="token punctuation">,</span> <span class="token class-name">Integer</span> y<span class="token punctuation">,</span> <span class="token class-name">OperFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> of<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> of<span class="token punctuation">.</span><span class="token function">operator</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="3"><li>调用方法时传入数据和lambda表达式</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">operator</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">operator</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> x <span class="token operator">-</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="Java内置函数式接口"><a href="#Java内置函数式接口" class="headerlink" title="Java内置函数式接口"></a>Java内置函数式接口</h2><p>​java内置的函数式接口放在java.util.function包下面，四大核心接口</p><ul><li>消费型接⼝：有⼊参，⽆返回值</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>供给型接⼝：⽆⼊参，有返回值</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>函数型接⼝：有⼊参，有返回值</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token class-name">R</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>断⾔型接⼝：有⼊参，返回值类型是boolean</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>    <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="⽅法引⽤与构造函数引⽤"><a href="#⽅法引⽤与构造函数引⽤" class="headerlink" title="⽅法引⽤与构造函数引⽤"></a>⽅法引⽤与构造函数引⽤</h2><ul><li><p>说明</p><p>​⽅法引⽤是⼀种更简洁易懂的lambda表达式，操作符是双冒号::，⽤来直接访问类或者实例已经存在的⽅法或构造⽅法</p></li><li><p>语法</p><p>左边是容器（可以是类名，实例名），中间是” :: “，右边是相应的⽅法名</p><ul><li><p>静态方法</p><p>ClassName::methodName</p></li><li><p>实例方法</p><p>Instance::methodName</p></li><li><p>构造函数</p><p>ClassName::new</p></li></ul></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> biFun <span class="token operator">=</span> <span class="token class-name">String</span><span class="token operator">::</span><span class="token function">contains</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> r <span class="token operator">=</span> biFun<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string">"ab"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> biFun2 <span class="token operator">=</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> a<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>biFun2<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string">"ab"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CharSequence</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> fun <span class="token operator">=</span> <span class="token string">"abc"</span><span class="token operator">::</span><span class="token function">contains</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fun<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">"ab"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> biFunction <span class="token operator">=</span> <span class="token class-name">User</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">;</span><span class="token class-name">User</span> user <span class="token operator">=</span> biFunction<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">"aacopy"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JDK8 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Win安装centOS7虚拟机</title>
      <link href="/linux/win-an-zhuang-centos7-xu-ni-ji/"/>
      <url>/linux/win-an-zhuang-centos7-xu-ni-ji/</url>
      
        <content type="html"><![CDATA[<h2 id="安装VMware-Workstation"><a href="#安装VMware-Workstation" class="headerlink" title="安装VMware Workstation"></a>安装VMware Workstation</h2><ul><li>下载地址：<a href="https://www.vmware.com/cn/products/workstation-pro/workstation-pro-evaluation.html">https://www.vmware.com/cn/products/workstation-pro/workstation-pro-evaluation.html</a></li><li>安装</li><li>激活：16版本的序列号：ZF3R0-FHED2-M80TY-8QYGC-NPKYF</li></ul><h2 id="下载centOS7镜像"><a href="#下载centOS7镜像" class="headerlink" title="下载centOS7镜像"></a>下载centOS7镜像</h2><ul><li>下载地址：<a href="http://mirrors.aliyun.com/centos/7/isos/x86_64/">http://mirrors.aliyun.com/centos/7/isos/x86_64/</a></li><li>下载标准安装版本DVD.iso，如：<a href="http://mirrors.aliyun.com/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-2009.iso">CentOS-7-x86_64-DVD-2009.iso</a></li></ul><h2 id="新建centOS7虚拟机"><a href="#新建centOS7虚拟机" class="headerlink" title="新建centOS7虚拟机"></a>新建centOS7虚拟机</h2><ol><li>打开VMware，选择创建新的虚拟机</li><li>选择稍后安装操作系统</li><li>选择linux 和 centos7 64</li><li>点击完成</li><li>在虚拟机页面点击编辑虚拟机设置</li><li>可以移除USB，声卡，打印机等无用的设备</li><li>选择CD/DVD</li><li>使用ISO映像文件，选择iso文件</li><li>点击确定</li><li>点击启动虚拟机</li><li>语言选择英语的就可以 continue</li><li>date&amp;time选择亚洲，选择down</li><li>选择INSTALLATION DESTINATION，直接点down</li><li>选择NETWORK &amp; HOST NAME 设置为ON</li><li>点击begin installation</li><li>设置ROOT PASSWORD 如123456. 点击down</li><li>等待加载完后点击reboot</li></ol><h2 id="设置虚拟机网络"><a href="#设置虚拟机网络" class="headerlink" title="设置虚拟机网络"></a>设置虚拟机网络</h2><p>三种网络模式</p><h3 id="Bridged桥接模式"><a href="#Bridged桥接模式" class="headerlink" title="Bridged桥接模式"></a>Bridged桥接模式</h3><ul><li>默认使用VMnet0，不提供DHCP服务（DHCP服务是指由服务器控制的一段IP地址范围，当客户机登录服务器时会自动获取服务器分配的IP地址与子网掩码）</li><li>虚拟机与外部主机需要在同一个网段上，与局域网的其它机器没有区别。</li><li>可以与局域网内其它主机通信，可以与外部网络通信</li><li>容易与局域网其他主机引起ip地址冲突</li></ul><h3 id="Host-Only仅主机模式"><a href="#Host-Only仅主机模式" class="headerlink" title="Host-Only仅主机模式"></a>Host-Only仅主机模式</h3><ul><li>默认使用VMnet1，提供DHCP服务</li><li>虚拟机可以和物理主机互相访问，但虚拟机无法访问外部网络</li></ul><h3 id="NAT模式"><a href="#NAT模式" class="headerlink" title="NAT模式"></a>NAT模式</h3><ul><li>默认使用VMnet8，提供DHCP服务</li><li>虚拟机可以和物理主机互相访问，可访问外部网络</li><li>局域网内其它机器访问不了</li></ul><p>​由于需要将闲置windows电脑作为虚拟机使用，并对其他局域网内的电脑可见，所以选用桥接模式，</p><p>右键服务-&gt;设置-&gt;网络适配器-&gt;选择桥接模式，并勾选上复制物理网络连接状态-&gt;确定</p><p>重启网卡：systemctl restart network.service</p><p>查看ip命令：ip addr</p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>问题1、启动报错：此主机支持 Intel VT-x，但 Intel VT-x 处于禁用状态。</p><p>（1）重启系统，进入BIOS（ThinkPad系列按F1）</p><p>（2）进入BIOS，选择Configuration选项，选择Intel Virtual Technology并回车</p><p>（3）若无VT选项或不可更改</p><p>（4）将光标移动至Enabled处，并回车确定</p><p>（5）最后按F10热键保存并退出即可开启VT功能</p><p>ping不通的时候，看下防火墙是不是关了</p><p>如果需要添加过个虚拟机，最简单的方式就是在已经添加好的虚拟机上右键-&gt;管理-&gt;克隆，选择全量</p><p>mac可以使用终端ssh@root:ip登录，传输文件可以下载免费的filezilla(<a href="https://www.filezilla.cn/download/client),%E9%80%89%E6%8B%A9sftp%E7%99%BB%E5%BD%95">https://www.filezilla.cn/download/client),选择sftp登录</a></p><h2 id="设置固定IP和连接互联网"><a href="#设置固定IP和连接互联网" class="headerlink" title="设置固定IP和连接互联网"></a>设置固定IP和连接互联网</h2><ul><li><p>管理员模式启动VMware</p></li><li><p>编辑 -&gt; 虚拟网络编辑器</p><p><img src="/images/Win%E5%AE%89%E8%A3%85centOS7%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20220208004436174.png"></p></li><li><p>设置网络</p><ul><li>选择VMnet8</li><li>点击还原默认设置</li><li>取消勾选使用本地DHCP</li><li>设置子网ip，改为需要设置的ip段</li><li>点击NAT设置</li></ul><p><img src="/images/Win%E5%AE%89%E8%A3%85centOS7%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20220208004905283.png"></p><ul><li><p>修改网关IP，最后一个要设置为2</p><p><img src="/images/Win%E5%AE%89%E8%A3%85centOS7%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20220208005134494.png"></p></li><li><p>点击确定</p></li></ul></li><li><p>设置linux虚拟机</p><ul><li>vim /etc/sysconfig/network-scripts/ifcfg-ens32</li><li>如下几项是需要添加或者修改的</li></ul></li></ul><p><img src="/images/Win%E5%AE%89%E8%A3%85centOS7%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20220208005519625.png"></p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">TYPE</span><span class="token punctuation">=</span><span class="token value attr-value">"Ethernet"</span><span class="token key attr-name">PROXY_METHOD</span><span class="token punctuation">=</span><span class="token value attr-value">"none"</span><span class="token key attr-name">BROWSER_ONLY</span><span class="token punctuation">=</span><span class="token value attr-value">"no"</span><span class="token key attr-name">BOOTPROTO</span><span class="token punctuation">=</span><span class="token value attr-value">"static"</span><span class="token key attr-name">DEFROUTE</span><span class="token punctuation">=</span><span class="token value attr-value">"yes"</span><span class="token key attr-name">IPADDR</span><span class="token punctuation">=</span><span class="token value attr-value">"192.168.80.128"</span><span class="token key attr-name">NETMASK</span><span class="token punctuation">=</span><span class="token value attr-value">"255.255.255.0"</span><span class="token key attr-name">GATEWAY</span><span class="token punctuation">=</span><span class="token value attr-value">"192.168.80.2"</span><span class="token key attr-name">DNS1</span><span class="token punctuation">=</span><span class="token value attr-value">"114.114.114.114"</span><span class="token key attr-name">IPV4_FAILURE_FATAL</span><span class="token punctuation">=</span><span class="token value attr-value">"no"</span><span class="token key attr-name">IPV6INIT</span><span class="token punctuation">=</span><span class="token value attr-value">"yes"</span><span class="token key attr-name">IPV6_AUTOCONF</span><span class="token punctuation">=</span><span class="token value attr-value">"yes"</span><span class="token key attr-name">IPV6_DEFROUTE</span><span class="token punctuation">=</span><span class="token value attr-value">"yes"</span><span class="token key attr-name">IPV6_FAILURE_FATAL</span><span class="token punctuation">=</span><span class="token value attr-value">"no"</span><span class="token key attr-name">IPV6_ADDR_GEN_MODE</span><span class="token punctuation">=</span><span class="token value attr-value">"stable-privacy"</span><span class="token key attr-name">NAME</span><span class="token punctuation">=</span><span class="token value attr-value">"ens32"</span><span class="token key attr-name">UUID</span><span class="token punctuation">=</span><span class="token value attr-value">"8733bc96-ef4d-4647-871c-846846a7e58f"</span><span class="token key attr-name">DEVICE</span><span class="token punctuation">=</span><span class="token value attr-value">"ens32"</span><span class="token key attr-name">ONBOOT</span><span class="token punctuation">=</span><span class="token value attr-value">"yes"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>重启网络服务</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">systemctl restart network<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="设置时间同步"><a href="#设置时间同步" class="headerlink" title="设置时间同步"></a>设置时间同步</h2><p>在虚拟机右键 –&gt; 设置 –&gt;  选项 –&gt; VMware Tools –&gt; 勾选将客户机与主机同步</p><p><img src="/images/Win%E5%AE%89%E8%A3%85centOS7%E8%99%9A%E6%8B%9F%E6%9C%BA/image-20220214161445742.png"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AlibabaCloud-Gateway</title>
      <link href="/springcloud/alibabacloud-gateway/"/>
      <url>/springcloud/alibabacloud-gateway/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是网关"><a href="#什么是网关" class="headerlink" title="什么是网关"></a>什么是网关</h2><p>​API Gateway，是系统的唯一对外的入口，介于客户端和服务器端之间的中间层，处理非业务功能，提供路由请求、鉴权、监控、缓存、限流等功能</p><p>​官网：<a href="https://spring.io/projects/spring-cloud-gateway">https://spring.io/projects/spring-cloud-gateway</a></p><p>​基于Spring5+Reactor技术开发的网关，性能强劲基于Reactor+WebFlux、功能多样。</p><h2 id="Gateway项目创建"><a href="#Gateway项目创建" class="headerlink" title="Gateway项目创建"></a>Gateway项目创建</h2><ul><li>创建module，名称为api-gateway</li><li>修改pom，添加依赖</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.aacopy.demo.alibabacloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>api-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>api-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>api-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bootstrap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-ribbon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-loadbalancer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建bootstrap.yml</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>      <span class="token key atrule">config</span><span class="token punctuation">:</span>        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml  <span class="token key atrule">application</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> api<span class="token punctuation">-</span>gateway<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在nacos网关中创建api-gateway.yaml配置</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>      <span class="token key atrule">routes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service  <span class="token comment">#路由唯一标示</span>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//order<span class="token punctuation">-</span>service  <span class="token comment">#从nacos获取名称转发,lb是负载均衡轮训策略</span>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> Path=/order<span class="token punctuation">-</span>service/<span class="token important">**</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul><li>在IDEA中Edit Configurations，勾选OrderService配置中的Allow parallel run</li><li>启动order-service，这时候端口为8080</li><li>在nacos中修改端口为8081，再次启动一个order-service，这时候有两个order-service服务，模拟双节点</li><li>启动api-gateway服务。</li><li>重复请求<a href="http://127.0.0.1:8888/order-service/api/v1/order/demo/sayHello?name=aacopy">http://127.0.0.1:8888/order-service/api/v1/order/demo/sayHello?name=aacopy</a></li><li>在两个order服务的控制台可以看到轮询打印日志</li></ul>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AlibabaCloud-Sentinel</title>
      <link href="/springcloud/alibabacloud-sentinel/"/>
      <url>/springcloud/alibabacloud-sentinel/</url>
      
        <content type="html"><![CDATA[<h2 id="Sentinel简介"><a href="#Sentinel简介" class="headerlink" title="Sentinel简介"></a>Sentinel简介</h2><p>官方地址：<a href="https://github.com/alibaba/Sentinel/">https://github.com/alibaba/Sentinel/</a></p><p>中文文档：<a href="https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D">https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D</a></p><p>Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p><p>Sentinel 分为两个部分:</p><ul><li>核心库（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。</li><li>控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器。</li></ul><h2 id="Sentinel控制台（1-8-1）"><a href="#Sentinel控制台（1-8-1）" class="headerlink" title="Sentinel控制台（1.8.1）"></a>Sentinel控制台（1.8.1）</h2><p>下载地址：<a href="https://github.com/alibaba/Sentinel/releases">https://github.com/alibaba/Sentinel/releases</a></p><p>中文文档：<a href="https://github.com/alibaba/Sentinel/wiki/%E6%8E%A7%E5%88%B6%E5%8F%B0">https://github.com/alibaba/Sentinel/wiki/%E6%8E%A7%E5%88%B6%E5%8F%B0</a></p><p>下载后的文件：sentinel-dashboard-1.8.1.jar</p><p>启动命令：nohup java -Dserver.port=9090 -Dcsp.sentinel.dashboard.server=localhost:9090 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-1.8.1.jar &amp;</p><p>注：端口号根据具体情况修改，jar包的名称根据版本号修改</p><p>浏览器访问控制台：<a href="http://localhost:9090/">http://localhost:9090</a> 默认账号密码 ：sentinel/sentinel</p><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><p>以order-service为例</p><h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="添加配置文件"><a href="#添加配置文件" class="headerlink" title="添加配置文件"></a>添加配置文件</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>      <span class="token key atrule">transport</span><span class="token punctuation">:</span>        <span class="token comment">#控制台地址</span>        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">9090</span>        <span class="token comment">#客户端监控 API 的端口（默认是 8719）若被占用,则自动+1</span>        <span class="token comment">#port: 9999</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><ul><li><p>启动控制台jar</p></li><li><p>启动order-service</p></li><li><p>多次访问<a href="http://127.0.0.1:8080/order-service/api/v1/order/demo/sayHello?name=aacopy">http://127.0.0.1:8080/order-service/api/v1/order/demo/sayHello?name=aacopy</a></p></li><li><p>查看控制台order-service的实时监控项</p><p><img src="/images/AlibabaCloud-Sentinel/image-20210925103233812.png"></p></li></ul><h2 id="流控配置"><a href="#流控配置" class="headerlink" title="流控配置"></a>流控配置</h2><h3 id="基于QPS"><a href="#基于QPS" class="headerlink" title="基于QPS"></a>基于QPS</h3><p>根据请求地址配置qps流控规则，当 QPS 超过某个阈值的时候，则采取措施进行流量控制</p><p><img src="/images/AlibabaCloud-Sentinel/image-20210926111843972.png"></p><p><img src="/images/AlibabaCloud-Sentinel/image-20210926112136869.png"></p><p>测试流控规则</p><ul><li>快速刷新<a href="http://127.0.0.1:8080/order-service/api/v1/order/demo/sayHello?name=aacopy">http://127.0.0.1:8080/order-service/api/v1/order/demo/sayHello?name=aacopy</a></li><li>提示“Blocked by Sentinel (flow limiting)”表示流控生效</li></ul><p>查看编辑流控规则，在左侧边栏找到流控规则进行操作</p><h3 id="基于并发线程数"><a href="#基于并发线程数" class="headerlink" title="基于并发线程数"></a>基于并发线程数</h3><p>用于保护业务线程池不被慢调用耗尽，如果超出阈值，新的请求会被立即拒绝，类似于信号量隔离。</p><ul><li>编写测试代码</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/sayHi"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hi "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token string">"Hi "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>重启order-service服务</p></li><li><p>打开sentinel控制台，这时候发现之前添加的流控规则没有了，是因为流控规则会下发到微服务，微服务如果重启，则流控规则会消失，可以持久化配置解决，后面会讲到</p></li><li><p>浏览器请求一次<a href="http://127.0.0.1:8080/order-service/api/v1/order/demo/sayHi?name=aacopy">http://127.0.0.1:8080/order-service/api/v1/order/demo/sayHi?name=aacopy</a></p></li><li><p>在<strong>簇点链路</strong>中找到**/api/v1/order/demo/sayHi**，点击流控</p><p><img src="/images/AlibabaCloud-Sentinel/image-20210926174622336.png"></p></li><li><p>再次访问sayHi链接，3秒内访问超过2次，则会看到限流提示<em>Blocked by Sentinel (flow limiting)</em></p></li></ul><h2 id="熔断降级"><a href="#熔断降级" class="headerlink" title="熔断降级"></a>熔断降级</h2><p>​对调用链路中不稳定的资源进行熔断降级也是保障高可用的重要措施之一，熔断降级作为保护自身的手段，通常在客户端（调用端）进行配置</p><p>​文档：<a href="https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7">https://github.com/alibaba/Sentinel/wiki/熔断降级</a></p><h3 id="熔断策略"><a href="#熔断策略" class="headerlink" title="熔断策略"></a>熔断策略</h3><h4 id="慢调用比例"><a href="#慢调用比例" class="headerlink" title="慢调用比例"></a>慢调用比例</h4><p>TODO</p><h4 id="异常比例"><a href="#异常比例" class="headerlink" title="异常比例"></a>异常比例</h4><ul><li>编写测试代码</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/exceptionProportion"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">exceptionProportion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>访问地址：<a href="http://127.0.0.1:8080/order-service/api/v1/order/demo/exceptionProportion">http://127.0.0.1:8080/order-service/api/v1/order/demo/exceptionProportion</a></p></li><li><p>打开控制台，在簇点链路中找到，点击降级</p></li></ul><p><img src="/images/AlibabaCloud-Sentinel/image-20210926211916453.png"></p><ul><li>快速刷新访问地址，触发降级，提示”*Blocked by Sentinel (flow limiting)*“</li></ul><h2 id="自定义异常"><a href="#自定义异常" class="headerlink" title="自定义异常"></a>自定义异常</h2><p>实现BlockExceptionHandler并且重写handle方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderBlockExceptionHandler</span> <span class="token keyword">implements</span> <span class="token class-name">BlockExceptionHandler</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpServletResponse<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> backMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">FlowException</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            backMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            backMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"限流-异常啦"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">DegradeException</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            backMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            backMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"降级-异常啦"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ParamFlowException</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            backMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            backMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"热点-异常啦"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">SystemBlockException</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            backMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            backMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"系统规则-异常啦"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">AuthorityException</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            backMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            backMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"认证-异常啦"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>                httpServletResponse<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        httpServletResponse<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"content-Type"</span><span class="token punctuation">,</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        httpServletResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>backMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>添加限流，降级等操作，触发流控测试</p><h2 id="feign和sentinel整合"><a href="#feign和sentinel整合" class="headerlink" title="feign和sentinel整合"></a>feign和sentinel整合</h2><ul><li>添加配置项</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#开启Feign对Sentinel的支持</span><span class="token key atrule">feign</span><span class="token punctuation">:</span>  <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>创建容错类</li></ul><p>创建fallback文件夹编写实现类GoodsServiceFallback</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GoodsServiceFallback</span> <span class="token keyword">implements</span> <span class="token class-name">GoodsService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getGoodsById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Fallback服务："</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"ID为"</span><span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">"的默认商品"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>配置feign容错类</li></ul><p>在feignClient接口上的注解@FeignClient增加fallback参数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"goods-service"</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">GoodsServiceFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p>注意：</p><p>当前最新springCloud版本2020.0.4，无法兼容此功能，会报错</p><pre class="line-numbers language-none"><code class="language-none">Requested bean is currently in creation: Is there an unresolvable circular reference?<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果要用到此功能需要将springCloud版本降到Hoxton.SR9及以下</p><p><a href="https://github.com/alibaba/spring-cloud-alibaba/issues/1974">https://github.com/alibaba/spring-cloud-alibaba/issues/1974</a><br><a href="https://github.com/alibaba/Sentinel/issues/2065">https://github.com/alibaba/Sentinel/issues/2065</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AlibabaCloud-Nacos</title>
      <link href="/springcloud/alibabacloud-nacos/"/>
      <url>/springcloud/alibabacloud-nacos/</url>
      
        <content type="html"><![CDATA[<h2 id="1-什么是nacos"><a href="#1-什么是nacos" class="headerlink" title="1. 什么是nacos"></a>1. 什么是nacos</h2><p>官方地址：<a href="https://nacos.io/zh-cn/index.html">https://nacos.io/zh-cn/index.html</a></p><p><img src="https://nacos.io/img/nacosMap.jpg"></p><h2 id="2-nacos服务端-v1-4-2"><a href="#2-nacos服务端-v1-4-2" class="headerlink" title="2. nacos服务端(v1.4.2)"></a>2. nacos服务端(v1.4.2)</h2><h3 id="2-1-下载路径"><a href="#2-1-下载路径" class="headerlink" title="2.1 下载路径"></a>2.1 下载路径</h3><p>在官网的首页中点对应的版本进入github，在最下面有下载入口</p><h3 id="2-2-单机模式启动"><a href="#2-2-单机模式启动" class="headerlink" title="2.2 单机模式启动"></a>2.2 单机模式启动</h3><ol><li>cd到nacos的bin目录下</li><li>sh startup.sh -m standalone</li><li>查看进程是否已启动 ps -ef|grep nacos</li><li>查看启动日志 tail -300f ../logs/start.out</li><li>浏览器访问地址：<a href="http://127.0.0.1:8848/nacos/">http://127.0.0.1:8848/nacos/</a></li><li>登录账号密码，默认 nacos/nacos</li></ol><h2 id="3-配置中心-demo"><a href="#3-配置中心-demo" class="headerlink" title="3. 配置中心(demo)"></a>3. 配置中心(demo)</h2><h3 id="3-1-添加依赖"><a href="#3-1-添加依赖" class="headerlink" title="3.1 添加依赖"></a>3.1 添加依赖</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bootstrap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-2-创建配置文件bootstrap-yml"><a href="#3-2-创建配置文件bootstrap-yml" class="headerlink" title="3.2 创建配置文件bootstrap.yml"></a>3.2 创建配置文件bootstrap.yml</h3><p>在子项目中添加配置文件bootstrap.yml，properties也可以</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>      <span class="token key atrule">config</span><span class="token punctuation">:</span>        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml  <span class="token key atrule">application</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-3-在nacos中添加配置项"><a href="#3-3-在nacos中添加配置项" class="headerlink" title="3.3 在nacos中添加配置项"></a>3.3 在nacos中添加配置项</h3><p>打开nacos地址，选择配置管理，选择配置列表，点击右侧➕</p><p>Data ID命名规则：${prefix}-${spring.profiles.active}.${file-extension}</p><ul><li><p>prefix 默认为 spring.application.name 的值，也可以通过配置项spring.cloud.nacos.config.prefix来配置。</p></li><li><p>spring.profiles.active 即为当前环境对应的 profile，注意：当 spring.profiles.active 为空时，对应的连接符 -</p><p>也将不存在，dataId 的拼接格式变成 ${prefix}.${file-extension}</p></li><li><p>file-exetension 为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置。目前只支持 properties (默认)和 yaml 类型。</p></li></ul><p>例如创建order-service的配置文件</p><ul><li><p>Data ID: order-service.yaml</p></li><li><p>配置格式：YAML</p></li><li><p>配置内容：</p></li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /order<span class="token punctuation">-</span>service    <span class="token key atrule">demo</span><span class="token punctuation">:</span>  <span class="token key atrule">test1</span><span class="token punctuation">:</span> abc  <span class="token key atrule">test2</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">demo2</span><span class="token punctuation">:</span> <span class="token number">123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>发布配置</p></li><li><p>编写测试代码：</p></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/v1/order/config"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@RefreshScope</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${demo.test1:hello}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> demoTest1<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${demo.test2:false}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> demoTest2<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${demo2:-1}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> demo2<span class="token punctuation">;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/get"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"demoTest1: "</span> <span class="token operator">+</span> demoTest1 <span class="token operator">+</span> <span class="token string">", demoTest2: "</span> <span class="token operator">+</span> demoTest2 <span class="token operator">+</span> <span class="token string">", demo2: "</span> <span class="token operator">+</span> demo2<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>访问地址：<a href="http://127.0.0.1:8080/order-service/api/v1/order/config/get">http://127.0.0.1:8080/order-service/api/v1/order/config/get</a></li></ul><p>@RefreshScope注解可以在修改配置文件后不用重启，动态刷新配置</p><h2 id="4-注册中心-demo"><a href="#4-注册中心-demo" class="headerlink" title="4. 注册中心(demo)"></a>4. 注册中心(demo)</h2><h3 id="4-1-配置服务提供者-goods-service"><a href="#4-1-配置服务提供者-goods-service" class="headerlink" title="4.1 配置服务提供者(goods-service)"></a>4.1 配置服务提供者(goods-service)</h3><ul><li>添加依赖</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>同时需要添加配置中心的依赖</p><ul><li>新增配置文件bootstrap.yml</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>      <span class="token key atrule">config</span><span class="token punctuation">:</span>        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml  <span class="token key atrule">application</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> goods<span class="token punctuation">-</span>service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在nacos中新增goods-service.yaml配置</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /goods<span class="token punctuation">-</span>service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>编写服务接口</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/v1/goods/"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GoodsController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/getGoodsById"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getGoodsById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"商品id："</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"ID为"</span><span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">"的商品"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>测试接口地址：<a href="http://127.0.0.1:8081/goods-service/api/v1/goods//getGoodsById?id=1">http://127.0.0.1:8081/goods-service/api/v1/goods//getGoodsById?id=1</a></li></ul><h3 id="4-2-配置客户端（order-service）"><a href="#4-2-配置客户端（order-service）" class="headerlink" title="4.2 配置客户端（order-service）"></a>4.2 配置客户端（order-service）</h3><ul><li>添加依赖</li></ul><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-ribbon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-loadbalancer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在启动类上添加注解@EnableDiscoveryClient 开启服务注册发现功能</li><li>编写feignClient服务接口</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"goods-service"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/goods-service"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GoodsService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/v1/goods/getGoodsById"</span><span class="token punctuation">)</span>    <span class="token class-name">String</span> <span class="token function">getGoodsById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>编写调用代码</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/v1/order"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> <span class="token class-name">GoodsService</span> goodsService<span class="token punctuation">;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/saveOrder"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">saveOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> goodsId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"商品id: "</span> <span class="token operator">+</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> goodsInfo <span class="token operator">=</span> goodsService<span class="token punctuation">.</span><span class="token function">getGoodsById</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> goodsInfo <span class="token operator">+</span> <span class="token string">"下单成功！"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>测试：<a href="http://127.0.0.1:8080/order-service/api/v1/order/saveOrder?goodsId=1">http://127.0.0.1:8080/order-service/api/v1/order/saveOrder?goodsId=1</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AlibabaCloud-聚合项目</title>
      <link href="/springcloud/alibabacloud-ju-he-xiang-mu/"/>
      <url>/springcloud/alibabacloud-ju-he-xiang-mu/</url>
      
        <content type="html"><![CDATA[<h2 id="Demo简介"><a href="#Demo简介" class="headerlink" title="Demo简介"></a>Demo简介</h2><p>本笔记以三个微服务作为例子：订单服务（order-service），商品服务（goods-service），用户服务（user-service）</p><h2 id="创建聚合工程"><a href="#创建聚合工程" class="headerlink" title="创建聚合工程"></a>创建聚合工程</h2><p>首先创建一个空的maven项目，只保留pom.xml</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.aacopy.demo.alibabacloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>order-service<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>goods-service<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>user-service<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2020.0.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.5.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.1.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="在该工程中创建子项目"><a href="#在该工程中创建子项目" class="headerlink" title="在该工程中创建子项目"></a>在该工程中创建子项目</h2><p>以order-service为例，user-service，goods-service和order类似</p><p>创建spring-boot项目，添加Spring Web依赖，修改pom.xml的parent依赖，删除groupId</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.aacopy.demo.alibabacloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>order-service<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>order-service<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>order-service<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/v1/order"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/sayHello"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"Hello "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>浏览器访问<a href="http://127.0.0.1:8080/api/v1/order/sayHello?name=aacopy">http://127.0.0.1:8080/api/v1/order/sayHello?name=aacopy</a></p>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudAlibaba</title>
      <link href="/springcloud/springcloudalibaba/"/>
      <url>/springcloud/springcloudalibaba/</url>
      
        <content type="html"><![CDATA[<h2 id="1-SpringCloudAlibaba"><a href="#1-SpringCloudAlibaba" class="headerlink" title="1. SpringCloudAlibaba"></a>1. SpringCloudAlibaba</h2><p>SpringCloudAlibaba提供了微服务开发的一站式解决方案</p><h2 id="2-架构演进"><a href="#2-架构演进" class="headerlink" title="2. 架构演进"></a>2. 架构演进</h2><h3 id="2-1-单体架构"><a href="#2-1-单体架构" class="headerlink" title="2.1 单体架构"></a>2.1 单体架构</h3><p>优点：便于集成，易于测试，部署，对小型项目友好</p><p>缺点：启动慢，依赖庞大，CI/CD复杂度高，升级重构成本大</p><h3 id="2-2-分布式架构"><a href="#2-2-分布式架构" class="headerlink" title="2.2 分布式架构"></a>2.2 分布式架构</h3><ul><li><p>SOA： 面向服务的架构，服务间通过相互依赖提供功能，服务之前通过网络调用</p></li><li><p>微服务： 将一个大的单体应用进行细粒度的服务化拆分，每个服务各自打包部署，服务间通过网络调用</p></li></ul><p>优点：易开发，理解和维护，独立部署和启动，微服务间是松耦合的，可以通过不同的语言开发，一个组件故障不会导致整个系统宕机</p><p>缺点：存在分布式事务问题，服务治理</p><h3 id="2-3-分布式架构考虑的因素"><a href="#2-3-分布式架构考虑的因素" class="headerlink" title="2.3 分布式架构考虑的因素"></a>2.3 分布式架构考虑的因素</h3><ul><li>服务编排调度<ul><li>应对不对增长的服务实例和容器规模，Kubernetes</li></ul></li><li>服务注册发现<ul><li>解决众多微服务之间复杂的调用关系，Consul，Zookeeper，Nacos，Eureka</li></ul></li><li>服务状态，集群管理<ul><li>解决庞大规模集群的服务和机器运行状态，Kubernetes</li><li>Skywalking可以解决复杂的分布式链路追踪，监控各个服务的状态</li></ul></li><li>容器数据存储<ul><li>解决容器存储是临时的问题，Kubernetes Persistent volume</li></ul></li><li>网络<ul><li>服务间的通讯通过RPC的方式，依赖网络，需要确认网络的可用性及带宽，优化网络IO的开销</li></ul></li><li>容器隔离技术<ul><li>多容器在同一个主机上运行，管理进程与进程之间的访问权限，Flannel，Weaveworks，Calico</li></ul></li><li>监控，审核，日志<ul><li>Loggly，Fluentd，日志条目，Datadog，ELK</li></ul></li></ul><h3 id="2-4-构建微服务的目标"><a href="#2-4-构建微服务的目标" class="headerlink" title="2.4 构建微服务的目标"></a>2.4 构建微服务的目标</h3><ul><li>降低维护成本</li><li>提高部署效率</li><li>提高系统弹性</li><li>监测服务状态</li></ul><h3 id="2-5-构建微服务的关键的"><a href="#2-5-构建微服务的关键的" class="headerlink" title="2.5 构建微服务的关键的"></a>2.5 构建微服务的关键的</h3><ul><li>可伸缩性<ul><li>在系统扩展过程中，通过较少的改动就能实现整体系统处理能力的提升</li><li>侧重系统的水平扩展，通过加机器实现分布式计算</li></ul></li><li>可用性<ul><li>通常使用多少个9来衡量系统可用性，比如99.99%即4个9表示1年中系统有一个小时不可用</li><li>服务可用性 = （服务周期总分钟数 - 服务不可用分钟数）/ 服务周期总分钟数 * 100%</li><li>一个服务周期为一个自然月</li><li>通过故障服务自动隔离，调用降级实现高可用</li></ul></li><li>弹性能力<ul><li>即从某些类型的故障中恢复并保持功能的能力</li><li>很大程度上取决于微服务的通讯弹性</li></ul></li><li>可扩展性<ul><li>水平扩展：添加现有节点相同功能的新节点，在重新分配负载</li><li>垂直扩展：增加CPU，内存，磁盘，网络接口等提高机器的性能</li></ul></li><li>高内聚，低耦合<ul><li>需要以面向对象思想设计系统</li></ul></li><li>服务治理能力<ul><li>管理众多应用服务</li></ul></li><li>故障隔离<ul><li>调用方要确保自己具有隔离故障的能力，避免被调服务不可用</li></ul></li><li>DevOps持续交付<ul><li>DEV（开发人员），OPS（运维人员）</li><li>DevOps强调的是团队间可以通过自动化工具来进行协作沟通贸易完成软件生命周期管理，从而更快，更频繁的交付更稳定的版本</li></ul></li></ul><h2 id="微服务架构核心组件"><a href="#微服务架构核心组件" class="headerlink" title="微服务架构核心组件"></a>微服务架构核心组件</h2><ul><li>网关：路由转发及过滤器，将Restful API以统一域名的方式暴露给app或者浏览器</li><li>服务发现与注册：调用方和被调用方的信息维护</li><li>配置中心：管理配置</li><li>链路追踪：分析调用链路耗时</li><li>负载均衡：分发流量到多个节点</li><li>熔断：保护自己和被调用方</li></ul><h2 id="常见微服务的解决方案"><a href="#常见微服务的解决方案" class="headerlink" title="常见微服务的解决方案"></a>常见微服务的解决方案</h2><ul><li>SpringCloudAlibaba<ul><li><a href="https://spring.io/projects/spring-cloud-alibaba">https://spring.io/projects/spring-cloud-alibaba</a></li><li>组件：<ul><li>通信方式：http restful (open-feign)，Dubbo</li><li>注册中心：nacos</li><li>配置中心：nacos</li><li>断路器：sentinal</li><li>网关：gateway</li><li>链路追踪：sleuth+zipkin</li><li>分布式事务：Seata</li><li>消息中间件：RocketMQ</li></ul></li></ul></li><li>SpringCloud<ul><li><a href="https://spring.io/projects/spring-cloud">https://spring.io/projects/spring-cloud</a></li><li>组件：<ul><li>通信方式：http restful</li><li>注册中心：eruka</li><li>配置中心：config</li><li>断路器：hystrix</li><li>网关：zuul/gateway</li><li>链路追踪：sleuth+zipkin</li></ul></li></ul></li><li>dubbo<ul><li><a href="https://dubbo.apache.org/zh/">https://dubbo.apache.org/zh/</a></li><li>组件：<ul><li>通信方式：rpc</li><li>注册中心：zookeper/redis/nacos</li><li>配置中心：diamond，nacos</li></ul></li></ul></li></ul><h2 id="SpringCloudAlibaba与SpringCloud的区别和选择"><a href="#SpringCloudAlibaba与SpringCloud的区别和选择" class="headerlink" title="SpringCloudAlibaba与SpringCloud的区别和选择"></a>SpringCloudAlibaba与SpringCloud的区别和选择</h2><ul><li>SpringCloud很多组件是基于第三方整合的，目前很多已经不更新或者闭源了，比如zuul，eureka，hystrix</li><li>SpringCloudAlibaba提供一站式微服务解决方案，已经和SpringCloud进行了整合，组件相互支持</li></ul><h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>SpringCloud需要严格按照官方文档上表明的SpringBoot版本使用</p><p><strong>Table 1. Release train Spring Boot compatibility</strong></p><table><thead><tr><th align="left">Release Train</th><th align="left">Boot Version</th></tr></thead><tbody><tr><td align="left"><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2020.0-Release-Notes">2020.0.x</a> aka Ilford</td><td align="left">2.4.x, 2.5.x (Starting with 2020.0.3)</td></tr><tr><td align="left"><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Hoxton-Release-Notes">Hoxton</a></td><td align="left">2.2.x, 2.3.x (Starting with SR5)</td></tr><tr><td align="left"><a href="https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Greenwich-Release-Notes">Greenwich</a></td><td align="left">2.1.x</td></tr><tr><td align="left"><a href="https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Finchley-Release-Notes">Finchley</a></td><td align="left">2.0.x</td></tr><tr><td align="left"><a href="https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Edgware-Release-Notes">Edgware</a></td><td align="left">1.5.x</td></tr><tr><td align="left"><a href="https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Dalston-Release-Notes">Dalston</a></td><td align="left">1.5.x</td></tr></tbody></table><p>当前笔记使用的环境和版本，（后续大版本变动再更新）</p><p>MAC，IDEA，JDK1.8，MySql5.7</p><p>spring-boot: 2.5.4</p><p>spring-cloud: 2020.0.3</p><p>spring-cloud-alibaba: 2.2.1.RELEASE</p>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
