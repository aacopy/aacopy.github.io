<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kafka-消费者 | aacopy</title><meta name="keywords" content="Kafka,消息队列"><meta name="author" content="cmyang"><meta name="copyright" content="cmyang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Kafka-消费者处理消息的策略">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka-消费者">
<meta property="og:url" content="https://www.aacopy.cn/Kafka/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/index.html">
<meta property="og:site_name" content="aacopy">
<meta property="og:description" content="Kafka-消费者处理消息的策略">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.aacopy.cn/images/common/kafka.png">
<meta property="article:published_time" content="2021-12-22T15:37:00.000Z">
<meta property="article:modified_time" content="2022-06-06T13:16:56.168Z">
<meta property="article:author" content="cmyang">
<meta property="article:tag" content="Kafka">
<meta property="article:tag" content="消息队列">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.aacopy.cn/images/common/kafka.png"><link rel="shortcut icon" href="/images/common/favicon.png"><link rel="canonical" href="https://www.aacopy.cn/Kafka/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kafka-消费者',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-06-06 21:16:56'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/common/header.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">107</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">aacopy</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Kafka-消费者</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-12-22T15:37:00.000Z" title="发表于 2021-12-22 23:37:00">2021-12-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-06-06T13:16:56.168Z" title="更新于 2022-06-06 21:16:56">2022-06-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Kafka/">Kafka</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Kafka-消费者"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="获取消息策略"><a href="#获取消息策略" class="headerlink" title="获取消息策略"></a>获取消息策略</h2><p>拉取（pull）的方式，消费者从partition中主动拉取消息。</p>
<p>优点：</p>
<ul>
<li>消费者可以根据性能处理消息，如果是push模式，可能会导致服务并发不够处理不过来，MQ的削峰也就没有了意义</li>
<li>如果服务端没有消息，客户端会定时发送请求，根据超时时间，阻塞一段时间后再返回</li>
</ul>
<h2 id="分区分配策略"><a href="#分区分配策略" class="headerlink" title="分区分配策略"></a>分区分配策略</h2><p>通过partition.assignment.strategy配置，ConsumerConfig.PARTITION_ASSIGNMENT_STRATEGY_CONFIG获取</p>
<p>默认策略：RangeAssignor（按照主题进行范围分配）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.define(PARTITION_ASSIGNMENT_STRATEGY_CONFIG,</span><br><span class="line">            Type.LIST,</span><br><span class="line">            Arrays.asList(RangeAssignor.class, CooperativeStickyAssignor.class),<span class="comment">//默认值</span></span><br><span class="line">            <span class="keyword">new</span> ConfigDef.NonNullValidator(),</span><br><span class="line">            Importance.MEDIUM,</span><br><span class="line">            PARTITION_ASSIGNMENT_STRATEGY_DOC)</span><br></pre></td></tr></table></figure>

<p>kafka的分配策略</p>
<ul>
<li><p>RangeAssignor</p>
<p>按照主题进行范围分配</p>
</li>
<li><p>RoundRobinAssignor</p>
<p>轮询分配，以循环方式将分区分配给消费者</p>
</li>
<li><p>StickyAssignor</p>
<p>保证分配是最大限度的平衡，同时保留尽可能多的现有分区分配。</p>
</li>
<li><p>CooperativeStickyAssignor</p>
<p>遵循StickyAssignor相同的逻辑，但允许合作再平衡。</p>
</li>
</ul>
<p>默认的assignor是[RangeAssignor, CooperativeStickyAssignor]，默认使用RangeAssignor，但是允许升级到CooperativeStickyAssignor，只需从列表中移除RangeAssignor。</p>
<p>也可以自定义策略，通过实现org.apache.kafka.clients.consumer.ConsumerPartitionAssignor</p>
<h3 id="RoundRobinAssignor"><a href="#RoundRobinAssignor" class="headerlink" title="RoundRobinAssignor"></a>RoundRobinAssignor</h3><p>实现方式：获取一个消费者组中订阅的所有的Topic中的所有partition，和消费者组中所有的消费者列表，外层遍历partition列表，内存遍历消费者列表，将每个partition依次分配给消费者。</p>
<p>示例1：</p>
<p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20211230112141081.png" alt="image-20211230112141081"></p>
<p>示例2：</p>
<p>官方示例：</p>
<blockquote>
<p>When subscriptions differ across consumer instances, the assignment process still considers each consumer instance in round robin fashion but skips over an instance if it is not subscribed to the topic. Unlike the case when subscriptions are identical, this can result in imbalanced assignments. For example, we have three consumers C0, C1, C2, and three topics t0, t1, t2, with 1, 2, and 3 partitions, respectively. Therefore, the partitions are t0p0, t1p0, t1p1, t2p0, t2p1, t2p2. C0 is subscribed to t0; C1 is subscribed to t0, t1; and C2 is subscribed to t0, t1, t2.<br>That assignment will be:<br>C0: [t0p0]<br>C1: [t1p0]<br>C2: [t1p1, t2p0, t2p1, t2p2]</p>
</blockquote>
<p>我们有三个消费者C0、C1、C2和三个主题t0、t1、t2，分别有1、2和3个分区。因此，分区为t0p0, t1p0, t1p1, t2p0, t2p1, t2p2。C0订阅到t0;C1订阅t0, t1;C2订阅了t0 t1 t2。</p>
<p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20211230112332363.png" alt="image-20211230112332363"></p>
<p>如果同一个消费者组中不同的消费者订阅了不同的主题，就会不均匀分配，上面的T1P1完全可以分配给消费者2</p>
<p>源码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoundRobinAssignor</span> <span class="keyword">extends</span> <span class="title">AbstractPartitionAssignor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;TopicPartition&gt;&gt; assign(Map&lt;String, Integer&gt; partitionsPerTopic,</span><br><span class="line">                                                    Map&lt;String, Subscription&gt; subscriptions) &#123;</span><br><span class="line">        Map&lt;String, List&lt;TopicPartition&gt;&gt; assignment = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">//获取消费者组中所有的消费者</span></span><br><span class="line">        List&lt;MemberInfo&gt; memberInfoList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Subscription&gt; memberSubscription : subscriptions.entrySet()) &#123;</span><br><span class="line">            assignment.put(memberSubscription.getKey(), <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">            memberInfoList.add(<span class="keyword">new</span> MemberInfo(memberSubscription.getKey(),</span><br><span class="line">                                              memberSubscription.getValue().groupInstanceId()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CircularIterator&lt;MemberInfo&gt; assigner = <span class="keyword">new</span> CircularIterator&lt;&gt;(Utils.sorted(memberInfoList));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (TopicPartition partition : allPartitionsSorted(partitionsPerTopic, subscriptions)) &#123;</span><br><span class="line">            <span class="keyword">final</span> String topic = partition.topic();</span><br><span class="line">            <span class="comment">//判断当前遍历的partition所属的主题在当前消费者是否订阅，如果没有订阅继续获取下一个消费者</span></span><br><span class="line">            <span class="keyword">while</span> (!subscriptions.get(assigner.peek().memberId).topics().contains(topic))</span><br><span class="line">                assigner.next();</span><br><span class="line">            assignment.get(assigner.next().memberId).add(partition);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> assignment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取消费者组内订阅的topic中所有的patition集合</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;TopicPartition&gt; <span class="title">allPartitionsSorted</span><span class="params">(Map&lt;String, Integer&gt; partitionsPerTopic,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                     Map&lt;String, Subscription&gt; subscriptions)</span> </span>&#123;</span><br><span class="line">        SortedSet&lt;String&gt; topics = <span class="keyword">new</span> TreeSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Subscription subscription : subscriptions.values())</span><br><span class="line">            topics.addAll(subscription.topics());</span><br><span class="line"></span><br><span class="line">        List&lt;TopicPartition&gt; allPartitions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String topic : topics) &#123;</span><br><span class="line">            Integer numPartitionsForTopic = partitionsPerTopic.get(topic);</span><br><span class="line">            <span class="keyword">if</span> (numPartitionsForTopic != <span class="keyword">null</span>)</span><br><span class="line">                allPartitions.addAll(AbstractPartitionAssignor.partitions(topic, numPartitionsForTopic));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> allPartitions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;roundrobin&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RangeAssignor"><a href="#RangeAssignor" class="headerlink" title="RangeAssignor"></a>RangeAssignor</h3><p>实现方式：获取消费者组中的所有主题，遍历主题，获取每个主题下面的所有消费者的数量和分区数量，用分区数量除以消费者数量，获取每个消费者应该分配到的分区数，如果有余数，按照顺序，排在前面的消费者每个多分配一个分区。</p>
<p>示例1：</p>
<p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20211230114834382.png" alt="image-20211230114834382"></p>
<p>官方示例2：</p>
<blockquote>
<p>For example, suppose there are two consumers C0 and C1, two topics t0 and t1, and each topic has 3 partitions, resulting in partitions t0p0, t0p1, t0p2, t1p0, t1p1, and t1p2.<br>The assignment will be:<br>C0: [t0p0, t0p1, t1p0, t1p1]<br>C1: [t0p2, t1p2]</p>
</blockquote>
<p>假设有两个消费者C0和C1，两个主题t0和t1，每个主题有3个分区，导致分区t0p0、t0p1、t0p2、t1p0、t1p1和t1p2。</p>
<p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20211230132133763.png" alt="image-20211230132133763"></p>
<p>如果有很多topic，这种方案会导致排在前面的消费者压力比后面的大</p>
<p>源码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RangeAssignor</span> <span class="keyword">extends</span> <span class="title">AbstractPartitionAssignor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;range&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, List&lt;MemberInfo&gt;&gt; consumersPerTopic(Map&lt;String, Subscription&gt; consumerMetadata) &#123;</span><br><span class="line">        Map&lt;String, List&lt;MemberInfo&gt;&gt; topicToConsumers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Subscription&gt; subscriptionEntry : consumerMetadata.entrySet()) &#123;</span><br><span class="line">            String consumerId = subscriptionEntry.getKey();</span><br><span class="line">            MemberInfo memberInfo = <span class="keyword">new</span> MemberInfo(consumerId, subscriptionEntry.getValue().groupInstanceId());</span><br><span class="line">            <span class="keyword">for</span> (String topic : subscriptionEntry.getValue().topics()) &#123;</span><br><span class="line">                put(topicToConsumers, topic, memberInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> topicToConsumers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;TopicPartition&gt;&gt; assign(Map&lt;String, Integer&gt; partitionsPerTopic,</span><br><span class="line">                                                    Map&lt;String, Subscription&gt; subscriptions) &#123;</span><br><span class="line">        Map&lt;String, List&lt;MemberInfo&gt;&gt; consumersPerTopic = consumersPerTopic(subscriptions);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, List&lt;TopicPartition&gt;&gt; assignment = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String memberId : subscriptions.keySet())</span><br><span class="line">            assignment.put(memberId, <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">		<span class="comment">//遍历所有的topic</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;MemberInfo&gt;&gt; topicEntry : consumersPerTopic.entrySet()) &#123;</span><br><span class="line">            String topic = topicEntry.getKey();</span><br><span class="line">            <span class="comment">//获取topic的订阅者</span></span><br><span class="line">            List&lt;MemberInfo&gt; consumersForTopic = topicEntry.getValue();</span><br><span class="line">			<span class="comment">//获取topic的分区数量</span></span><br><span class="line">            Integer numPartitionsForTopic = partitionsPerTopic.get(topic);</span><br><span class="line">            <span class="keyword">if</span> (numPartitionsForTopic == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">			<span class="comment">//对消费者进行排序</span></span><br><span class="line">            Collections.sort(consumersForTopic);</span><br><span class="line">			<span class="comment">//计算每个消费者需要分配的分区数量</span></span><br><span class="line">            <span class="keyword">int</span> numPartitionsPerConsumer = numPartitionsForTopic / consumersForTopic.size();</span><br><span class="line">            <span class="comment">//计算没法平均分配的分区数量</span></span><br><span class="line">            <span class="keyword">int</span> consumersWithExtraPartition = numPartitionsForTopic % consumersForTopic.size();</span><br><span class="line"></span><br><span class="line">            List&lt;TopicPartition&gt; partitions = AbstractPartitionAssignor.partitions(topic, numPartitionsForTopic);</span><br><span class="line">            <span class="comment">//遍历订阅过的每个消费者</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = consumersForTopic.size(); i &lt; n; i++) &#123;</span><br><span class="line">                <span class="comment">//计算每个消费者分配的分区的开始index</span></span><br><span class="line">                <span class="keyword">int</span> start = numPartitionsPerConsumer * i + Math.min(i, consumersWithExtraPartition);</span><br><span class="line">                <span class="comment">//计算每个消费者是否需要额外分配一个分区</span></span><br><span class="line">                <span class="keyword">int</span> length = numPartitionsPerConsumer + (i + <span class="number">1</span> &gt; consumersWithExtraPartition ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">                assignment.get(consumersForTopic.get(i).memberId).addAll(partitions.subList(start, start + length));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> assignment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="StickyAssignor"><a href="#StickyAssignor" class="headerlink" title="StickyAssignor"></a>StickyAssignor</h3><p>粘性分配器有两个目的</p>
<ol>
<li>保证尽可能平衡的分配</li>
<li>当重新分配发生时，它尽可能多地保留了现有的分配。这有助于在主题分区从一个消费者转移到另一个消费者时节省一些开销处理。</li>
</ol>
<h4 id="示例1："><a href="#示例1：" class="headerlink" title="示例1："></a>示例1：</h4><p>假设有三个消费者C0、C1、C2，四个主题t0、t1、t2、t3，每个主题有2个分区，形成分区t0p0、t0p1、t1p0、t1p1、t2p0、t2p1、t3p0、t3p1。每个消费者都订阅了所有三个主题。</p>
<p>粘性分配器和轮询分配器的分配结果相同：</p>
<p>C0: [t0p0, t1p1, t3p0]<br>C1: [t0p1, t2p0, t3p1]<br>C2: [t1p0, t2p1]</p>
<p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20220101165705649.png" alt="image-20220101165705649"></p>
<p>假设C1被删除，</p>
<ul>
<li>轮询策略将会重新分配如下结果：</li>
</ul>
<p>C0: [t0p0, t1p0, t2p0, t3p0]<br>C2: [t0p1, t1p1, t2p1, t3p1]</p>
<p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20220101170347490.png" alt="image-20220101170347490"></p>
<ul>
<li>粘性分配器策略将会重新分配如下结果：</li>
</ul>
<p>C0 [t0p0, t1p1, t3p0, t2p0]<br>C2 [t1p0, t2p1, t0p1, t3p1]</p>
<p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20220101170400295.png" alt="image-20220101170400295"></p>
<p><strong>可以看出粘性分配器策略保留所有以前的分配</strong></p>
<h4 id="示例2"><a href="#示例2" class="headerlink" title="示例2"></a>示例2</h4><p>有三个消费者C0、C1、C2，以及三个主题t0、t1、t2，分别有1、2、3个分区。因此，分区为t0p0, t1p0, t1p1, t2p0, t2p1, t2p2。C0被订阅为t0；C1被订阅为t0、t1；C2被订阅为t0、t1、t2。</p>
<ul>
<li>轮询策略分配结果：</li>
</ul>
<p>C0 [t0p0]<br>C1 [t1p0]<br>C2 [t1p1, t2p0, t2p1, t2p2]</p>
<p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20220101171354358.png" alt="image-20220101171354358"></p>
<ul>
<li>粘性策略分配结果：</li>
</ul>
<p>C0 [t0p0]<br>C1 [t1p0, t1p1]<br>C2 [t2p0, t2p1, t2p2]</p>
<p><img src="/images/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/image-20220101171446089.png" alt="image-20220101171446089"></p>
<p>如果删除C0消费者</p>
<p>Round Robin重新分配结果如下：</p>
<p>C1 [t0p0, t1p1]<br>C2 [t1p0, t2p0, t2p1, t2p2]</p>
<p>Sticky重新分配结果如下：</p>
<p>C1 [t1p0, t1p1, t0p0]<br>C2 [t2p0, t2p1, t2p2]</p>
<h3 id="CooperativeStickyAssignor"><a href="#CooperativeStickyAssignor" class="headerlink" title="CooperativeStickyAssignor"></a>CooperativeStickyAssignor</h3><p>AbstractStickyAssignor的一个合作版本。它遵循与StickyAssignor相同的（粘性）分配逻辑，但允许合作式再平衡</p>
<p>Kafka的两种协议：EAGER，COOPERATIVE</p>
<ul>
<li><p>EAGER再平衡协议要求消费者在参与再平衡事件之前总是撤销其所有分区。因此，它允许完全重新洗牌分配。</p>
</li>
<li><p>COOPERATIVE重新平衡协议允许消费者在参与重新平衡事件之前保留其当前拥有的分区。而不是立即重新分配任何拥有的分区，分配者可以向消费者表示需要撤销该分区，这样被撤销的分区就可以在下一次重新平衡事件中重新分配给另一个消费者。这是为粘性分配逻辑设计的，该逻辑试图通过合作调整来尽量减少分区的重新分配。</p>
</li>
</ul>
<p>EAGER协议：RangeAssignor，RoundRobinAssignor，StickyAssignor</p>
<p>COOPERATIVE协议：CooperativeStickyAssignor</p>
<p>在集群庞大的情况下，频繁的发生集群节点上下线，消费订阅变更频繁，EAGER会操作全部的分区，COOPERATIVE只会操作部分，达到最终平衡</p>
<h2 id="消费记录offset"><a href="#消费记录offset" class="headerlink" title="消费记录offset"></a>消费记录offset</h2><ul>
<li><p>消费者利用offset记录每个消费者组消费到哪个位置</p>
<ul>
<li><p>通过group.id+topic+patitin.id来确定唯一的offset的key，value为offset的值</p>
</li>
<li><p>kafka通过将offset存放在一个名称为__consumer_offsets的内置topic中。默认有50个partition</p>
</li>
</ul>
</li>
<li><p>如何从头消费partition中的数据</p>
<ul>
<li>从头开始消费消息，需要两点<ul>
<li>设置auto.offset.reset属性为earliest，默认是latest</li>
<li>创建一个新的消费者组</li>
</ul>
</li>
</ul>
</li>
<li><p>offset手动提交</p>
<ul>
<li><p>offset默认是自动提交的，在实际很多场景中，需要业务服务确定消息是否被正常消费，正常消费后才可以提交offset</p>
</li>
<li><p>设置enable.auto.commit属性为false</p>
</li>
<li><p>手动提交分为两种：</p>
<ul>
<li>同步阻塞提交：kafkaConsumer.commitSync()</li>
<li>异步提交：kafkaConsumer.commitAsync()，实现onComplete方法处理自定义逻辑</li>
</ul>
</li>
</ul>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">cmyang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.aacopy.cn/Kafka/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/">https://www.aacopy.cn/Kafka/Kafka-%E6%B6%88%E8%B4%B9%E8%80%85/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.aacopy.cn" target="_blank">aacopy</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kafka/">Kafka</a><a class="post-meta__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a></div><div class="post_share"><div class="social-share" data-image="/images/common/kafka.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/Kafka/Kafka-AdminApi/"><img class="prev-cover" src="/images/common/kafka.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Kafka-AdminApi</div></div></a></div><div class="next-post pull-right"><a href="/Kafka/Kafka-%E7%94%9F%E4%BA%A7%E8%80%85/"><img class="next-cover" src="/images/common/kafka.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Kafka-生产者</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/Kafka/Kafka-AdminApi/" title="Kafka-AdminApi"><img class="cover" src="/images/common/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-27</div><div class="title">Kafka-AdminApi</div></div></a></div><div><a href="/Kafka/Kafka-HelloWorld/" title="Kafka-HelloWorld"><img class="cover" src="/images/common/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-06</div><div class="title">Kafka-HelloWorld</div></div></a></div><div><a href="/Kafka/Kafka-SpringBoot/" title="Kafka-SpringBoot"><img class="cover" src="/images/common/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-07</div><div class="title">Kafka-SpringBoot</div></div></a></div><div><a href="/Kafka/Kafka-事务消息/" title="Kafka-事务消息"><img class="cover" src="/images/common/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-04</div><div class="title">Kafka-事务消息</div></div></a></div><div><a href="/Kafka/Kafka-命令/" title="Kafka-命令"><img class="cover" src="/images/common/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-14</div><div class="title">Kafka-命令</div></div></a></div><div><a href="/Kafka/Kafka-文件存储机制/" title="Kafka-文件存储机制"><img class="cover" src="/images/common/kafka.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-13</div><div class="title">Kafka-文件存储机制</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%B6%88%E6%81%AF%E7%AD%96%E7%95%A5"><span class="toc-number">1.</span> <span class="toc-text">获取消息策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="toc-number">2.</span> <span class="toc-text">分区分配策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RoundRobinAssignor"><span class="toc-number">2.1.</span> <span class="toc-text">RoundRobinAssignor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RangeAssignor"><span class="toc-number">2.2.</span> <span class="toc-text">RangeAssignor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StickyAssignor"><span class="toc-number">2.3.</span> <span class="toc-text">StickyAssignor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B1%EF%BC%9A"><span class="toc-number">2.3.1.</span> <span class="toc-text">示例1：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B2"><span class="toc-number">2.3.2.</span> <span class="toc-text">示例2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CooperativeStickyAssignor"><span class="toc-number">2.4.</span> <span class="toc-text">CooperativeStickyAssignor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%AE%B0%E5%BD%95offset"><span class="toc-number">3.</span> <span class="toc-text">消费记录offset</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By cmyang</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a href="http://beian.miit.gov.cn/" target="_blank">皖ICP备2022008292号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='all'|| 'all' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://www.aacopy.cn/categories/Kafka/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 Kafka (11)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.aacopy.cn/categories/Mysql/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 Mysql (14)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.aacopy.cn/categories/SpringCloud/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎮 SpringCloud (10)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.aacopy.cn/categories/ElasticSearch/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🐱‍👓 ElasticSearch (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.aacopy.cn/categories/Flowable/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 Flowable (8)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.aacopy.cn/categories/Redis/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📒 Redis (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://www.aacopy.cn/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #b30070}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><!-- hexo injector body_end end --></body></html>